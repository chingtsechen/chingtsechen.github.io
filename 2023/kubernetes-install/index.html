<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="使用kubeadm方式，建置kubernetes集群，並採用haproxy、keepalived讓集群達到高可用。"><title>kubeadm安裝 高可用版(ubuntu2204+k8s版本1.26.3+docker+cri-docker)</title><link rel=canonical href=https://blog.goldfishbrain-fighting.com/2023/kubernetes-install/><link rel=stylesheet href=/scss/style.min.d868909d7283a33ea0f0387696ac11ff970849e15f3a6149ee12c0f272b08e81.css><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><script src=//cdn.bootcss.com/jquery/3.2.1/jquery.min.js></script>
<script>$(document).ready(function(){var e=setInterval(s,100),t=100,n=50;function s(){$("#busuanzi_container_site_pv").css("display")!="none"&&(clearInterval(e),$("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html())+t),$("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html())+n))}})</script><meta property="og:title" content="kubeadm安裝 高可用版(ubuntu2204+k8s版本1.26.3+docker+cri-docker)"><meta property="og:description" content="使用kubeadm方式，建置kubernetes集群，並採用haproxy、keepalived讓集群達到高可用。"><meta property="og:url" content="https://blog.goldfishbrain-fighting.com/2023/kubernetes-install/"><meta property="og:site_name" content="翻轉吧金魚腦"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="kubernetes"><meta property="article:tag" content="ubuntu"><meta property="article:tag" content="docker"><meta property="article:tag" content="cri-docker"><meta property="article:published_time" content="2023-10-07T02:30:00+08:00"><meta property="article:modified_time" content="2023-10-07T02:30:00+08:00"><meta name=twitter:title content="kubeadm安裝 高可用版(ubuntu2204+k8s版本1.26.3+docker+cri-docker)"><meta name=twitter:description content="使用kubeadm方式，建置kubernetes集群，並採用haproxy、keepalived讓集群達到高可用。"><link rel="shortcut icon" href=/favicon.png><script async src="https://www.googletagmanager.com/gtag/js?id=G-QB4H991E1G"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QB4H991E1G",{anonymize_ip:!1})}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><div id=article-toolbar style=position:sticky;top:5px;z-index:1000><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>返回</span></a></div><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目錄</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#一節點規劃>一、節點規劃</a></li><li><a href=#二組件版本>二、組件版本</a></li></ol><ol><li><a href=#一設置hosts解析>一、設置hosts解析</a></li><li><a href=#二調整系統配置>二、調整系統配置</a></li><li><a href=#三安裝docker>三、安裝docker</a></li><li><a href=#四安裝cri-docker>四、安裝cri-docker</a></li></ol><ol><li><a href=#一安裝kubeadmkubeletkubectl>一、安裝kubeadm、kubelet、kubectl</a></li><li><a href=#二安裝配置haproxykeepalived>二、安裝配置haproxy、keepalived</a></li><li><a href=#三初始化配置文件>三、初始化配置文件</a></li><li><a href=#四提前下載鏡像>四、提前下載鏡像</a></li><li><a href=#五初始化master節點>五、初始化master節點</a></li><li><a href=#六添加其他master節點到集群中>六、添加其他master節點到集群中</a></li><li><a href=#七添加node節點到集群中>七、添加node節點到集群中</a></li><li><a href=#部署容器網絡calico>部署容器網絡（calico）</a></li></ol><ol><li><a href=#設置master節點是否可調度可選>設置master節點是否可調度（可選）</a></li><li><a href=#設置kubectl自動補全>設置kubectl自動補全</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/kubernetes/ style=background-color:#0000e3;color:#fff>kubernetes</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/2023/kubernetes-install/>kubeadm安裝 高可用版(ubuntu2204+k8s版本1.26.3+docker+cri-docker)</a></h2><h3 class=article-subtitle>使用kubeadm方式，建置kubernetes集群，並採用haproxy、keepalived讓集群達到高可用。</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>2023/10/07</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>閱讀時間: 15 分鐘</time></div></footer></div></header><section class=article-content><section class="toc toc--inline"><h2>目錄</h2><div><nav id=TableOfContents><ol><li><a href=#一節點規劃>一、節點規劃</a></li><li><a href=#二組件版本>二、組件版本</a></li></ol><ol><li><a href=#一設置hosts解析>一、設置hosts解析</a></li><li><a href=#二調整系統配置>二、調整系統配置</a></li><li><a href=#三安裝docker>三、安裝docker</a></li><li><a href=#四安裝cri-docker>四、安裝cri-docker</a></li></ol><ol><li><a href=#一安裝kubeadmkubeletkubectl>一、安裝kubeadm、kubelet、kubectl</a></li><li><a href=#二安裝配置haproxykeepalived>二、安裝配置haproxy、keepalived</a></li><li><a href=#三初始化配置文件>三、初始化配置文件</a></li><li><a href=#四提前下載鏡像>四、提前下載鏡像</a></li><li><a href=#五初始化master節點>五、初始化master節點</a></li><li><a href=#六添加其他master節點到集群中>六、添加其他master節點到集群中</a></li><li><a href=#七添加node節點到集群中>七、添加node節點到集群中</a></li><li><a href=#部署容器網絡calico>部署容器網絡（calico）</a></li></ol><ol><li><a href=#設置master節點是否可調度可選>設置master節點是否可調度（可選）</a></li><li><a href=#設置kubectl自動補全>設置kubectl自動補全</a></li></ol></nav></div></section><p><img src=/2023/kubernetes-install/media/Pasted-image-20230919205815.png width=1057 height=723 srcset="/2023/kubernetes-install/media/Pasted-image-20230919205815_hu68c64d2de39064ad11cfc1877399bd32_320279_480x0_resize_box_3.png 480w, /2023/kubernetes-install/media/Pasted-image-20230919205815_hu68c64d2de39064ad11cfc1877399bd32_320279_1024x0_resize_box_3.png 1024w" loading=lazy alt=media/Pasted-image-20230919205815.png class=gallery-image data-flex-grow=146 data-flex-basis=350px></p><h2 id=一節點規劃>一、節點規劃</h2><p>部署k8s集群的節點按照用途可以劃分為如下2類角色：</p><ul><li><strong>master</strong>：集群的master節點，集群的初始化節點，基礎配置不低於2C4G</li><li><strong>node</strong>：集群的node節點，可以多台，基礎配置不低於2C4G</li></ul><p><strong>K8S實體機網段: 192.168.1.0/24</strong></p><p><strong>POD網段: 10.244.0.0/16</strong></p><p><strong>SERVICE網段: 10.245.0.0/16</strong></p><div class=table-wrapper><table><thead><tr><th>主機名</th><th>節點ip</th><th>角色</th><th>部署組件</th></tr></thead><tbody><tr><td>k8s-master71u</td><td>192.168.1.71</td><td>master</td><td>etcd, kube-apiserver, kube-controller-manager, kubectl, kubeadm, kubelet, kube-proxy, calico</td></tr><tr><td>k8s-master72u</td><td>192.168.1.72</td><td>master</td><td>etcd, kube-apiserver, kube-controller-manager, kubectl, kubeadm, kubelet, kube-proxy, calico</td></tr><tr><td>k8s-master73u</td><td>192.168.1.73</td><td>master</td><td>etcd, kube-apiserver, kube-controller-manager, kubectl, kubeadm, kubelet, kube-proxy, calico</td></tr><tr><td></td><td><strong>192.168.1.74</strong></td><td>VIP</td><td>作為3台master節點的LB使用</td></tr><tr><td>k8s-node75u</td><td>k8s-node75u</td><td>node</td><td>kubectl, kubelet, kube-proxy, calico</td></tr><tr><td>k8s-node76u</td><td>k8s-node76u</td><td>node</td><td>kubectl, kubelet, kube-proxy, calico</td></tr></tbody></table></div><h2 id=二組件版本>二、組件版本</h2><div class=table-wrapper><table><thead><tr><th>組件</th><th>版本</th><th>說明</th></tr></thead><tbody><tr><td>Ubuntu</td><td>22.04.3 LTS</td><td></td></tr><tr><td>Kernel</td><td>5.15.0-83-generic</td><td></td></tr><tr><td>etcd</td><td>3.5.6-0</td><td>使用Pod方式部署，默認數據掛載到本地路徑</td></tr><tr><td>coredns</td><td>v1.9.3</td><td></td></tr><tr><td>kubeadm</td><td>v1.26.3</td><td></td></tr><tr><td>kubectl</td><td>v1.26.3</td><td></td></tr><tr><td>kubelet</td><td>v1.26.3</td><td></td></tr><tr><td>kube-proxy</td><td>v1.26.3</td><td></td></tr><tr><td>calico</td><td>v3.26.0</td><td></td></tr><tr><td>cri-dockerd</td><td>0.3.3.3-0</td><td></td></tr></tbody></table></div><h1 id=安裝前準備>安裝前準備</h1><h2 id=一設置hosts解析>一、設置hosts解析</h2><p>操作節點：所有節點（<code>k8s-master，k8s-node</code>）均需執行</p><ul><li><strong>添加hosts解析</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master71u:~# cat &gt;&gt;/etc/hosts<span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>192.168.1.71 k8s-master71u
</span></span></span><span class=line><span class=cl><span class=s>192.168.1.72 k8s-master72u
</span></span></span><span class=line><span class=cl><span class=s>192.168.1.73 k8s-master73u
</span></span></span><span class=line><span class=cl><span class=s>192.168.1.75 k8s-node75u
</span></span></span><span class=line><span class=cl><span class=s>192.168.1.76 k8s-node76u
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# cat /etc/hosts
</span></span><span class=line><span class=cl>127.0.0.1 localhost
</span></span><span class=line><span class=cl>127.0.1.1 k8s-master71u
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># The following lines are desirable for IPv6 capable hosts</span>
</span></span><span class=line><span class=cl>::1     ip6-localhost ip6-loopback
</span></span><span class=line><span class=cl>fe00::0 ip6-localnet
</span></span><span class=line><span class=cl>ff00::0 ip6-mcastprefix
</span></span><span class=line><span class=cl>ff02::1 ip6-allnodes
</span></span><span class=line><span class=cl>ff02::2 ip6-allrouters
</span></span><span class=line><span class=cl>192.168.1.71 k8s-master71u
</span></span><span class=line><span class=cl>192.168.1.72 k8s-master72u
</span></span><span class=line><span class=cl>192.168.1.73 k8s-master73u
</span></span><span class=line><span class=cl>192.168.1.75 k8s-node75u
</span></span><span class=line><span class=cl>192.168.1.76 k8s-node76u
</span></span></code></pre></div><h2 id=二調整系統配置>二、調整系統配置</h2><p>操作節點： 所有的master和node節點（<code>k8s-master,k8s-node</code>）需要執行</p><blockquote><p>本章下述操作均以k8s-master為例，其他節點均是相同的操作（ip和hostname的值換成對應機器的真實值）</p></blockquote><ul><li><strong>設置安全組開放端口</strong></li></ul><p>如果節點間無安全組限制（內網機器間可以任意訪問），可以忽略，否則，至少保證如下端口可通： k8s-master節點：TCP：6443，2379，2380，60080，60081UDP協議端口全部打開 k8s-node節點：UDP協議端口全部打開</p><ul><li><strong>關閉防火牆</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master71u:~# ufw status
</span></span><span class=line><span class=cl>Status: inactive
</span></span></code></pre></div><ul><li><strong>關閉swap</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master71u:~# swapoff -a <span class=o>&amp;&amp;</span> sysctl -w vm.swappiness<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>vm.swappiness <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# sed -i <span class=s1>&#39;s/.*swap.*/#&amp;/g&#39;</span> /etc/fstab
</span></span><span class=line><span class=cl><span class=c1>#/dev/disk/by-id/dm-uuid-LVM-kAtY9KpfwxzNTDEpBzFkOODzcZgK93hc3OfpHLBwOVbgBZUOZC21pLNScKzDP2aI none swap sw 0 0</span>
</span></span></code></pre></div><ul><li><strong>修改內核參數</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master71u:~# cat <span class=s>&lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
</span></span></span><span class=line><span class=cl><span class=s>overlay
</span></span></span><span class=line><span class=cl><span class=s>br_netfilter
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# systemctl restart systemd-modules-load.service
</span></span><span class=line><span class=cl>root@k8s-master71u:~# systemctl status systemd-modules-load.service
</span></span><span class=line><span class=cl>● systemd-modules-load.service - Load Kernel Modules
</span></span><span class=line><span class=cl>     Loaded: loaded <span class=o>(</span>/lib/systemd/system/systemd-modules-load.service<span class=p>;</span> static<span class=o>)</span>
</span></span><span class=line><span class=cl>     Active: active <span class=o>(</span>exited<span class=o>)</span> since Wed 2023-09-20 00:23:11 UTC<span class=p>;</span> 6s ago
</span></span><span class=line><span class=cl>       Docs: man:systemd-modules-load.service<span class=o>(</span>8<span class=o>)</span>
</span></span><span class=line><span class=cl>             man:modules-load.d<span class=o>(</span>5<span class=o>)</span>
</span></span><span class=line><span class=cl>    Process: <span class=m>2322</span> <span class=nv>ExecStart</span><span class=o>=</span>/lib/systemd/systemd-modules-load <span class=o>(</span><span class=nv>code</span><span class=o>=</span>exited, <span class=nv>status</span><span class=o>=</span>0/SUCCESS<span class=o>)</span>
</span></span><span class=line><span class=cl>   Main PID: <span class=m>2322</span> <span class=o>(</span><span class=nv>code</span><span class=o>=</span>exited, <span class=nv>status</span><span class=o>=</span>0/SUCCESS<span class=o>)</span>
</span></span><span class=line><span class=cl>        CPU: 39ms
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Sep <span class=m>20</span> 00:23:11 k8s-master71u systemd<span class=o>[</span>1<span class=o>]</span>: Starting Load Kernel Modules...
</span></span><span class=line><span class=cl>Sep <span class=m>20</span> 00:23:11 k8s-master71u systemd-modules-load<span class=o>[</span>2322<span class=o>]</span>: Inserted module <span class=s1>&#39;overlay&#39;</span>
</span></span><span class=line><span class=cl>Sep <span class=m>20</span> 00:23:11 k8s-master71u systemd-modules-load<span class=o>[</span>2322<span class=o>]</span>: Inserted module <span class=s1>&#39;br_netfilter&#39;</span>
</span></span><span class=line><span class=cl>Sep <span class=m>20</span> 00:23:11 k8s-master71u systemd<span class=o>[</span>1<span class=o>]</span>: Finished Load Kernel Modules.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# lsmod <span class=p>|</span>grep -e overlay
</span></span><span class=line><span class=cl>overlay               <span class=m>151552</span>  <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# lsmod <span class=p>|</span>grep -e br_netfilter
</span></span><span class=line><span class=cl>br_netfilter           <span class=m>32768</span>  <span class=m>0</span>
</span></span><span class=line><span class=cl>bridge                <span class=m>307200</span>  <span class=m>1</span> br_netfilter
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master71u:~# cat <span class=s>&lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf
</span></span></span><span class=line><span class=cl><span class=s>vm.max_map_count=262144
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.ip_forward = 1
</span></span></span><span class=line><span class=cl><span class=s>net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span class=line><span class=cl><span class=s>net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span class=line><span class=cl><span class=s>vm.overcommit_memory=1
</span></span></span><span class=line><span class=cl><span class=s>vm.panic_on_oom=0
</span></span></span><span class=line><span class=cl><span class=s>fs.inotify.max_user_watches=89100
</span></span></span><span class=line><span class=cl><span class=s>fs.file-max=52706963
</span></span></span><span class=line><span class=cl><span class=s>fs.nr_open=52706963
</span></span></span><span class=line><span class=cl><span class=s>net.netfilter.nf_conntrack_max=2310720
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_keepalive_time = 600
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_keepalive_probes = 3
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_keepalive_intvl =15
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_max_tw_buckets = 36000
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_tw_reuse = 1
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_max_orphans = 327680
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_orphan_retries = 3
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_syncookies = 1
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_max_syn_backlog = 16384
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_max_syn_backlog = 16384
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_timestamps = 0
</span></span></span><span class=line><span class=cl><span class=s>net.core.somaxconn = 16384
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# sysctl -p /etc/sysctl.d/k8s.conf
</span></span><span class=line><span class=cl>vm.max_map_count <span class=o>=</span> <span class=m>262144</span>
</span></span><span class=line><span class=cl>net.ipv4.ip_forward <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>net.bridge.bridge-nf-call-iptables <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>net.bridge.bridge-nf-call-ip6tables <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>vm.overcommit_memory <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>vm.panic_on_oom <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>fs.inotify.max_user_watches <span class=o>=</span> <span class=m>89100</span>
</span></span><span class=line><span class=cl>fs.file-max <span class=o>=</span> <span class=m>52706963</span>
</span></span><span class=line><span class=cl>fs.nr_open <span class=o>=</span> <span class=m>52706963</span>
</span></span><span class=line><span class=cl>sysctl: cannot stat /proc/sys/net/netfilter/nf_conntrack_max: No such file or directory
</span></span><span class=line><span class=cl>net.ipv4.tcp_keepalive_time <span class=o>=</span> <span class=m>600</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_keepalive_probes <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_keepalive_intvl <span class=o>=</span> <span class=m>15</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_max_tw_buckets <span class=o>=</span> <span class=m>36000</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_tw_reuse <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_max_orphans <span class=o>=</span> <span class=m>327680</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_orphan_retries <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_syncookies <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_max_syn_backlog <span class=o>=</span> <span class=m>16384</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_max_syn_backlog <span class=o>=</span> <span class=m>16384</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_timestamps <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>net.core.somaxconn <span class=o>=</span> <span class=m>16384</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 報錯</span>
</span></span><span class=line><span class=cl>sysctl: cannot stat /proc/sys/net/netfilter/nf_conntrack_max: 沒有此一檔案或目錄
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 解決方式</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# modprobe ip_conntrack
</span></span><span class=line><span class=cl>root@k8s-master71u:~# sysctl -p /etc/sysctl.d/k8s.conf
</span></span><span class=line><span class=cl>vm.max_map_count <span class=o>=</span> <span class=m>262144</span>
</span></span><span class=line><span class=cl>net.ipv4.ip_forward <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>net.bridge.bridge-nf-call-iptables <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>net.bridge.bridge-nf-call-ip6tables <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>vm.overcommit_memory <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>vm.panic_on_oom <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>fs.inotify.max_user_watches <span class=o>=</span> <span class=m>89100</span>
</span></span><span class=line><span class=cl>fs.file-max <span class=o>=</span> <span class=m>52706963</span>
</span></span><span class=line><span class=cl>fs.nr_open <span class=o>=</span> <span class=m>52706963</span>
</span></span><span class=line><span class=cl>net.netfilter.nf_conntrack_max <span class=o>=</span> <span class=m>2310720</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_keepalive_time <span class=o>=</span> <span class=m>600</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_keepalive_probes <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_keepalive_intvl <span class=o>=</span> <span class=m>15</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_max_tw_buckets <span class=o>=</span> <span class=m>36000</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_tw_reuse <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_max_orphans <span class=o>=</span> <span class=m>327680</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_orphan_retries <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_syncookies <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_max_syn_backlog <span class=o>=</span> <span class=m>16384</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_max_syn_backlog <span class=o>=</span> <span class=m>16384</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_timestamps <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>net.core.somaxconn <span class=o>=</span> <span class=m>16384</span>
</span></span></code></pre></div><ul><li><strong>添加ipvs，安裝套件</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master71u:~# apt -y install ipvsadm ipset sysstat conntrack libseccomp2 libseccomp-dev
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# cat &gt; /etc/modules-load.d/ipvs.conf <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>ip_vs
</span></span></span><span class=line><span class=cl><span class=s>ip_vs_lc
</span></span></span><span class=line><span class=cl><span class=s>ip_vs_wlc
</span></span></span><span class=line><span class=cl><span class=s>ip_vs_rr
</span></span></span><span class=line><span class=cl><span class=s>ip_vs_wrr
</span></span></span><span class=line><span class=cl><span class=s>ip_vs_lblc
</span></span></span><span class=line><span class=cl><span class=s>ip_vs_lblcr
</span></span></span><span class=line><span class=cl><span class=s>ip_vs_dh
</span></span></span><span class=line><span class=cl><span class=s>ip_vs_sh
</span></span></span><span class=line><span class=cl><span class=s>ip_vs_fo
</span></span></span><span class=line><span class=cl><span class=s>ip_vs_nq
</span></span></span><span class=line><span class=cl><span class=s>ip_vs_sed
</span></span></span><span class=line><span class=cl><span class=s>ip_vs_ftp
</span></span></span><span class=line><span class=cl><span class=s>nf_conntrack
</span></span></span><span class=line><span class=cl><span class=s>ip_tables
</span></span></span><span class=line><span class=cl><span class=s>ip_set
</span></span></span><span class=line><span class=cl><span class=s>xt_set
</span></span></span><span class=line><span class=cl><span class=s>ipt_set
</span></span></span><span class=line><span class=cl><span class=s>ipt_rpfilter
</span></span></span><span class=line><span class=cl><span class=s>ipt_REJECT
</span></span></span><span class=line><span class=cl><span class=s>ipip
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# systemctl restart systemd-modules-load.service
</span></span><span class=line><span class=cl>root@k8s-master71u:~# systemctl status systemd-modules-load.service
</span></span><span class=line><span class=cl>● systemd-modules-load.service - Load Kernel Modules
</span></span><span class=line><span class=cl>     Loaded: loaded <span class=o>(</span>/lib/systemd/system/systemd-modules-load.service<span class=p>;</span> static<span class=o>)</span>
</span></span><span class=line><span class=cl>     Active: active <span class=o>(</span>exited<span class=o>)</span> since Wed 2023-09-20 00:28:06 UTC<span class=p>;</span> 7s ago
</span></span><span class=line><span class=cl>       Docs: man:systemd-modules-load.service<span class=o>(</span>8<span class=o>)</span>
</span></span><span class=line><span class=cl>             man:modules-load.d<span class=o>(</span>5<span class=o>)</span>
</span></span><span class=line><span class=cl>    Process: <span class=m>3116</span> <span class=nv>ExecStart</span><span class=o>=</span>/lib/systemd/systemd-modules-load <span class=o>(</span><span class=nv>code</span><span class=o>=</span>exited, <span class=nv>status</span><span class=o>=</span>0/SUCCESS<span class=o>)</span>
</span></span><span class=line><span class=cl>   Main PID: <span class=m>3116</span> <span class=o>(</span><span class=nv>code</span><span class=o>=</span>exited, <span class=nv>status</span><span class=o>=</span>0/SUCCESS<span class=o>)</span>
</span></span><span class=line><span class=cl>        CPU: 76ms
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Sep <span class=m>20</span> 00:28:06 k8s-master71u systemd-modules-load<span class=o>[</span>3116<span class=o>]</span>: Inserted module <span class=s1>&#39;ip_vs_fo&#39;</span>
</span></span><span class=line><span class=cl>Sep <span class=m>20</span> 00:28:06 k8s-master71u systemd-modules-load<span class=o>[</span>3116<span class=o>]</span>: Inserted module <span class=s1>&#39;ip_vs_nq&#39;</span>
</span></span><span class=line><span class=cl>Sep <span class=m>20</span> 00:28:06 k8s-master71u systemd-modules-load<span class=o>[</span>3116<span class=o>]</span>: Inserted module <span class=s1>&#39;ip_vs_sed&#39;</span>
</span></span><span class=line><span class=cl>Sep <span class=m>20</span> 00:28:06 k8s-master71u systemd-modules-load<span class=o>[</span>3116<span class=o>]</span>: Inserted module <span class=s1>&#39;ip_vs_ftp&#39;</span>
</span></span><span class=line><span class=cl>Sep <span class=m>20</span> 00:28:06 k8s-master71u systemd-modules-load<span class=o>[</span>3116<span class=o>]</span>: Inserted module <span class=s1>&#39;ip_set&#39;</span>
</span></span><span class=line><span class=cl>Sep <span class=m>20</span> 00:28:06 k8s-master71u systemd-modules-load<span class=o>[</span>3116<span class=o>]</span>: Inserted module <span class=s1>&#39;xt_set&#39;</span>
</span></span><span class=line><span class=cl>Sep <span class=m>20</span> 00:28:06 k8s-master71u systemd-modules-load<span class=o>[</span>3116<span class=o>]</span>: Inserted module <span class=s1>&#39;ipt_rpfilter&#39;</span>
</span></span><span class=line><span class=cl>Sep <span class=m>20</span> 00:28:06 k8s-master71u systemd-modules-load<span class=o>[</span>3116<span class=o>]</span>: Inserted module <span class=s1>&#39;ipt_REJECT&#39;</span>
</span></span><span class=line><span class=cl>Sep <span class=m>20</span> 00:28:06 k8s-master71u systemd-modules-load<span class=o>[</span>3116<span class=o>]</span>: Inserted module <span class=s1>&#39;ipip&#39;</span>
</span></span><span class=line><span class=cl>Sep <span class=m>20</span> 00:28:06 k8s-master71u systemd<span class=o>[</span>1<span class=o>]</span>: Finished Load Kernel Modules.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# lsmod <span class=p>|</span>grep -e ip_vs -e nf_conntrack_ipv4
</span></span><span class=line><span class=cl>ip_vs_ftp              <span class=m>16384</span>  <span class=m>0</span>
</span></span><span class=line><span class=cl>nf_nat                 <span class=m>49152</span>  <span class=m>1</span> ip_vs_ftp
</span></span><span class=line><span class=cl>ip_vs_sed              <span class=m>16384</span>  <span class=m>0</span>
</span></span><span class=line><span class=cl>ip_vs_nq               <span class=m>16384</span>  <span class=m>0</span>
</span></span><span class=line><span class=cl>ip_vs_fo               <span class=m>16384</span>  <span class=m>0</span>
</span></span><span class=line><span class=cl>ip_vs_sh               <span class=m>16384</span>  <span class=m>0</span>
</span></span><span class=line><span class=cl>ip_vs_dh               <span class=m>16384</span>  <span class=m>0</span>
</span></span><span class=line><span class=cl>ip_vs_lblcr            <span class=m>16384</span>  <span class=m>0</span>
</span></span><span class=line><span class=cl>ip_vs_lblc             <span class=m>16384</span>  <span class=m>0</span>
</span></span><span class=line><span class=cl>ip_vs_wrr              <span class=m>16384</span>  <span class=m>0</span>
</span></span><span class=line><span class=cl>ip_vs_rr               <span class=m>16384</span>  <span class=m>0</span>
</span></span><span class=line><span class=cl>ip_vs_wlc              <span class=m>16384</span>  <span class=m>0</span>
</span></span><span class=line><span class=cl>ip_vs_lc               <span class=m>16384</span>  <span class=m>0</span>
</span></span><span class=line><span class=cl>ip_vs                 <span class=m>176128</span>  <span class=m>24</span> ip_vs_wlc,ip_vs_rr,ip_vs_dh,ip_vs_lblcr,ip_vs_sh,ip_vs_fo,ip_vs_nq,ip_vs_lblc,ip_vs_wrr,ip_vs_lc,ip_vs_sed,ip_vs_ftp
</span></span><span class=line><span class=cl>nf_conntrack          <span class=m>172032</span>  <span class=m>2</span> nf_nat,ip_vs
</span></span><span class=line><span class=cl>nf_defrag_ipv6         <span class=m>24576</span>  <span class=m>2</span> nf_conntrack,ip_vs
</span></span><span class=line><span class=cl>libcrc32c              <span class=m>16384</span>  <span class=m>7</span> nf_conntrack,nf_nat,btrfs,nf_tables,xfs,raid456,ip_vs
</span></span></code></pre></div><h2 id=三安裝docker>三、安裝docker</h2><p>所有的master和node節點（<code>k8s-master,k8s-node</code>）需要執行</p><p><a class=link href=https://docs.docker.com/engine/install/ubuntu/ target=_blank rel=noopener>https://docs.docker.com/engine/install/ubuntu/</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. Update the apt package index and install packages to allow apt to use a repository over HTTPS:</span>
</span></span><span class=line><span class=cl>sudo apt-get update
</span></span><span class=line><span class=cl>sudo apt-get install ca-certificates curl gnupg
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1># 2. Add Docker’s official GPG key:</span>
</span></span><span class=line><span class=cl>sudo install -m <span class=m>0755</span> -d /etc/apt/keyrings
</span></span><span class=line><span class=cl>curl -fsSL https://download.docker.com/linux/ubuntu/gpg <span class=p>|</span> sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
</span></span><span class=line><span class=cl>sudo chmod a+r /etc/apt/keyrings/docker.gpg
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1># 3. Use the following command to set up the repository:</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=s2>&#34;deb [arch=&#34;</span><span class=k>$(</span>dpkg --print-architecture<span class=k>)</span><span class=s2>&#34; signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
</span></span></span><span class=line><span class=cl><span class=s2>  &#34;</span><span class=k>$(</span>. /etc/os-release <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$VERSION_CODENAME</span><span class=s2>&#34;</span><span class=k>)</span><span class=s2>&#34; stable&#34;</span> <span class=p>|</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 檢查是否已經添加源</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# cat /etc/apt/sources.list.d/docker.list
</span></span><span class=line><span class=cl>deb <span class=o>[</span><span class=nv>arch</span><span class=o>=</span>amd64 signed-by<span class=o>=</span>/etc/apt/keyrings/docker.gpg<span class=o>]</span> https://download.docker.com/linux/ubuntu   jammy stable
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. Update the apt package index</span>
</span></span><span class=line><span class=cl>sudo apt-get update
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看所有的可用版本</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# apt-cache madison docker-ce <span class=p>|</span> awk <span class=s1>&#39;{ print $3 }&#39;</span>
</span></span><span class=line><span class=cl>5:24.0.6-1~ubuntu.22.04~jammy
</span></span><span class=line><span class=cl>5:24.0.5-1~ubuntu.22.04~jammy
</span></span><span class=line><span class=cl>5:24.0.4-1~ubuntu.22.04~jammy
</span></span><span class=line><span class=cl>5:24.0.3-1~ubuntu.22.04~jammy
</span></span><span class=line><span class=cl>5:24.0.2-1~ubuntu.22.04~jammy
</span></span><span class=line><span class=cl>5:24.0.1-1~ubuntu.22.04~jammy
</span></span><span class=line><span class=cl>5:24.0.0-1~ubuntu.22.04~jammy
</span></span><span class=line><span class=cl>5:23.0.6-1~ubuntu.22.04~jammy
</span></span><span class=line><span class=cl>5:23.0.5-1~ubuntu.22.04~jammy
</span></span><span class=line><span class=cl>5:23.0.4-1~ubuntu.22.04~jammy
</span></span><span class=line><span class=cl>5:23.0.3-1~ubuntu.22.04~jammy
</span></span><span class=line><span class=cl>5:23.0.2-1~ubuntu.22.04~jammy
</span></span><span class=line><span class=cl>5:23.0.1-1~ubuntu.22.04~jammy
</span></span><span class=line><span class=cl>5:23.0.0-1~ubuntu.22.04~jammy
</span></span><span class=line><span class=cl>5:20.10.24~3-0~ubuntu-jammy
</span></span><span class=line><span class=cl>5:20.10.23~3-0~ubuntu-jammy
</span></span><span class=line><span class=cl>5:20.10.22~3-0~ubuntu-jammy
</span></span><span class=line><span class=cl>5:20.10.21~3-0~ubuntu-jammy
</span></span><span class=line><span class=cl>5:20.10.20~3-0~ubuntu-jammy
</span></span><span class=line><span class=cl>5:20.10.19~3-0~ubuntu-jammy
</span></span><span class=line><span class=cl>5:20.10.18~3-0~ubuntu-jammy
</span></span><span class=line><span class=cl>5:20.10.17~3-0~ubuntu-jammy
</span></span><span class=line><span class=cl>5:20.10.16~3-0~ubuntu-jammy
</span></span><span class=line><span class=cl>5:20.10.15~3-0~ubuntu-jammy
</span></span><span class=line><span class=cl>5:20.10.14~3-0~ubuntu-jammy
</span></span><span class=line><span class=cl>5:20.10.13~3-0~ubuntu-jammy
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 指定版本，安裝docker-ce</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# <span class=nv>VERSION_STRING</span><span class=o>=</span>5:20.10.13~3-0~ubuntu-jammy
</span></span><span class=line><span class=cl>root@k8s-master71u:~# sudo apt-get install docker-ce<span class=o>=</span><span class=nv>$VERSION_STRING</span> docker-ce-cli<span class=o>=</span><span class=nv>$VERSION_STRING</span> containerd.io
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## 配置docker使用cgroupdriver=systemd</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# mkdir -p /etc/docker
</span></span><span class=line><span class=cl>root@k8s-master71u:~# vim /etc/docker/daemon.json
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;exec-opts&#34;</span>: <span class=o>[</span><span class=s2>&#34;native.cgroupdriver=systemd&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# systemctl daemon-reload
</span></span><span class=line><span class=cl>root@k8s-master71u:~# systemctl restart docker
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 啟動docker</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# systemctl <span class=nb>enable</span> docker <span class=o>&amp;&amp;</span> systemctl start docker
</span></span><span class=line><span class=cl>root@k8s-master71u:~# systemctl status docker
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 測試起一個容器</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# sudo docker run hello-world
</span></span><span class=line><span class=cl>Unable to find image <span class=s1>&#39;hello-world:latest&#39;</span> locally
</span></span><span class=line><span class=cl>latest: Pulling from library/hello-world
</span></span><span class=line><span class=cl>719385e32844: Pull <span class=nb>complete</span> 
</span></span><span class=line><span class=cl>Digest: sha256:4f53e2564790c8e7856ec08e384732aa38dc43c52f02952483e3f003afbf23db
</span></span><span class=line><span class=cl>Status: Downloaded newer image <span class=k>for</span> hello-world:latest
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Hello from Docker!
</span></span></code></pre></div><h2 id=四安裝cri-docker>四、安裝cri-docker</h2><p>所有的master和node節點（<code>k8s-master,k8s-node</code>）需要執行</p><p><a class=link href=https://github.com/Mirantis/cri-dockerd target=_blank rel=noopener>https://github.com/Mirantis/cri-dockerd</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master71u:~# wget https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.3/cri-dockerd_0.3.3.3-0.ubuntu-jammy_amd64.deb
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# sudo dpkg -i cri-dockerd_0.3.3.3-0.ubuntu-jammy_amd64.deb 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# systemctl daemon-reload 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# systemctl <span class=nb>enable</span> cri-docker <span class=o>&amp;&amp;</span> systemctl start cri-docker <span class=o>&amp;&amp;</span> systemctl status cri-docker
</span></span><span class=line><span class=cl>● cri-docker.service - CRI Interface <span class=k>for</span> Docker Application Container Engine
</span></span><span class=line><span class=cl>     Loaded: loaded <span class=o>(</span>/lib/systemd/system/cri-docker.service<span class=p>;</span> enabled<span class=p>;</span> vendor preset: enabled<span class=o>)</span>
</span></span><span class=line><span class=cl>     Active: active <span class=o>(</span>running<span class=o>)</span> since Wed 2023-09-20 00:44:58 UTC<span class=p>;</span> 25s ago
</span></span><span class=line><span class=cl>TriggeredBy: ● cri-docker.socket
</span></span><span class=line><span class=cl>       Docs: https://docs.mirantis.com
</span></span><span class=line><span class=cl>   Main PID: <span class=m>5055</span> <span class=o>(</span>cri-dockerd<span class=o>)</span>
</span></span><span class=line><span class=cl>      Tasks: <span class=m>10</span>
</span></span><span class=line><span class=cl>     Memory: 9.8M
</span></span><span class=line><span class=cl>        CPU: 83ms
</span></span><span class=line><span class=cl>     CGroup: /system.slice/cri-docker.service
</span></span><span class=line><span class=cl>             └─5055 /usr/bin/cri-dockerd --container-runtime-endpoint fd://
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Sep <span class=m>20</span> 00:44:58 k8s-master71u cri-dockerd<span class=o>[</span>5055<span class=o>]</span>: <span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2023-09-20T00:44:58Z&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Start docker client with reque&gt;
</span></span></span><span class=line><span class=cl><span class=s2>Sep 20 00:44:58 k8s-master71u cri-dockerd[5055]: time=&#34;</span>2023-09-20T00:44:58Z<span class=s2>&#34; level=info msg=&#34;</span>Hairpin mode is <span class=nb>set</span> to none<span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>Sep 20 00:44:58 k8s-master71u cri-dockerd[5055]: time=&#34;</span>2023-09-20T00:44:58Z<span class=s2>&#34; level=info msg=&#34;</span>Loaded network plugin cni<span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>Sep 20 00:44:58 k8s-master71u cri-dockerd[5055]: time=&#34;</span>2023-09-20T00:44:58Z<span class=s2>&#34; level=info msg=&#34;</span>Docker cri networking managed &gt;
</span></span><span class=line><span class=cl>Sep <span class=m>20</span> 00:44:58 k8s-master71u cri-dockerd<span class=o>[</span>5055<span class=o>]</span>: <span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2023-09-20T00:44:58Z&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Docker Info: &amp;{ID:ZVOJ:5V6C:QO&gt;
</span></span></span><span class=line><span class=cl><span class=s2>Sep 20 00:44:58 k8s-master71u cri-dockerd[5055]: time=&#34;</span>2023-09-20T00:44:58Z<span class=s2>&#34; level=info msg=&#34;</span>Setting cgroupDriver systemd<span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>Sep 20 00:44:58 k8s-master71u cri-dockerd[5055]: time=&#34;</span>2023-09-20T00:44:58Z<span class=s2>&#34; level=info msg=&#34;</span>Docker cri received runtime co&gt;
</span></span><span class=line><span class=cl>Sep <span class=m>20</span> 00:44:58 k8s-master71u cri-dockerd<span class=o>[</span>5055<span class=o>]</span>: <span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2023-09-20T00:44:58Z&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Starting the GRPC backend for &gt;
</span></span></span><span class=line><span class=cl><span class=s2>Sep 20 00:44:58 k8s-master71u cri-dockerd[5055]: time=&#34;</span>2023-09-20T00:44:58Z<span class=s2>&#34; level=info msg=&#34;</span>Start cri-dockerd grpc backend<span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>Sep 20 00:44:58 k8s-master71u systemd[1]: Started CRI Interface for Docker Application Container Engine.
</span></span></span></code></pre></div><h1 id=初始化集群>初始化集群</h1><h2 id=一安裝kubeadmkubeletkubectl>一、安裝kubeadm、kubelet、kubectl</h2><p>操作節點： 所有的master和node節點(<code>k8s-master,k8s-node</code>) 需要執行</p><p><a class=link href=https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/ target=_blank rel=noopener>https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. Update the apt package index and install packages needed to use the Kubernetes apt repository:</span>
</span></span><span class=line><span class=cl>sudo apt-get update
</span></span><span class=line><span class=cl>sudo apt-get install -y apt-transport-https ca-certificates curl
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. Download the Google Cloud public signing key:</span>
</span></span><span class=line><span class=cl>curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg <span class=p>|</span> sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-archive-keyring.gpg
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. Add the Kubernetes apt repository:</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&#34;</span> <span class=p>|</span> sudo tee /etc/apt/sources.list.d/kubernetes.list
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 檢查是否已經添加源 </span>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# cat /etc/apt/sources.list.d/kubernetes.list
</span></span><span class=line><span class=cl>deb <span class=o>[</span>signed-by<span class=o>=</span>/etc/apt/keyrings/kubernetes-archive-keyring.gpg<span class=o>]</span> https://apt.kubernetes.io/ kubernetes-xenial main
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. Update apt package index, install kubelet, kubeadm and kubectl, and pin their version:</span>
</span></span><span class=line><span class=cl>sudo apt-get update
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master71u:~# sudo apt-get install -y <span class=nv>kubelet</span><span class=o>=</span>1.26.3-00 <span class=nv>kubeadm</span><span class=o>=</span>1.26.3-00 <span class=nv>kubectl</span><span class=o>=</span>1.26.3-00
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 查看kubeadm 版本</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# kubeadm version
</span></span><span class=line><span class=cl>kubeadm version: <span class=p>&amp;</span>version.Info<span class=o>{</span>Major:<span class=s2>&#34;1&#34;</span>, Minor:<span class=s2>&#34;26&#34;</span>, GitVersion:<span class=s2>&#34;v1.26.3&#34;</span>, GitCommit:<span class=s2>&#34;9e644106593f3f4aa98f8a84b23db5fa378900bd&#34;</span>, GitTreeState:<span class=s2>&#34;clean&#34;</span>, BuildDate:<span class=s2>&#34;2023-03-15T13:38:47Z&#34;</span>, GoVersion:<span class=s2>&#34;go1.19.7&#34;</span>, Compiler:<span class=s2>&#34;gc&#34;</span>, Platform:<span class=s2>&#34;linux/amd64&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 設置kubelet開機啟動，並使用ipvs與systemd</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# vim /etc/default/kubelet
</span></span><span class=line><span class=cl><span class=nv>KUBE_PROXY_MODE</span><span class=o>=</span><span class=s2>&#34;ipvs&#34;</span> <span class=nv>KUBELET_EXTRA_ARGS</span><span class=o>=</span><span class=s2>&#34;--cgroup-driver=systemd --pod-infra-container-image=registry.k8s.io/pause:3.6&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# systemctl <span class=nb>enable</span> --now kubelet
</span></span></code></pre></div><h2 id=二安裝配置haproxykeepalived>二、安裝配置haproxy、keepalived</h2><p><font color=red>操作節點： 所有的master</font></p><p>注意：如果有兩個集群，都在同一網段內，/etc/keepalived/keepalived.conf裡面的virtual_router_id 60記得要不一樣，不然/var/log/message會一直報錯。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master71u:~# apt-get install keepalived haproxy -y
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 所有master節點執行,注意替換最後的master節點IP地址</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# vim /etc/haproxy/haproxy.cfg 
</span></span><span class=line><span class=cl>global
</span></span><span class=line><span class=cl>  maxconn  <span class=m>2000</span>
</span></span><span class=line><span class=cl>  ulimit-n  <span class=m>16384</span>
</span></span><span class=line><span class=cl>  log  127.0.0.1 local0 err
</span></span><span class=line><span class=cl>  stats timeout 30s
</span></span><span class=line><span class=cl>defaults
</span></span><span class=line><span class=cl>  log global
</span></span><span class=line><span class=cl>  mode  http
</span></span><span class=line><span class=cl>  option  httplog
</span></span><span class=line><span class=cl>  timeout connect <span class=m>5000</span>
</span></span><span class=line><span class=cl>  timeout client  <span class=m>50000</span>
</span></span><span class=line><span class=cl>  timeout server  <span class=m>50000</span>
</span></span><span class=line><span class=cl>  timeout http-request 15s
</span></span><span class=line><span class=cl>  timeout http-keep-alive 15s
</span></span><span class=line><span class=cl>frontend monitor-in
</span></span><span class=line><span class=cl>  <span class=nb>bind</span> *:33305
</span></span><span class=line><span class=cl>  mode http
</span></span><span class=line><span class=cl>  option httplog
</span></span><span class=line><span class=cl>  monitor-uri /monitor
</span></span><span class=line><span class=cl>frontend k8s-master
</span></span><span class=line><span class=cl>  <span class=nb>bind</span> 0.0.0.0:7443
</span></span><span class=line><span class=cl>  <span class=nb>bind</span> 127.0.0.1:7443
</span></span><span class=line><span class=cl>  mode tcp
</span></span><span class=line><span class=cl>  option tcplog
</span></span><span class=line><span class=cl>  tcp-request inspect-delay 5s
</span></span><span class=line><span class=cl>  default_backend k8s-master
</span></span><span class=line><span class=cl>backend k8s-master
</span></span><span class=line><span class=cl>  mode tcp
</span></span><span class=line><span class=cl>  option tcplog
</span></span><span class=line><span class=cl>  option tcp-check
</span></span><span class=line><span class=cl>  balance roundrobin
</span></span><span class=line><span class=cl>  default-server inter 10s downinter 5s rise <span class=m>2</span> fall <span class=m>2</span> slowstart 60s maxconn <span class=m>250</span> maxqueue <span class=m>256</span> weight <span class=m>100</span>
</span></span><span class=line><span class=cl>  server k8s-master71u    192.168.1.71:6443   check
</span></span><span class=line><span class=cl>  server k8s-master72u    192.168.1.72:6443   check
</span></span><span class=line><span class=cl>  server k8s-master73u    192.168.1.73:6443   check 
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在k8s-master71u節點，注意mcast_src_ip換成實際的master1ip地址，virtual_ipaddress換成lb地址，interface要替換成主機IP使用的介面</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# vim /etc/keepalived/keepalived.conf
</span></span><span class=line><span class=cl>! Configuration File <span class=k>for</span> keepalived
</span></span><span class=line><span class=cl>global_defs <span class=o>{</span>
</span></span><span class=line><span class=cl>    router_id LVS_DEVEL
</span></span><span class=line><span class=cl>script_user root
</span></span><span class=line><span class=cl>    enable_script_security
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>vrrp_script chk_apiserver <span class=o>{</span>
</span></span><span class=line><span class=cl>    script <span class=s2>&#34;/etc/keepalived/check_apiserver.sh&#34;</span>
</span></span><span class=line><span class=cl>    interval <span class=m>5</span>
</span></span><span class=line><span class=cl>    weight -5
</span></span><span class=line><span class=cl>    fall <span class=m>2</span>
</span></span><span class=line><span class=cl>    rise <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>vrrp_instance VI_1 <span class=o>{</span>
</span></span><span class=line><span class=cl>    state MASTER
</span></span><span class=line><span class=cl>    interface ens160
</span></span><span class=line><span class=cl>    mcast_src_ip 192.168.1.71
</span></span><span class=line><span class=cl>    virtual_router_id <span class=m>60</span>
</span></span><span class=line><span class=cl>    priority <span class=m>101</span>
</span></span><span class=line><span class=cl>    advert_int <span class=m>2</span>
</span></span><span class=line><span class=cl>    authentication <span class=o>{</span>
</span></span><span class=line><span class=cl>        auth_type PASS
</span></span><span class=line><span class=cl>        auth_pass K8SHA_KA_AUTH
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    virtual_ipaddress <span class=o>{</span>
</span></span><span class=line><span class=cl>        192.168.1.74
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    track_script <span class=o>{</span>
</span></span><span class=line><span class=cl>       chk_apiserver
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=c1># 在k8s-master52u和k8s-master53u分別創建/etc/keepalived/keepalived.conf，注意修改mcast_src_ip和virtual_ipaddress</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#所有master節點配置KeepAlived健康檢查文件：</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# vim /etc/keepalived/check_apiserver.sh
</span></span><span class=line><span class=cl><span class=c1>#!/bin/bash</span>
</span></span><span class=line><span class=cl><span class=nv>err</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=k>for</span> k in <span class=k>$(</span>seq <span class=m>1</span> 3<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nv>check_code</span><span class=o>=</span><span class=k>$(</span>pgrep haproxy<span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[[</span> <span class=nv>$check_code</span> <span class=o>==</span> <span class=s2>&#34;&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nv>err</span><span class=o>=</span><span class=k>$(</span>expr <span class=nv>$err</span> + 1<span class=k>)</span>
</span></span><span class=line><span class=cl>        sleep <span class=m>1</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nv>err</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>        <span class=nb>break</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[[</span> <span class=nv>$err</span> !<span class=o>=</span> <span class=s2>&#34;0&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;systemctl stop keepalived&#34;</span>
</span></span><span class=line><span class=cl>    /usr/bin/systemctl stop keepalived
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 啟動haproxy和keepalived----&gt;所有master節點</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# chmod +x /etc/keepalived/check_apiserver.sh
</span></span><span class=line><span class=cl>root@k8s-master71u:~# systemctl daemon-reload
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# systemctl <span class=nb>enable</span> --now haproxy
</span></span><span class=line><span class=cl>root@k8s-master71u:~# systemctl <span class=nb>enable</span> --now keepalived 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# systemctl restart haproxy
</span></span><span class=line><span class=cl>root@k8s-master71u:~# systemctl restart keepalived 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# systemctl status haproxy
</span></span><span class=line><span class=cl>root@k8s-master71u:~# systemctl status keepalived 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 測試lbip是否生效(從node節點測試的)</span>
</span></span><span class=line><span class=cl>root@k8s-node76u:~# telnet 192.168.1.74 <span class=m>7443</span>
</span></span><span class=line><span class=cl>Trying 192.168.1.74...
</span></span><span class=line><span class=cl>Connected to 192.168.1.74.
</span></span><span class=line><span class=cl>Escape character is <span class=s1>&#39;^]&#39;</span>.
</span></span><span class=line><span class=cl>Connection closed by foreign host.
</span></span></code></pre></div><h2 id=三初始化配置文件>三、初始化配置文件</h2><p>操作節點： 只在master節點（<code>k8s-master</code>）執行</p><p><a class=link href=https://kubernetes.io/docs/reference/config-api/kubeadm-config.v1beta3/ target=_blank rel=noopener>https://kubernetes.io/docs/reference/config-api/kubeadm-config.v1beta3/</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1.24.0版本之後，需修改為criSocket: unix:///var/run/cri-dockerd.sock</span>
</span></span><span class=line><span class=cl><span class=c1># 1.27.x版本之後，需修改為apiVersion: kubeadm.k8s.io/v1beta3，v1beta2不能用了</span>
</span></span><span class=line><span class=cl><span class=c1># imageRepository: k8s.gcr.io已不更新，改imageRepository: registry.k8s.io</span>
</span></span><span class=line><span class=cl><span class=c1># clusterName: kubernetes -&gt;依自己需求修改</span>
</span></span><span class=line><span class=cl><span class=c1># dns: type: CoreDNS 已棄用，不用寫</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# vim kubeadm.yaml 
</span></span><span class=line><span class=cl>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span class=line><span class=cl>bootstrapTokens:
</span></span><span class=line><span class=cl>- groups:
</span></span><span class=line><span class=cl>  - system:bootstrappers:kubeadm:default-node-token
</span></span><span class=line><span class=cl>  token: 7t2weq.bjbawausm0jaxury
</span></span><span class=line><span class=cl>  ttl: 24h0m0s
</span></span><span class=line><span class=cl>  usages:
</span></span><span class=line><span class=cl>  - signing
</span></span><span class=line><span class=cl>  - authentication
</span></span><span class=line><span class=cl>kind: InitConfiguration
</span></span><span class=line><span class=cl>localAPIEndpoint:
</span></span><span class=line><span class=cl>  advertiseAddress: 192.168.1.71
</span></span><span class=line><span class=cl>  bindPort: <span class=m>6443</span>
</span></span><span class=line><span class=cl>nodeRegistration:
</span></span><span class=line><span class=cl>  criSocket: unix:///var/run/cri-dockerd.sock
</span></span><span class=line><span class=cl>  name: k8s-master71u
</span></span><span class=line><span class=cl>  taints:
</span></span><span class=line><span class=cl>  - effect: NoSchedule
</span></span><span class=line><span class=cl>    key: node-role.kubernetes.io/master
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>apiServer:
</span></span><span class=line><span class=cl>  certSANs:
</span></span><span class=line><span class=cl>  - 192.168.1.74
</span></span><span class=line><span class=cl>  timeoutForControlPlane: 4m0s
</span></span><span class=line><span class=cl>apiVersion: kubeadm.k8s.io/v1beta3
</span></span><span class=line><span class=cl>certificatesDir: /etc/kubernetes/pki
</span></span><span class=line><span class=cl>clusterName: kubernetes
</span></span><span class=line><span class=cl>controlPlaneEndpoint: 192.168.1.74:7443
</span></span><span class=line><span class=cl>controllerManager: <span class=o>{}</span>
</span></span><span class=line><span class=cl>etcd:
</span></span><span class=line><span class=cl>  local:
</span></span><span class=line><span class=cl>    dataDir: /var/lib/etcd
</span></span><span class=line><span class=cl>imageRepository: registry.k8s.io
</span></span><span class=line><span class=cl>kind: ClusterConfiguration
</span></span><span class=line><span class=cl>kubernetesVersion: v1.26.3
</span></span><span class=line><span class=cl>networking:
</span></span><span class=line><span class=cl>  dnsDomain: cluster.local
</span></span><span class=line><span class=cl>  podSubnet: 10.244.0.0/16
</span></span><span class=line><span class=cl>  serviceSubnet: 10.245.0.0/16
</span></span><span class=line><span class=cl>scheduler: <span class=o>{}</span>
</span></span></code></pre></div><h2 id=四提前下載鏡像>四、提前下載鏡像</h2><p>操作節點：所有master節點執行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master71u:~# kubeadm config images list --config kubeadm.yaml
</span></span><span class=line><span class=cl>registry.k8s.io/kube-apiserver:v1.26.3
</span></span><span class=line><span class=cl>registry.k8s.io/kube-controller-manager:v1.26.3
</span></span><span class=line><span class=cl>registry.k8s.io/kube-scheduler:v1.26.3
</span></span><span class=line><span class=cl>registry.k8s.io/kube-proxy:v1.26.3
</span></span><span class=line><span class=cl>registry.k8s.io/pause:3.9
</span></span><span class=line><span class=cl>registry.k8s.io/etcd:3.5.6-0
</span></span><span class=line><span class=cl>registry.k8s.io/coredns/coredns:v1.9.3
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# kubeadm config images pull --config kubeadm.yaml
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.k8s.io/kube-apiserver:v1.26.3
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.k8s.io/kube-controller-manager:v1.26.3
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.k8s.io/kube-scheduler:v1.26.3
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.k8s.io/kube-proxy:v1.26.3
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.k8s.io/pause:3.9
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.k8s.io/etcd:3.5.6-0
</span></span><span class=line><span class=cl><span class=o>[</span>config/images<span class=o>]</span> Pulled registry.k8s.io/coredns/coredns:v1.9.3
</span></span></code></pre></div><h2 id=五初始化master節點>五、初始化master節點</h2><p>操作節點：只在master節點（<code>k8s-master</code>）執行，找一台master執行即可</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master71u:~# kubeadm init --config kubeadm.yaml --upload-certs
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 若初始化成功後，最後會提示如下信息：</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Your Kubernetes control-plane has initialized successfully!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>To start using your cluster, you need to run the following as a regular user:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>  sudo cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>  sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Alternatively, <span class=k>if</span> you are the root user, you can run:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>export</span> <span class=nv>KUBECONFIG</span><span class=o>=</span>/etc/kubernetes/admin.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>You should now deploy a pod network to the cluster.
</span></span><span class=line><span class=cl>Run <span class=s2>&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span class=line><span class=cl>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>You can now join any number of the control-plane node running the following <span class=nb>command</span> on each as root:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kubeadm join 192.168.1.74:7443 --token 7t2weq.bjbawausm0jaxury <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--discovery-token-ca-cert-hash sha256:86af29371fd57d46a8592782fb4ae158035711372c0541449dcadfdc8f7fc243 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--control-plane --certificate-key a543d4775e0ca9787d4d2936758a3447d189cdae117170512b4de60a23b59e8a
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
</span></span><span class=line><span class=cl>As a safeguard, uploaded-certs will be deleted in two hours<span class=p>;</span> If necessary, you can use
</span></span><span class=line><span class=cl><span class=s2>&#34;kubeadm init phase upload-certs --upload-certs&#34;</span> to reload certs afterward.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubeadm join 192.168.1.74:7443 --token 7t2weq.bjbawausm0jaxury <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--discovery-token-ca-cert-hash sha256:86af29371fd57d46a8592782fb4ae158035711372c0541449dcadfdc8f7fc243 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 接下來按照上述提示信息操作，配置kubectl客戶端的認證</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>root@k8s-master71u:~# sudo cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>root@k8s-master71u:~# sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</span></span></code></pre></div><blockquote><p>若執行初始化過程中出錯，根據錯誤信息調整後，執行 kubeadm reset -f ; ipvsadm &ndash;clear ; rm -rf ~/.kube ; rm -rf /etc/kubernetes/manifests/* ; rm -rf /var/lib/etcd/</p></blockquote><h2 id=六添加其他master節點到集群中>六、添加其他master節點到集群中</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># k8s-master72u主機</span>
</span></span><span class=line><span class=cl>root@k8s-master72u:~#   kubeadm join 192.168.1.74:7443 --token 7t2weq.bjbawausm0jaxury <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--discovery-token-ca-cert-hash sha256:86af29371fd57d46a8592782fb4ae158035711372c0541449dcadfdc8f7fc243 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--control-plane --certificate-key a543d4775e0ca9787d4d2936758a3447d189cdae117170512b4de60a23b59e8a <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--cri-socket<span class=o>=</span>unix:///var/run/cri-dockerd.sock
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master72u:~# mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>root@k8s-master72u:~# sudo cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>root@k8s-master72u:~# sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># k8s-master73u主機</span>
</span></span><span class=line><span class=cl>root@k8s-master73u:~#   kubeadm join 192.168.1.74:7443 --token 7t2weq.bjbawausm0jaxury <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--discovery-token-ca-cert-hash sha256:86af29371fd57d46a8592782fb4ae158035711372c0541449dcadfdc8f7fc243 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--control-plane --certificate-key a543d4775e0ca9787d4d2936758a3447d189cdae117170512b4de60a23b59e8a <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--cri-socket<span class=o>=</span>unix:///var/run/cri-dockerd.sock
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master73u:~# mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>root@k8s-master73u:~# sudo cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>root@k8s-master73u:~# sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</span></span></code></pre></div><h2 id=七添加node節點到集群中>七、添加node節點到集群中</h2><p>操作節點：所有的node節點（<code>k8s-node</code>）需要執行 在每台node節點，執行如下命令，該命令是在kubeadm init成功後提示信息中打印出來的，需要替換成實際init後打印出的命令。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># k8s-node75u主機</span>
</span></span><span class=line><span class=cl>root@k8s-node75u:~# kubeadm join 192.168.1.74:7443 --token 7t2weq.bjbawausm0jaxury <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--discovery-token-ca-cert-hash sha256:86af29371fd57d46a8592782fb4ae158035711372c0541449dcadfdc8f7fc243 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--cri-socket<span class=o>=</span>unix:///var/run/cri-dockerd.sock
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># k8s-node76u主機</span>
</span></span><span class=line><span class=cl>root@k8s-node76u:~# kubeadm join 192.168.1.74:7443 --token 7t2weq.bjbawausm0jaxury <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--discovery-token-ca-cert-hash sha256:86af29371fd57d46a8592782fb4ae158035711372c0541449dcadfdc8f7fc243 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--cri-socket<span class=o>=</span>unix:///var/run/cri-dockerd.sock
</span></span></code></pre></div><p>如果忘記添加命令，可以通過如下命令生成：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubeadm token create --print-join-command
</span></span></code></pre></div><p>查看目前node狀況:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master71u:~# kubectl get node
</span></span><span class=line><span class=cl>NAME            STATUS     ROLES           AGE     VERSION
</span></span><span class=line><span class=cl>k8s-master71u   NotReady   control-plane   10m     v1.26.3
</span></span><span class=line><span class=cl>k8s-master72u   NotReady   control-plane   3m58s   v1.26.3
</span></span><span class=line><span class=cl>k8s-master73u   NotReady   control-plane   2m57s   v1.26.3
</span></span><span class=line><span class=cl>k8s-node75u     NotReady   &lt;none&gt;          55s     v1.26.3
</span></span><span class=line><span class=cl>k8s-node76u     NotReady   &lt;none&gt;          51s     v1.26.3
</span></span></code></pre></div><h2 id=部署容器網絡calico>部署容器網絡（calico）</h2><p>操作節點：只在master節點（<code>k8s-master</code>）執行，找一台master執行即可，CNI</p><p>Calico是一個純三層的數據中心網絡方案，是目前Kubernetes主流的網絡方案。</p><p><a class=link href=https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart target=_blank rel=noopener>https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master71u:~# mkdir calico
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# <span class=nb>cd</span> calico/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~/calico# wget https://raw.githubusercontent.com/projectcalico/calico/v3.26.0/manifests/tigera-operator.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~/calico# wget https://raw.githubusercontent.com/projectcalico/calico/v3.26.0/manifests/custom-resources.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~/calico# kubectl create -f tigera-operator.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># cidr ip部分，與前面kubeadm init的 --pod-network-cidr指定的一樣。</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:~/calico# vim custom-resources.yaml 
</span></span><span class=line><span class=cl><span class=c1># This section includes base Calico installation configuration.</span>
</span></span><span class=line><span class=cl><span class=c1># For more information, see: https://projectcalico.docs.tigera.io/master/reference/installation/api#operator.tigera.io/v1.Installation</span>
</span></span><span class=line><span class=cl>apiVersion: operator.tigera.io/v1
</span></span><span class=line><span class=cl>kind: Installation
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: default
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  <span class=c1># Configures Calico networking.</span>
</span></span><span class=line><span class=cl>  calicoNetwork:
</span></span><span class=line><span class=cl>    <span class=c1># Note: The ipPools section cannot be modified post-install.</span>
</span></span><span class=line><span class=cl>    ipPools:
</span></span><span class=line><span class=cl>    - blockSize: <span class=m>26</span>
</span></span><span class=line><span class=cl>      cidr: 10.244.0.0/16
</span></span><span class=line><span class=cl>      encapsulation: VXLANCrossSubnet
</span></span><span class=line><span class=cl>      natOutgoing: Enabled
</span></span><span class=line><span class=cl>      nodeSelector: all<span class=o>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># This section configures the Calico API server.</span>
</span></span><span class=line><span class=cl><span class=c1># For more information, see: https://projectcalico.docs.tigera.io/master/reference/installation/api#operator.tigera.io/v1.APIServer</span>
</span></span><span class=line><span class=cl>apiVersion: operator.tigera.io/v1
</span></span><span class=line><span class=cl>kind: APIServer
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: default
</span></span><span class=line><span class=cl>spec: <span class=o>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~/calico# kubectl create -f custom-resources.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 等Calico Pod都Running，節點也會准備就緒。</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:~/calico# kubectl get pods -n calico-system
</span></span><span class=line><span class=cl>NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>calico-kube-controllers-676484d755-9llvm   1/1     Running   <span class=m>0</span>          16m
</span></span><span class=line><span class=cl>calico-node-2s4gl                          1/1     Running   <span class=m>0</span>          16m
</span></span><span class=line><span class=cl>calico-node-f9dz9                          1/1     Running   <span class=m>0</span>          16m
</span></span><span class=line><span class=cl>calico-node-kvc55                          1/1     Running   <span class=m>0</span>          16m
</span></span><span class=line><span class=cl>calico-node-l9gb2                          1/1     Running   <span class=m>0</span>          16m
</span></span><span class=line><span class=cl>calico-node-xdp42                          1/1     Running   <span class=m>0</span>          16m
</span></span><span class=line><span class=cl>calico-typha-98f544f9f-nqc4n               1/1     Running   <span class=m>0</span>          16m
</span></span><span class=line><span class=cl>calico-typha-98f544f9f-plpnn               1/1     Running   <span class=m>0</span>          16m
</span></span><span class=line><span class=cl>calico-typha-98f544f9f-vgrmn               1/1     Running   <span class=m>0</span>          16m
</span></span><span class=line><span class=cl>csi-node-driver-42c8p                      2/2     Running   <span class=m>0</span>          16m
</span></span><span class=line><span class=cl>csi-node-driver-kdd42                      2/2     Running   <span class=m>0</span>          16m
</span></span><span class=line><span class=cl>csi-node-driver-nxf5d                      2/2     Running   <span class=m>0</span>          16m
</span></span><span class=line><span class=cl>csi-node-driver-rphdj                      2/2     Running   <span class=m>0</span>          16m
</span></span><span class=line><span class=cl>csi-node-driver-shs2s                      2/2     Running   <span class=m>0</span>          16m
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~/calico# kubectl get node
</span></span><span class=line><span class=cl>NAME            STATUS   ROLES           AGE   VERSION
</span></span><span class=line><span class=cl>k8s-master71u   Ready    control-plane   31m   v1.26.3
</span></span><span class=line><span class=cl>k8s-master72u   Ready    control-plane   24m   v1.26.3
</span></span><span class=line><span class=cl>k8s-master73u   Ready    control-plane   23m   v1.26.3
</span></span><span class=line><span class=cl>k8s-node75u     Ready    &lt;none&gt;          21m   v1.26.3
</span></span><span class=line><span class=cl>k8s-node76u     Ready    &lt;none&gt;          21m   v1.26.3
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~/calico# kubectl get pods -n kube-system
</span></span><span class=line><span class=cl>NAME                                    READY   STATUS    RESTARTS      AGE
</span></span><span class=line><span class=cl>coredns-787d4945fb-6x8v2                1/1     Running   <span class=m>0</span>             31m
</span></span><span class=line><span class=cl>coredns-787d4945fb-ddpgp                1/1     Running   <span class=m>0</span>             31m
</span></span><span class=line><span class=cl>etcd-k8s-master71u                      1/1     Running   <span class=m>0</span>             31m
</span></span><span class=line><span class=cl>etcd-k8s-master72u                      1/1     Running   <span class=m>0</span>             24m
</span></span><span class=line><span class=cl>etcd-k8s-master73u                      1/1     Running   <span class=m>0</span>             23m
</span></span><span class=line><span class=cl>kube-apiserver-k8s-master71u            1/1     Running   <span class=m>0</span>             31m
</span></span><span class=line><span class=cl>kube-apiserver-k8s-master72u            1/1     Running   <span class=m>0</span>             24m
</span></span><span class=line><span class=cl>kube-apiserver-k8s-master73u            1/1     Running   <span class=m>1</span> <span class=o>(</span>23m ago<span class=o>)</span>   23m
</span></span><span class=line><span class=cl>kube-controller-manager-k8s-master71u   1/1     Running   <span class=m>1</span> <span class=o>(</span>24m ago<span class=o>)</span>   31m
</span></span><span class=line><span class=cl>kube-controller-manager-k8s-master72u   1/1     Running   <span class=m>0</span>             24m
</span></span><span class=line><span class=cl>kube-controller-manager-k8s-master73u   1/1     Running   <span class=m>0</span>             22m
</span></span><span class=line><span class=cl>kube-proxy-4rtwz                        1/1     Running   <span class=m>0</span>             23m
</span></span><span class=line><span class=cl>kube-proxy-84v9t                        1/1     Running   <span class=m>0</span>             24m
</span></span><span class=line><span class=cl>kube-proxy-9bh8t                        1/1     Running   <span class=m>0</span>             21m
</span></span><span class=line><span class=cl>kube-proxy-m5gj8                        1/1     Running   <span class=m>0</span>             21m
</span></span><span class=line><span class=cl>kube-proxy-x4t5v                        1/1     Running   <span class=m>0</span>             31m
</span></span><span class=line><span class=cl>kube-scheduler-k8s-master71u            1/1     Running   <span class=m>1</span> <span class=o>(</span>24m ago<span class=o>)</span>   31m
</span></span><span class=line><span class=cl>kube-scheduler-k8s-master72u            1/1     Running   <span class=m>0</span>             24m
</span></span><span class=line><span class=cl>kube-scheduler-k8s-master73u            1/1     Running   <span class=m>0</span>             22m
</span></span></code></pre></div><p>註：以後所有yaml文件都只在Master節點執行。</p><p>安裝目錄：/etc/kubernetes/</p><p>組件配置文件目錄：/etc/kubernetes/manifests/</p><h1 id=集群設置>集群設置</h1><h2 id=設置master節點是否可調度可選>設置master節點是否可調度（可選）</h2><p>操作節點：<code>k8s-master</code></p><p>默認部署成功後，master節點無法調度業務pod，如需設置master節點也可以參與pod的調度，需執行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl taint node k8s-master node-role.kubernetes.io/master:NoSchedule-
</span></span></code></pre></div><h2 id=設置kubectl自動補全>設置kubectl自動補全</h2><p>操作節點：<code>k8s-master</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master71u:~# apt install -y bash-completion
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# apt install plocate
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# locate bash_completion
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# <span class=nb>source</span> /usr/share/bash-completion/bash_completion
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# <span class=nb>source</span> &lt;<span class=o>(</span>kubectl completion bash<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# <span class=nb>echo</span> <span class=s2>&#34;source &lt;(kubectl completion bash)&#34;</span> &gt;&gt; ~/.bashrc
</span></span></code></pre></div><h1 id=調整證書過期>調整證書過期</h1><p>使用kubeadm安裝的集群，證書默認有效期為1年，可以通過如下方式修改為10年。<strong>全部master節點都要執行</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master71u:~/calico# <span class=nb>cd</span> /etc/kubernetes/pki
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:/etc/kubernetes/pki# <span class=k>for</span> i in <span class=k>$(</span>ls *.crt<span class=k>)</span><span class=p>;</span> <span class=k>do</span> <span class=nb>echo</span> <span class=s2>&#34;===== </span><span class=nv>$i</span><span class=s2> =====&#34;</span><span class=p>;</span> openssl x509 -in <span class=nv>$i</span> -text -noout <span class=p>|</span> grep -A <span class=m>3</span> <span class=s1>&#39;Validity&#39;</span> <span class=p>;</span> <span class=k>done</span>
</span></span><span class=line><span class=cl><span class=o>=====</span> apiserver.crt <span class=o>=====</span>
</span></span><span class=line><span class=cl>        Validity
</span></span><span class=line><span class=cl>            Not Before: Sep <span class=m>20</span> 04:42:27 <span class=m>2023</span> GMT
</span></span><span class=line><span class=cl>            Not After : Sep <span class=m>19</span> 04:42:27 <span class=m>2024</span> GMT
</span></span><span class=line><span class=cl>        Subject: <span class=nv>CN</span> <span class=o>=</span> kube-apiserver
</span></span><span class=line><span class=cl><span class=o>=====</span> apiserver-etcd-client.crt <span class=o>=====</span>
</span></span><span class=line><span class=cl>        Validity
</span></span><span class=line><span class=cl>            Not Before: Sep <span class=m>20</span> 04:42:28 <span class=m>2023</span> GMT
</span></span><span class=line><span class=cl>            Not After : Sep <span class=m>19</span> 04:42:29 <span class=m>2024</span> GMT
</span></span><span class=line><span class=cl>        Subject: <span class=nv>O</span> <span class=o>=</span> system:masters, <span class=nv>CN</span> <span class=o>=</span> kube-apiserver-etcd-client
</span></span><span class=line><span class=cl><span class=o>=====</span> apiserver-kubelet-client.crt <span class=o>=====</span>
</span></span><span class=line><span class=cl>        Validity
</span></span><span class=line><span class=cl>            Not Before: Sep <span class=m>20</span> 04:42:27 <span class=m>2023</span> GMT
</span></span><span class=line><span class=cl>            Not After : Sep <span class=m>19</span> 04:42:27 <span class=m>2024</span> GMT
</span></span><span class=line><span class=cl>        Subject: <span class=nv>O</span> <span class=o>=</span> system:masters, <span class=nv>CN</span> <span class=o>=</span> kube-apiserver-kubelet-client
</span></span><span class=line><span class=cl><span class=o>=====</span> ca.crt <span class=o>=====</span>
</span></span><span class=line><span class=cl>        Validity
</span></span><span class=line><span class=cl>            Not Before: Sep <span class=m>20</span> 04:42:27 <span class=m>2023</span> GMT
</span></span><span class=line><span class=cl>            Not After : Sep <span class=m>17</span> 04:42:27 <span class=m>2033</span> GMT
</span></span><span class=line><span class=cl>        Subject: <span class=nv>CN</span> <span class=o>=</span> <span class=nv>kubernetes</span>
</span></span><span class=line><span class=cl><span class=o>=====</span> front-proxy-ca.crt <span class=o>=====</span>
</span></span><span class=line><span class=cl>        Validity
</span></span><span class=line><span class=cl>            Not Before: Sep <span class=m>20</span> 04:42:27 <span class=m>2023</span> GMT
</span></span><span class=line><span class=cl>            Not After : Sep <span class=m>17</span> 04:42:27 <span class=m>2033</span> GMT
</span></span><span class=line><span class=cl>        Subject: <span class=nv>CN</span> <span class=o>=</span> front-proxy-ca
</span></span><span class=line><span class=cl><span class=o>=====</span> front-proxy-client.crt <span class=o>=====</span>
</span></span><span class=line><span class=cl>        Validity
</span></span><span class=line><span class=cl>            Not Before: Sep <span class=m>20</span> 04:42:27 <span class=m>2023</span> GMT
</span></span><span class=line><span class=cl>            Not After : Sep <span class=m>19</span> 04:42:28 <span class=m>2024</span> GMT
</span></span><span class=line><span class=cl>        Subject: <span class=nv>CN</span> <span class=o>=</span> front-proxy-client
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:/etc/kubernetes/pki# mkdir backup_key<span class=p>;</span> cp -rp ./* backup_key/
</span></span><span class=line><span class=cl>root@k8s-master71u:/etc/kubernetes/pki# git clone https://github.com/yuyicai/update-kube-cert.git
</span></span><span class=line><span class=cl>root@k8s-master71u:/etc/kubernetes/pki# <span class=nb>cd</span> update-kube-cert/ 
</span></span><span class=line><span class=cl>root@k8s-master71u:/etc/kubernetes/pki/update-kube-cert# bash update-kubeadm-cert.sh all
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:/etc/kubernetes/pki/update-kube-cert# kubectl -n kube-system delete po kube-apiserver-k8s-master71u kube-apiserver-k8s-master72u kube-apiserver-k8s-master73u kube-controller-manager-k8s-master71u kube-controller-manager-k8s-master72u kube-controller-manager-k8s-master73u kube-scheduler-k8s-master71u kube-scheduler-k8s-master72u kube-scheduler-k8s-master73u
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:/etc/kubernetes/pki/update-kube-cert# kubectl get pod -n kube-system
</span></span><span class=line><span class=cl>NAME                                    READY   STATUS    RESTARTS      AGE
</span></span><span class=line><span class=cl>coredns-787d4945fb-6x8v2                1/1     Running   <span class=m>0</span>             36m
</span></span><span class=line><span class=cl>coredns-787d4945fb-ddpgp                1/1     Running   <span class=m>0</span>             36m
</span></span><span class=line><span class=cl>etcd-k8s-master71u                      1/1     Running   <span class=m>0</span>             36m
</span></span><span class=line><span class=cl>etcd-k8s-master72u                      1/1     Running   <span class=m>0</span>             29m
</span></span><span class=line><span class=cl>etcd-k8s-master73u                      1/1     Running   <span class=m>0</span>             28m
</span></span><span class=line><span class=cl>kube-apiserver-k8s-master71u            1/1     Running   <span class=m>0</span>             30s
</span></span><span class=line><span class=cl>kube-apiserver-k8s-master72u            1/1     Running   <span class=m>0</span>             30s
</span></span><span class=line><span class=cl>kube-apiserver-k8s-master73u            1/1     Running   <span class=m>1</span> <span class=o>(</span>28m ago<span class=o>)</span>   30s
</span></span><span class=line><span class=cl>kube-controller-manager-k8s-master71u   1/1     Running   <span class=m>1</span> <span class=o>(</span>29m ago<span class=o>)</span>   30s
</span></span><span class=line><span class=cl>kube-controller-manager-k8s-master72u   1/1     Running   <span class=m>0</span>             30s
</span></span><span class=line><span class=cl>kube-controller-manager-k8s-master73u   1/1     Running   <span class=m>0</span>             30s
</span></span><span class=line><span class=cl>kube-proxy-4rtwz                        1/1     Running   <span class=m>0</span>             28m
</span></span><span class=line><span class=cl>kube-proxy-84v9t                        1/1     Running   <span class=m>0</span>             29m
</span></span><span class=line><span class=cl>kube-proxy-9bh8t                        1/1     Running   <span class=m>0</span>             26m
</span></span><span class=line><span class=cl>kube-proxy-m5gj8                        1/1     Running   <span class=m>0</span>             26m
</span></span><span class=line><span class=cl>kube-proxy-x4t5v                        1/1     Running   <span class=m>0</span>             36m
</span></span><span class=line><span class=cl>kube-scheduler-k8s-master71u            1/1     Running   <span class=m>2</span> <span class=o>(</span>69s ago<span class=o>)</span>   30s
</span></span><span class=line><span class=cl>kube-scheduler-k8s-master72u            1/1     Running   <span class=m>0</span>             30s
</span></span><span class=line><span class=cl>kube-scheduler-k8s-master73u            1/1     Running   <span class=m>0</span>             30s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:/etc/kubernetes/pki/update-kube-cert# <span class=nb>cd</span> /etc/kubernetes/pki
</span></span><span class=line><span class=cl>root@k8s-master71u:/etc/kubernetes/pki# <span class=k>for</span> i in <span class=k>$(</span>ls *.crt<span class=k>)</span><span class=p>;</span> <span class=k>do</span> <span class=nb>echo</span> <span class=s2>&#34;===== </span><span class=nv>$i</span><span class=s2> =====&#34;</span><span class=p>;</span> openssl x509 -in <span class=nv>$i</span> -text -noout <span class=p>|</span> grep -A <span class=m>3</span> <span class=s1>&#39;Validity&#39;</span> <span class=p>;</span> <span class=k>done</span>
</span></span><span class=line><span class=cl><span class=o>=====</span> apiserver.crt <span class=o>=====</span>
</span></span><span class=line><span class=cl>        Validity
</span></span><span class=line><span class=cl>            Not Before: Sep <span class=m>20</span> 05:17:58 <span class=m>2023</span> GMT
</span></span><span class=line><span class=cl>            Not After : Sep <span class=m>17</span> 05:17:58 <span class=m>2033</span> GMT
</span></span><span class=line><span class=cl>        Subject: <span class=nv>CN</span> <span class=o>=</span> kube-apiserver
</span></span><span class=line><span class=cl><span class=o>=====</span> apiserver-etcd-client.crt <span class=o>=====</span>
</span></span><span class=line><span class=cl>        Validity
</span></span><span class=line><span class=cl>            Not Before: Sep <span class=m>20</span> 05:17:55 <span class=m>2023</span> GMT
</span></span><span class=line><span class=cl>            Not After : Sep <span class=m>17</span> 05:17:55 <span class=m>2033</span> GMT
</span></span><span class=line><span class=cl>        Subject: <span class=nv>O</span> <span class=o>=</span> system:masters, <span class=nv>CN</span> <span class=o>=</span> kube-apiserver-etcd-client
</span></span><span class=line><span class=cl><span class=o>=====</span> apiserver-kubelet-client.crt <span class=o>=====</span>
</span></span><span class=line><span class=cl>        Validity
</span></span><span class=line><span class=cl>            Not Before: Sep <span class=m>20</span> 05:17:58 <span class=m>2023</span> GMT
</span></span><span class=line><span class=cl>            Not After : Sep <span class=m>17</span> 05:17:58 <span class=m>2033</span> GMT
</span></span><span class=line><span class=cl>        Subject: <span class=nv>O</span> <span class=o>=</span> system:masters, <span class=nv>CN</span> <span class=o>=</span> kube-apiserver-kubelet-client
</span></span><span class=line><span class=cl><span class=o>=====</span> ca.crt <span class=o>=====</span>
</span></span><span class=line><span class=cl>        Validity
</span></span><span class=line><span class=cl>            Not Before: Sep <span class=m>20</span> 04:42:27 <span class=m>2023</span> GMT
</span></span><span class=line><span class=cl>            Not After : Sep <span class=m>17</span> 04:42:27 <span class=m>2033</span> GMT
</span></span><span class=line><span class=cl>        Subject: <span class=nv>CN</span> <span class=o>=</span> <span class=nv>kubernetes</span>
</span></span><span class=line><span class=cl><span class=o>=====</span> front-proxy-ca.crt <span class=o>=====</span>
</span></span><span class=line><span class=cl>        Validity
</span></span><span class=line><span class=cl>            Not Before: Sep <span class=m>20</span> 04:42:27 <span class=m>2023</span> GMT
</span></span><span class=line><span class=cl>            Not After : Sep <span class=m>17</span> 04:42:27 <span class=m>2033</span> GMT
</span></span><span class=line><span class=cl>        Subject: <span class=nv>CN</span> <span class=o>=</span> front-proxy-ca
</span></span><span class=line><span class=cl><span class=o>=====</span> front-proxy-client.crt <span class=o>=====</span>
</span></span><span class=line><span class=cl>        Validity
</span></span><span class=line><span class=cl>            Not Before: Sep <span class=m>20</span> 05:17:59 <span class=m>2023</span> GMT
</span></span><span class=line><span class=cl>            Not After : Sep <span class=m>17</span> 05:17:59 <span class=m>2033</span> GMT
</span></span><span class=line><span class=cl>        Subject: <span class=nv>CN</span> <span class=o>=</span> front-proxy-client
</span></span></code></pre></div><h1 id=驗證集群>驗證集群</h1><p>操作節點： 在master節點（<code>k8s-master</code>）執行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master71u:~# kubectl get nodes
</span></span><span class=line><span class=cl>NAME            STATUS   ROLES           AGE   VERSION
</span></span><span class=line><span class=cl>k8s-master71u   Ready    control-plane   39m   v1.26.3
</span></span><span class=line><span class=cl>k8s-master72u   Ready    control-plane   32m   v1.26.3
</span></span><span class=line><span class=cl>k8s-master73u   Ready    control-plane   31m   v1.26.3
</span></span><span class=line><span class=cl>k8s-node75u     Ready    &lt;none&gt;          29m   v1.26.3
</span></span><span class=line><span class=cl>k8s-node76u     Ready    &lt;none&gt;          29m   v1.26.3
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# kubectl run  test-nginx --image<span class=o>=</span>nginx:alpine
</span></span><span class=line><span class=cl>pod/test-nginx created
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# kubectl get pod -o wide
</span></span><span class=line><span class=cl>NAME         READY   STATUS    RESTARTS   AGE   IP               NODE          NOMINATED NODE   READINESS GATES
</span></span><span class=line><span class=cl>test-nginx   1/1     Running   <span class=m>0</span>          21s   10.244.255.195   k8s-node76u   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:~# curl 10.244.255.195
</span></span><span class=line><span class=cl>&lt;!DOCTYPE html&gt;
</span></span><span class=line><span class=cl>&lt;html&gt;
</span></span><span class=line><span class=cl>&lt;head&gt;
</span></span><span class=line><span class=cl>&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span class=line><span class=cl>&lt;style&gt;
</span></span><span class=line><span class=cl>html <span class=o>{</span> color-scheme: light dark<span class=p>;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>body <span class=o>{</span> width: 35em<span class=p>;</span> margin: <span class=m>0</span> auto<span class=p>;</span>
</span></span><span class=line><span class=cl>font-family: Tahoma, Verdana, Arial, sans-serif<span class=p>;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>&lt;/style&gt;
</span></span><span class=line><span class=cl>&lt;/head&gt;
</span></span><span class=line><span class=cl>&lt;body&gt;
</span></span><span class=line><span class=cl>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span><span class=line><span class=cl>&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span class=line><span class=cl>working. Further configuration is required.&lt;/p&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;p&gt;For online documentation and support please refer to
</span></span><span class=line><span class=cl>&lt;a <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span class=line><span class=cl>Commercial support is available at
</span></span><span class=line><span class=cl>&lt;a <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;p&gt;&lt;em&gt;Thank you <span class=k>for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span class=line><span class=cl>&lt;/body&gt;
</span></span><span class=line><span class=cl>&lt;/html&gt;
</span></span></code></pre></div></section><footer class=article-footer><section class=article-tags><a href=/tags/kubernetes/>kubernetes</a>
<a href=/tags/ubuntu/>ubuntu</a>
<a href=/tags/docker/>docker</a>
<a href=/tags/cri-docker/>cri-docker</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相關文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/2023/kubernetes-docker/><div class=article-details><h2 class=article-title>使用Docker安裝Rancher管理平台，納管現有k8s集群(單節點-非高可用)</h2></div></a></article><article><a href=/2023/kubernetes-helm/><div class=article-details><h2 class=article-title>使用Helm安裝Rancher管理平台，納管現有k8s集群( 高可用)</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//blog-goldfishbrain-fighting-com.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2022 -
2023 翻轉吧金魚腦</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 建立<br>主題 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.20.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 設計</section><section class=totalcount>發表了20篇文章 ·
總計8.33k字</section><section class=running-time>本站已運行
<span id=runningdays class=running-days></span></section><section class=visit-count><span id=busuanzi_container_site_pv style=display:none>本站總訪問量 <span id=busuanzi_value_site_pv></span> 次 </span>·
<span id=busuanzi_container_site_uv style=display:none>總訪客數 <span id=busuanzi_value_site_uv></span> 人</span></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><a href=# id=back-to-top title=返回顶部></a><style>#back-to-top{display:none;position:fixed;bottom:20px;right:55px;width:55px;height:55px;border-radius:7px;background-color:rgba(64,158,255,.5);box-shadow:var(--shadow-l2);font-size:30px;text-align:center;line-height:50px;cursor:pointer}#back-to-top:before{content:' ';display:inline-block;position:relative;top:0;transform:rotate(135deg);height:10px;width:10px;border-width:0 0 2px 2px;border-color:var(--back-to-top-color);border-style:solid}#back-to-top:hover:before{border-color:#2674e0}@media screen and (max-width:768px){#back-to-top{bottom:20px;right:20px;width:40px;height:40px;font-size:10px}}@media screen and (min-width:1024px){#back-to-top{bottom:20px;right:40px}}@media screen and (min-width:1280px){#back-to-top{bottom:20px;right:55px}}@media screen and (min-width:1536px){#back-to-top{visibility:hidden}}</style><script>function backToTop(){document.documentElement.scrollIntoView({behavior:"smooth"})}window.onload=function(){let t=this.document.documentElement.scrollTop||this.document.body.scrollTop,e=this.document.getElementById("back-to-top");t>0?e.style.display="inline":e.style.display="none"},window.onscroll=function(){let t=this.document.documentElement.scrollTop||this.document.body.scrollTop,e=this.document.getElementById("back-to-top");t<200?e.style.display="none":(e.style.display="inline",e.addEventListener("click",backToTop,!1))}</script><script>(function(){var t,e=window;if(e.ChannelIO)return e.console.error("ChannelIO script included twice.");t=function(){t.c(arguments)},t.q=[],t.c=function(e){t.q.push(e)},e.ChannelIO=t;function n(){if(e.ChannelIOInitialized)return;e.ChannelIOInitialized=!0;var n,t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="https://cdn.channel.io/plugin/ch-plugin-web.js",n=document.getElementsByTagName("script")[0],n.parentNode&&n.parentNode.insertBefore(t,n)}document.readyState==="complete"?n():(e.addEventListener("DOMContentLoaded",n),e.addEventListener("load",n))})(),ChannelIO("boot",{pluginKey:"ad479103-2d28-421a-a916-ae09e72ce014"})</script><script>let s1="2023-10-7";s1=new Date(s1.replace(/-/g,"/"));let s2=new Date,timeDifference=s2.getTime()-s1.getTime(),days=Math.floor(timeDifference/(1e3*60*60*24)),hours=Math.floor(timeDifference%(1e3*60*60*24)/(1e3*60*60)),minutes=Math.floor(timeDifference%(1e3*60*60)/(1e3*60)),result=days+"天"+hours+"小時"+minutes+"分鐘";document.getElementById("runningdays").innerHTML=result</script></body></html>