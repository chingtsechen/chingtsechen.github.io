<!doctype html><html lang=en-us dir=ltr><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-QB4H991E1G"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QB4H991E1G")</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="使用docker-compose的方式，快速佈屬ELK8版集群，採角色拆分，佈屬在多節點上，並啟用security(tls)登入驗證"><meta name=keywords content="ELK8.x 多節點集群佈署-啟用security(tls)登入驗證(Docker-Compose),翻轉吧金魚腦"><title>ELK8.x 多節點集群佈署-啟用security(tls)登入驗證(Docker-Compose)</title>
<link rel=canonical href=https://blog.goldfishbrain-fighting.com/2023/docker-compose-elk-multinodes-cluster/><link rel=stylesheet href=/scss/style.min.7fb7f5621081d8ecec310edc2d95cc0b431358ce9c30c3ee8601b16732dbef57.css><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><script src=//cdn.bootcss.com/jquery/3.2.1/jquery.min.js></script><script>$(document).ready(function(){var e=setInterval(s,100),t=100,n=50;function s(){$("#busuanzi_container_site_pv").css("display")!="none"&&(clearInterval(e),$("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html())+t),$("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html())+n))}})</script><meta property="og:title" content="ELK8.x 多節點集群佈署-啟用security(tls)登入驗證(Docker-Compose)"><meta property="og:description" content="使用docker-compose的方式，快速佈屬ELK8版集群，採角色拆分，佈屬在多節點上，並啟用security(tls)登入驗證"><meta property="og:url" content="https://blog.goldfishbrain-fighting.com/2023/docker-compose-elk-multinodes-cluster/"><meta property="og:site_name" content="翻轉吧金魚腦"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="docker"><meta property="article:tag" content="tls"><meta property="article:tag" content="elasticsearch"><meta property="article:tag" content="logstash"><meta property="article:tag" content="kibana"><meta property="article:tag" content="elk"><meta property="article:tag" content="cluster"><meta property="article:tag" content="docker-compose"><meta property="article:tag" content="security"><meta property="article:tag" content="multinodes"><meta property="article:published_time" content="2023-10-24T06:52:48+08:00"><meta property="article:modified_time" content="2023-10-24T06:52:48+08:00"><meta name=twitter:title content="ELK8.x 多節點集群佈署-啟用security(tls)登入驗證(Docker-Compose)"><meta name=twitter:description content="使用docker-compose的方式，快速佈屬ELK8版集群，採角色拆分，佈屬在多節點上，並啟用security(tls)登入驗證"><link rel="shortcut icon" href=/favicon.png><script async src="https://www.googletagmanager.com/gtag/js?id=G-QB4H991E1G"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QB4H991E1G")</script><meta name=google-site-verification content="EkUcMLTrO3RDZzjREX9Dffy2lcjWCR-2Qtu8VF4b8sQ"><meta content="ELK8.x 多節點集群佈署-啟用security(tls)登入驗證(Docker-Compose),翻轉吧金魚腦" name=keywords></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><div id=article-toolbar style=position:sticky;top:5px;z-index:1000><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>返回</span></a></div><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目錄</h2><div class=widget--toc><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#前情提要與架構規劃>前情提要與架構規劃</a></li><li><a href=#目錄結構>目錄結構</a></li><li><a href=#clone代碼建立目錄>Clone代碼，建立目錄</a></li><li><a href=#修改env設定>修改.env設定</a></li><li><a href=#生成憑證>生成憑證</a></li><li><a href=#修改docker-compose設定>修改docker-compose設定</a></li><li><a href=#修改elasticsearch設定>修改elasticsearch設定</a></li><li><a href=#修改kibana設定>修改kibana設定</a></li><li><a href=#修改logstash設定>修改logstash設定</a></li><li><a href=#啟動setup與elasticsearch>啟動setup與elasticsearch</a></li><li><a href=#啟動kibana>啟動kibana</a></li><li><a href=#啟動logstash>啟動logstash</a></li><li><a href=#注意自簽憑證3年到期>(注意)自簽憑證3年到期</a></li><li><a href=#重新頒發憑證並改10年到期>重新頒發憑證(並改10年到期)</a></li></ul></li></ul></li></ul></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/docker/ style=background-color:#005ab5;color:#fff>docker</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/2023/docker-compose-elk-multinodes-cluster/>ELK8.x 多節點集群佈署-啟用security(tls)登入驗證(Docker-Compose)</a></h2><h3 class=article-subtitle>使用docker-compose的方式，快速佈屬ELK8版集群，採角色拆分，佈屬在多節點上，並啟用security(tls)登入驗證</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>2023/10/24</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>閱讀時間: 13 分鐘</time></div></footer></div></header><section class=article-content><section class="toc toc--inline"><h2>目錄</h2><div><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#前情提要與架構規劃>前情提要與架構規劃</a></li><li><a href=#目錄結構>目錄結構</a></li><li><a href=#clone代碼建立目錄>Clone代碼，建立目錄</a></li><li><a href=#修改env設定>修改.env設定</a></li><li><a href=#生成憑證>生成憑證</a></li><li><a href=#修改docker-compose設定>修改docker-compose設定</a></li><li><a href=#修改elasticsearch設定>修改elasticsearch設定</a></li><li><a href=#修改kibana設定>修改kibana設定</a></li><li><a href=#修改logstash設定>修改logstash設定</a></li><li><a href=#啟動setup與elasticsearch>啟動setup與elasticsearch</a></li><li><a href=#啟動kibana>啟動kibana</a></li><li><a href=#啟動logstash>啟動logstash</a></li><li><a href=#注意自簽憑證3年到期>(注意)自簽憑證3年到期</a></li><li><a href=#重新頒發憑證並改10年到期>重新頒發憑證(並改10年到期)</a></li></ul></li></ul></li></ul></nav></div></section><h3 id=前情提要與架構規劃>前情提要與架構規劃</h3><p>參考專案: <a class=link href=https://github.com/deviantony/docker-elk/tree/tls target=_blank rel=noopener>https://github.com/deviantony/docker-elk/tree/tls</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>由於此專案演示的，是將所有角色在單機上佈屬，
</span></span><span class=line><span class=cl>然後我這裡是要示範，如何在跨節點主機上，去佈屬各項角色，達到角色拆分。
</span></span></code></pre></div><p>主機規劃，與角色分配</p><div class=table-wrapper><table><thead><tr><th>主機名稱</th><th>主機IP</th><th>node.name</th><th>角色</th></tr></thead><tbody><tr><td>k8s-master71u</td><td>192.168.1.71</td><td>elasticsearch01</td><td>elasticsearch<br><br>kibana</td></tr><tr><td>k8s-master72u</td><td>192.168.1.72</td><td>elasticsearch02<br><br>logstach02</td><td>elasticsearch<br><br>logstach</td></tr><tr><td>k8s-master73u</td><td>192.168.1.73</td><td>elasticsearch03<br><br>logstach03</td><td>elasticsearch<br><br>logstach</td></tr></tbody></table></div><h3 id=目錄結構>目錄結構</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# tree -a
</span></span><span class=line><span class=cl><span class=c1># 目錄結構</span>
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── docker-compose.yml
</span></span><span class=line><span class=cl>├── elasticsearch
</span></span><span class=line><span class=cl>│   ├── config
</span></span><span class=line><span class=cl>│   │   └── elasticsearch.yml
</span></span><span class=line><span class=cl>│   ├── data
</span></span><span class=line><span class=cl>│   │   ├── .gitignore
</span></span><span class=line><span class=cl>│   ├── Dockerfile
</span></span><span class=line><span class=cl>│   ├── .dockerignore
</span></span><span class=line><span class=cl>│   └── logs
</span></span><span class=line><span class=cl>│       └── .gitignore
</span></span><span class=line><span class=cl>├── .env
</span></span><span class=line><span class=cl>├── etc
</span></span><span class=line><span class=cl>│   ├── localtime
</span></span><span class=line><span class=cl>│   └── timezone
</span></span><span class=line><span class=cl>├── extensions
</span></span><span class=line><span class=cl>│   ├── curator
</span></span><span class=line><span class=cl>│   │   ├── config
</span></span><span class=line><span class=cl>│   │   │   ├── curator.yml
</span></span><span class=line><span class=cl>│   │   │   └── delete_log_files_curator.yml
</span></span><span class=line><span class=cl>│   │   ├── curator-compose.yml
</span></span><span class=line><span class=cl>│   │   ├── Dockerfile
</span></span><span class=line><span class=cl>│   │   ├── .dockerignore
</span></span><span class=line><span class=cl>│   │   └── README.md
</span></span><span class=line><span class=cl>│   ├── enterprise-search
</span></span><span class=line><span class=cl>│   │   ├── config
</span></span><span class=line><span class=cl>│   │   │   └── enterprise-search.yml
</span></span><span class=line><span class=cl>│   │   ├── Dockerfile
</span></span><span class=line><span class=cl>│   │   ├── .dockerignore
</span></span><span class=line><span class=cl>│   │   ├── enterprise-search-compose.yml
</span></span><span class=line><span class=cl>│   │   └── README.md
</span></span><span class=line><span class=cl>│   ├── filebeat
</span></span><span class=line><span class=cl>│   │   ├── config
</span></span><span class=line><span class=cl>│   │   │   └── filebeat.yml
</span></span><span class=line><span class=cl>│   │   ├── Dockerfile
</span></span><span class=line><span class=cl>│   │   ├── .dockerignore
</span></span><span class=line><span class=cl>│   │   ├── filebeat-compose.yml
</span></span><span class=line><span class=cl>│   │   └── README.md
</span></span><span class=line><span class=cl>│   ├── fleet
</span></span><span class=line><span class=cl>│   │   ├── agent-apmserver-compose.yml
</span></span><span class=line><span class=cl>│   │   ├── Dockerfile
</span></span><span class=line><span class=cl>│   │   ├── .dockerignore
</span></span><span class=line><span class=cl>│   │   ├── fleet-compose.yml
</span></span><span class=line><span class=cl>│   │   └── README.md
</span></span><span class=line><span class=cl>│   ├── heartbeat
</span></span><span class=line><span class=cl>│   │   ├── config
</span></span><span class=line><span class=cl>│   │   │   └── heartbeat.yml
</span></span><span class=line><span class=cl>│   │   ├── Dockerfile
</span></span><span class=line><span class=cl>│   │   ├── .dockerignore
</span></span><span class=line><span class=cl>│   │   ├── heartbeat-compose.yml
</span></span><span class=line><span class=cl>│   │   └── README.md
</span></span><span class=line><span class=cl>│   ├── logspout
</span></span><span class=line><span class=cl>│   │   ├── build.sh
</span></span><span class=line><span class=cl>│   │   ├── Dockerfile
</span></span><span class=line><span class=cl>│   │   ├── .dockerignore
</span></span><span class=line><span class=cl>│   │   ├── logspout-compose.yml
</span></span><span class=line><span class=cl>│   │   ├── modules.go
</span></span><span class=line><span class=cl>│   │   └── README.md
</span></span><span class=line><span class=cl>│   ├── metricbeat
</span></span><span class=line><span class=cl>│   │   ├── config
</span></span><span class=line><span class=cl>│   │   │   └── metricbeat.yml
</span></span><span class=line><span class=cl>│   │   ├── Dockerfile
</span></span><span class=line><span class=cl>│   │   ├── .dockerignore
</span></span><span class=line><span class=cl>│   │   ├── metricbeat-compose.yml
</span></span><span class=line><span class=cl>│   │   └── README.md
</span></span><span class=line><span class=cl>│   └── README.md
</span></span><span class=line><span class=cl>├── kibana
</span></span><span class=line><span class=cl>│   ├── config
</span></span><span class=line><span class=cl>│   │   └── kibana.yml
</span></span><span class=line><span class=cl>│   ├── data
</span></span><span class=line><span class=cl>│   ├── Dockerfile
</span></span><span class=line><span class=cl>│   └── .dockerignore
</span></span><span class=line><span class=cl>├── LICENSE
</span></span><span class=line><span class=cl>├── logstash
</span></span><span class=line><span class=cl>│   ├── config
</span></span><span class=line><span class=cl>│   │   └── logstash.yml
</span></span><span class=line><span class=cl>│   ├── Dockerfile
</span></span><span class=line><span class=cl>│   ├── .dockerignore
</span></span><span class=line><span class=cl>│   └── pipeline
</span></span><span class=line><span class=cl>│       └── logstash.conf
</span></span><span class=line><span class=cl>├── README.md
</span></span><span class=line><span class=cl>├── setup
</span></span><span class=line><span class=cl>│   ├── Dockerfile
</span></span><span class=line><span class=cl>│   ├── .dockerignore
</span></span><span class=line><span class=cl>│   ├── entrypoint.sh
</span></span><span class=line><span class=cl>│   ├── lib.sh
</span></span><span class=line><span class=cl>│   └── roles
</span></span><span class=line><span class=cl>│       ├── filebeat_writer.json
</span></span><span class=line><span class=cl>│       ├── heartbeat_writer.json
</span></span><span class=line><span class=cl>│       ├── logstash_writer.json
</span></span><span class=line><span class=cl>│       └── metricbeat_writer.json
</span></span><span class=line><span class=cl>└── tls
</span></span><span class=line><span class=cl>    ├── certs
</span></span><span class=line><span class=cl>    │   ├── apm-server
</span></span><span class=line><span class=cl>    │   │   ├── apm-server.crt
</span></span><span class=line><span class=cl>    │   │   └── apm-server.key
</span></span><span class=line><span class=cl>    │   ├── ca
</span></span><span class=line><span class=cl>    │   │   ├── ca.crt
</span></span><span class=line><span class=cl>    │   │   └── ca.key
</span></span><span class=line><span class=cl>    │   ├── elasticsearch
</span></span><span class=line><span class=cl>    │   │   ├── elasticsearch.crt
</span></span><span class=line><span class=cl>    │   │   └── elasticsearch.key
</span></span><span class=line><span class=cl>    │   ├── fleet-server
</span></span><span class=line><span class=cl>    │   │   ├── fleet-server.crt
</span></span><span class=line><span class=cl>    │   │   └── fleet-server.key
</span></span><span class=line><span class=cl>    │   ├── .gitignore
</span></span><span class=line><span class=cl>    │   └── kibana
</span></span><span class=line><span class=cl>    │       ├── kibana.crt
</span></span><span class=line><span class=cl>    │       └── kibana.key
</span></span><span class=line><span class=cl>    ├── Dockerfile
</span></span><span class=line><span class=cl>    ├── .dockerignore
</span></span><span class=line><span class=cl>    ├── entrypoint.sh
</span></span><span class=line><span class=cl>    ├── instances.yml
</span></span><span class=line><span class=cl>    └── README.md
</span></span></code></pre></div><h3 id=clone代碼建立目錄>Clone代碼，建立目錄</h3><p><strong><font color=red>每一台皆要執行</font></strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># git clone項目</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data# git clone --branch tls https://github.com/deviantony/docker-elk.git
</span></span><span class=line><span class=cl>root@k8s-master71u:/data# <span class=nb>cd</span> docker-elk/
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# ll
</span></span><span class=line><span class=cl>total <span class=m>48</span>
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>10</span> root root  <span class=m>4096</span> Oct <span class=m>23</span> 23:14 ./
</span></span><span class=line><span class=cl>drwxr-xr-x  <span class=m>3</span> root root    <span class=m>24</span> Oct <span class=m>23</span> 23:14 ../
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> root root  <span class=m>5440</span> Oct <span class=m>23</span> 23:14 docker-compose.yml
</span></span><span class=line><span class=cl>drwxr-xr-x  <span class=m>3</span> root root    <span class=m>59</span> Oct <span class=m>23</span> 23:14 elasticsearch/
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> root root  <span class=m>1502</span> Oct <span class=m>23</span> 23:14 .env
</span></span><span class=line><span class=cl>drwxr-xr-x  <span class=m>9</span> root root   <span class=m>143</span> Oct <span class=m>23</span> 23:14 extensions/
</span></span><span class=line><span class=cl>drwxr-xr-x  <span class=m>8</span> root root   <span class=m>163</span> Oct <span class=m>23</span> 23:14 .git/
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> root root    <span class=m>83</span> Oct <span class=m>23</span> 23:14 .gitattributes
</span></span><span class=line><span class=cl>drwxr-xr-x  <span class=m>4</span> root root    <span class=m>45</span> Oct <span class=m>23</span> 23:14 .github/
</span></span><span class=line><span class=cl>drwxr-xr-x  <span class=m>3</span> root root    <span class=m>59</span> Oct <span class=m>23</span> 23:14 kibana/
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> root root  <span class=m>1082</span> Oct <span class=m>23</span> 23:14 LICENSE
</span></span><span class=line><span class=cl>drwxr-xr-x  <span class=m>4</span> root root    <span class=m>75</span> Oct <span class=m>23</span> 23:14 logstash/
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> root root <span class=m>23158</span> Oct <span class=m>23</span> 23:14 README.md
</span></span><span class=line><span class=cl>drwxr-xr-x  <span class=m>3</span> root root    <span class=m>93</span> Oct <span class=m>23</span> 23:14 setup/
</span></span><span class=line><span class=cl>drwxr-xr-x  <span class=m>3</span> root root   <span class=m>117</span> Oct <span class=m>23</span> 23:14 tls/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 建立共用檔案，放置目錄</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# mkdir etc
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# <span class=nb>cd</span> etc/
</span></span><span class=line><span class=cl><span class=c1># 將localtime、timezone，校時與時區檔案傳入</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# chmod <span class=m>777</span> -R etc
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# ll etc/
</span></span><span class=line><span class=cl>total <span class=m>12</span>
</span></span><span class=line><span class=cl>drwxrwxrwx  <span class=m>2</span> root root   <span class=m>39</span> Oct <span class=m>23</span> 23:17 ./
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>11</span> root root <span class=m>4096</span> Oct <span class=m>23</span> 23:15 ../
</span></span><span class=line><span class=cl>-rwxrwxrwx  <span class=m>1</span> root root  <span class=m>764</span> Oct <span class=m>23</span> 23:17 localtime*
</span></span><span class=line><span class=cl>-rwxrwxrwx  <span class=m>1</span> root root   <span class=m>12</span> Oct <span class=m>23</span> 23:17 timezone*
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 建立各功能，所需目錄</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# mkdir elasticsearch/data
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# mkdir elasticsearch/logs
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# chmod <span class=m>777</span> -R elasticsearch/data
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# chmod <span class=m>777</span> -R elasticsearch/logs
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# mkdir kibana/data
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# chmod <span class=m>777</span> -R kibana/data
</span></span></code></pre></div><h3 id=修改env設定>修改.env設定</h3><p><strong><font color=red>每一台皆要執行，ELASTIC版本指定，ELASTIC密碼，LOGSTASH_INTERNAL密碼，KIBANA_SYSTEM密碼，依當下需求修改，每一台保持一樣即可</font></strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@b1-se-prometheus01:/data/docker-elk# cat  .env 
</span></span><span class=line><span class=cl><span class=nv>ELASTIC_VERSION</span><span class=o>=</span>8.6.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Passwords for stack users</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># User &#39;elastic&#39; (built-in)</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Superuser role, full access to cluster management and data indices.</span>
</span></span><span class=line><span class=cl><span class=c1># https://www.elastic.co/guide/en/elasticsearch/reference/current/built-in-users.html</span>
</span></span><span class=line><span class=cl><span class=nv>ELASTIC_PASSWORD</span><span class=o>=</span><span class=s1>&#39;changeme&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># User &#39;logstash_internal&#39; (custom)</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># The user Logstash uses to connect and send data to Elasticsearch.</span>
</span></span><span class=line><span class=cl><span class=c1># https://www.elastic.co/guide/en/logstash/current/ls-security.html</span>
</span></span><span class=line><span class=cl><span class=nv>LOGSTASH_INTERNAL_PASSWORD</span><span class=o>=</span><span class=s1>&#39;changeme&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># User &#39;kibana_system&#39; (built-in)</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># The user Kibana uses to connect and communicate with Elasticsearch.</span>
</span></span><span class=line><span class=cl><span class=c1># https://www.elastic.co/guide/en/elasticsearch/reference/current/built-in-users.html</span>
</span></span><span class=line><span class=cl><span class=nv>KIBANA_SYSTEM_PASSWORD</span><span class=o>=</span><span class=s1>&#39;changeme&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Users &#39;metricbeat_internal&#39;, &#39;filebeat_internal&#39; and &#39;heartbeat_internal&#39; (custom)</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># The users Beats use to connect and send data to Elasticsearch.</span>
</span></span><span class=line><span class=cl><span class=c1># https://www.elastic.co/guide/en/beats/metricbeat/current/feature-roles.html</span>
</span></span><span class=line><span class=cl><span class=nv>METRICBEAT_INTERNAL_PASSWORD</span><span class=o>=</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>FILEBEAT_INTERNAL_PASSWORD</span><span class=o>=</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>HEARTBEAT_INTERNAL_PASSWORD</span><span class=o>=</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># User &#39;monitoring_internal&#39; (custom)</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># The user Metricbeat uses to collect monitoring data from stack components.</span>
</span></span><span class=line><span class=cl><span class=c1># https://www.elastic.co/guide/en/elasticsearch/reference/current/how-monitoring-works.html</span>
</span></span><span class=line><span class=cl><span class=nv>MONITORING_INTERNAL_PASSWORD</span><span class=o>=</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># User &#39;beats_system&#39; (built-in)</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># The user the Beats use when storing monitoring information in Elasticsearch.</span>
</span></span><span class=line><span class=cl><span class=c1># https://www.elastic.co/guide/en/elasticsearch/reference/current/built-in-users.html</span>
</span></span><span class=line><span class=cl><span class=nv>BEATS_SYSTEM_PASSWORD</span><span class=o>=</span><span class=s1>&#39;&#39;</span>
</span></span></code></pre></div><h3 id=生成憑證>生成憑證</h3><p><strong><font color=red>選一台執行，再將生成憑證拷貝至其他主機</font></strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 編寫instances主機資訊，要用來產生憑證</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# vim tls/instances.yml 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># This file is used by elasticsearch-certutil to generate X.509 certificates</span>
</span></span><span class=line><span class=cl><span class=c1># for stack components.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Ref. https://www.elastic.co/guide/en/elasticsearch/reference/current/certutil.html#certutil-silent</span>
</span></span><span class=line><span class=cl><span class=c1># 多instance可以寫一起</span>
</span></span><span class=line><span class=cl>instances:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>- name: elasticsearch
</span></span><span class=line><span class=cl>  dns:
</span></span><span class=line><span class=cl>  - elasticsearch01
</span></span><span class=line><span class=cl>  - elasticsearch02
</span></span><span class=line><span class=cl>  - elasticsearch03
</span></span><span class=line><span class=cl><span class=c1>#  - elasticsearch  # Compose service, resolved by the embedded Docker DNS server name</span>
</span></span><span class=line><span class=cl><span class=c1>#  - localhost      # local connections</span>
</span></span><span class=line><span class=cl>  ip:
</span></span><span class=line><span class=cl>  - 192.168.1.71
</span></span><span class=line><span class=cl>  - 192.168.1.72
</span></span><span class=line><span class=cl>  - 192.168.1.73
</span></span><span class=line><span class=cl><span class=c1>#  - 127.0.0.1      # local connections</span>
</span></span><span class=line><span class=cl><span class=c1>#  - ::1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>- name: kibana
</span></span><span class=line><span class=cl>  dns:
</span></span><span class=line><span class=cl>  - kibana
</span></span><span class=line><span class=cl><span class=c1>#  - kibana.127.0.0.1.nip.io    # Examples of resolvable domains.</span>
</span></span><span class=line><span class=cl><span class=c1>#  - kibana.127.0.0.1.sslip.io  #</span>
</span></span><span class=line><span class=cl><span class=c1>#  - localhost</span>
</span></span><span class=line><span class=cl>  ip:
</span></span><span class=line><span class=cl>  - 192.168.1.71
</span></span><span class=line><span class=cl><span class=c1>#  - 127.0.0.1</span>
</span></span><span class=line><span class=cl><span class=c1>#  - ::1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 執行tls容器，產生憑證</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# docker-compose up tls
</span></span><span class=line><span class=cl>Attaching to docker-elk_tls_1
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span> <span class=o>[</span>+<span class=o>]</span> CA certificate and key
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿ Created
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿ SHA256 fingerprint: 73cfd9c6c9220b46005ae2fcf0c0e1234093a70f4c62741ef9d701b192150a52
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿   tls/certs/ca/ca.crt
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿   tls/certs/ca/ca.key
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span> <span class=o>[</span>+<span class=o>]</span> Server certificates and keys
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿ Created
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿   tls/certs/elasticsearch/elasticsearch.crt
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿   tls/certs/elasticsearch/elasticsearch.key
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿   tls/certs/kibana/kibana.crt
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿   tls/certs/kibana/kibana.key
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿   tls/certs/fleet-server/fleet-server.crt
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿   tls/certs/fleet-server/fleet-server.key
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿   tls/certs/apm-server/apm-server.crt
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿   tls/certs/apm-server/apm-server.key
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# scp -r tls/certs root@192.168.1.72:/data/docker-elk/tls/
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# scp -r tls/certs root@192.168.1.73:/data/docker-elk/tls/
</span></span></code></pre></div><h3 id=修改docker-compose設定>修改docker-compose設定</h3><p><strong><font color=red>每一台皆要執行</font></strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 佈署檔案docker-compose設定</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# vim docker-compose.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>version: <span class=s1>&#39;3.7&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># The &#39;tls&#39; service runs a one-off script which initializes TLS certificates and</span>
</span></span><span class=line><span class=cl>  <span class=c1># private keys for all components of the stack inside the local tls/ directory.</span>
</span></span><span class=line><span class=cl>  <span class=c1>#</span>
</span></span><span class=line><span class=cl>  <span class=c1># This task only needs to be performed once, *before* the first stack startup.</span>
</span></span><span class=line><span class=cl>  <span class=c1>#</span>
</span></span><span class=line><span class=cl>  <span class=c1># By default, it is excluded from the services started by &#39;docker compose up&#39;</span>
</span></span><span class=line><span class=cl>  <span class=c1># due to the non-default profile it belongs to. To run it, either provide the</span>
</span></span><span class=line><span class=cl>  <span class=c1># &#39;--profile=setup&#39; CLI flag to Compose commands, or &#34;up&#34; the service by name</span>
</span></span><span class=line><span class=cl>  <span class=c1># such as &#39;docker compose up tls&#39;.</span>
</span></span><span class=line><span class=cl>  tls:
</span></span><span class=line><span class=cl>    profiles:
</span></span><span class=line><span class=cl>      - setup
</span></span><span class=line><span class=cl>    build:
</span></span><span class=line><span class=cl>      context: tls/
</span></span><span class=line><span class=cl>      args:
</span></span><span class=line><span class=cl>        ELASTIC_VERSION: <span class=si>${</span><span class=nv>ELASTIC_VERSION</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    user: root  <span class=c1># ensures we can write to the local tls/ directory.</span>
</span></span><span class=line><span class=cl>    init: <span class=nb>true</span>
</span></span><span class=line><span class=cl>    volumes:
</span></span><span class=line><span class=cl>      - ./tls/entrypoint.sh:/entrypoint.sh:ro,Z
</span></span><span class=line><span class=cl>      - ./tls/instances.yml:/usr/share/elasticsearch/tls/instances.yml:ro,Z
</span></span><span class=line><span class=cl>      - ./tls/certs:/usr/share/elasticsearch/tls/certs:z
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># The &#39;setup&#39; service runs a one-off script which initializes users inside</span>
</span></span><span class=line><span class=cl>  <span class=c1># Elasticsearch — such as &#39;logstash_internal&#39; and &#39;kibana_system&#39; — with the</span>
</span></span><span class=line><span class=cl>  <span class=c1># values of the passwords defined in the &#39;.env&#39; file. It also creates the</span>
</span></span><span class=line><span class=cl>  <span class=c1># roles required by some of these users.</span>
</span></span><span class=line><span class=cl>  <span class=c1>#</span>
</span></span><span class=line><span class=cl>  <span class=c1># This task only needs to be performed once, during the *initial* startup of</span>
</span></span><span class=line><span class=cl>  <span class=c1># the stack. Any subsequent run will reset the passwords of existing users to</span>
</span></span><span class=line><span class=cl>  <span class=c1># the values defined inside the &#39;.env&#39; file, and the built-in roles to their</span>
</span></span><span class=line><span class=cl>  <span class=c1># default permissions.</span>
</span></span><span class=line><span class=cl>  <span class=c1>#</span>
</span></span><span class=line><span class=cl>  <span class=c1># By default, it is excluded from the services started by &#39;docker compose up&#39;</span>
</span></span><span class=line><span class=cl>  <span class=c1># due to the non-default profile it belongs to. To run it, either provide the</span>
</span></span><span class=line><span class=cl>  <span class=c1># &#39;--profile=setup&#39; CLI flag to Compose commands, or &#34;up&#34; the service by name</span>
</span></span><span class=line><span class=cl>  <span class=c1># such as &#39;docker compose up setup&#39;.</span>
</span></span><span class=line><span class=cl>  setup:
</span></span><span class=line><span class=cl>    profiles:
</span></span><span class=line><span class=cl>      - setup
</span></span><span class=line><span class=cl>    build:
</span></span><span class=line><span class=cl>      context: setup/
</span></span><span class=line><span class=cl>      args:
</span></span><span class=line><span class=cl>        ELASTIC_VERSION: <span class=si>${</span><span class=nv>ELASTIC_VERSION</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    init: <span class=nb>true</span>
</span></span><span class=line><span class=cl>    volumes:
</span></span><span class=line><span class=cl>      - ./setup/entrypoint.sh:/entrypoint.sh:ro,Z
</span></span><span class=line><span class=cl>      - ./setup/lib.sh:/lib.sh:ro,Z
</span></span><span class=line><span class=cl>      - ./setup/roles:/roles:ro,Z
</span></span><span class=line><span class=cl>      <span class=c1># (!) CA certificate. Generate using the &#39;tls&#39; service.</span>
</span></span><span class=line><span class=cl>      - ./tls/certs/ca/ca.crt:/ca.crt:ro,z
</span></span><span class=line><span class=cl>    environment:
</span></span><span class=line><span class=cl>      ELASTIC_PASSWORD: <span class=si>${</span><span class=nv>ELASTIC_PASSWORD</span><span class=k>:-</span><span class=si>}</span>
</span></span><span class=line><span class=cl>      LOGSTASH_INTERNAL_PASSWORD: <span class=si>${</span><span class=nv>LOGSTASH_INTERNAL_PASSWORD</span><span class=k>:-</span><span class=si>}</span>
</span></span><span class=line><span class=cl>      KIBANA_SYSTEM_PASSWORD: <span class=si>${</span><span class=nv>KIBANA_SYSTEM_PASSWORD</span><span class=k>:-</span><span class=si>}</span>
</span></span><span class=line><span class=cl>      METRICBEAT_INTERNAL_PASSWORD: <span class=si>${</span><span class=nv>METRICBEAT_INTERNAL_PASSWORD</span><span class=k>:-</span><span class=si>}</span>
</span></span><span class=line><span class=cl>      FILEBEAT_INTERNAL_PASSWORD: <span class=si>${</span><span class=nv>FILEBEAT_INTERNAL_PASSWORD</span><span class=k>:-</span><span class=si>}</span>
</span></span><span class=line><span class=cl>      HEARTBEAT_INTERNAL_PASSWORD: <span class=si>${</span><span class=nv>HEARTBEAT_INTERNAL_PASSWORD</span><span class=k>:-</span><span class=si>}</span>
</span></span><span class=line><span class=cl>      MONITORING_INTERNAL_PASSWORD: <span class=si>${</span><span class=nv>MONITORING_INTERNAL_PASSWORD</span><span class=k>:-</span><span class=si>}</span>
</span></span><span class=line><span class=cl>      BEATS_SYSTEM_PASSWORD: <span class=si>${</span><span class=nv>BEATS_SYSTEM_PASSWORD</span><span class=k>:-</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    networks:
</span></span><span class=line><span class=cl>      - elk
</span></span><span class=line><span class=cl>    depends_on:
</span></span><span class=line><span class=cl>      - elasticsearch
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  elasticsearch:
</span></span><span class=line><span class=cl>    build:
</span></span><span class=line><span class=cl>      context: elasticsearch/
</span></span><span class=line><span class=cl>      args:
</span></span><span class=line><span class=cl>        ELASTIC_VERSION: <span class=si>${</span><span class=nv>ELASTIC_VERSION</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    volumes:
</span></span><span class=line><span class=cl>      - ./elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro,Z
</span></span><span class=line><span class=cl>      <span class=c1># elasticsearch存放data與logs目錄，依需求自行定義</span>
</span></span><span class=line><span class=cl>      - ./elasticsearch/data:/usr/share/elasticsearch/data:Z
</span></span><span class=line><span class=cl>      - ./elasticsearch/logs:/usr/share/elasticsearch/logs:Z
</span></span><span class=line><span class=cl>      <span class=c1># (!) TLS certificates. Generate using the &#39;tls&#39; service.</span>
</span></span><span class=line><span class=cl>      - ./tls/certs/ca/ca.crt:/usr/share/elasticsearch/config/ca.crt:ro,z
</span></span><span class=line><span class=cl>      - ./tls/certs/elasticsearch/elasticsearch.crt:/usr/share/elasticsearch/config/elasticsearch.crt:ro,z
</span></span><span class=line><span class=cl>      - ./tls/certs/elasticsearch/elasticsearch.key:/usr/share/elasticsearch/config/elasticsearch.key:ro,z
</span></span><span class=line><span class=cl>      <span class=c1># 校時文件</span>
</span></span><span class=line><span class=cl>      - ./etc/localtime:/etc/localtime
</span></span><span class=line><span class=cl>      - ./etc/timezone:/etc/timezone
</span></span><span class=line><span class=cl>    ports:
</span></span><span class=line><span class=cl>      - 9200:9200
</span></span><span class=line><span class=cl>      - 9300:9300
</span></span><span class=line><span class=cl>    environment:
</span></span><span class=line><span class=cl>      <span class=c1># node.name 每一台要不一樣</span>
</span></span><span class=line><span class=cl>      node.name: elasticsearch01
</span></span><span class=line><span class=cl>      ES_JAVA_OPTS: -Xms512m -Xmx512m
</span></span><span class=line><span class=cl>      <span class=c1># Bootstrap password.</span>
</span></span><span class=line><span class=cl>      <span class=c1># Used to initialize the keystore during the initial startup of</span>
</span></span><span class=line><span class=cl>      <span class=c1># Elasticsearch. Ignored on subsequent runs.</span>
</span></span><span class=line><span class=cl>      ELASTIC_PASSWORD: <span class=si>${</span><span class=nv>ELASTIC_PASSWORD</span><span class=k>:-</span><span class=si>}</span>
</span></span><span class=line><span class=cl>      <span class=c1># Use single node discovery in order to disable production mode and avoid bootstrap checks.</span>
</span></span><span class=line><span class=cl>      <span class=c1># see: https://www.elastic.co/guide/en/elasticsearch/reference/current/bootstrap-checks.html</span>
</span></span><span class=line><span class=cl>      <span class=c1>#discovery.type: single-node</span>
</span></span><span class=line><span class=cl>      <span class=c1># 主機IP</span>
</span></span><span class=line><span class=cl>      network.publish_host: 192.168.1.71
</span></span><span class=line><span class=cl>      <span class=c1># Use other cluster nodes for unicast discovery.</span>
</span></span><span class=line><span class=cl>      discovery.seed_hosts: 192.168.1.71:9300,192.168.1.72:9300,192.168.1.73:9300
</span></span><span class=line><span class=cl>      <span class=c1># Define initial masters, assuming a cluster size of at least 3.</span>
</span></span><span class=line><span class=cl>      cluster.initial_master_nodes: 192.168.1.71,192.168.1.72,192.168.1.73
</span></span><span class=line><span class=cl>    networks:
</span></span><span class=line><span class=cl>      - elk
</span></span><span class=line><span class=cl>    restart: unless-stopped
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  logstash:
</span></span><span class=line><span class=cl>    build:
</span></span><span class=line><span class=cl>      context: logstash/
</span></span><span class=line><span class=cl>      args:
</span></span><span class=line><span class=cl>        ELASTIC_VERSION: <span class=si>${</span><span class=nv>ELASTIC_VERSION</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    volumes:
</span></span><span class=line><span class=cl>      - ./logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml:ro,Z
</span></span><span class=line><span class=cl>      - ./logstash/pipeline:/usr/share/logstash/pipeline:ro,Z
</span></span><span class=line><span class=cl>      <span class=c1># (!) CA certificate. Generate using the &#39;tls&#39; service.</span>
</span></span><span class=line><span class=cl>      - ./tls/certs/ca/ca.crt:/usr/share/logstash/config/ca.crt:ro,z
</span></span><span class=line><span class=cl>      <span class=c1># 校時文件</span>
</span></span><span class=line><span class=cl>      - ./etc/localtime:/etc/localtime
</span></span><span class=line><span class=cl>      - ./etc/timezone:/etc/timezone
</span></span><span class=line><span class=cl>    ports:
</span></span><span class=line><span class=cl>      - 5044:5044
</span></span><span class=line><span class=cl>      - 50000:50000/tcp
</span></span><span class=line><span class=cl>      - 50000:50000/udp
</span></span><span class=line><span class=cl>      - 9600:9600
</span></span><span class=line><span class=cl>    environment:
</span></span><span class=line><span class=cl>      LS_JAVA_OPTS: -Xms256m -Xmx256m
</span></span><span class=line><span class=cl>      LOGSTASH_INTERNAL_PASSWORD: <span class=si>${</span><span class=nv>LOGSTASH_INTERNAL_PASSWORD</span><span class=k>:-</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    networks:
</span></span><span class=line><span class=cl>      - elk
</span></span><span class=line><span class=cl>    depends_on:
</span></span><span class=line><span class=cl>      - elasticsearch
</span></span><span class=line><span class=cl>    restart: unless-stopped
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kibana:
</span></span><span class=line><span class=cl>    build:
</span></span><span class=line><span class=cl>      context: kibana/
</span></span><span class=line><span class=cl>      args:
</span></span><span class=line><span class=cl>        ELASTIC_VERSION: <span class=si>${</span><span class=nv>ELASTIC_VERSION</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    volumes:
</span></span><span class=line><span class=cl>      - ./kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml:ro,Z
</span></span><span class=line><span class=cl>      <span class=c1># kibana存放data目錄，依需求自行定義</span>
</span></span><span class=line><span class=cl>      - ./kibana/data:/usr/share/kibana/data:Z
</span></span><span class=line><span class=cl>      <span class=c1># (!) TLS certificates. Generate using the &#39;tls&#39; service.</span>
</span></span><span class=line><span class=cl>      - ./tls/certs/ca/ca.crt:/usr/share/kibana/config/ca.crt:ro,z
</span></span><span class=line><span class=cl>      - ./tls/certs/kibana/kibana.crt:/usr/share/kibana/config/kibana.crt:ro,Z
</span></span><span class=line><span class=cl>      - ./tls/certs/kibana/kibana.key:/usr/share/kibana/config/kibana.key:ro,Z
</span></span><span class=line><span class=cl>      <span class=c1># 校時文件</span>
</span></span><span class=line><span class=cl>      - ./etc/localtime:/etc/localtime
</span></span><span class=line><span class=cl>      - ./etc/timezone:/etc/timezone
</span></span><span class=line><span class=cl>    ports:
</span></span><span class=line><span class=cl>      - 5601:5601
</span></span><span class=line><span class=cl>    environment:
</span></span><span class=line><span class=cl>      KIBANA_SYSTEM_PASSWORD: <span class=si>${</span><span class=nv>KIBANA_SYSTEM_PASSWORD</span><span class=k>:-</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    networks:
</span></span><span class=line><span class=cl>      - elk
</span></span><span class=line><span class=cl>    depends_on:
</span></span><span class=line><span class=cl>      - elasticsearch
</span></span><span class=line><span class=cl>    restart: unless-stopped
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>networks:
</span></span><span class=line><span class=cl>  elk:
</span></span><span class=line><span class=cl>    driver: bridge
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>volumes:
</span></span><span class=line><span class=cl>  elasticsearch:
</span></span></code></pre></div><h3 id=修改elasticsearch設定>修改elasticsearch設定</h3><p><strong><font color=red>需要安裝elasticsearch的執行</font></strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># elasticsearch 設定檔設定</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# vim elasticsearch/config/elasticsearch.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl><span class=c1>## Default Elasticsearch configuration from Elasticsearch base image.</span>
</span></span><span class=line><span class=cl><span class=c1>## https://github.com/elastic/elasticsearch/blob/main/distribution/docker/src/docker/config/elasticsearch.yml</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># cluster.name名稱，依需求自行定義</span>
</span></span><span class=line><span class=cl>cluster.name: elk-cluster
</span></span><span class=line><span class=cl>network.host: 0.0.0.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## X-Pack settings</span>
</span></span><span class=line><span class=cl><span class=c1>## see https://www.elastic.co/guide/en/elasticsearch/reference/current/security-settings.html</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># 修改license，由trial改成basic</span>
</span></span><span class=line><span class=cl>xpack.license.self_generated.type: basic
</span></span><span class=line><span class=cl>xpack.security.enabled: <span class=nb>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##</span>
</span></span><span class=line><span class=cl><span class=c1>## TLS configuration</span>
</span></span><span class=line><span class=cl><span class=c1>## See instructions from README to enable.</span>
</span></span><span class=line><span class=cl><span class=c1>##</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Communications between nodes in a cluster</span>
</span></span><span class=line><span class=cl><span class=c1>## see https://www.elastic.co/guide/en/elasticsearch/reference/current/configuring-tls.html#tls-transport</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl>xpack.security.transport.ssl.enabled: <span class=nb>true</span>
</span></span><span class=line><span class=cl>xpack.security.transport.ssl.verification_mode: certificate
</span></span><span class=line><span class=cl>xpack.security.transport.ssl.certificate_authorities: <span class=o>[</span> ca.crt <span class=o>]</span>
</span></span><span class=line><span class=cl>xpack.security.transport.ssl.certificate: elasticsearch.crt
</span></span><span class=line><span class=cl>xpack.security.transport.ssl.key: elasticsearch.key
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## HTTP client communications</span>
</span></span><span class=line><span class=cl><span class=c1>## see https://www.elastic.co/guide/en/elasticsearch/reference/current/configuring-tls.html#tls-http</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl>xpack.security.http.ssl.enabled: <span class=nb>true</span>
</span></span><span class=line><span class=cl>xpack.security.http.ssl.certificate_authorities: <span class=o>[</span> ca.crt <span class=o>]</span>
</span></span><span class=line><span class=cl>xpack.security.http.ssl.certificate: elasticsearch.crt
</span></span><span class=line><span class=cl>xpack.security.http.ssl.key: elasticsearch.key
</span></span></code></pre></div><h3 id=修改kibana設定>修改kibana設定</h3><p><strong><font color=red>需要安裝kibana的執行</font></strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># kibana 設定檔設定</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# vim kibana/config/kibana.yml
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl><span class=c1>## Default Kibana configuration from Kibana base image.</span>
</span></span><span class=line><span class=cl><span class=c1>## https://github.com/elastic/kibana/blob/main/src/dev/build/tasks/os_packages/docker_generator/templates/kibana_yml.template.ts</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl>server.name: kibana
</span></span><span class=line><span class=cl>server.host: 0.0.0.0
</span></span><span class=line><span class=cl><span class=c1># 多節點elasticsearch，都寫上</span>
</span></span><span class=line><span class=cl>elasticsearch.hosts: <span class=o>[</span> <span class=s2>&#34;https://192.168.1.71:9200&#34;</span>,<span class=s2>&#34;https://192.168.1.72:9200&#34;</span>,<span class=s2>&#34;https://192.168.1.73:9200&#34;</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>monitoring.ui.container.elasticsearch.enabled: <span class=nb>true</span>
</span></span><span class=line><span class=cl>monitoring.ui.container.logstash.enabled: <span class=nb>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## X-Pack security credentials</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl>elasticsearch.username: kibana_system
</span></span><span class=line><span class=cl>elasticsearch.password: <span class=si>${</span><span class=nv>KIBANA_SYSTEM_PASSWORD</span><span class=si>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##</span>
</span></span><span class=line><span class=cl><span class=c1>## TLS configuration</span>
</span></span><span class=line><span class=cl><span class=c1>## See instructions from README to enable.</span>
</span></span><span class=line><span class=cl><span class=c1>##</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Communications between Kibana and Elasticsearch</span>
</span></span><span class=line><span class=cl><span class=c1>## see https://www.elastic.co/guide/en/kibana/current/configuring-tls.html#configuring-tls-kib-es</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># 寫上根憑證位置</span>
</span></span><span class=line><span class=cl>elasticsearch.ssl.certificateAuthorities: <span class=o>[</span> config/ca.crt <span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Communications between web browsers and Kibana</span>
</span></span><span class=line><span class=cl><span class=c1>## see https://www.elastic.co/guide/en/kibana/current/configuring-tls.html#configuring-tls-browser-kib</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># 開啟kibana ssl，填寫憑證位置</span>
</span></span><span class=line><span class=cl>server.ssl.enabled: <span class=nb>true</span>
</span></span><span class=line><span class=cl>server.ssl.certificate: config/kibana.crt
</span></span><span class=line><span class=cl>server.ssl.key: config/kibana.key
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Encryption keys (optional but highly recommended)</span>
</span></span><span class=line><span class=cl><span class=c1>##</span>
</span></span><span class=line><span class=cl><span class=c1>## Generate with either</span>
</span></span><span class=line><span class=cl><span class=c1>##  $ docker container run --rm docker.elastic.co/kibana/kibana:8.6.2 bin/kibana-encryption-keys generate</span>
</span></span><span class=line><span class=cl><span class=c1>##  $ openssl rand -hex 32</span>
</span></span><span class=line><span class=cl><span class=c1>##</span>
</span></span><span class=line><span class=cl><span class=c1>## https://www.elastic.co/guide/en/kibana/current/using-kibana-with-security.html</span>
</span></span><span class=line><span class=cl><span class=c1>## https://www.elastic.co/guide/en/kibana/current/kibana-encryption-keys.html</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>#xpack.security.encryptionKey:</span>
</span></span><span class=line><span class=cl><span class=c1>#xpack.encryptedSavedObjects.encryptionKey:</span>
</span></span><span class=line><span class=cl><span class=c1>#xpack.reporting.encryptionKey:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Fleet</span>
</span></span><span class=line><span class=cl><span class=c1>## https://www.elastic.co/guide/en/kibana/current/fleet-settings-kb.html</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl>xpack.fleet.agents.fleet_server.hosts: <span class=o>[</span> https://fleet-server:8220 <span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>xpack.fleet.outputs:
</span></span><span class=line><span class=cl>  - id: fleet-default-output
</span></span><span class=line><span class=cl>    name: default
</span></span><span class=line><span class=cl>    type: elasticsearch
</span></span><span class=line><span class=cl>    <span class=c1># 多節點elasticsearch，都寫上</span>
</span></span><span class=line><span class=cl>    hosts: <span class=o>[</span> <span class=s2>&#34;https://192.168.1.71:9200&#34;</span>,<span class=s2>&#34;https://192.168.1.72:9200&#34;</span>,<span class=s2>&#34;https://192.168.1.73:9200&#34;</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=c1># Set to output of &#39;docker-compose up tls&#39;. Example:</span>
</span></span><span class=line><span class=cl>    <span class=c1>#ca_trusted_fingerprint: 846637d1bb82209640d31b79869a370c8e47c2dc15c7eafd4f3d615e51e3d503</span>
</span></span><span class=line><span class=cl>    is_default: <span class=nb>true</span>
</span></span><span class=line><span class=cl>    is_default_monitoring: <span class=nb>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>xpack.fleet.packages:
</span></span><span class=line><span class=cl>  - name: fleet_server
</span></span><span class=line><span class=cl>    version: latest
</span></span><span class=line><span class=cl>  - name: system
</span></span><span class=line><span class=cl>    version: latest
</span></span><span class=line><span class=cl>  - name: elastic_agent
</span></span><span class=line><span class=cl>    version: latest
</span></span><span class=line><span class=cl>  - name: apm
</span></span><span class=line><span class=cl>    version: latest
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>xpack.fleet.agentPolicies:
</span></span><span class=line><span class=cl>  - name: Fleet Server Policy
</span></span><span class=line><span class=cl>    id: fleet-server-policy
</span></span><span class=line><span class=cl>    description: Static agent policy <span class=k>for</span> Fleet Server
</span></span><span class=line><span class=cl>    monitoring_enabled:
</span></span><span class=line><span class=cl>      - logs
</span></span><span class=line><span class=cl>      - metrics
</span></span><span class=line><span class=cl>    package_policies:
</span></span><span class=line><span class=cl>      - name: fleet_server-1
</span></span><span class=line><span class=cl>        package:
</span></span><span class=line><span class=cl>          name: fleet_server
</span></span><span class=line><span class=cl>      - name: system-1
</span></span><span class=line><span class=cl>        package:
</span></span><span class=line><span class=cl>          name: system
</span></span><span class=line><span class=cl>      - name: elastic_agent-1
</span></span><span class=line><span class=cl>        package:
</span></span><span class=line><span class=cl>          name: elastic_agent
</span></span><span class=line><span class=cl>  - name: Agent Policy APM Server
</span></span><span class=line><span class=cl>    id: agent-policy-apm-server
</span></span><span class=line><span class=cl>    description: Static agent policy <span class=k>for</span> the APM Server integration
</span></span><span class=line><span class=cl>    monitoring_enabled:
</span></span><span class=line><span class=cl>      - logs
</span></span><span class=line><span class=cl>      - metrics
</span></span><span class=line><span class=cl>    package_policies:
</span></span><span class=line><span class=cl>      - name: system-1
</span></span><span class=line><span class=cl>        package:
</span></span><span class=line><span class=cl>          name: system
</span></span><span class=line><span class=cl>      - name: elastic_agent-1
</span></span><span class=line><span class=cl>        package:
</span></span><span class=line><span class=cl>          name: elastic_agent
</span></span><span class=line><span class=cl>      - name: apm-1
</span></span><span class=line><span class=cl>        package:
</span></span><span class=line><span class=cl>          name: apm
</span></span><span class=line><span class=cl>        <span class=c1># See the APM package manifest for a list of possible inputs.</span>
</span></span><span class=line><span class=cl>        <span class=c1># https://github.com/elastic/apm-server/blob/v8.5.0/apmpackage/apm/manifest.yml#L41-L168</span>
</span></span><span class=line><span class=cl>        inputs:
</span></span><span class=line><span class=cl>          - type: apm
</span></span><span class=line><span class=cl>            vars:
</span></span><span class=line><span class=cl>              - name: host
</span></span><span class=line><span class=cl>                value: 0.0.0.0:8200
</span></span><span class=line><span class=cl>              - name: url
</span></span><span class=line><span class=cl>                value: https://apm-server:8200
</span></span><span class=line><span class=cl>              - name: tls_enabled
</span></span><span class=line><span class=cl>                value: <span class=nb>true</span>
</span></span><span class=line><span class=cl>              - name: tls_certificate
</span></span><span class=line><span class=cl>                value: /usr/share/elastic-agent/apm-server.crt
</span></span><span class=line><span class=cl>              - name: tls_key
</span></span><span class=line><span class=cl>                value: /usr/share/elastic-agent/apm-server.key
</span></span></code></pre></div><h3 id=修改logstash設定>修改logstash設定</h3><p><strong><font color=red>需要安裝logstash的執行</font></strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># logstash 設定檔設定</span>
</span></span><span class=line><span class=cl>root@k8s-master72u:/data/docker-elk# vim logstash/config/logstash.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl><span class=c1>## Default Logstash configuration from Logstash base image.</span>
</span></span><span class=line><span class=cl><span class=c1>## https://github.com/elastic/logstash/blob/main/docker/data/logstash/config/logstash-full.yml</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl>http.host: 0.0.0.0
</span></span><span class=line><span class=cl><span class=c1># node.name 每一台要不一樣</span>
</span></span><span class=line><span class=cl>node.name: logstash02
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 測試抓容器內的log，發送到elasticsearch是否成功</span>
</span></span><span class=line><span class=cl>root@k8s-master72u:/data/docker-elk# vim logstash/pipeline/logstash.conf
</span></span><span class=line><span class=cl>input <span class=o>{</span>
</span></span><span class=line><span class=cl>        beats <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nv>port</span> <span class=o>=</span>&gt; <span class=m>5044</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        tcp <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nv>port</span> <span class=o>=</span>&gt; <span class=m>50000</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        file <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nv>path</span> <span class=o>=</span>&gt; <span class=o>[</span><span class=s2>&#34;/var/log/bootstrap.log&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>                <span class=nb>type</span> <span class=o>=</span>&gt; <span class=s2>&#34;system&#34;</span>
</span></span><span class=line><span class=cl>                <span class=nv>start_position</span> <span class=o>=</span>&gt; <span class=s2>&#34;beginning&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Add your filters / logstash plugins configuration here</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>output <span class=o>{</span>
</span></span><span class=line><span class=cl>        elasticsearch <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nv>hosts</span> <span class=o>=</span>&gt; <span class=o>[</span><span class=s2>&#34;192.168.1.71:9200&#34;</span>,<span class=s2>&#34;192.168.1.72:9200&#34;</span>,<span class=s2>&#34;192.168.1.73:9200&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>                <span class=nv>user</span> <span class=o>=</span>&gt; <span class=s2>&#34;logstash_internal&#34;</span>
</span></span><span class=line><span class=cl>                <span class=nv>password</span> <span class=o>=</span>&gt; <span class=s2>&#34;</span><span class=si>${</span><span class=nv>LOGSTASH_INTERNAL_PASSWORD</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                <span class=nv>ssl</span> <span class=o>=</span>&gt; <span class=nb>true</span>
</span></span><span class=line><span class=cl>                <span class=nv>cacert</span> <span class=o>=</span>&gt; <span class=s2>&#34;config/ca.crt&#34;</span>
</span></span><span class=line><span class=cl>                <span class=nv>index</span> <span class=o>=</span>&gt; <span class=s2>&#34;logstash-%{+YYYY.MM.dd}&#34;</span>
</span></span><span class=line><span class=cl>                <span class=nv>codec</span> <span class=o>=</span>&gt; <span class=s2>&#34;rubydebug&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=啟動setup與elasticsearch>啟動setup與elasticsearch</h3><p><strong><font color=red>需要安裝elasticsearch的執行</font></strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># setup腳本會帶憑證去判斷elasticsearch是否存活了，判斷存活才會設定elasticsearch所需要的帳號和密碼</span>
</span></span><span class=line><span class=cl><span class=c1># 所以將setup腳本中的環境變數elasticsearch:9200，替換成node.name名稱(前面有定義過)</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# sed -i <span class=s1>&#39;s/elasticsearch:9200/elasticsearch01:9200/g&#39;</span> setup/lib.sh 
</span></span><span class=line><span class=cl>root@k8s-master72u:/data/docker-elk# sed -i <span class=s1>&#39;s/elasticsearch:9200/elasticsearch02:9200/g&#39;</span> setup/lib.sh
</span></span><span class=line><span class=cl>root@k8s-master73u:/data/docker-elk# sed -i <span class=s1>&#39;s/elasticsearch:9200/elasticsearch03:9200/g&#39;</span> setup/lib.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加hosts，node.name</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# vim /etc/hosts
</span></span><span class=line><span class=cl>192.168.1.71 elasticsearch01
</span></span><span class=line><span class=cl>192.168.1.72 elasticsearch02
</span></span><span class=line><span class=cl>192.168.1.73 elasticsearch03
</span></span><span class=line><span class=cl>root@k8s-master72u:/data/docker-elk# vim /etc/hosts
</span></span><span class=line><span class=cl>192.168.1.71 elasticsearch01
</span></span><span class=line><span class=cl>192.168.1.72 elasticsearch02
</span></span><span class=line><span class=cl>192.168.1.73 elasticsearch03
</span></span><span class=line><span class=cl>root@k8s-master73u:/data/docker-elk# vim /etc/hosts
</span></span><span class=line><span class=cl>192.168.1.71 elasticsearch01
</span></span><span class=line><span class=cl>192.168.1.72 elasticsearch02
</span></span><span class=line><span class=cl>192.168.1.73 elasticsearch03
</span></span></code></pre></div><p>**<font color=red>需要安裝elasticsearch的執行</font></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 執行setup容器，啟動elasticsearch，並設定elasticsearch所需要使用到的帳號和密碼</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# docker-compose up setup
</span></span><span class=line><span class=cl>root@k8s-master72u:/data/docker-elk# docker-compose up setup
</span></span><span class=line><span class=cl>root@k8s-master73u:/data/docker-elk# docker-compose up setup
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 可以看到以下，就是elasticsearch成功啟動，且已設定elasticsearch所需要使用到的帳號和密碼</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# docker-compose up setup
</span></span><span class=line><span class=cl>docker-elk_elasticsearch_1 is up-to-date
</span></span><span class=line><span class=cl>Starting docker-elk_setup_1 ... <span class=k>done</span>
</span></span><span class=line><span class=cl>Attaching to docker-elk_setup_1
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span> <span class=o>[</span>+<span class=o>]</span> Waiting <span class=k>for</span> availability of Elasticsearch. This can take several minutes.
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span>    ⠿ Elasticsearch is running
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span> <span class=o>[</span>+<span class=o>]</span> Waiting <span class=k>for</span> initialization of built-in users
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span>    ⠿ Built-in users were initialized
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span> <span class=o>[</span>+<span class=o>]</span> Role <span class=s1>&#39;heartbeat_writer&#39;</span>
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span>    ⠿ Creating/updating
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span> <span class=o>[</span>+<span class=o>]</span> Role <span class=s1>&#39;metricbeat_writer&#39;</span>
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span>    ⠿ Creating/updating
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span> <span class=o>[</span>+<span class=o>]</span> Role <span class=s1>&#39;filebeat_writer&#39;</span>
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span>    ⠿ Creating/updating
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span> <span class=o>[</span>+<span class=o>]</span> Role <span class=s1>&#39;logstash_writer&#39;</span>
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span>    ⠿ Creating/updating
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span> <span class=o>[</span>+<span class=o>]</span> User <span class=s1>&#39;filebeat_internal&#39;</span>
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span>    ⠿ No password defined, skipping
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span> <span class=o>[</span>+<span class=o>]</span> User <span class=s1>&#39;kibana_system&#39;</span>
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span>    ⠿ User exists, setting password
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span> <span class=o>[</span>+<span class=o>]</span> User <span class=s1>&#39;logstash_internal&#39;</span>
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span>    ⠿ User exists, setting password
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span> <span class=o>[</span>+<span class=o>]</span> User <span class=s1>&#39;heartbeat_internal&#39;</span>
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span>    ⠿ No password defined, skipping
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span> <span class=o>[</span>+<span class=o>]</span> User <span class=s1>&#39;metricbeat_internal&#39;</span>
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span>    ⠿ No password defined, skipping
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span> <span class=o>[</span>+<span class=o>]</span> User <span class=s1>&#39;monitoring_internal&#39;</span>
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span>    ⠿ No password defined, skipping
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span> <span class=o>[</span>+<span class=o>]</span> User <span class=s1>&#39;beats_system&#39;</span>
</span></span><span class=line><span class=cl>setup_1          <span class=p>|</span>    ⠿ No password defined, skipping
</span></span><span class=line><span class=cl>docker-elk_setup_1 exited with code <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# docker ps <span class=p>|</span> grep -i elk
</span></span><span class=line><span class=cl>13130e0e2653   docker-elk_elasticsearch    <span class=s2>&#34;/bin/tini -- /usr/l…&#34;</span>   <span class=m>3</span> minutes ago   Up <span class=m>3</span> minutes   0.0.0.0:9200-&gt;9200/tcp, :::9200-&gt;9200/tcp, 0.0.0.0:9300-&gt;9300/tcp, :::9300-&gt;9300/tcp   docker-elk_elasticsearch_1
</span></span></code></pre></div><p>https://192.168.1.71:9200/</p><p><img src=/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024220535.png width=905 height=308 srcset="/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024220535_hu7687eda4f9ca66bf49c5100d449e1522_33921_480x0_resize_box_3.png 480w, /2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024220535_hu7687eda4f9ca66bf49c5100d449e1522_33921_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=293 data-flex-basis=705px></p><p><img src=/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024220559.png width=505 height=392 srcset="/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024220559_huc23ed2490624e48fc2f5f8eb872c5fde_55184_480x0_resize_box_3.png 480w, /2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024220559_huc23ed2490624e48fc2f5f8eb872c5fde_55184_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=128 data-flex-basis=309px></p><p>https://192.168.1.71:9200/_cat/health?v</p><p><img src=/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024220713.png width=1160 height=188 srcset="/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024220713_hud0e7452ea50f0a65183a6bf5bfa5fbfb_37341_480x0_resize_box_3.png 480w, /2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024220713_hud0e7452ea50f0a65183a6bf5bfa5fbfb_37341_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=617 data-flex-basis=1480px></p><h3 id=啟動kibana>啟動kibana</h3><p><strong><font color=red>需要安裝kibana的執行</font></strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 執行kibana容器，啟動kibana</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# docker-compose up -d kibana
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# docker ps <span class=p>|</span> grep -i elk
</span></span><span class=line><span class=cl>a652860861bc   docker-elk_kibana           <span class=s2>&#34;/bin/tini -- /usr/l…&#34;</span>   <span class=m>45</span> seconds ago   Up <span class=m>38</span> seconds   0.0.0.0:5601-&gt;5601/tcp, :::5601-&gt;5601/tcp                                              docker-elk_kibana_1
</span></span><span class=line><span class=cl>13130e0e2653   docker-elk_elasticsearch    <span class=s2>&#34;/bin/tini -- /usr/l…&#34;</span>   <span class=m>11</span> minutes ago   Up <span class=m>11</span> minutes   0.0.0.0:9200-&gt;9200/tcp, :::9200-&gt;9200/tcp, 0.0.0.0:9300-&gt;9300/tcp, :::9300-&gt;9300/tcp   docker-elk_elasticsearch_1
</span></span></code></pre></div><p>https://192.168.1.71:5601/</p><p><img src=/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221117.png width=950 height=635 srcset="/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221117_hu5ccbdcd97d532a51c81b93dd17f0c90c_47418_480x0_resize_box_3.png 480w, /2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221117_hu5ccbdcd97d532a51c81b93dd17f0c90c_47418_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=149 data-flex-basis=359px></p><p><img src=/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221159.png width=1491 height=980 srcset="/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221159_hu718524bc52e4e726c36836bd028cf749_209262_480x0_resize_box_3.png 480w, /2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221159_hu718524bc52e4e726c36836bd028cf749_209262_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=152 data-flex-basis=365px></p><h3 id=啟動logstash>啟動logstash</h3><p><strong>需要安裝logstash的執行</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 執行logstash容器，啟動logstash</span>
</span></span><span class=line><span class=cl>root@k8s-master72u:/data/docker-elk# docker-compose up -d logstash
</span></span><span class=line><span class=cl>root@k8s-master73u:/data/docker-elk# docker-compose up -d logstash
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master72u:/data/docker-elk# docker ps <span class=p>|</span> grep -i elk
</span></span><span class=line><span class=cl>c7712d2eb7bd   docker-elk_logstash         <span class=s2>&#34;/usr/local/bin/dock…&#34;</span>   <span class=m>31</span> seconds ago   Up <span class=m>30</span> seconds   0.0.0.0:5044-&gt;5044/tcp, :::5044-&gt;5044/tcp, 0.0.0.0:9600-&gt;9600/tcp, :::9600-&gt;9600/tcp, 0.0.0.0:50000-&gt;50000/tcp, :::50000-&gt;50000/tcp, 0.0.0.0:50000-&gt;50000/udp, :::50000-&gt;50000/udp   docker-elk_logstash_1
</span></span><span class=line><span class=cl>678934a90729   docker-elk_elasticsearch    <span class=s2>&#34;/bin/tini -- /usr/l…&#34;</span>   <span class=m>13</span> minutes ago   Up <span class=m>13</span> minutes   0.0.0.0:9200-&gt;9200/tcp, :::9200-&gt;9200/tcp, 0.0.0.0:9300-&gt;9300/tcp, :::9300-&gt;9300/tcp                                                                                                 docker-elk_elasticsearch_1
</span></span></code></pre></div><p>可以從kibana頁面看到，有索引進來了</p><p><img src=/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221559.png width=1486 height=644 srcset="/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221559_hu0b65a9bd0ec421a6e5979f34902073e3_129987_480x0_resize_box_3.png 480w, /2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221559_hu0b65a9bd0ec421a6e5979f34902073e3_129987_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=230 data-flex-basis=553px></p><p>創建Data Views</p><p><img src=/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221647.png width=1491 height=876 srcset="/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221647_huef1bb4750e7f138a139312e6bed51d22_134314_480x0_resize_box_3.png 480w, /2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221647_huef1bb4750e7f138a139312e6bed51d22_134314_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=170 data-flex-basis=408px></p><p><img src=/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221736.png width=1120 height=454 srcset="/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221736_hue70087df2ebefe204471f1fb69cf1ec7_53471_480x0_resize_box_3.png 480w, /2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221736_hue70087df2ebefe204471f1fb69cf1ec7_53471_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=246 data-flex-basis=592px></p><p>可以從Discover查看到收集的log訊息了</p><p><img src=/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221820.png width=1500 height=994 srcset="/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221820_hu10c771c26dc4325490ea3a8693f83a9e_288133_480x0_resize_box_3.png 480w, /2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221820_hu10c771c26dc4325490ea3a8693f83a9e_288133_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=150 data-flex-basis=362px></p><p>點擊，Stack Monitoring
<img src=/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221944.png width=1062 height=932 srcset="/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221944_hub2d210a90cf90aa33361e2042aba0b08_133784_480x0_resize_box_3.png 480w, /2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024221944_hub2d210a90cf90aa33361e2042aba0b08_133784_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=113 data-flex-basis=273px></p><p><img src=/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024222042.png width=644 height=494 srcset="/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024222042_hu29dabbce900bcb4e9e0ac4914ee83e9d_45700_480x0_resize_box_3.png 480w, /2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024222042_hu29dabbce900bcb4e9e0ac4914ee83e9d_45700_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=130 data-flex-basis=312px>
可以簡單看到elasticsearch和kibana的狀態
<img src=/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024222122.png width=1494 height=884 srcset="/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024222122_hu8d402cb3ec2f131a779e1c2689ce6bfa_160449_480x0_resize_box_3.png 480w, /2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024222122_hu8d402cb3ec2f131a779e1c2689ce6bfa_160449_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=169 data-flex-basis=405px></p><h3 id=注意自簽憑證3年到期>(注意)自簽憑證3年到期</h3><p><img src=/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024222246.png width=544 height=666 srcset="/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024222246_hu7381ac84c543957ed9ecb5299eedd136_69571_480x0_resize_box_3.png 480w, /2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024222246_hu7381ac84c543957ed9ecb5299eedd136_69571_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=81 data-flex-basis=196px></p><h3 id=重新頒發憑證並改10年到期>重新頒發憑證(並改10年到期)</h3><p>停掉所有elasticsearch和kibana和logstash</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# docker-compose down
</span></span><span class=line><span class=cl>root@k8s-master72u:/data/docker-elk# docker-compose down
</span></span><span class=line><span class=cl>root@k8s-master73u:/data/docker-elk# docker-compose down
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# docker-compose ps
</span></span><span class=line><span class=cl>Name   Command   State   Ports
</span></span><span class=line><span class=cl>------------------------------
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master72u:/data/docker-elk# docker-compose ps
</span></span><span class=line><span class=cl>Name   Command   State   Ports
</span></span><span class=line><span class=cl>------------------------------
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master73u:/data/docker-elk# docker-compose ps
</span></span><span class=line><span class=cl>Name   Command   State   Ports
</span></span><span class=line><span class=cl>------------------------------
</span></span></code></pre></div><p>刪除原本憑證</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# rm -rf tls/certs/*
</span></span><span class=line><span class=cl>root@k8s-master72u:/data/docker-elk# rm -rf tls/certs/*
</span></span><span class=line><span class=cl>root@k8s-master73u:/data/docker-elk# rm -rf tls/certs/*
</span></span></code></pre></div><p><strong><font color=red>選一台執行，再將生成憑證拷貝至其他主機</font></strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 修改憑證頒發到期時間為10年，有bin/elasticsearch-certutil這段，都加上--days 3650</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# vim tls/entrypoint.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;[+] CA certificate and key&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> ! -f tls/certs/ca/ca.key <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nv>symbol</span><span class=o>=</span>⠿
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        bin/elasticsearch-certutil ca <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                --days <span class=m>3650</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                --silent <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                --pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                --out tls/certs/ca.zip
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;[+] Server certificates and keys&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> ! -f tls/certs/elasticsearch/elasticsearch.key <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nv>symbol</span><span class=o>=</span>⠿
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        bin/elasticsearch-certutil cert <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                --days <span class=m>3650</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                --silent <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                --pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                --in tls/instances.yml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                --ca-cert tls/certs/ca/ca.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                --ca-key tls/certs/ca/ca.key <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                --out tls/certs/certs.zip
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 頒發憑證</span>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# docker-compose up tls
</span></span><span class=line><span class=cl>Creating network <span class=s2>&#34;docker-elk_default&#34;</span> with the default driver
</span></span><span class=line><span class=cl>Creating network <span class=s2>&#34;docker-elk_elk&#34;</span> with driver <span class=s2>&#34;bridge&#34;</span>
</span></span><span class=line><span class=cl>Creating docker-elk_tls_1 ... <span class=k>done</span>
</span></span><span class=line><span class=cl>Attaching to docker-elk_tls_1
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span> <span class=o>[</span>+<span class=o>]</span> CA certificate and key
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿ Created
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿ SHA256 fingerprint: d93ccec000656ad3cd2ea04e1de39c0c2d32eef1b20b32a117d3c92469ed94fb
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿   tls/certs/ca/ca.crt
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿   tls/certs/ca/ca.key
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span> <span class=o>[</span>+<span class=o>]</span> Server certificates and keys
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿ Created
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿   tls/certs/elasticsearch/elasticsearch.crt
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿   tls/certs/elasticsearch/elasticsearch.key
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿   tls/certs/kibana/kibana.crt
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿   tls/certs/kibana/kibana.key
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿   tls/certs/fleet-server/fleet-server.crt
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿   tls/certs/fleet-server/fleet-server.key
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿   tls/certs/apm-server/apm-server.crt
</span></span><span class=line><span class=cl>tls_1            <span class=p>|</span>    ⠿   tls/certs/apm-server/apm-server.key
</span></span><span class=line><span class=cl>docker-elk_tls_1 exited with code <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# scp -r tls/certs root@192.168.1.72:/data/docker-elk/tls/
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# scp -r tls/certs root@192.168.1.73:/data/docker-elk/tls/
</span></span></code></pre></div><p>將各台服務啟動</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# docker-compose up -d elasticsearch
</span></span><span class=line><span class=cl>root@k8s-master72u:/data/docker-elk# docker-compose up -d elasticsearch
</span></span><span class=line><span class=cl>root@k8s-master73u:/data/docker-elk# docker-compose up -d elasticsearch
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master71u:/data/docker-elk# docker-compose up -d kibana
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@k8s-master72u:/data/docker-elk# docker-compose up -d logstash
</span></span><span class=line><span class=cl>root@k8s-master73u:/data/docker-elk# docker-compose up -d logstash
</span></span></code></pre></div><p>https://192.168.1.71:9200/</p><p>elasticsearch憑證更換成10年了
<img src=/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024230048.png width=544 height=666 srcset="/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024230048_hu3d834ebb846991f6e64530588d316f89_72864_480x0_resize_box_3.png 480w, /2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024230048_hu3d834ebb846991f6e64530588d316f89_72864_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=81 data-flex-basis=196px></p><p>kibana可以正常登入</p><p><img src=/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024230321.png width=963 height=641 srcset="/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024230321_huccfd83508b5652092b376b9ab70d34c8_48165_480x0_resize_box_3.png 480w, /2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024230321_huccfd83508b5652092b376b9ab70d34c8_48165_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=150 data-flex-basis=360px></p><p>kibana憑證更換成10年了
<img src=/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024230348.png width=544 height=666 srcset="/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024230348_hu7381ac84c543957ed9ecb5299eedd136_70933_480x0_resize_box_3.png 480w, /2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024230348_hu7381ac84c543957ed9ecb5299eedd136_70933_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=81 data-flex-basis=196px></p><p>資料也有正常進來了，完成更換憑證</p><p><img src=/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024230459.png width=1500 height=994 srcset="/2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024230459_hu2112db49c92ffdb9951f6e6149bc8ce8_293959_480x0_resize_box_3.png 480w, /2023/docker-compose-elk-multinodes-cluster/media/Pasted-image-20231024230459_hu2112db49c92ffdb9951f6e6149bc8ce8_293959_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=150 data-flex-basis=362px></p></section><footer class=article-footer><section class=article-tags><a href=/tags/docker/>docker</a>
<a href=/tags/tls/>tls</a>
<a href=/tags/elasticsearch/>elasticsearch</a>
<a href=/tags/logstash/>logstash</a>
<a href=/tags/kibana/>kibana</a>
<a href=/tags/elk/>elk</a>
<a href=/tags/cluster/>cluster</a>
<a href=/tags/docker-compose/>docker-compose</a>
<a href=/tags/security/>security</a>
<a href=/tags/multinodes/>multinodes</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相關文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/2023/thanos-docker-compose-multinodes/><div class=article-details><h2 class=article-title>Thanos部署Prometheus高可用(docker-compose) + redis_exporter(docker-compose)</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//blog-goldfishbrain-fighting-com.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2022 -
2023 翻轉吧金魚腦</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 建立<br>主題 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.20.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 設計</section><section class=totalcount>發表了98篇文章 ·
總計43.58k字</section><section class=running-time>本站已運行
<span id=runningdays class=running-days></span></section><section class=visit-count><span id=busuanzi_container_site_pv style=display:none>本站總訪問量 <span id=busuanzi_value_site_pv></span> 次 </span>·
<span id=busuanzi_container_site_uv style=display:none>總訪客數 <span id=busuanzi_value_site_uv></span> 人</span></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><a href=# id=back-to-top title=返回顶部></a><style>#back-to-top{display:none;position:fixed;bottom:20px;right:55px;width:55px;height:55px;border-radius:7px;background-color:rgba(64,158,255,.5);box-shadow:var(--shadow-l2);font-size:30px;text-align:center;line-height:50px;cursor:pointer}#back-to-top:before{content:' ';display:inline-block;position:relative;top:0;transform:rotate(135deg);height:10px;width:10px;border-width:0 0 2px 2px;border-color:var(--back-to-top-color);border-style:solid}#back-to-top:hover:before{border-color:#2674e0}@media screen and (max-width:768px){#back-to-top{bottom:20px;right:20px;width:40px;height:40px;font-size:10px}}@media screen and (min-width:1024px){#back-to-top{bottom:20px;right:40px}}@media screen and (min-width:1280px){#back-to-top{bottom:20px;right:55px}}@media screen and (min-width:1536px){#back-to-top{visibility:hidden}}</style><script>function backToTop(){document.documentElement.scrollIntoView({behavior:"smooth"})}window.onload=function(){let t=this.document.documentElement.scrollTop||this.document.body.scrollTop,e=this.document.getElementById("back-to-top");t>0?e.style.display="inline":e.style.display="none"},window.onscroll=function(){let t=this.document.documentElement.scrollTop||this.document.body.scrollTop,e=this.document.getElementById("back-to-top");t<200?e.style.display="none":(e.style.display="inline",e.addEventListener("click",backToTop,!1))}</script><script>(function(){var t,e=window;if(e.ChannelIO)return e.console.error("ChannelIO script included twice.");t=function(){t.c(arguments)},t.q=[],t.c=function(e){t.q.push(e)},e.ChannelIO=t;function n(){if(e.ChannelIOInitialized)return;e.ChannelIOInitialized=!0;var n,t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="https://cdn.channel.io/plugin/ch-plugin-web.js",n=document.getElementsByTagName("script")[0],n.parentNode&&n.parentNode.insertBefore(t,n)}document.readyState==="complete"?n():(e.addEventListener("DOMContentLoaded",n),e.addEventListener("load",n))})(),ChannelIO("boot",{pluginKey:"ad479103-2d28-421a-a916-ae09e72ce014"})</script><script>let s1="2023-10-7";s1=new Date(s1.replace(/-/g,"/"));let s2=new Date,timeDifference=s2.getTime()-s1.getTime(),days=Math.floor(timeDifference/(1e3*60*60*24)),hours=Math.floor(timeDifference%(1e3*60*60*24)/(1e3*60*60)),minutes=Math.floor(timeDifference%(1e3*60*60)/(1e3*60)),result=days+"天"+hours+"小時"+minutes+"分鐘";document.getElementById("runningdays").innerHTML=result</script></body></html>