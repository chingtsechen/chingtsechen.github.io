<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Gitlab on 翻轉吧金魚腦</title><link>https://blog.goldfishbrain-fighting.com/tags/gitlab/</link><description>Recent content in Gitlab on 翻轉吧金魚腦</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Sun, 31 Mar 2024 17:04:59 +0800</lastBuildDate><atom:link href="https://blog.goldfishbrain-fighting.com/tags/gitlab/index.xml" rel="self" type="application/rss+xml"/><item><title>安裝Gitlab-runner在kubernetes上，並註冊與執行pipeline</title><link>https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/</link><pubDate>Sun, 31 Mar 2024 17:04:59 +0800</pubDate><guid>https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/</guid><description>&lt;h4 id="安裝helm3">安裝helm3&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">https://github.com/helm/helm/releases
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar -zxvf helm-v3.13.1-linux-amd64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mv linux-amd64/helm /usr/local/bin/helm
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm version
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">version.BuildInfo&lt;span class="o">{&lt;/span>Version:&lt;span class="s2">&amp;#34;v3.13.1&amp;#34;&lt;/span>, GitCommit:&lt;span class="s2">&amp;#34;3547a4b5bf5edb5478ce352e18858d8a552a4110&amp;#34;&lt;/span>, GitTreeState:&lt;span class="s2">&amp;#34;clean&amp;#34;&lt;/span>, GoVersion:&lt;span class="s2">&amp;#34;go1.20.8&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="配置chart-儲存庫">配置chart 儲存庫&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## 添加chart儲存庫&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">helm repo add gitlab https://charts.gitlab.io
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## 驗證源&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">helm repo list
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##查詢可以安裝的gitlab-runner chart&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">helm search repo -l gitlab/gitlab-runner
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm repo add gitlab https://charts.gitlab.io
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;gitlab&amp;#34;&lt;/span> has been added to your repositories
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm repo list
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME URL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rancher-stable https://releases.rancher.com/server-charts/stable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">jetstack https://charts.jetstack.io
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">prometheus-community https://prometheus-community.github.io/helm-charts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab https://charts.gitlab.io
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm search repo -l gitlab/gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME CHART VERSION APP VERSION DESCRIPTION
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.63.0 16.10.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.62.1 16.9.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.62.0 16.9.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.61.3 16.8.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.61.2 16.8.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.61.1 16.8.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.61.0 16.8.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.60.1 16.7.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.60.0 16.7.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.59.3 16.6.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.59.2 16.6.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.59.1 16.6.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.59.0 16.6.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.58.2 16.5.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.58.1 16.5.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.58.0 16.5.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.57.2 16.4.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.57.1 16.4.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.57.0 16.4.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.56.3 16.3.3 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.56.2 16.3.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.56.1 16.3.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.56.0 16.3.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.55.3 16.2.3 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.55.2 16.2.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.55.1 16.2.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.55.0 16.2.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.54.1 16.1.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.54.0 16.1.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.53.3 16.0.3 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.53.2 16.0.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.53.1 16.0.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.53.0 16.0.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.52.1 15.11.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.52.0 15.11.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.51.1 15.10.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.51.0 15.10.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.50.1 15.9.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.50.0 15.9.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.49.3 15.8.3 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.49.2 15.8.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.49.1 15.8.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.49.0 15.8.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.48.3 15.7.4 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.48.2 15.7.3 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.48.1 15.7.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.48.0 15.7.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.47.3 15.6.3 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.47.2 15.6.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.47.1 15.6.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.47.0 15.6.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.46.1 15.5.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.46.0 15.5.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.45.2 15.4.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.45.1 15.4.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.45.0 15.4.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.44.3 15.3.3 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.44.2 15.3.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.44.1 15.3.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.44.0 15.3.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.43.2 15.2.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.43.1 15.2.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.43.0 15.2.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.42.0 15.1.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.41.1 15.0.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.41.0 15.0.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.40.1 14.10.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.40.0 14.10.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.39.1 14.9.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.39.0 14.9.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.38.2 14.8.3 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.38.1 14.8.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.38.0 14.8.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.37.3 14.7.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.37.2 14.7.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.37.1 bleeding GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.37.0 14.7.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.36.1 14.6.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.36.0 14.6.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.35.3 14.5.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.35.2 14.5.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.35.0 14.5.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.34.2 14.4.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.34.1 14.4.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.34.0 14.4.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.33.3 14.3.4 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.33.2 14.3.3 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.33.1 14.3.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.33.0 14.3.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.32.0 14.2.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.31.0 14.1.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.30.0 14.0.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.29.0 13.12.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.28.0 13.11.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.27.0 13.10.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.26.0 13.9.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.25.0 13.8.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.24.0 13.7.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.23.0 13.6.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.22.0 13.5.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.21.1 13.4.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.21.0 13.4.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.20.2 13.3.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.20.1 13.3.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.20.0 13.3.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.19.4 13.2.4 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.19.3 13.2.3 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.19.2 13.2.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.19.1 13.2.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.19.0 13.2.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.18.3 13.1.3 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.18.2 13.1.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.18.1 13.1.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.18.0 13.1.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.17.2 13.0.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.17.1 13.0.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.17.0 13.0.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.16.2 12.10.3 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.16.1 12.10.2 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.16.0 12.10.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.15.1 12.9.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.15.0 12.9.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.14.0 12.8.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.13.1 12.7.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.13.0 12.7.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.12.0 12.6.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.11.0 12.5.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.10.1 12.4.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.10.0 12.4.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.9.1 12.3.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.9.0 12.3.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.8.0 12.2.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.7.0 12.1.0 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.6.1 12.0.1 GitLab Runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.6.0 12.0.0 GitLab Runner
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="更新配置資訊">更新配置資訊&lt;/h4>
&lt;p>目前我的gitlab版本是12.3.9，所以runner我就安裝12.4的，CHART版本就是0.10.0&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">NAME CHART VERSION APP VERSION DESCRIPTION
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab/gitlab-runner 0.10.0 12.4.0 GitLab Runner
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## 獲取相關版本的chart包&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">helm fetch gitlab/gitlab-runner --version&lt;span class="o">=&lt;/span>0.10.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@zeyang-nuc-service ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># ls&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Desktop es
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Documents gitlab-runner-0.15.0.tgz
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## 獲取相關版本的chart包&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm fetch gitlab/gitlab-runner --version&lt;span class="o">=&lt;/span>0.10.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# ll
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">11744&lt;/span> Mar &lt;span class="m">31&lt;/span> 09:16 gitlab-runner-0.10.0.tgz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# tar -xzvf gitlab-runner-0.10.0.tgz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# &lt;span class="nb">cd&lt;/span> gitlab-runner/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/gitlab-runner# ll
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total &lt;span class="m">52&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">3&lt;/span> root root &lt;span class="m">190&lt;/span> Mar &lt;span class="m">31&lt;/span> 09:18 ./
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwx------ &lt;span class="m">13&lt;/span> root root &lt;span class="m">4096&lt;/span> Mar &lt;span class="m">31&lt;/span> 09:18 ../
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwxr-xr-x &lt;span class="m">1&lt;/span> root root &lt;span class="m">2973&lt;/span> Oct &lt;span class="m">21&lt;/span> &lt;span class="m">2019&lt;/span> CHANGELOG.md*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwxr-xr-x &lt;span class="m">1&lt;/span> root root &lt;span class="m">345&lt;/span> Oct &lt;span class="m">21&lt;/span> &lt;span class="m">2019&lt;/span> Chart.yaml*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwxr-xr-x &lt;span class="m">1&lt;/span> root root &lt;span class="m">796&lt;/span> Oct &lt;span class="m">21&lt;/span> &lt;span class="m">2019&lt;/span> CONTRIBUTING.md*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwxr-xr-x &lt;span class="m">1&lt;/span> root root &lt;span class="m">1782&lt;/span> Oct &lt;span class="m">21&lt;/span> &lt;span class="m">2019&lt;/span> .gitlab-ci.yml*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwxr-xr-x &lt;span class="m">1&lt;/span> root root &lt;span class="m">362&lt;/span> Oct &lt;span class="m">21&lt;/span> &lt;span class="m">2019&lt;/span> .helmignore*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwxr-xr-x &lt;span class="m">1&lt;/span> root root &lt;span class="m">1084&lt;/span> Oct &lt;span class="m">21&lt;/span> &lt;span class="m">2019&lt;/span> LICENSE*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwxr-xr-x &lt;span class="m">1&lt;/span> root root &lt;span class="m">1305&lt;/span> Oct &lt;span class="m">21&lt;/span> &lt;span class="m">2019&lt;/span> NOTICE*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwxr-xr-x &lt;span class="m">1&lt;/span> root root &lt;span class="m">229&lt;/span> Oct &lt;span class="m">21&lt;/span> &lt;span class="m">2019&lt;/span> README.md*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">4096&lt;/span> Mar &lt;span class="m">31&lt;/span> 09:18 templates/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwxr-xr-x &lt;span class="m">1&lt;/span> root root &lt;span class="m">11896&lt;/span> Oct &lt;span class="m">21&lt;/span> &lt;span class="m">2019&lt;/span> values.yaml*
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>values.yml&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/gitlab-runner# cat values.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## GitLab Runner Image&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## By default it&amp;#39;s using gitlab/gitlab-runner:alpine-v{VERSION}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## where {VERSION} is taken from Chart.yaml from appVersion field&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## ref: https://hub.docker.com/r/gitlab/gitlab-runner/tags/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">image: gitlab/gitlab-runner:alpine-v12.4.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## 鏡像下載策略&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">imagePullPolicy: IfNotPresent
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Gitlab伺服器地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlabUrl: http://192.168.1.55/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## runner註冊token&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">runnerRegistrationToken: &lt;span class="s2">&amp;#34;BmSnpmSVS3CMxQ9Vyiki&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## 終止之前註銷所有跑步者&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">unregisterRunners: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## 當停止管道時等待其作業終止時間&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">terminationGracePeriodSeconds: &lt;span class="m">3600&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Set the certsSecretName in order to pass custom certficates for GitLab Runner to use&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Provide resource name for a Kubernetes Secret Object in the same namespace,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## this is used to populate the /home/gitlab-runner/.gitlab-runner/certs/ directory&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## ref: https://docs.gitlab.com/runner/configuration/tls-self-signed.html#supported-options-for-self-signed-certificates&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># certsSecretName:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## 配置最大並發作業數&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">concurrent: &lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## 新作業檢查間隔&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">checkInterval: &lt;span class="m">30&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## GitlabRunner日誌級別 debug, info, warn, error, fatal, panic&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">logLevel: info
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Configure GitLab Runner&amp;#39;s logging format. Available values are: runner, text, json&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># logFormat:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## For RBAC support:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##rbac:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## create: true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## ## Define specific rbac permissions.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## resources: [&amp;#34;pods&amp;#34;, &amp;#34;pods/exec&amp;#34;, &amp;#34;secrets&amp;#34;]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## verbs: [&amp;#34;get&amp;#34;, &amp;#34;list&amp;#34;, &amp;#34;watch&amp;#34;, &amp;#34;create&amp;#34;, &amp;#34;patch&amp;#34;, &amp;#34;delete&amp;#34;]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rbac:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> create: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rules:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - resources: &lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;configmaps&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;events&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;pods&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;pods/attach&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;pods/exec&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;secrets&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;services&amp;#34;&lt;/span>,&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> verbs: &lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;get&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;list&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;watch&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;create&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;patch&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;update&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;delete&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - apiGroups: &lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> resources: &lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;pods/exec&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> verbs: &lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;create&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;patch&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;delete&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Run the gitlab-bastion container with the ability to deploy/manage containers of jobs&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## cluster-wide or only within namespace&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> clusterWideAccess: &lt;span class="nb">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Use the following Kubernetes Service Account name if RBAC is disabled in this Helm chart (see rbac.create)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># serviceAccountName: default&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Specify annotations for Service Accounts, useful for annotations such as eks.amazonaws.com/role-arn&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## ref: https://docs.aws.amazon.com/eks/latest/userguide/specify-service-account-role.html&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># serviceAccountAnnotations: {}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Configure integrated Prometheus metrics exporter&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## ref: https://docs.gitlab.com/runner/monitoring/#configuration-of-the-metrics-http-server&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metrics:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> enabled: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Configuration for the Pods that that the runner launches for each new job&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">runners:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Default container image to use for builds when none is specified&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> image: ubuntu:16.04
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Specify one or more imagePullSecrets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># imagePullSecrets: []&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Specify the image pull policy: never, if-not-present, always. The cluster default will be used if not set.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> imagePullPolicy: &lt;span class="s2">&amp;#34;if-not-present&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Defines number of concurrent requests for new job from GitLab&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-section&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## 限制來自GitLab的對新作業的並發請求數&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requestConcurrency: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Specify whether the runner should be locked to a specific project: true, false. Defaults to true.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> locked: &lt;span class="nb">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Specify the tags associated with the runner. Comma-separated list of tags.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## ref: https://docs.gitlab.com/ce/ci/runners/#using-tags&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tags: &lt;span class="s2">&amp;#34;kubernetes-runner,k8s&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Specify if jobs without tags should be run.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## If not specified, Runner will default to true if no tags were specified. In other case it will&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## default to false.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## ref: https://docs.gitlab.com/ce/ci/runners/#allowing-runners-with-tags-to-pick-jobs-without-tags&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> runUntagged: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Specify whether the runner should only run protected branches.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Defaults to False.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## ref: https://docs.gitlab.com/ee/ci/runners/#protected-runners&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> protected: &lt;span class="nb">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Run all containers with the privileged flag enabled&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## This will allow the docker:dind image to run if you need to run Docker&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## commands. Please read the docs before turning this on:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## ref: https://docs.gitlab.com/runner/executors/kubernetes.html#using-docker-dind&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> privileged: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## The name of the secret containing runner-token and runner-registration-token&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># secret: gitlab-runner&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Namespace to run Kubernetes jobs in (defaults to the same namespace of this release)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># namespace:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## The amount of time, in seconds, that needs to pass before the runner will&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## timeout attempting to connect to the container it has just created.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## ref: https://docs.gitlab.com/runner/executors/kubernetes.html&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pollTimeout: &lt;span class="m">180&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Set maximum build log size in kilobytes, by default set to 4096 (4MB)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-section&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> outputLimit: &lt;span class="m">4096&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Distributed runners caching&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## ref: https://gitlab.com/gitlab-org/gitlab-runner/blob/master/docs/configuration/autoscale.md#distributed-runners-caching&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## If you want to use s3 based distributing caching:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## First of all you need to uncomment General settings and S3 settings sections.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Create a secret &amp;#39;s3access&amp;#39; containing &amp;#39;accesskey&amp;#39; &amp;amp; &amp;#39;secretkey&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## ref: https://aws.amazon.com/blogs/security/wheres-my-secret-access-key/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## $ kubectl create secret generic s3access \&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## --from-literal=accesskey=&amp;#34;YourAccessKey&amp;#34; \&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## --from-literal=secretkey=&amp;#34;YourSecretKey&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## ref: https://kubernetes.io/docs/concepts/configuration/secret/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## If you want to use gcs based distributing caching:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## First of all you need to uncomment General settings and GCS settings sections.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Access using credentials file:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Create a secret &amp;#39;google-application-credentials&amp;#39; containing your application credentials file.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runnerscachegcs-section&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## You could configure&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## $ kubectl create secret generic google-application-credentials \&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## --from-file=gcs-application-credentials-file=./path-to-your-google-application-credentials-file.json&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## ref: https://kubernetes.io/docs/concepts/configuration/secret/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Access using access-id and private-key:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Create a secret &amp;#39;gcsaccess&amp;#39; containing &amp;#39;gcs-access-id&amp;#39; &amp;amp; &amp;#39;gcs-private-key&amp;#39;.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-cache-gcs-section&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## You could configure&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## $ kubectl create secret generic gcsaccess \&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## --from-literal=gcs-access-id=&amp;#34;YourAccessID&amp;#34; \&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## --from-literal=gcs-private-key=&amp;#34;YourPrivateKey&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## ref: https://kubernetes.io/docs/concepts/configuration/secret/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cache: &lt;span class="o">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## General settings&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># cacheType: s3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># cachePath: &amp;#34;gitlab_runner&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># cacheShared: true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## S3 settings&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># s3ServerAddress: s3.amazonaws.com&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># s3BucketName:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># s3BucketLocation:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># s3CacheInsecure: false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># secretName: s3access&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## GCS settings&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># gcsBucketName:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Use this line for access using access-id and private-key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># secretName: gcsaccess&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Use this line for access using google-application-credentials file&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># secretName: google-application-credentials&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Build Container specific configuration&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> builds: &lt;span class="o">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># cpuLimit: 200m&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># memoryLimit: 256Mi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># cpuRequests: 100m&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># memoryRequests: 128Mi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Service Container specific configuration&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> services: &lt;span class="o">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># cpuLimit: 200m&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># memoryLimit: 256Mi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># cpuRequests: 100m&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># memoryRequests: 128Mi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Helper Container specific configuration&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> helpers: &lt;span class="o">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># cpuLimit: 200m&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># memoryLimit: 256Mi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># cpuRequests: 100m&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># memoryRequests: 128Mi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># image: gitlab/gitlab-runner-helper:x86_64-latest&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Service Account to be used for runners&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># serviceAccountName:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## If Gitlab is not reachable through $CI_SERVER_URL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># cloneUrl:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Specify node labels for CI job pods assignment&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># nodeSelector: {}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Specify pod labels for CI job pods&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># podLabels: {}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Specify annotations for job pods, useful for annotations such as iam.amazonaws.com/role&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># podAnnotations: {}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Configure environment variables that will be injected to the pods that are created while&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## the build is running. These variables are passed as parameters, i.e. `--env &amp;#34;NAME=VALUE&amp;#34;`,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## to `gitlab-runner register` command.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## Note that `envVars` (see below) are only present in the runner pod, not the pods that are&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## created for each build.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">## ref: https://docs.gitlab.com/runner/commands/#gitlab-runner-register&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># env:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># NAME: VALUE&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Configure securitycontext&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## ref: http://kubernetes.io/docs/user-guide/security-context/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">securityContext:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> fsGroup: &lt;span class="m">65533&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> runAsUser: &lt;span class="m">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Configure resource requests and limits&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## ref: http://kubernetes.io/docs/user-guide/compute-resources/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">resources: &lt;span class="o">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># limits:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># memory: 256Mi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># cpu: 200m&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># requests:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># memory: 128Mi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># cpu: 100m&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Affinity for pod assignment&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">affinity: &lt;span class="o">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Node labels for pod assignment&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Ref: https://kubernetes.io/docs/user-guide/node-selection/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nodeSelector: &lt;span class="o">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Example: The gitlab runner manager should not run on spot instances so you can assign&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># them to the regular worker nodes only.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># node-role.kubernetes.io/worker: &amp;#34;true&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## List of node taints to tolerate (requires Kubernetes &amp;gt;= 1.6)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Ref: https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tolerations: &lt;span class="o">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Example: Regular worker nodes may have a taint, thus you need to tolerate the taint&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># when you assign the gitlab runner manager with nodeSelector or affinity to the nodes.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># - key: &amp;#34;node-role.kubernetes.io/worker&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># operator: &amp;#34;Exists&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Configure environment variables that will be present when the registration command runs&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## This provides further control over the registration process and the config.toml file&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## ref: `gitlab-runner register --help`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># envVars:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># - name: RUNNER_EXECUTOR&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># value: kubernetes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## list of hosts and IPs that will be injected into the pod&amp;#39;s hosts file&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hostAliases: &lt;span class="o">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Example:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># - ip: &amp;#34;127.0.0.1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># hostnames:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># - &amp;#34;foo.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># - &amp;#34;bar.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># - ip: &amp;#34;10.1.2.3&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># hostnames:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># - &amp;#34;foo.remote&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># - &amp;#34;bar.remote&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Annotations to be added to manager pod&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">podAnnotations: &lt;span class="o">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Example:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># iam.amazonaws.com/role: &amp;lt;my_role_arn&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Labels to be added to manager pod&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">podLabels: &lt;span class="o">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Example:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># owner.team: &amp;lt;my_cool_team&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## HPA support for custom metrics:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## This section enables runners to autoscale based on defined custom metrics.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## In order to use this functionality, Need to enable a custom metrics API server by&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## implementing &amp;#34;custom.metrics.k8s.io&amp;#34; using supported third party adapter&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Example: https://github.com/directxman12/k8s-prometheus-adapter&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#hpa: {}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># minReplicas: 1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># maxReplicas: 10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># metrics:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># - type: Pods&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># pods:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># metricName: gitlab_runner_jobs&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># targetAverageValue: 400m&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="部署chart">部署chart&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## 創建runner&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm install gitlab-runner --namespace &lt;span class="nb">test&lt;/span> ./gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME: gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">LAST DEPLOYED: Sun Mar &lt;span class="m">31&lt;/span> 09:40:46 &lt;span class="m">2024&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAMESPACE: &lt;span class="nb">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">STATUS: deployed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">REVISION: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TEST SUITE: None
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NOTES:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Your GitLab Runner should now be registered against the GitLab instance reachable at: &lt;span class="s2">&amp;#34;http://192.168.1.55/&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>此時可以回到Gitlab頁面，查看runner是否已註冊&lt;/p>
&lt;p>確定已註冊成功了&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331174235.png"
width="1713"
height="647"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331174235_hu0230bca1ebedb31c247b5f17daf6bd4a_159289_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331174235_hu0230bca1ebedb31c247b5f17daf6bd4a_159289_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="264"
data-flex-basis="635px"
>&lt;/p>
&lt;p>進k8s查看，可以看到namespace test下，已經有一個runner產生&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/gitlab-runner# kubectl get pod -n &lt;span class="nb">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner-gitlab-runner-648b664dbf-knshw 1/1 Running &lt;span class="m">0&lt;/span> 3m57s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="測試-runner-執行pipeline">測試 Runner 執行pipeline&lt;/h4>
&lt;p>在專案新增一個名為.gitlab-ci.yml的檔案&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331174954.png"
width="1451"
height="829"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331174954_hu1d25d93376249a0a3ed08c74f4245c08_83877_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331174954_hu1d25d93376249a0a3ed08c74f4245c08_83877_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="175"
data-flex-basis="420px"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven:3.6.3-jdk-8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">before_script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ls&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">services&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mysql:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">alias&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mysql-1 &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven:3.6.3-jdk-8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">build&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tags&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ls&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">sleep 2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">echo &amp;#34;mvn clean &amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">sleep 10&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">deploy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deploy&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tags&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">echo &amp;#34;deploy&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">environment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">production&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">url&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">http:/google.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>調整Runner設定，並分配給Project使用&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331175208.png"
width="1735"
height="656"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331175208_hu94356f3cacfcdc94fd1e51b77a31ac46_159802_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331175208_hu94356f3cacfcdc94fd1e51b77a31ac46_159802_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="264"
data-flex-basis="634px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331175256.png"
width="1309"
height="561"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331175256_hu4a6b63093272dee331a9ba21e717be86_49482_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331175256_hu4a6b63093272dee331a9ba21e717be86_49482_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="233"
data-flex-basis="560px"
>&lt;/p>
&lt;p>執行pipeline&lt;/p>
&lt;p>看到dns無法解析
&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331175639.png"
width="1367"
height="367"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331175639_hua70fdde981df88d33b713241540d56b2_67104_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331175639_hua70fdde981df88d33b713241540d56b2_67104_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="372"
data-flex-basis="893px"
>&lt;/p>
&lt;p>coredns添加hosts解析&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get configmaps coredns -n kube-system -o yaml &amp;gt; coredns-configmaps.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# vim coredns-configmaps.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">data:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Corefile: &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> .:53 &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> errors &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> health &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> lameduck 5s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ready
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> kubernetes cluster.local in-addr.arpa ip6.arpa &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pods insecure
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> fallthrough in-addr.arpa ip6.arpa
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hosts &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 192.168.1.55 gitlab.jimmyhome.tw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> fallthrough
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl apply -f coredns-configmaps.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>重啟coredns服務&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl delete pod coredns-57c7559cc8-sq8c4 -n kube-system
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod &lt;span class="s2">&amp;#34;coredns-57c7559cc8-sq8c4&amp;#34;&lt;/span> deleted
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl delete pod coredns-57c7559cc8-vrf7g -n kube-system
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod &lt;span class="s2">&amp;#34;coredns-57c7559cc8-vrf7g&amp;#34;&lt;/span> deleted
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod -n kube-system
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cadvisor-8ksn8 1/1 Running &lt;span class="m">3&lt;/span> &lt;span class="o">(&lt;/span>19h ago&lt;span class="o">)&lt;/span> 93d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cadvisor-zxskk 1/1 Running &lt;span class="m">3&lt;/span> &lt;span class="o">(&lt;/span>19h ago&lt;span class="o">)&lt;/span> 93d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">calico-kube-controllers-777ff6cddb-xbmt2 1/1 Running &lt;span class="m">5&lt;/span> &lt;span class="o">(&lt;/span>19h ago&lt;span class="o">)&lt;/span> 13d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">calico-node-5gfmb 1/1 Running &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>19h ago&lt;span class="o">)&lt;/span> 13d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">calico-node-7vxfv 1/1 Running &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>19h ago&lt;span class="o">)&lt;/span> 13d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">calico-node-cpxc6 1/1 Running &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>19h ago&lt;span class="o">)&lt;/span> 13d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">calico-node-k7xmf 1/1 Running &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>19h ago&lt;span class="o">)&lt;/span> 13d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">calico-node-x5fhs 1/1 Running &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>19h ago&lt;span class="o">)&lt;/span> 13d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">coredns-57c7559cc8-7ktfj 1/1 Running &lt;span class="m">0&lt;/span> 25s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">coredns-57c7559cc8-hzxfv 1/1 Running &lt;span class="m">0&lt;/span> 8s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>再一次重新執行pipeline&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331181124.png"
width="1411"
height="561"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331181124_hud997113e41a86b961cefcb6f72a4a86e_44532_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331181124_hud997113e41a86b961cefcb6f72a4a86e_44532_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="251"
data-flex-basis="603px"
>&lt;/p>
&lt;p>執行pipeline時，k8s裡面會產生executor pod來執行任務&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 產生 executor，執行任務&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod -n &lt;span class="nb">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner-gitlab-runner-648b664dbf-knshw 1/1 Running &lt;span class="m">0&lt;/span> 26m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">runner-r9nmxgfb-project-7-concurrent-0chf72 3/3 Running &lt;span class="m">0&lt;/span> 3s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 執行完畢，executor 自動delete掉&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod -n &lt;span class="nb">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner-gitlab-runner-648b664dbf-knshw 1/1 Running &lt;span class="m">0&lt;/span> 26m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">runner-r9nmxgfb-project-7-concurrent-0chf72 2/3 Error &lt;span class="m">0&lt;/span> 4s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># executor消失&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod -n &lt;span class="nb">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner-gitlab-runner-648b664dbf-knshw 1/1 Running &lt;span class="m">0&lt;/span> 26m
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>可以看到，確定是使用，我們分配的runner執行&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331181213.png"
width="1380"
height="700"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331181213_hu0e8b8ddf2355b0eadfdf5ca53585ebc5_84559_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331181213_hu0e8b8ddf2355b0eadfdf5ca53585ebc5_84559_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="197"
data-flex-basis="473px"
>&lt;/p>
&lt;h4 id="解決構建快取問題">解決構建快取問題&lt;/h4>
&lt;p>所謂的構建快取就是我們在進行maven等構建工具打包時所依賴的包。預設會在私服中獲取，加快構建速度可以在本地快取一份。在此，我們需要創建PVC來持久化構建快取，加速構建速度。為了節省儲存空間決定不在每個項目中儲存構建快取，而是配置全局快取。
&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331184647.png"
width="1375"
height="825"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331184647_hu0aae08903a330af1426a7f65afb7637d_155323_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331184647_hu0aae08903a330af1426a7f65afb7637d_155323_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="166"
data-flex-basis="400px"
>&lt;/p>
&lt;p>創建pvc&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331185327.png"
width="1917"
height="512"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331185327_hu6e8385d52d4db40d8f65aafa4606fac9_59866_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331185327_hu6e8385d52d4db40d8f65aafa4606fac9_59866_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="374"
data-flex-basis="898px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331185518.png"
width="1675"
height="483"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331185518_hudb4cb5e5a35e57039fae0eb503f2e345_60512_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331185518_hudb4cb5e5a35e57039fae0eb503f2e345_60512_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="346"
data-flex-basis="832px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331190252.png"
width="1863"
height="491"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331190252_hue77cb29deedfe81f32318b3656ca84a8_79499_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331190252_hue77cb29deedfe81f32318b3656ca84a8_79499_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="379"
data-flex-basis="910px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331190355.png"
width="1912"
height="518"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331190355_hud6337978f11c0397c6647d6e44f90a11_81336_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331190355_hud6337978f11c0397c6647d6e44f90a11_81336_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="369"
data-flex-basis="885px"
>&lt;/p>
&lt;p>第一步：編輯value.yml文件，添加構建快取資訊配置。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/gitlab-runner# vim values.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## 當停止管道時等待其作業終止時間&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">terminationGracePeriodSeconds: &lt;span class="m">3600&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## configure build cache&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cibuild:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cache:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pvcName: ci-build-cache-pvc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mountPath: /home/gitlab-runner/ci-build-cache
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>第二步：編輯templates/configmap.yml文件，entrypoint部分添加runner配置。在start之前添加，這樣runner在創建構建pod的時候會根據配置掛載pvc。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/gitlab-runner# vim templates/configmap.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># add build cache&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cat &amp;gt;&amp;gt;/home/gitlab-runner/.gitlab-runner/config.toml &lt;span class="s">&amp;lt;&amp;lt;EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> [[runners.kubernetes.volumes.pvc]]
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> name = &amp;#34;{{.Values.cibuild.cache.pvcName}}&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> mount_path = &amp;#34;{{.Values.cibuild.cache.mountPath}}&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Start the runner&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exec&lt;/span> /entrypoint run --user&lt;span class="o">=&lt;/span>gitlab-runner &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --working-directory&lt;span class="o">=&lt;/span>/home/gitlab-runner
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>到此gitlab-runner chart部分配置就完成了，接下來可以通過Helm命令進行創建和更新了。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm upgrade gitlab-runner --namespace &lt;span class="nb">test&lt;/span> ./gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Release &lt;span class="s2">&amp;#34;gitlab-runner&amp;#34;&lt;/span> has been upgraded. Happy Helming!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME: gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">LAST DEPLOYED: Sun Mar &lt;span class="m">31&lt;/span> 11:10:46 &lt;span class="m">2024&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAMESPACE: &lt;span class="nb">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">STATUS: deployed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">REVISION: &lt;span class="m">6&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TEST SUITE: None
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NOTES:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Your GitLab Runner should now be registered against the GitLab instance reachable at: &lt;span class="s2">&amp;#34;http://192.168.1.55/&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod -n &lt;span class="nb">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner-gitlab-runner-7c4f66c9bb-jkg96 1/1 Running &lt;span class="m">0&lt;/span> 59s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331191243.png"
width="1751"
height="647"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331191243_hu93cddc4d0eae3e848801baf16d3a40cf_159511_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331191243_hu93cddc4d0eae3e848801baf16d3a40cf_159511_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="270"
data-flex-basis="649px"
>&lt;/p>
&lt;p>構建測試&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331191848.png"
width="1640"
height="824"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331191848_hu6578b5ec6c0d18da817d717c6f39cc84_189936_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331191848_hu6578b5ec6c0d18da817d717c6f39cc84_189936_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="199"
data-flex-basis="477px"
>&lt;/p>
&lt;p>可以看到executor，確實有掛載pvc&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331191642.png"
width="1879"
height="605"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331191642_hu4adedfa1d239950e4b771268400a2105_136342_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331191642_hu4adedfa1d239950e4b771268400a2105_136342_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="310"
data-flex-basis="745px"
>&lt;/p>
&lt;p>部署完成了，後續使用構建工具打包時添加指定快取目錄。例如：maven&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">mvn clean package -DskipTests -Dmaven.repo.local&lt;span class="o">=&lt;/span>/home/gitlab-runner/ci-build-cache/maven
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>.gitlab-ci.yml&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven:3.6.3-jdk-8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">before_script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ls&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">services&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mysql:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">alias&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mysql-1 &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven:3.6.3-jdk-8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">build&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tags&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ls&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">sleep 2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">mvn clean package -DskipTests -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">sleep 10&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">deploy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deploy&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tags&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">echo &amp;#34;deploy&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">environment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">production&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">url&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">http:/google.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331192150.png"
width="1327"
height="828"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331192150_hu40fa11af2a2ce26dc5ca661a54a9e562_89489_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331192150_hu40fa11af2a2ce26dc5ca661a54a9e562_89489_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="160"
data-flex-basis="384px"
>&lt;/p>
&lt;p>可以看到，已經有緩存了，不會再去下載
&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331192558.png"
width="1368"
height="816"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331192558_hub060d74a05aa2576169f7ba1f300becc_170278_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331192558_hub060d74a05aa2576169f7ba1f300becc_170278_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="167"
data-flex-basis="402px"
>&lt;/p>
&lt;p>可以看到有緩存和無緩存，pipeline執行時間上確實有差&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331192739.png"
width="1052"
height="176"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331192739_hu4d25d293093c49f05fb0925de537d9e2_38189_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331192739_hu4d25d293093c49f05fb0925de537d9e2_38189_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="597"
data-flex-basis="1434px"
>&lt;/p>
&lt;p>查看緩存檔案，是否真的存在pvc中&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# ceph-fuse -m 10.202.172.63:6789,10.202.232.220:6789,10.202.191.144:6789 /mnt/mycephfs
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# &lt;span class="nb">cd&lt;/span> /mnt/mycephfs/volumes/csi/csi-vol-5fa68a6a-7d6c-4bef-8b6b-04d59aa62598/7663c2ab-b1e9-4f20-87d9-cf3de6f729c0/maven
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:/mnt/mycephfs/volumes/csi/csi-vol-5fa68a6a-7d6c-4bef-8b6b-04d59aa62598/7663c2ab-b1e9-4f20-87d9-cf3de6f729c0/maven# ll
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total &lt;span class="m">8&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">15&lt;/span> root root &lt;span class="m">34573465&lt;/span> Mar &lt;span class="m">31&lt;/span> 11:22 ./
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">3&lt;/span> root root &lt;span class="m">34573465&lt;/span> Mar &lt;span class="m">31&lt;/span> 11:22 ../
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">3&lt;/span> root root &lt;span class="m">333176&lt;/span> Mar &lt;span class="m">31&lt;/span> 11:22 backport-util-concurrent/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">3&lt;/span> root root &lt;span class="m">798096&lt;/span> Mar &lt;span class="m">31&lt;/span> 11:22 ch/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">3&lt;/span> root root &lt;span class="m">44925&lt;/span> Mar &lt;span class="m">31&lt;/span> 11:22 classworlds/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">6&lt;/span> root root &lt;span class="m">3187173&lt;/span> Mar &lt;span class="m">31&lt;/span> 11:22 com/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">3&lt;/span> root root &lt;span class="m">429136&lt;/span> Mar &lt;span class="m">31&lt;/span> 11:22 commons-io/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">4&lt;/span> root root &lt;span class="m">20095&lt;/span> Mar &lt;span class="m">31&lt;/span> 11:22 io/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">4&lt;/span> root root &lt;span class="m">146461&lt;/span> Mar &lt;span class="m">31&lt;/span> 11:22 javax/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">3&lt;/span> root root &lt;span class="m">338878&lt;/span> Mar &lt;span class="m">31&lt;/span> 11:22 junit/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">3&lt;/span> root root &lt;span class="m">1006247&lt;/span> Mar &lt;span class="m">31&lt;/span> 11:22 mysql/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">3&lt;/span> root root &lt;span class="m">4997&lt;/span> Mar &lt;span class="m">31&lt;/span> 11:22 net/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">18&lt;/span> root root &lt;span class="m">28229427&lt;/span> Mar &lt;span class="m">31&lt;/span> 11:22 org/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">3&lt;/span> root root &lt;span class="m">7896&lt;/span> Mar &lt;span class="m">31&lt;/span> 11:22 xmlpull/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">3&lt;/span> root root &lt;span class="m">26958&lt;/span> Mar &lt;span class="m">31&lt;/span> 11:22 xpp3/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# umount /mnt/mycephfs
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="解決構建製品問題">解決構建製品問題&lt;/h4>
&lt;p>在kubernetes中對cache支持一般，我們可以使用artifacts進行代替。但是考慮到artifacts收集製品會占用儲存空間，所以準備研究下如何配置統一的快取。實際上我們可以將repo目錄做成持久化。&lt;/p>
&lt;p>經過測試，在使用kubernetes執行器創建的構建pod會默認掛載一個空目錄。此目錄用於儲存每次下載的代碼，因為是空目錄的原因導致後續測試pod無法獲取需要重新下載代碼，這還不要緊，重要的是構建生成的文件target目錄都不存在了導致後續步驟接連失敗。&lt;/p>
&lt;p>問題演示 :
每個stages，都會重新下載代碼，導致上一個流程編譯完產生的target，在下一個stages，不會存在，如果要測試其功能，就無法執行&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331200702.png"
width="1298"
height="809"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331200702_hu7e8354016e5d34f8f4c501b3e614579e_95650_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331200702_hu7e8354016e5d34f8f4c501b3e614579e_95650_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="160"
data-flex-basis="385px"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven:3.6.3-jdk-8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">before_script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ls&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">services&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mysql:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">alias&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mysql-1 &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven:3.6.3-jdk-8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">build&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tags&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ls&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">sleep 2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">mvn clean package -DskipTests -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">sleep 10&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ls target/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">test&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven:3.6.3-jdk-8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tags&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ls target/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">sleep 2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">mvn test -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">sleep 10&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">deploy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deploy&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tags&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">echo &amp;#34;deploy&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">environment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">production&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">url&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">http:/google.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>build流程，是有target目錄
&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331200900.png"
width="1663"
height="817"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331200900_huf7eae8f674853ddf0817a3988fa2e9f2_187417_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331200900_huf7eae8f674853ddf0817a3988fa2e9f2_187417_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="203"
data-flex-basis="488px"
>&lt;/p>
&lt;p>test流程，是沒有target目錄&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331201006.png"
width="1685"
height="719"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331201006_hu6305594ced893369e4b026db5afc4aef_139668_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331201006_hu6305594ced893369e4b026db5afc4aef_139668_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="234"
data-flex-basis="562px"
>&lt;/p>
&lt;p>經過測試在本地的pv中能夠看到，下載的代碼文件。但是默認每次每個job運行的時候都會獲取遠程最新的代碼，會把構建目錄刪除掉，此時就需要配置git checkout策略了。其實按照我們目前的場景，不需要每個作業都下載代碼。只要第一個作業下載好最新的代碼，然後運行流水線即可。當在運行流水線的過程中遇到新代碼提交可以放到下次流水線執行。&lt;/p>
&lt;p>需要在ci文件中定義&lt;code>GIT_CHECKOUT&lt;/code>變數，預設值為true，即每次都需要代碼下載。我們將全局配置為false然後在build作業中配置為true。也就實現了只在build作業下載最新代碼了。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">GIT_CHECKOUT&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;false&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331201748.png"
width="1273"
height="792"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331201748_hu3e74734ed6ada210d9485e4de3944136_94941_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331201748_hu3e74734ed6ada210d9485e4de3944136_94941_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="160"
data-flex-basis="385px"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven:3.6.3-jdk-8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">before_script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ls&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">services&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mysql:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">alias&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mysql-1 &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven:3.6.3-jdk-8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">build&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tags&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ls&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">sleep 2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">mvn clean package -DskipTests -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">sleep 10&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ls target/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">test&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">variables&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">GIT_CHECKOUT&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;false&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven:3.6.3-jdk-8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tags&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ls target/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">sleep 2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">mvn test -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">sleep 10&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">deploy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deploy&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tags&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">echo &amp;#34;deploy&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">environment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">production&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">url&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">http:/google.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>可以看到，就算不重新下載代碼，一樣不會有target，因為使用kubernetes執行器創建的構建pod會默認掛載一個空目錄。&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331202007.png"
width="1518"
height="680"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331202007_hu0b0ec9f4183c93bbe88eb561adf2d3b0_133549_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331202007_hu0b0ec9f4183c93bbe88eb561adf2d3b0_133549_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="223"
data-flex-basis="535px"
>&lt;/p>
&lt;p>創建repo持久化pvc&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331200005.png"
width="1915"
height="504"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331200005_hu6563fb5096a40b3da557123a53b54ed5_88283_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331200005_hu6563fb5096a40b3da557123a53b54ed5_88283_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="379"
data-flex-basis="911px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331200111.png"
width="1067"
height="587"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331200111_hu4352eae6d23398dd6fe74bad5e3d6d18_91348_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331200111_hu4352eae6d23398dd6fe74bad5e3d6d18_91348_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="181"
data-flex-basis="436px"
>&lt;/p>
&lt;p>編譯values.yaml文件添加註冊配置變數。&lt;code>RUNNER_BUILDS_DIR&lt;/code>定義構建目錄。&lt;code>CUSTOM_BUILD_DIR_ENABLED&lt;/code>開啟自訂構建目錄配置。&lt;/p>
&lt;p>添加repo目錄快取配置，我們把自訂的構建目錄放到默認構建目錄的下面builds目錄中。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="l">root@k8s-master71u:~/gitlab-runner# vim values.yaml&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c">## configure build cache&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">cibuild&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cache&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">pvcName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ci-build-cache-pvc&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/home/gitlab-runner/ci-build-cache&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">builds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">pvcName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ci-build-dir-pvc&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/home/gitlab-runner/ci-build-dir/builds&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c">## Configure environment variables that will be present when the registration command runs&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c">## This provides further control over the registration process and the config.toml file&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c">## ref: `gitlab-runner register --help`&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c">## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c">##&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c"># envVars:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c"># - name: RUNNER_EXECUTOR&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c"># value: kubernetes&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">envVars&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">RUNNER_BUILDS_DIR&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/home/gitlab-runner/ci-build-dir/&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">CUSTOM_BUILD_DIR_ENABLED&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>編輯templates/configmap.yml&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="l">root@k8s-master71u:~/gitlab-runner# vim templates/configmap.yaml&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># add build cache&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">cat &amp;gt;&amp;gt;/home/gitlab-runner/.gitlab-runner/config.toml &amp;lt;&amp;lt;EOF&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">[[&lt;/span>&lt;span class="l">runners.kubernetes.volumes.pvc]]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">name = &amp;#34;{{.Values.cibuild.cache.pvcName}}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">mount_path = &amp;#34;{{.Values.cibuild.cache.mountPath}}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">[[&lt;/span>&lt;span class="l">runners.kubernetes.volumes.pvc]]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">name = &amp;#34;{{.Values.cibuild.builds.pvcName}}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">mount_path = &amp;#34;{{.Values.cibuild.builds.mountPath}}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">EOF&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>更新runner&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm upgrade gitlab-runner --namespace &lt;span class="nb">test&lt;/span> ./gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Release &lt;span class="s2">&amp;#34;gitlab-runner&amp;#34;&lt;/span> has been upgraded. Happy Helming!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME: gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">LAST DEPLOYED: Sun Mar &lt;span class="m">31&lt;/span> 12:30:59 &lt;span class="m">2024&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAMESPACE: &lt;span class="nb">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">STATUS: deployed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">REVISION: &lt;span class="m">7&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TEST SUITE: None
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NOTES:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Your GitLab Runner should now be registered against the GitLab instance reachable at: &lt;span class="s2">&amp;#34;http://192.168.1.55/&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod -n &lt;span class="nb">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner-gitlab-runner-59cb5fc9df-zfwb5 1/1 Running &lt;span class="m">0&lt;/span> 28s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331203203.png"
width="1332"
height="603"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331203203_hu568d3a308608fbcc1b58797a1094926e_120927_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331203203_hu568d3a308608fbcc1b58797a1094926e_120927_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="220"
data-flex-basis="530px"
>&lt;/p>
&lt;p>在CI文件中配置，如果不開啟自訂構建目錄配置會出現錯誤。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">variables&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">GIT_CLONE_PATH&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="n">CI_BUILDS_DIR&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">builds&lt;/span>&lt;span class="o">/$&lt;/span>&lt;span class="n">CI_PROJECT_NAMESPACE&lt;/span>&lt;span class="o">/$&lt;/span>&lt;span class="n">CI_PROJECT_NAME&lt;/span>&lt;span class="o">/$&lt;/span>&lt;span class="n">CI_PIPELINE_ID&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331203617.png"
width="1272"
height="802"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331203617_hu6cf61bcb252712ff30cfb190f012cc88_98816_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331203617_hu6cf61bcb252712ff30cfb190f012cc88_98816_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="158"
data-flex-basis="380px"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven:3.6.3-jdk-8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">before_script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ls&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">services&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mysql:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">alias&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mysql-1 &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">variables&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">GIT_CLONE_PATH&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">$CI_BUILDS_DIR/builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_PIPELINE_ID&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven:3.6.3-jdk-8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">build&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tags&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ls&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">sleep 2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">mvn clean package -DskipTests -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">sleep 10&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ls target/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">test&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">variables&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">GIT_CHECKOUT&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;false&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maven:3.6.3-jdk-8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tags&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ls target/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">sleep 2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">mvn test -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">sleep 10&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">deploy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deploy&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tags&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">k8s&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">echo &amp;#34;deploy&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">environment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">production&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">url&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">http:/google.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>可以看到，test流程有上一個流程build出來的target目錄
&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331204028.png"
width="1617"
height="821"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331204028_hu169641e7286254a8d3d160688ad8a0b9_211660_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-kubernetes/media/Pasted-image-20240331204028_hu169641e7286254a8d3d160688ad8a0b9_211660_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="196"
data-flex-basis="472px"
>&lt;/p></description></item><item><title>安裝Gitlab-runner在linux主機上(centos)，並註冊與執行pipeline</title><link>https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/</link><pubDate>Sun, 31 Mar 2024 16:46:28 +0800</pubDate><guid>https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/</guid><description>&lt;h1 id="安裝gitlab-runner">安裝Gitlab Runner&lt;/h1>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@docker ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.rpm.sh | sudo bash&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@docker ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># yum list gitlab-runner --showduplicates | sort -r&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Repository base is listed more than once in the configuration
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Repository updates is listed more than once in the configuration
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Repository extras is listed more than once in the configuration
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Repository centosplus is listed more than once in the configuration
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> * updates: mirror01.idc.hinet.net
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Loading mirror speeds from cached hostfile
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Loaded plugins: fastestmirror
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.9.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.9.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.8.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.8.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.7.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.7.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.6.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.6.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.6.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.5.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.4.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.4.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.4.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.3.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.3.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.3.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.2.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.2.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.2.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.1.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.1.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.10.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.0.3-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.0.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.0.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 16.0.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.9.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.9.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.8.3-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.8.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.8.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.8.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.7.4-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.7.3-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.7.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.7.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.7.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.6.3-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.6.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.6.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.6.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.5.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.5.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.5.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.4.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.4.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.4.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.3.3-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.3.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.3.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.3.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.2.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.2.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.2.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.1.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.11.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.11.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.1.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.10.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.10.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.0.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 15.0.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.9.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.9.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.9.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.8.3-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.8.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.8.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.7.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.7.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.6.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.6.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.5.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.5.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.5.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.4.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.4.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.4.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.3.4-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.3.3-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.3.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.3.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.2.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.1.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.10.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.10.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.0.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 14.0.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.9.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.8.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.7.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.6.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.5.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.4.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.4.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.3.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.3.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.3.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.2.4-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.2.3-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.2.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.2.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.2.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.1.3-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.1.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.12.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.1.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.11.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.1.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.10.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.0.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.0.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 13.0.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 12.9.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 12.9.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 12.8.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 12.7.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 12.7.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 12.6.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 12.5.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 12.4.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 12.4.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 12.3.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 12.2.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 12.10.3-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 12.10.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 12.1.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 12.10.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 12.10.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 12.0.2-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 12.0.1-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gitlab-runner.x86_64 12.0.0-1 runner_gitlab-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@docker ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># sudo yum install gitlab-runner-12.4.0-1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="gitlab-runner註冊">Gitlab Runner註冊&lt;/h1>
&lt;p>進到已安裝的Gitlab管理頁面，點選Runners，可以看到URL和token&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331165311.png"
width="1703"
height="548"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331165311_hu40900f95c39bdb02c72f6dfc0492fc68_142487_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331165311_hu40900f95c39bdb02c72f6dfc0492fc68_142487_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="310"
data-flex-basis="745px"
>&lt;/p>
&lt;p>進行註冊&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@docker ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># gitlab-runner register&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Runtime platform &lt;span class="nv">arch&lt;/span>&lt;span class="o">=&lt;/span>amd64 &lt;span class="nv">os&lt;/span>&lt;span class="o">=&lt;/span>linux &lt;span class="nv">pid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">15214&lt;/span> &lt;span class="nv">revision&lt;/span>&lt;span class="o">=&lt;/span>1564076b &lt;span class="nv">version&lt;/span>&lt;span class="o">=&lt;/span>12.4.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Running in system-mode.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Please enter the gitlab-ci coordinator URL &lt;span class="o">(&lt;/span>e.g. https://gitlab.com/&lt;span class="o">)&lt;/span>:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">http://192.168.1.55/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Please enter the gitlab-ci token &lt;span class="k">for&lt;/span> this runner:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BmSnpmSVS3CMxQ9Vyiki
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Please enter the gitlab-ci description &lt;span class="k">for&lt;/span> this runner:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>docker&lt;span class="o">]&lt;/span>: devops-service-runner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Please enter the gitlab-ci tags &lt;span class="k">for&lt;/span> this runner &lt;span class="o">(&lt;/span>comma separated&lt;span class="o">)&lt;/span>:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">build
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Registering runner... succeeded &lt;span class="nv">runner&lt;/span>&lt;span class="o">=&lt;/span>BmSnpmSV
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Please enter the executor: parallels, virtualbox, docker-ssh+machine, kubernetes, custom, docker, docker-ssh, shell, ssh, docker+machine:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">shell
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Runner registered successfully. Feel free to start it, but &lt;span class="k">if&lt;/span> it&lt;span class="err">&amp;#39;&lt;/span>s running already the config should be automatically reloaded!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>此時可以回到Gitlab頁面，查看runner是否已註冊&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331165528.png"
width="1311"
height="569"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331165528_hufb2be9430dd16e26e1a6ab1aacd88e34_114833_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331165528_hufb2be9430dd16e26e1a6ab1aacd88e34_114833_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="230"
data-flex-basis="552px"
>
確定已註冊，調整Runner設定，並分配給Project使用&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331165643.png"
width="1287"
height="619"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331165643_hufc51c7498b74892e6aa446224758f92c_85668_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331165643_hufc51c7498b74892e6aa446224758f92c_85668_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="207"
data-flex-basis="498px"
>&lt;/p>
&lt;p>這裡可以看到，我分配給demo-ci-service project使用
&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331165743.png"
width="1304"
height="456"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331165743_hua6ee695c9aa70849f781761a365922c8_101664_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331165743_hua6ee695c9aa70849f781761a365922c8_101664_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="285"
data-flex-basis="686px"
>&lt;/p>
&lt;h1 id="測試-runner-執行pipeline">測試 Runner 執行pipeline&lt;/h1>
&lt;p>在專案新增一個名為.gitlab-ci.yml的檔案&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331165923.png"
width="1009"
height="571"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331165923_hu844c094cec17ef2c00f5f4e343d91330_68754_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331165923_hu844c094cec17ef2c00f5f4e343d91330_68754_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="176"
data-flex-basis="424px"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">before_script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">echo &amp;#34;before-script!!&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">variables&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">DOMAIN&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">example.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">stages&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">build&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">codescan&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">deploy&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">before_script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">echo &amp;#34;before-script in job&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">build&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">echo &amp;#34;mvn clean &amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">echo &amp;#34;mvn install&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">echo &amp;#34;$DOMAIN&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">after_script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">echo &amp;#34;after script in buildjob&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">unittest&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">echo &amp;#34;run test&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">deploy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deploy&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">echo &amp;#34;hello deploy&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">sleep 2;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">codescan&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">codescan&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">echo &amp;#34;codescan&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">sleep 5;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">after_script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">echo &amp;#34;after-script&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ech&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>保存並執行pipeline&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331170107.png"
width="1697"
height="695"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331170107_hu2481090078c1879a8e6537a300d4bf0a_137679_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331170107_hu2481090078c1879a8e6537a300d4bf0a_137679_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="244"
data-flex-basis="586px"
>&lt;/p>
&lt;p>可以看到，執行完成&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331170208.png"
width="1279"
height="678"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331170208_hu507f227958892e328ca79cdcd72a5d25_49476_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331170208_hu507f227958892e328ca79cdcd72a5d25_49476_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="188"
data-flex-basis="452px"
>&lt;/p>
&lt;p>可以看到，確定是使用，我們分配的runner執行&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331170250.png"
width="1185"
height="707"
srcset="https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331170250_hu71a6580a0afba6110fed958f08a72296_72155_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2024/install-gitlab-runner-in-linux-baremetal/media/Pasted-image-20240331170250_hu71a6580a0afba6110fed958f08a72296_72155_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="167"
data-flex-basis="402px"
>&lt;/p></description></item><item><title>Jenkins+Gitlab+Ansible 版控與佈屬 Redis Redis-Sentinel集群</title><link>https://blog.goldfishbrain-fighting.com/2023/devops-jenkins-gitlab-ansible-redis/</link><pubDate>Sun, 08 Oct 2023 11:49:00 +0800</pubDate><guid>https://blog.goldfishbrain-fighting.com/2023/devops-jenkins-gitlab-ansible-redis/</guid><description>&lt;h1 id="今日大綱">今日大綱&lt;/h1>
&lt;ol>
&lt;li>Ansible自動化安裝Redis、Redis-Sentinel服務&lt;/li>
&lt;li>Gitlab redis-config設定檔管理
&lt;ol>
&lt;li>創建project&lt;/li>
&lt;li>將設定檔傳入&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>Ansible佈屬腳本撰寫&lt;/li>
&lt;li>Jenkins Free-Style專案建立
&lt;ol>
&lt;li>創建Free-Style軟體專案&lt;/li>
&lt;li>參數化構建&lt;/li>
&lt;li>原始碼管理&lt;/li>
&lt;li>Build Steps: Invoke Ansible Playbook&lt;/li>
&lt;li>建置測試&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481A1zg9qCmwo.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481A1zg9qCmwo.png"
>&lt;/p>
&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481T64YfhjSvU.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481T64YfhjSvU.png"
>&lt;/p>
&lt;h1 id="ansible自動化安裝redisredis-sentinel服務">Ansible自動化安裝Redis、Redis-Sentinel服務&lt;/h1>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ansible佈屬腳本目錄&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ansible ansible&lt;span class="o">]&lt;/span>&lt;span class="c1"># ll&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">總計 &lt;span class="m">24&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r--. &lt;span class="m">1&lt;/span> root root &lt;span class="m">12593&lt;/span> 9月 &lt;span class="m">11&lt;/span> 22:52 hosts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x. &lt;span class="m">33&lt;/span> root root &lt;span class="m">4096&lt;/span> 9月 &lt;span class="m">12&lt;/span> 21:05 roles
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r--. &lt;span class="m">1&lt;/span> root root &lt;span class="m">2091&lt;/span> 9月 &lt;span class="m">11&lt;/span> 22:38 site.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 主機清單&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ansible ansible&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat hosts&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>redis&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.11 &lt;span class="nv">ansible_nodename&lt;/span>&lt;span class="o">=&lt;/span>redis01
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.12 &lt;span class="nv">ansible_nodename&lt;/span>&lt;span class="o">=&lt;/span>redis02
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.13 &lt;span class="nv">ansible_nodename&lt;/span>&lt;span class="o">=&lt;/span>redis03
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.14 &lt;span class="nv">ansible_nodename&lt;/span>&lt;span class="o">=&lt;/span>redis04
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 選擇要佈屬的主機和角色，使用become: yes(sudo su -)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ansible ansible&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat site.yml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- hosts: redis
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> remote_user: root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> gather_facts: &lt;span class="nb">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> become: yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> roles:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - roles/redis
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 要佈屬的任務腳本&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ansible ansible&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat roles/redis/tasks/main.yml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 執行佈屬&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ansible ansible&lt;span class="o">]&lt;/span>&lt;span class="c1"># ansible-playbook -i hosts site.yml --ask-pass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PLAY RECAP *******************************************************************************************************************
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.11 : &lt;span class="nv">ok&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">46&lt;/span> &lt;span class="nv">changed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">45&lt;/span> &lt;span class="nv">unreachable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">failed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">skipped&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">rescued&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">ignored&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.12 : &lt;span class="nv">ok&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">46&lt;/span> &lt;span class="nv">changed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">45&lt;/span> &lt;span class="nv">unreachable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">failed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">skipped&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">rescued&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">ignored&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.13 : &lt;span class="nv">ok&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">46&lt;/span> &lt;span class="nv">changed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">45&lt;/span> &lt;span class="nv">unreachable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">failed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">skipped&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">rescued&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">ignored&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.14 : &lt;span class="nv">ok&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">46&lt;/span> &lt;span class="nv">changed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">45&lt;/span> &lt;span class="nv">unreachable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">failed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">skipped&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">rescued&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">ignored&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="gitlab-redis-config設定檔管理">Gitlab redis-config設定檔管理&lt;/h1>
&lt;h2 id="1-創建project">1. 創建project&lt;/h2>
&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/201324811FAyYPAkSA.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/201324811FAyYPAkSA.png"
>&lt;/p>
&lt;h2 id="2-將設定檔傳入">2. 將設定檔傳入&lt;/h2>
&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481dsdfZSG51j.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481dsdfZSG51j.png"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 使用已存在目錄的方式，將設定檔傳入&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 當前目錄&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chenqingze@chenqingze-MBP redis-config-test % ll
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x@ &lt;span class="m">5&lt;/span> chenqingze staff &lt;span class="m">160&lt;/span> &lt;span class="m">9&lt;/span> &lt;span class="m">12&lt;/span> 22:49 batch
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x@ &lt;span class="m">4&lt;/span> chenqingze staff &lt;span class="m">128&lt;/span> &lt;span class="m">9&lt;/span> &lt;span class="m">12&lt;/span> 22:44 t1zone
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x@ &lt;span class="m">4&lt;/span> chenqingze staff &lt;span class="m">128&lt;/span> &lt;span class="m">9&lt;/span> &lt;span class="m">12&lt;/span> 22:45 t2zone
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 傳入gitlab&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chenqingze@chenqingze-MBP redis-config-test % git init
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Initialized empty Git repository in /Users/chenqingze/Desktop/redis-config-test/redis-config-test/.git/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chenqingze@chenqingze-MBP redis-config-test % git remote add origin http://gitlab.jimmyhome.tw/root/redis-config-test.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chenqingze@chenqingze-MBP redis-config-test % git add .
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chenqingze@chenqingze-MBP redis-config-test % git commit -m &lt;span class="s2">&amp;#34;Initial commit&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chenqingze@chenqingze-MBP redis-config-test % git branch -m main master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chenqingze@chenqingze-MBP redis-config-test % git push -u origin master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Enumerating objects: 19, &lt;span class="k">done&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Counting objects: 100% &lt;span class="o">(&lt;/span>19/19&lt;span class="o">)&lt;/span>, &lt;span class="k">done&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Delta compression using up to &lt;span class="m">10&lt;/span> threads
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Compressing objects: 100% &lt;span class="o">(&lt;/span>19/19&lt;span class="o">)&lt;/span>, &lt;span class="k">done&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Writing objects: 100% &lt;span class="o">(&lt;/span>19/19&lt;span class="o">)&lt;/span>, 45.79 KiB &lt;span class="p">|&lt;/span> 7.63 MiB/s, &lt;span class="k">done&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Total &lt;span class="m">19&lt;/span> &lt;span class="o">(&lt;/span>delta 6&lt;span class="o">)&lt;/span>, reused &lt;span class="m">0&lt;/span> &lt;span class="o">(&lt;/span>delta 0&lt;span class="o">)&lt;/span>, pack-reused &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">To http://gitlab.jimmyhome.tw/root/redis-config-test.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> * &lt;span class="o">[&lt;/span>new branch&lt;span class="o">]&lt;/span> master -&amp;gt; master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">branch &lt;span class="s1">&amp;#39;master&amp;#39;&lt;/span> &lt;span class="nb">set&lt;/span> up to track &lt;span class="s1">&amp;#39;origin/master&amp;#39;&lt;/span>.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481x1b02IPM1q.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481x1b02IPM1q.png"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">redis-sentinel.conf -&amp;gt; redis-sentinel設定檔
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">redis.conf -&amp;gt; redis設定檔
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sentinel-users.acl -&amp;gt; redis-sentinel的acl設定檔
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">users.acl -&amp;gt; redis的acl設定檔
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/201324818UCYMZ6gqm.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/201324818UCYMZ6gqm.png"
>&lt;/p>
&lt;h1 id="ansible佈屬腳本撰寫">Ansible佈屬腳本撰寫&lt;/h1>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">1. 變數定義與獲取、判斷輸入選項&lt;span class="o">(&lt;/span>Jenkins本地端操作&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1. 獲取項目的工作目錄 &lt;span class="o">{{&lt;/span> workspace.stdout &lt;span class="o">}}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2. 確認function是否沒有選擇，沒有選擇，報錯終止流程
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3. 確認masterip不能沒有輸入，沒有輸入，報錯終止流程
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 4. 確認masterip只能一個，一個以上則報錯，報錯終止流程
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 5. 確認slaveip不能沒有輸入，沒有輸入，報錯終止流程
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. masterip開始流程
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0. 確認Redis服務是否活著，活著的話，報錯終止流程
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0. 確認Redis-Sentinel服務是否活著，活著的話，報錯終止流程
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1. 拷貝檔案至遠端主機
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2. 替換redis-sentinel.conf配置文件，將masterip寫入
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3. slaveip開始流程
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0. 確認Redis服務是否啟動，啟動的話，報錯終止流程
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0. 確認Redis-Sentinel服務是否啟動，啟動的話，報錯終止流程
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1. 拷貝檔案至遠端主機
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2. 替換redis-sentinel.conf配置文件，將masterip寫入
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3. 將slaveof masterip 6379寫入redis.conf配置文件
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4. all開始流程
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0. 確認Redis服務是否啟動，啟動的話，報錯終止流程
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0. 確認Redis-Sentinel服務是否啟動，啟動的話，報錯終止流程
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1. 啟動，開機自啟動redis服務
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2. 確認Redis服務是否正常啟動，不啟動的話，報錯終止流程
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3. 啟動，開機自啟動redis-sentinel服務
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 4. 確認Redis-Sentinel服務是否正常啟動，不啟動的話，報錯終止流程
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> redis-sentinel剛啟動連接，需要一點時間偵測，所以流程暫停5秒
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 5. 查看Redis-Sentinel狀態連接狀態&lt;span class="o">(&lt;/span>/usr/local/bin/redis-cli -p &lt;span class="m">26379&lt;/span> info &lt;span class="p">|&lt;/span> grep -i &lt;span class="o">{{&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="o">}})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="l">root@ansible ansible]# cat se_redis-config-test_deploy.yml&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c">##################變數定義與獲取、判斷輸入選項(Jenkins本地端操作)###################&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">hosts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">all&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">gather_facts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">no&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 1. 獲取項目的工作目錄 {{ workspace.stdout }}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Get WorkSpace Work Path&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">shell&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cmd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;echo ${WORKSPACE}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">register&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">workspace&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">delegate_to&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">127.0.0.1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 2. 確認function是否沒有選擇，沒有選擇，報錯終止流程&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Check Function Choice&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">shell&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cmd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;echo {{ function }} | wc -w&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">register&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">is_function&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">delegate_to&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">127.0.0.1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">failed_when&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;&amp;#39;0&amp;#39; == is_function.stdout&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 3. 確認masterip不能沒有輸入，沒有輸入，報錯終止流程&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Check Masterip Input&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">shell&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cmd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;echo {{ masterip }} | wc -w&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">register&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">is_masterip&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">delegate_to&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">127.0.0.1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">failed_when&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;&amp;#39;0&amp;#39; == is_masterip.stdout&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 4. 確認masterip只能一個，一個以上則報錯，報錯終止流程&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Check Masterip Count&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">shell&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cmd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;echo -e &amp;#39;{{ masterip }}&amp;#39; | wc -l&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">register&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">is_masterip&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">delegate_to&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">127.0.0.1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">failed_when&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;is_masterip.stdout &amp;gt; &amp;#39;1&amp;#39;&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 5. 確認slaveip不能沒有輸入，沒有輸入，報錯終止流程&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Check Slaveip Input&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">shell&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cmd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;echo {{ slaveip }} | wc -w&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">register&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">is_slaveip&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">delegate_to&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">127.0.0.1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">failed_when&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;&amp;#39;0&amp;#39; == is_slaveip.stdout&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c">################################masterip開始流程###################################&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">hosts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;{{ masterip }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">gather_facts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">no&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 0. 確認Redis服務是否活著，活著的話，報錯終止流程&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Check Redis Service&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/usr/bin/systemctl is-active redis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">register&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">command_result&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">failed_when&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;&amp;#39;active&amp;#39; == command_result.stdout&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 0. 確認Redis-Sentinel服務是否活著，活著的話，報錯終止流程&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Check Redis-Sentinel Service&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/usr/bin/systemctl is-active redis-sentinel&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">register&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">command_result&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">failed_when&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;&amp;#39;active&amp;#39; == command_result.stdout&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 1. 拷貝檔案至遠端主機&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Copy Filepath To Remote Server&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">copy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">src&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;{{ workspace.stdout }}/{{ zone }}/{{ function }}/&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dest&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/usr/local/redis/&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">owner&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">redis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">redis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">mode&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0644&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 2. 替換redis-sentinel.conf配置文件，將masterip寫入&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Replace Masterip To redis-sentinel.conf&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">shell&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;sed -i &amp;#39;s/o.o.o.o/{{ masterip }}/g&amp;#39; /usr/local/redis/redis-sentinel.conf&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c">################################slaveip開始流程###################################&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">hosts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;{{ slaveip }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">gather_facts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">no&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 0. 確認Redis服務是否啟動，啟動的話，報錯終止流程&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Check Redis Service&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/usr/bin/systemctl is-active redis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">register&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">command_result&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">failed_when&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;&amp;#39;active&amp;#39; == command_result.stdout&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 0. 確認Redis-Sentinel服務是否啟動，啟動的話，報錯終止流程&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Check Redis-Sentinel Service&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/usr/bin/systemctl is-active redis-sentinel&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">register&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">command_result&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">failed_when&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;&amp;#39;active&amp;#39; == command_result.stdout&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 1. 拷貝檔案至遠端主機&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Copy Filepath To Remote Server&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">copy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">src&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;{{ workspace.stdout }}/{{ zone }}/{{ function }}/&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dest&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/usr/local/redis/&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">owner&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">redis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">redis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">mode&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0644&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 2. 替換redis-sentinel.conf配置文件，將masterip寫入&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Replace Masterip To redis-sentinel.conf&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">shell&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;sed -i &amp;#39;s/o.o.o.o/{{ masterip }}/g&amp;#39; /usr/local/redis/redis-sentinel.conf&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 3. 將slaveof masterip 6379寫入redis.conf配置文件&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Add Slaveof To redis.conf&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">blockinfile&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/usr/local/redis/redis.conf&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">block&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> slaveof {{ masterip }} 6379&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c">##################################all開始流程#####################################&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">hosts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">all&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">gather_facts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">no&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 0. 確認Redis服務是否啟動，啟動的話，報錯終止流程&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Check Redis Service&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/usr/bin/systemctl is-active redis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">register&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">command_result&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">failed_when&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;&amp;#39;active&amp;#39; == command_result.stdout&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 0. 確認Redis-Sentinel服務是否啟動，啟動的話，報錯終止流程&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Check Redis-Sentinel Service&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/usr/bin/systemctl is-active redis-sentinel&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">register&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">command_result&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">failed_when&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;&amp;#39;active&amp;#39; == command_result.stdout&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 1. 啟動，開機自啟動redis服務&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 2. 確認Redis服務是否正常啟動，不啟動的話，報錯終止流程&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Enabled、Started Redis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">systemd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">redis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">enabled&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">started&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Check Redis Service&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/usr/bin/systemctl is-active redis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">register&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">command_result&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">failed_when&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;&amp;#39;failed&amp;#39; in command_result.stdout or &amp;#39;unknown&amp;#39; in command_result.stdout or &amp;#39;inactive&amp;#39; in command_result.stdout&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 3. 啟動，開機自啟動redis-sentinel服務&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 4. 確認Redis-Sentinel服務是否正常啟動，不啟動的話，報錯終止流程&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Enabled、Started Redis-Sentinel&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">systemd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">redis-sentinel&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">enabled&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">started&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Check Redis-Sentinel Service&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/usr/bin/systemctl is-active redis-sentinel&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">register&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">command_result&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">failed_when&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;&amp;#39;failed&amp;#39; in command_result.stdout or &amp;#39;unknown&amp;#39; in command_result.stdout or &amp;#39;inactive&amp;#39; in command_result.stdout&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># redis-sentinel剛啟動連接，需要一點時間偵測，所以流程暫停5秒&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pause for 5 seconds to build app cache&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">pause&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">seconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">5&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 5. 查看Redis-Sentinel狀態連接狀態(/usr/local/bin/redis-cli -p 26379 info | grep -i web-front)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Check Redis-Sentinel info&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">shell&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/usr/local/bin/redis-cli -p 26379 info | grep -i {{ function }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">register&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;command_result&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">warn&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">no&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ignore_errors&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Runcommand Redis-Sentinel info Msg&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">debug&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">msg&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;{{ command_result.stdout_lines }}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ignore_errors&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="jenkins-free-style專案建立">Jenkins Free-Style專案建立&lt;/h1>
&lt;h2 id="1-創建free-style軟體專案">1. 創建Free-Style軟體專案&lt;/h2>
&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481aMfv8sP1jS.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481aMfv8sP1jS.png"
>&lt;/p>
&lt;h2 id="2-參數化構建">2. 參數化構建&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">Active Choices Parameter
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/201324816dBspBN6eY.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/201324816dBspBN6eY.png"
>
&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481CW3GbdJirK.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481CW3GbdJirK.png"
>&lt;/p>
&lt;hr>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">Active Choices Reactive Parameter
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481Lp13bGXNcC.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481Lp13bGXNcC.png"
>
&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481iOycuFWgoP.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481iOycuFWgoP.png"
>&lt;/p>
&lt;hr>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">文字參數
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481eP6AKSX7e5.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481eP6AKSX7e5.png"
>&lt;/p>
&lt;hr>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">文字參數
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481yAkfGqKUdj.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481yAkfGqKUdj.png"
>&lt;/p>
&lt;hr>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">使用ansible這台主機來跑佈屬流程
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481ipmJ9CICyP.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481ipmJ9CICyP.png"
>&lt;/p>
&lt;h2 id="3-原始碼管理">3. 原始碼管理&lt;/h2>
&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481ZKuUi0pyiK.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481ZKuUi0pyiK.png"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">原始碼管理&lt;span class="o">(&lt;/span>連接Gitlab&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##### Gitlab複製下來的clone&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">http://gitlab.jimmyhome.tw/root/redis-config-test.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##### Credential&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">連接gitlab帳號和密碼
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481Kr0sAjwIin.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481Kr0sAjwIin.png"
>&lt;/p>
&lt;h2 id="4-build-steps-invoke-ansible-playbook">4. Build Steps: Invoke Ansible Playbook&lt;/h2>
&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481pTjDL6LvhP.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481pTjDL6LvhP.png"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">Invoke Ansible Playbook
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##### ansible腳本位置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Playbook path: /root/ansible/se_redis-config-test_deploy.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##### Inventory主機IP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">以下撰寫方式，ip都會傳入
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481uYiDE3t2eA.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481uYiDE3t2eA.png"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">連接要佈屬的主機，使用帳號，我這裡用key，
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">所以我有從ansible主機，產生key，ssh-copy-id 要佈屬的主機
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ansible ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># ssh-copy-id 192.168.1.11&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/bin/ssh-copy-id: INFO: Source of key&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span> to be installed: &lt;span class="s2">&amp;#34;/root/.ssh/id_rsa.pub&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span>, to filter out any that are already installed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/bin/ssh-copy-id: INFO: &lt;span class="m">1&lt;/span> key&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span> remain to be installed -- &lt;span class="k">if&lt;/span> you are prompted now it is to install the new keys
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@192.168.1.11&lt;span class="s1">&amp;#39;s password:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">Number of key(s) added: 1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">Now try logging into the machine, with: &amp;#34;ssh &amp;#39;&lt;/span>192.168.1.11&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="s2">&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">and check to make sure that only the key(s) you wanted were added.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">[root@ansible ~]# ssh-copy-id 192.168.1.12
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">[root@ansible ~]# ssh-copy-id 192.168.1.13
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">[root@ansible ~]# ssh-copy-id 192.168.1.14
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">Jenkins參數，要傳入ansible內
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Extra Variables
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481JVmDfr5D8r.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481JVmDfr5D8r.png"
>
&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481lnceXat7Q5.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481lnceXat7Q5.png"
>&lt;/p>
&lt;h2 id="5-建置測試">5. 建置測試&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">可以看到，zone選擇，function也會跟著變動
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481kddeuPgLDr.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481kddeuPgLDr.png"
>
&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481KWj671Rc4p.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481KWj671Rc4p.png"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">輸入IP處，slaveip可以輸入多個
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481GguK5r8Es5.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481GguK5r8Es5.png"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">可以看到，redis-sentinel已經成功啟動，有偵測到目前master是誰，也偵測到slaves主機有3台，總共4台主機啟動sentinel服務
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481BEZgT17eQl.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481BEZgT17eQl.png"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">進redis主機直接確認，使用redis-cli登入，選擇index 1，
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> 1個key為test value為1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">get key test，value為1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@redis01 redis&lt;span class="o">]&lt;/span>&lt;span class="c1"># redis-cli&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">127.0.0.1:6379&amp;gt; &lt;span class="k">select&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">127.0.0.1:6379&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span>&amp;gt; &lt;span class="nb">set&lt;/span> &lt;span class="nb">test&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">127.0.0.1:6379&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span>&amp;gt; get &lt;span class="nb">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@redis01 redis&lt;span class="o">]&lt;/span>&lt;span class="c1"># redis-cli -p 26379&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">master0:name&lt;span class="o">=&lt;/span>search,status&lt;span class="o">=&lt;/span>ok,address&lt;span class="o">=&lt;/span>192.168.1.11:6379,slaves&lt;span class="o">=&lt;/span>3,sentinels&lt;span class="o">=&lt;/span>&lt;span class="m">4&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">可以看到，如果再次佈屬，會顯示失敗，因為主機redis和redis-sentinel服務如果是active狀態，就不能佈屬&lt;span class="o">(&lt;/span>腳本一開始就有添加此段），
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">防止輸入IP輸錯，導致設定檔覆蓋，營運中的redis服務異常
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481P7LDryWPOC.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481P7LDryWPOC.png"
>&lt;/p>
&lt;p>&lt;img src="https://ithelp.ithome.com.tw/upload/images/20230913/20132481R6pScPLx4K.png"
loading="lazy"
alt="https://ithelp.ithome.com.tw/upload/images/20230913/20132481R6pScPLx4K.png"
>&lt;/p>
&lt;h1 id="youtube教學影片">YouTube教學影片&lt;/h1>
&lt;p>&lt;a class="link" href="https://www.youtube.com/watch?v=2h1r68Im_Bg" target="_blank" rel="noopener"
>&lt;img src="https://img.youtube.com/vi/2h1r68Im_Bg/0.jpg"
loading="lazy"
alt="Yes"
>&lt;/a>&lt;/p></description></item></channel></rss>