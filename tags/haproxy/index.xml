<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>haproxy on 翻轉吧金魚腦</title><link>https://blog.goldfishbrain-fighting.com/tags/haproxy/</link><description>Recent content in haproxy on 翻轉吧金魚腦</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Sat, 02 Dec 2023 17:34:57 +0800</lastBuildDate><atom:link href="https://blog.goldfishbrain-fighting.com/tags/haproxy/index.xml" rel="self" type="application/rss+xml"/><item><title>使用kubespray專案，用ansible批量佈屬生產環境高可用kubernetes集群(haproxy、keepalived)</title><link>https://blog.goldfishbrain-fighting.com/2023/ansible-deploy-kubernetes-cluster-use-kubespray-haproxy-keepalived/</link><pubDate>Sat, 02 Dec 2023 17:34:57 +0800</pubDate><guid>https://blog.goldfishbrain-fighting.com/2023/ansible-deploy-kubernetes-cluster-use-kubespray-haproxy-keepalived/</guid><description>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/ansible-deploy-kubernetes-cluster-use-kubespray-haproxy-keepalived/media/Pasted-image-20231205222815.png" alt="Featured image of post 使用kubespray專案，用ansible批量佈屬生產環境高可用kubernetes集群(haproxy、keepalived)" />&lt;h1 id="架構圖">架構圖&lt;/h1>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/ansible-deploy-kubernetes-cluster-use-kubespray-haproxy-keepalived/media/Pasted-image-20231205214821.png"
width="1276"
height="728"
srcset="https://blog.goldfishbrain-fighting.com/2023/ansible-deploy-kubernetes-cluster-use-kubespray-haproxy-keepalived/media/Pasted-image-20231205214821_hua7912735140a57843d03f863f5ef97a0_414365_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/ansible-deploy-kubernetes-cluster-use-kubespray-haproxy-keepalived/media/Pasted-image-20231205214821_hua7912735140a57843d03f863f5ef97a0_414365_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="175"
data-flex-basis="420px"
>&lt;/p>
&lt;h1 id="集群自動化建置">集群自動化建置&lt;/h1>
&lt;h2 id="準備">準備&lt;/h2>
&lt;p>&lt;a class="link" href="https://kubespray.io/#/docs/ansible?id=installing-ansible" target="_blank" rel="noopener"
>https://kubespray.io/#/docs/ansible?id=installing-ansible&lt;/a>&lt;/p>
&lt;p>使用python3創建虛擬目錄，安裝依賴包&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ansible ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># python3 --version&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Python 3.9.18
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ansible ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># git clone https://github.com/kubernetes-sigs/kubespray.git&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ansible ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># VENVDIR=kubespray-venv&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ansible ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># KUBESPRAYDIR=kubespray&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ansible ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># python3 -m venv $VENVDIR&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ansible ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># source $VENVDIR/bin/activate&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># cd $KUBESPRAYDIR&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># pip install -U -r requirements.txt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting &lt;span class="nv">ansible&lt;/span>&lt;span class="o">==&lt;/span>8.5.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading ansible-8.5.0-py3-none-any.whl &lt;span class="o">(&lt;/span>47.5 MB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 47.5/47.5 MB 4.0 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting &lt;span class="nv">cryptography&lt;/span>&lt;span class="o">==&lt;/span>41.0.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading cryptography-41.0.4-cp37-abi3-manylinux_2_17_x86_64.manylinux2014_x86_64.whl &lt;span class="o">(&lt;/span>4.4 MB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 4.4/4.4 MB 9.2 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting &lt;span class="nv">jinja2&lt;/span>&lt;span class="o">==&lt;/span>3.1.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading Jinja2-3.1.2-py3-none-any.whl &lt;span class="o">(&lt;/span>&lt;span class="m">133&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 133.1/133.1 kB 9.1 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting &lt;span class="nv">jmespath&lt;/span>&lt;span class="o">==&lt;/span>1.0.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading jmespath-1.0.1-py3-none-any.whl &lt;span class="o">(&lt;/span>&lt;span class="m">20&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting &lt;span class="nv">MarkupSafe&lt;/span>&lt;span class="o">==&lt;/span>2.1.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading MarkupSafe-2.1.3-cp39-cp39-manylinux_2_17_x86_64.manylinux2014_x86_64.whl &lt;span class="o">(&lt;/span>&lt;span class="m">25&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting &lt;span class="nv">netaddr&lt;/span>&lt;span class="o">==&lt;/span>0.9.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading netaddr-0.9.0-py3-none-any.whl &lt;span class="o">(&lt;/span>2.2 MB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 2.2/2.2 MB 9.2 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting &lt;span class="nv">pbr&lt;/span>&lt;span class="o">==&lt;/span>5.11.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading pbr-5.11.1-py2.py3-none-any.whl &lt;span class="o">(&lt;/span>&lt;span class="m">112&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 112.7/112.7 kB 8.2 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting ruamel.yaml&lt;span class="o">==&lt;/span>0.17.35
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading ruamel.yaml-0.17.35-py3-none-any.whl &lt;span class="o">(&lt;/span>&lt;span class="m">112&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 112.9/112.9 kB 9.4 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting ruamel.yaml.clib&lt;span class="o">==&lt;/span>0.2.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading ruamel.yaml.clib-0.2.8-cp39-cp39-manylinux_2_5_x86_64.manylinux1_x86_64.whl &lt;span class="o">(&lt;/span>&lt;span class="m">562&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 562.1/562.1 kB 10.4 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting ansible-core~&lt;span class="o">=&lt;/span>2.15.5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading ansible_core-2.15.6-py3-none-any.whl &lt;span class="o">(&lt;/span>2.2 MB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 2.2/2.2 MB 9.3 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting cffi&amp;gt;&lt;span class="o">=&lt;/span>1.12
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading cffi-1.16.0-cp39-cp39-manylinux_2_17_x86_64.manylinux2014_x86_64.whl &lt;span class="o">(&lt;/span>&lt;span class="m">443&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 443.4/443.4 kB 9.7 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting importlib-resources&amp;lt;5.1,&amp;gt;&lt;span class="o">=&lt;/span>5.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading importlib_resources-5.0.7-py3-none-any.whl &lt;span class="o">(&lt;/span>&lt;span class="m">24&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting PyYAML&amp;gt;&lt;span class="o">=&lt;/span>5.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading PyYAML-6.0.1-cp39-cp39-manylinux_2_17_x86_64.manylinux2014_x86_64.whl &lt;span class="o">(&lt;/span>&lt;span class="m">738&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 738.9/738.9 kB 8.6 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting packaging
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading packaging-23.2-py3-none-any.whl &lt;span class="o">(&lt;/span>&lt;span class="m">53&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 53.0/53.0 kB 7.5 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting resolvelib&amp;lt;1.1.0,&amp;gt;&lt;span class="o">=&lt;/span>0.5.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading resolvelib-1.0.1-py2.py3-none-any.whl &lt;span class="o">(&lt;/span>&lt;span class="m">17&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting pycparser
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading pycparser-2.21-py2.py3-none-any.whl &lt;span class="o">(&lt;/span>&lt;span class="m">118&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 118.7/118.7 kB 8.6 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Installing collected packages: resolvelib, netaddr, ruamel.yaml.clib, PyYAML, pycparser, pbr, packaging, MarkupSafe, jmespath, importlib-resources, ruamel.yaml, jinja2, cffi, cryptography, ansible-core, ansible
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Successfully installed MarkupSafe-2.1.3 PyYAML-6.0.1 ansible-8.5.0 ansible-core-2.15.6 cffi-1.16.0 cryptography-41.0.4 importlib-resources-5.0.7 jinja2-3.1.2 jmespath-1.0.1 netaddr-0.9.0 packaging-23.2 pbr-5.11.1 pycparser-2.21 resolvelib-1.0.1 ruamel.yaml-0.17.35 ruamel.yaml.clib-0.2.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>notice&lt;span class="o">]&lt;/span> A new release of pip is available: 23.0.1 -&amp;gt; 23.3.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>notice&lt;span class="o">]&lt;/span> To update, run: pip install --upgrade pip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="生成hostsyaml">生成hosts.yaml&lt;/h2>
&lt;p>&lt;a class="link" href="https://kubespray.io/#/?id=deploy-a-production-ready-kubernetes-cluster" target="_blank" rel="noopener"
>https://kubespray.io/#/?id=deploy-a-production-ready-kubernetes-cluster&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># cp -rfp inventory/sample inventory/mycluster&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># declare -a IPS=(192.168.1.71 192.168.1.72 192.168.1.73 192.168.1.75 192.168.1.76)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># CONFIG_FILE=inventory/mycluster/hosts.yaml python3 contrib/inventory_builder/inventory.py ${IPS[@]}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: Adding group all
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: Adding group kube_control_plane
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: Adding group kube_node
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: Adding group etcd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: Adding group k8s_cluster
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: Adding group calico_rr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node1 to group all
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node2 to group all
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node3 to group all
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node4 to group all
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node5 to group all
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node1 to group etcd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node2 to group etcd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node3 to group etcd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node1 to group kube_control_plane
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node2 to group kube_control_plane
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node1 to group kube_node
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node2 to group kube_node
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node3 to group kube_node
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node4 to group kube_node
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node5 to group kube_node
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="修改allyml">修改all.yml&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">主要修改內容如下：
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">VIP與domain_name設定
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">需要Proxy的可以設定
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># vim inventory/mycluster/group_vars/all/all.yml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiserver_loadbalancer_domain_name: &lt;span class="s2">&amp;#34;k8s-apiserver-lb.jimmyhome.tw&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loadbalancer_apiserver:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> address: 192.168.1.74
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> port: &lt;span class="m">7443&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Set these proxy values in order to update package manager and docker daemon to use proxies and custom CA for https_proxy if needed&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># http_proxy: &amp;#34;http://x.x.x.x:3128&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># https_proxy: &amp;#34;http://x.x.x.x:3128&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># https_proxy_cert_file: &amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Refer to roles/kubespray-defaults/defaults/main.yml before modifying no_proxy&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># no_proxy: &amp;#34;127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,cattle-system.svc,.svc,.cluster.local,k8s-apiserver-lb.jimmyhome.tw&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="修改k8s-clusteryml">修改k8s-cluster.yml&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">主要修改內容如下：
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">要安裝的kubernetes版本
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service ip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod ip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">network_node_prefix
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">容器引擎，我這裡使用docker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">是否憑證自動更新(每個月月初，會自動更新)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># vim inventory/mycluster/group_vars/k8s_cluster/k8s-cluster.yml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Change this to use another Kubernetes version, e.g. a current beta release&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube_version: v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Kubernetes internal network for services, unused block of space.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube_service_addresses: 10.202.0.0/16
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># internal network. When used, it will assign IP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># addresses from this range to individual pods.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># This network must be unused in your network infrastructure!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube_pods_subnet: 10.201.0.0/16
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube_network_node_prefix: &lt;span class="m">16&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Container runtime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## docker for docker, crio for cri-o and containerd for containerd.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Default: containerd&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">container_manager: docker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Automatically renew K8S control plane certificates on first Monday of each month&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">auto_renew_certificates: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="修改addonsyml">修改addons.yml&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">主要修改內容如下：
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">安裝Nginx ingress
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">安裝helm工具
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">安裝metrics_server
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># vim inventory/mycluster/group_vars/k8s_cluster/addons.yml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Nginx ingress controller deployment&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress_nginx_enabled: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress_nginx_host_network: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress_publish_status_address: &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ingress_nginx_nodeselector:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># kubernetes.io/os: &amp;#34;linux&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress_nginx_tolerations:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: &lt;span class="s2">&amp;#34;node-role.kubernetes.io/control-plane&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: &lt;span class="s2">&amp;#34;Equal&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> value: &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> effect: &lt;span class="s2">&amp;#34;NoSchedule&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Helm deployment&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">helm_enabled: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Metrics Server deployment&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metrics_server_enabled: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="修改mainyml">修改main.yml&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">主要修改內容如下：
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">網路組件calico版本
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># vim roles/kubespray-defaults/vars/main.yml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">calico_min_version_required: &lt;span class="s2">&amp;#34;v3.26.0&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># cri-docker版本修改位置，有需要再改，這裡就依這個版本&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># vim roles/download/defaults/main/main.yml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cri_dockerd_version: 0.3.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># docker版本修改位置，有需要再改，這裡就依這個版本&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># vim roles/container-engine/docker/defaults/main.yml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker_version: &lt;span class="s1">&amp;#39;20.10&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="修改hostsyaml">修改hosts.yaml&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">主要修改內容如下：
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">依據現況去填寫
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube_control_plane -&amp;gt; master節點(會有不能調度污點)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube_node -&amp;gt; worker節點
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">etcd -&amp;gt; 數據庫節點
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat inventory/mycluster/hosts.yaml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">all:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hosts:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-master71u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ansible_host: k8s-master71u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip: 192.168.1.71
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> access_ip: 192.168.1.71
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-master72u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ansible_host: k8s-master72u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip: 192.168.1.72
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> access_ip: 192.168.1.72
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-master73u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ansible_host: k8s-master73u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip: 192.168.1.73
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> access_ip: 192.168.1.73
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-node75u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ansible_host: k8s-node75u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip: 192.168.1.75
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> access_ip: 192.168.1.75
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-node76u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ansible_host: k8s-node76u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip: 192.168.1.76
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> access_ip: 192.168.1.76
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> children:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> kube_control_plane:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hosts:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-master71u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-master72u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-master73u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> kube_node:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hosts:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-node75u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-node76u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> etcd:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hosts:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-master71u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-master72u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-master73u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s_cluster:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> children:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> kube_control_plane:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> kube_node:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> calico_rr:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hosts: &lt;span class="o">{}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="安裝配置haproxykeepalived">安裝配置haproxy、keepalived&lt;/h2>
&lt;p>操作節點： 所有的master&lt;/p>
&lt;p>注意：如果有兩個集群，都在同一網段內，/etc/keepalived/keepalived.conf裡面的virtual_router_id 60記得要不一樣，不然/var/log/message會一直報錯。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# apt-get install keepalived haproxy -y
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 所有master節點執行,注意替換最後的master節點IP地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat /etc/haproxy/haproxy.cfg
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">global
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> maxconn &lt;span class="m">2000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ulimit-n &lt;span class="m">16384&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> log 127.0.0.1 local0 err
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> stats timeout 30s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">defaults
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> log global
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mode http
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option httplog
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeout connect &lt;span class="m">5000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeout client &lt;span class="m">50000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeout server &lt;span class="m">50000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeout http-request 15s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeout http-keep-alive 15s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">frontend monitor-in
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">bind&lt;/span> *:33305
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mode http
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option httplog
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> monitor-uri /monitor
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">frontend k8s-master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">bind&lt;/span> 0.0.0.0:7443
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">bind&lt;/span> 127.0.0.1:7443
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mode tcp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option tcplog
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tcp-request inspect-delay 5s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default_backend k8s-master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">backend k8s-master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mode tcp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option tcplog
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option tcp-check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> balance roundrobin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default-server inter 10s downinter 5s rise &lt;span class="m">2&lt;/span> fall &lt;span class="m">2&lt;/span> slowstart 60s maxconn &lt;span class="m">250&lt;/span> maxqueue &lt;span class="m">256&lt;/span> weight &lt;span class="m">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server k8s-master71u 192.168.1.71:6443 check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server k8s-master72u 192.168.1.72:6443 check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server k8s-master73u 192.168.1.73:6443 check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 在k8s-master71u節點，注意mcast_src_ip換成實際的master1ip地址，virtual_ipaddress換成lb地址，interface要替換成主機IP使用的介面&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat /etc/keepalived/keepalived.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! Configuration File &lt;span class="k">for&lt;/span> keepalived
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">global_defs &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router_id LVS_DEVEL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">script_user root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> enable_script_security
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vrrp_script chk_apiserver &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> script &lt;span class="s2">&amp;#34;/etc/keepalived/check_apiserver.sh&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> interval &lt;span class="m">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> weight -5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> fall &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rise &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vrrp_instance VI_1 &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> state MASTER
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> interface ens160
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mcast_src_ip 192.168.1.71
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> virtual_router_id &lt;span class="m">64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> priority &lt;span class="m">101&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> advert_int &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> authentication &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> auth_type PASS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> auth_pass K8SHA_KA_AUTH
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> virtual_ipaddress &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 192.168.1.74
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> track_script &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> chk_apiserver
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 在k8s-master72u和k8s-master73u分別創建/etc/keepalived/keepalived.conf，注意修改mcast_src_ip和virtual_ipaddress&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#所有master節點配置KeepAlived健康檢查文件：&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@ck8s-p-4faj09-24:~# vim /etc/keepalived/check_apiserver.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#!/bin/bash&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">err&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> k in &lt;span class="k">$(&lt;/span>seq &lt;span class="m">1&lt;/span> 3&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">check_code&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>pgrep haproxy&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[[&lt;/span> &lt;span class="nv">$check_code&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span> &lt;span class="o">]]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">err&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>expr &lt;span class="nv">$err&lt;/span> + 1&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sleep &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">err&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[[&lt;/span> &lt;span class="nv">$err&lt;/span> !&lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;0&amp;#34;&lt;/span> &lt;span class="o">]]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;systemctl stop keepalived&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /usr/bin/systemctl stop keepalived
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 啟動haproxy和keepalived----&amp;gt;所有master節點&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# chmod +x /etc/keepalived/check_apiserver.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl daemon-reload
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl &lt;span class="nb">enable&lt;/span> --now haproxy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl &lt;span class="nb">enable&lt;/span> --now keepalived
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl restart haproxy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl restart keepalived
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl status haproxy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl status keepalived
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 測試lbip是否生效(從worker節點測試的)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# telnet 192.168.1.74 &lt;span class="m">7443&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Trying 192.168.1.74...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Connected to 192.168.1.74.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Escape character is &lt;span class="s1">&amp;#39;^]&amp;#39;&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Connection closed by foreign host.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="佈屬主機etchosts填寫">佈屬主機/etc/hosts填寫&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># vim /etc/hosts&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.71 k8s-master71u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.72 k8s-master72u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.73 k8s-master73u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.75 k8s-node75u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.76 k8s-node76u
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>將key推送至要佈屬的主機&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># ssh-copy-id k8s-master71u&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># ssh-copy-id k8s-master72u&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># ssh-copy-id k8s-master73u&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># ssh-copy-id k8s-node75u&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># ssh-copy-id k8s-node76u&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="開始佈屬">開始佈屬&lt;/h2>
&lt;p>中間如果有突然報錯中斷，查看報錯訊息，調整一下，再次執行佈屬即可&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># ansible-playbook -i inventory/mycluster/hosts.yaml --become --become-user=root cluster.yml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PLAY RECAP *****************************************************************************************************************************
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master71u : &lt;span class="nv">ok&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">746&lt;/span> &lt;span class="nv">changed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">145&lt;/span> &lt;span class="nv">unreachable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">failed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">skipped&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1288&lt;/span> &lt;span class="nv">rescued&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">ignored&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">8&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master72u : &lt;span class="nv">ok&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">643&lt;/span> &lt;span class="nv">changed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">130&lt;/span> &lt;span class="nv">unreachable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">failed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">skipped&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1138&lt;/span> &lt;span class="nv">rescued&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">ignored&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master73u : &lt;span class="nv">ok&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">645&lt;/span> &lt;span class="nv">changed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">131&lt;/span> &lt;span class="nv">unreachable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">failed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">skipped&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1136&lt;/span> &lt;span class="nv">rescued&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">ignored&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-node75u : &lt;span class="nv">ok&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">467&lt;/span> &lt;span class="nv">changed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">79&lt;/span> &lt;span class="nv">unreachable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">failed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">skipped&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">794&lt;/span> &lt;span class="nv">rescued&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">ignored&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-node76u : &lt;span class="nv">ok&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">467&lt;/span> &lt;span class="nv">changed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">79&lt;/span> &lt;span class="nv">unreachable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">failed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">skipped&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">793&lt;/span> &lt;span class="nv">rescued&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">ignored&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">localhost : &lt;span class="nv">ok&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">3&lt;/span> &lt;span class="nv">changed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">unreachable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">failed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">skipped&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">rescued&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">ignored&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">週日 &lt;span class="m">03&lt;/span> 十二月 &lt;span class="m">2023&lt;/span> 22:56:39 +0800 &lt;span class="o">(&lt;/span>0:00:01.997&lt;span class="o">)&lt;/span> 0:44:07.257 ****************
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">===============================================================================&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_file &lt;span class="p">|&lt;/span> Download item -------------------------------------------------------------------------------------- 114.13s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">container-engine/docker : Ensure docker packages are installed ----------------------------------------------------------------- 80.93s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_file &lt;span class="p">|&lt;/span> Download item --------------------------------------------------------------------------------------- 59.73s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_container &lt;span class="p">|&lt;/span> Download image &lt;span class="k">if&lt;/span> required --------------------------------------------------------------------- 50.88s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_container &lt;span class="p">|&lt;/span> Download image &lt;span class="k">if&lt;/span> required --------------------------------------------------------------------- 47.73s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubernetes/preinstall : Preinstall &lt;span class="p">|&lt;/span> &lt;span class="nb">wait&lt;/span> &lt;span class="k">for&lt;/span> the apiserver to be running ------------------------------------------------------ 46.30s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_file &lt;span class="p">|&lt;/span> Download item --------------------------------------------------------------------------------------- 44.36s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">container-engine/crictl : Download_file &lt;span class="p">|&lt;/span> Download item ------------------------------------------------------------------------ 42.56s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubernetes/preinstall : Install packages requirements -------------------------------------------------------------------------- 37.19s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubernetes/control-plane : Joining control plane node to the cluster. ---------------------------------------------------------- 34.16s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">container-engine/cri-dockerd : Download_file &lt;span class="p">|&lt;/span> Download item ------------------------------------------------------------------- 31.95s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_file &lt;span class="p">|&lt;/span> Download item --------------------------------------------------------------------------------------- 31.86s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_container &lt;span class="p">|&lt;/span> Download image &lt;span class="k">if&lt;/span> required --------------------------------------------------------------------- 30.03s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">container-engine/validate-container-engine : Populate service facts ------------------------------------------------------------ 27.13s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubernetes/control-plane : Kubeadm &lt;span class="p">|&lt;/span> Initialize first master ------------------------------------------------------------------- 26.53s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_container &lt;span class="p">|&lt;/span> Download image &lt;span class="k">if&lt;/span> required --------------------------------------------------------------------- 24.24s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_file &lt;span class="p">|&lt;/span> Download item --------------------------------------------------------------------------------------- 23.99s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_container &lt;span class="p">|&lt;/span> Download image &lt;span class="k">if&lt;/span> required --------------------------------------------------------------------- 23.34s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_container &lt;span class="p">|&lt;/span> Download image &lt;span class="k">if&lt;/span> required --------------------------------------------------------------------- 21.88s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubernetes/kubeadm : Join to cluster ------------------------------------------------------------------------------------------- 21.07s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="功能驗證">功能驗證&lt;/h2>
&lt;h3 id="命令補全">命令補全&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 命令補全&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;source &amp;lt;(kubectl completion bash)&amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/profile
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# &lt;span class="nb">source&lt;/span> /etc/profile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="etchosts">/etc/hosts&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat /etc/hosts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">127.0.0.1 localhost localhost.localdomain
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">127.0.1.1 k8s-master71u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># The following lines are desirable for IPv6 capable hosts&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">::1 ip6-localhost ip6-loopback localhost6 localhost6.localdomain
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fe00::0 ip6-localnet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ff00::0 ip6-mcastprefix
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ff02::1 ip6-allnodes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ff02::2 ip6-allrouters
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Ansible inventory hosts BEGIN&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.71 k8s-master71u.cluster.local k8s-master71u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.72 k8s-master72u.cluster.local k8s-master72u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.73 k8s-master73u.cluster.local k8s-master73u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.75 k8s-node75u.cluster.local k8s-node75u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.76 k8s-node76u.cluster.local k8s-node76u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Ansible inventory hosts END&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.74 k8s-apiserver-lb.jimmyhome.tw
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="連線配置文件config">連線配置文件(config)&lt;/h3>
&lt;p>可以看到，都是用VIP的domain name，
k8s-apiserver-lb.jimmyhome.tw&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat .kube/config
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusters:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- cluster:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> certificate-authority-data: &lt;span class="nv">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1USXdNekUwTkRVME9Wb1hEVE16TVRFek1ERTBORFUwT1Zvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTHovCmVJQmpqY2xCd3ZtTWV2YlhsaDV4ZW1HcjVxRlBlRkxsMGhQcERGaW1lcHFGREJkZWl0V0ppTmdGSUFVa3JzaE0KdkdtdXVjNy9mMGt5UUFGVFprTDBzUFI3QUlnbHlyeS9Hc0M1dzRZUEdYTHVpZmRoUGczM09QREdTSWNCejRYMAoyNU1aR1hEcWU2TzhTS2JyOFZidnpNVkxBK1JjbldQVTNIOGR2Znd6N2FxY0N3MlRwdFFxU1VnbVhzS1Z0ZTIzCmgrUGJDMW90OUU0UTYzYXFGQmRWei91aGJ4VHVFYm8wb1c5T3p3c2V1RTJLMzQ0RE1qZWxvZy9rMVdNeFA2OGwKYWRuOC9MbkdPNUJtTlp2UUZ6Q05kaXFkcm1YdXRubUk5N3BYY0dyN0tIdzYzYzZ2dTZ5aGZHMXNjRjg3WG40bQpLZmo5eDRDQ0cvVUJWc2RIV1lzQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZFK0lJS2NBcTBLbVl3SUpFYjJDWER4VHFibXhNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBRWF3SmEwaEVCZmJ5VG1UazlORQoweGZYUm12SnYrOGpZSlVIZExENmkvYXppQnpKMUNPUlRKKzUxbVYrWmNIZFJWbDE3UkNOZDY4MU9RMkRFWkhWCi83aVphSGxvYldNM3cvUjAxSzdXZm4yQUJsQ09lVkU3d3RKOUc0VEMzK2FVNEhaZFhsdlNLSkt6Y0oxbjZ2V04KMjErbUp1UHdLQXlJTVZEYVB6OGx2QVhxbDR2elBGWTRUd1k1OWlORVZYaFBuUHBiOWhiUGVxTUtSMG80UFBTMgp2YmNlOGw5R016aVpEaEQxb0RDSXBacGE5VzVneXFYdDBTbXk3RVJBWkx2V1N3ZHVrVnJoMXcrWVh3TEFzajF6CkZhNGJKWDExOGdQT3JUVi8rYTNXZXVpYk5JOFNNZm5KSXhHTVduUkpEemVwYW1oUUdiZmtFT3BzdHpRQms2ZGoKd0QwPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg&lt;/span>&lt;span class="o">==&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server: https://k8s-apiserver-lb.jimmyhome.tw:7443
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: cluster.local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">contexts:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- context:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cluster: cluster.local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> user: kubernetes-admin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: kubernetes-admin@cluster.local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">current-context: kubernetes-admin@cluster.local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: Config
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">preferences: &lt;span class="o">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">users:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- name: kubernetes-admin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> user:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> client-certificate-data: &lt;span class="nv">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURJVENDQWdtZ0F3SUJBZ0lJSjc2UTFQWXh4Zm93RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TXpFeU1ETXhORFExTkRsYUZ3MHlOREV5TURJeE5EUTFOVEphTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXVOK0pkMHE1T0xnWVlhaE0Kdnp4YTB0M2E5U2psdTZTZzFUWW5TbE5LRTBYeEQrOTErUmhpV0dUc2o3RlhhNmpLSkd2WE1FT1ZWUVN4UktrQQpwNE8ybDM5L3gyUDlPQ3dZWEovZEJCRFRIQUZBdWNzYWRoa0VjV3gvbnNVZWZQUE44cWxNV3YrN1B3clRzQUpFCmJBalZYSEVERVhDM3VVN2ZWM3lHaEJWVnRHZ29mOFdMdEluN3k3b2ozbnUxbldPY1ZVQ0dhQ09ncXNPdURERGQKVms0QUpyWnFWTWllUDAvWkk0YjhuMkJkZHREbUIyRVl5NmpsZ1M5eVIyYk5nVnNjaW0zMS9MTjQxWEI1YnViYQptbzAyWWIzcE5QN3VzYmtRZndNalhPZ1VrM3U2dks2Ky9hSzQ4WWhndUZvWi9wUVR2ejJtUUpKeldWU2dvYW9mCk5VTTdzUUlEQVFBQm8xWXdWREFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0RBWURWUjBUQVFIL0JBSXdBREFmQmdOVkhTTUVHREFXZ0JSUGlDQ25BS3RDcG1NQ0NSRzlnbHc4VTZtNQpzVEFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBbHQwNXJSVkhhc25GTjh6ZlJDUXVOT2hSKzhxNW5tRnNXU0pUCnFIeW92Uys2NFBkRzBJU21jSTYvanVhTmU1ZzhHdENkTlZoMmVSendLakxZZHc0RGZCUXBTTWh5UEYxZlFLYzEKMmthS2twTzh1MjQ4alZscitaQTV3Q2FaeWh3Qy8yTFFIdGxpdjZnWFNXTjZoNU5IUjNQdzhuWFBJMXQ5Q3JsegpUTCtQcFI3Ti9UUXczOWJqOUgrU0RuZTh2eVNoSVBCeXIzbzhSYXA4K3RMZVF6eVMwWWZNU1BTVnJKZjJMVFFwCnBhaWEyYVF5MVRUcXlicEQxODFsY2RzYzZxOU16cVlseE9zdE5QdG1ES3BTNFdsdFE3bDlLZVVLKzhtdmh0TWwKZXRVZ3lleXdPWmdIcUsrd0lLaC9aMzJScG1LODlub05vOHJWTHdvTGxkMjRFSXpDbmc9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg&lt;/span>&lt;span class="o">==&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> client-key-data: &lt;span class="nv">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBdU4rSmQwcTVPTGdZWWFoTXZ6eGEwdDNhOVNqbHU2U2cxVFluU2xOS0UwWHhEKzkxCitSaGlXR1RzajdGWGE2aktKR3ZYTUVPVlZRU3hSS2tBcDRPMmwzOS94MlA5T0N3WVhKL2RCQkRUSEFGQXVjc2EKZGhrRWNXeC9uc1VlZlBQTjhxbE1Xdis3UHdyVHNBSkViQWpWWEhFREVYQzN1VTdmVjN5R2hCVlZ0R2dvZjhXTAp0SW43eTdvajNudTFuV09jVlVDR2FDT2dxc091REREZFZrNEFKclpxVk1pZVAwL1pJNGI4bjJCZGR0RG1CMkVZCnk2amxnUzl5UjJiTmdWc2NpbTMxL0xONDFYQjVidWJhbW8wMlliM3BOUDd1c2JrUWZ3TWpYT2dVazN1NnZLNisKL2FLNDhZaGd1Rm9aL3BRVHZ6Mm1RSkp6V1ZTZ29hb2ZOVU03c1FJREFRQUJBb0lCQVFDY2J0SmtOYjk3SmhQRApkdVRTSU9EOWN5c1dyYStQVXVPZzVuemlvSTJhdDJFZXlkSjZuODUvMjQ1c25IUkxyZnkyU3VaQWViOS92RU8vCnhIM0FRV3ljenc4eGlnTTNwK0JKYUNCZGsxci9aSFAvZ3NQMlVINzQ5d1VhTk5QeWlWNm9TZWRKVFFHRmU4VGEKTjJEc1JhRTg0b2ZsRndydmE3VUMwMlVEbVFYM2E0YXBiMnVNRklMSnpHenJ4bmM0RDY1VHBwQUxwM2dYclo0YwpLRU5sU051dG03TVdza2JPUDB3UzJNNTk2U0R3LzNEQkQ5cVB4Y2ZsR0NyMGFDOFp6cGRUQnpiTjg4TzNORTVNClk3RFFsZHZaRHE0Q1h3QnhqSk9jN2Q1RE9VNWd2aHg5K1Y0NFZtWUNLMHV0UkFDaEliNC9lYlMweWw0U1ZMSnIKV0NUMDVwV1JBb0dCQU0xZEMzNkM5WVFZZDVDRng3Q2Q4TXlUUVY3NnppNXVlMUFiWmtPM1FRcmJ3QVR6UG9RdApsNm1vOUF6dVpHUnpreXVBU1AwRW5XbWQ1QWd3N3MybWphbTRDYndnK21xaFFpUHBYaTYyay8rVjlJdCtycDVVCjNyeldteGZxNnVWZ0lUREdBSloyckVpOVB4Q091RU1JdEw3VHJRbnBVTWVBZjZXbTdyb3VlVVQxQW9HQkFPWjEKR3ZHK0ZVVGxVL3d5WlJmOTRSOUlRQVBrM05tSHhua1JQUENtb2xXYUNNZWRmK2JvaVZlQnJka2NCQ2RRYW1TYwpReERBTW4wekVjMVQyT0E4d1BoTDJaYWd0L2FEU1dsS1RsdFF2SUNhUy94TUx3UmFGQXlJQkE3a3JOUk42TWdYCkViM093Z3FETmZkNXFIODRxMW1NbzVRVzBRVGNaL1VDb2ZLcEpNWk5Bb0dBVkJ1TWJwY0NLTVRBaTA5UE5yV28KL3BBODBNS1ZtUXlrc20xV1Y5dUE1d3FUUFRQR1llb3VXRTBiRHdTLzF5aENtU2xrTzBRZG1Ea1RRSXVSOG1ZSgpWUDVMOW1IblRhNlg0UTllQkhIQWNZZ2Y3TlhJZkk0ejMxRmhtYzBid1MrNnlEZi8yNS9rOWJHVVY1cXNPc0FoCkRwcXhId01RazNTOFVzTG91Ulg1a3RVQ2dZRUFrSGhCRitMTmVvODVBeFNrZzFISVdzLzBNWHk3WmpMVG5Qbk4KZGg5QURPR3ZOMVBvNWx4SUhPOVNpSlFqbG5HM0FMTms1NDlWRjE5NGZYdGVyZFBvTkw5My9CRnN3Y0N6dUttNApUVTVqblVzYzcyRGk2SnQvamd1R1g3L0RDS1IrbFZEQThuZzI5RmdrOEtyM2tpbDRZWDdrM09VZ3l5ZFFsQ3UrClVsenVqTkVDZ1lCZW1xaWowMjBXQVFkTWZnbnRtVk9keWVybC9IZmxhZDQwRkw2cU8wRytDRWtlSXdpZkRnVU8Kc3FIOWFRR1p3NzY4STZDUmJPYlhJMzZueHhtVXRQdFY0TllqTGFoU0lySGhEeVI5VGhvL2o3bnh3NnMyVXRwOQpLbVZlb1dtT3JGcS9LVGJHK055MU15dHpaUWhRYzJBV1oyamxDcDVaVm8ycGo0aWF1Q2I0K0E9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo&lt;/span>&lt;span class="o">=&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="節點ready">節點Ready&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get nodes -o wide
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIME
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master71u Ready control-plane 12m v1.26.3 192.168.1.71 &amp;lt;none&amp;gt; Ubuntu 22.04.3 LTS 5.15.0-84-generic docker://20.10.20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master72u Ready control-plane 12m v1.26.3 192.168.1.72 &amp;lt;none&amp;gt; Ubuntu 22.04.3 LTS 5.15.0-84-generic docker://20.10.20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master73u Ready control-plane 12m v1.26.3 192.168.1.73 &amp;lt;none&amp;gt; Ubuntu 22.04.3 LTS 5.15.0-84-generic docker://20.10.20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-node75u Ready &amp;lt;none&amp;gt; 11m v1.26.3 192.168.1.75 &amp;lt;none&amp;gt; Ubuntu 22.04.3 LTS 5.15.0-84-generic docker://20.10.20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-node76u Ready &amp;lt;none&amp;gt; 10m v1.26.3 192.168.1.76 &amp;lt;none&amp;gt; Ubuntu 22.04.3 LTS 5.15.0-84-generic docker://20.10.20
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="master都有污點">master都有污點&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get nodes k8s-master71u -o yaml &lt;span class="p">|&lt;/span> grep -i -A &lt;span class="m">2&lt;/span> taint
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> taints:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> key: node-role.kubernetes.io/control-plane
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get nodes k8s-master72u -o yaml &lt;span class="p">|&lt;/span> grep -i -A &lt;span class="m">2&lt;/span> taint
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> taints:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> key: node-role.kubernetes.io/control-plane
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get nodes k8s-master73u -o yaml &lt;span class="p">|&lt;/span> grep -i -A &lt;span class="m">2&lt;/span> taint
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> taints:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> key: node-role.kubernetes.io/control-plane
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="helm有安裝">helm有安裝&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm version
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">version.BuildInfo&lt;span class="o">{&lt;/span>Version:&lt;span class="s2">&amp;#34;v3.13.1&amp;#34;&lt;/span>, GitCommit:&lt;span class="s2">&amp;#34;3547a4b5bf5edb5478ce352e18858d8a552a4110&amp;#34;&lt;/span>, GitTreeState:&lt;span class="s2">&amp;#34;clean&amp;#34;&lt;/span>, GoVersion:&lt;span class="s2">&amp;#34;go1.20.8&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="所有pod都running">所有POD都Running&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod -A -o wide
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAMESPACE NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress-nginx ingress-nginx-controller-46rbx 1/1 Running &lt;span class="m">0&lt;/span> 8m16s 192.168.1.75 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress-nginx ingress-nginx-controller-7ccdp 1/1 Running &lt;span class="m">0&lt;/span> 8m16s 192.168.1.72 k8s-master72u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress-nginx ingress-nginx-controller-fqvxb 1/1 Running &lt;span class="m">0&lt;/span> 8m16s 192.168.1.71 k8s-master71u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress-nginx ingress-nginx-controller-hjbv7 1/1 Running &lt;span class="m">0&lt;/span> 8m16s 192.168.1.73 k8s-master73u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress-nginx ingress-nginx-controller-hlkh8 1/1 Running &lt;span class="m">0&lt;/span> 8m16s 192.168.1.76 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system calico-kube-controllers-777ff6cddb-d4htx 1/1 Running &lt;span class="m">0&lt;/span> 8m31s 10.201.14.129 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system calico-node-4qhfj 1/1 Running &lt;span class="m">0&lt;/span> 9m56s 192.168.1.72 k8s-master72u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system calico-node-9wrql 1/1 Running &lt;span class="m">0&lt;/span> 9m56s 192.168.1.76 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system calico-node-9xzmn 1/1 Running &lt;span class="m">0&lt;/span> 9m56s 192.168.1.75 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system calico-node-m975z 1/1 Running &lt;span class="m">0&lt;/span> 9m56s 192.168.1.73 k8s-master73u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system calico-node-s9w4x 1/1 Running &lt;span class="m">0&lt;/span> 9m56s 192.168.1.71 k8s-master71u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system coredns-57c7559cc8-sq8c4 1/1 Running &lt;span class="m">0&lt;/span> 7m39s 10.201.96.1 k8s-master73u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system coredns-57c7559cc8-vrf7g 1/1 Running &lt;span class="m">0&lt;/span> 7m47s 10.201.133.1 k8s-master71u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system dns-autoscaler-9875c9b44-9x7cg 1/1 Running &lt;span class="m">0&lt;/span> 7m43s 10.201.126.1 k8s-master72u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-apiserver-k8s-master71u 1/1 Running &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>3m18s ago&lt;span class="o">)&lt;/span> 13m 192.168.1.71 k8s-master71u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-apiserver-k8s-master72u 1/1 Running &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>3m18s ago&lt;span class="o">)&lt;/span> 12m 192.168.1.72 k8s-master72u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-apiserver-k8s-master73u 1/1 Running &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>3m18s ago&lt;span class="o">)&lt;/span> 11m 192.168.1.73 k8s-master73u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-controller-manager-k8s-master71u 1/1 Running &lt;span class="m">2&lt;/span> &lt;span class="o">(&lt;/span>3m49s ago&lt;span class="o">)&lt;/span> 13m 192.168.1.71 k8s-master71u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-controller-manager-k8s-master72u 1/1 Running &lt;span class="m">2&lt;/span> &lt;span class="o">(&lt;/span>3m49s ago&lt;span class="o">)&lt;/span> 12m 192.168.1.72 k8s-master72u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-controller-manager-k8s-master73u 1/1 Running &lt;span class="m">2&lt;/span> &lt;span class="o">(&lt;/span>3m49s ago&lt;span class="o">)&lt;/span> 12m 192.168.1.73 k8s-master73u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-proxy-6rz9s 1/1 Running &lt;span class="m">0&lt;/span> 11m 192.168.1.76 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-proxy-jqvw9 1/1 Running &lt;span class="m">0&lt;/span> 11m 192.168.1.75 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-proxy-mtclv 1/1 Running &lt;span class="m">0&lt;/span> 11m 192.168.1.73 k8s-master73u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-proxy-rsv52 1/1 Running &lt;span class="m">0&lt;/span> 11m 192.168.1.71 k8s-master71u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-proxy-vmnwj 1/1 Running &lt;span class="m">0&lt;/span> 11m 192.168.1.72 k8s-master72u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-scheduler-k8s-master71u 1/1 Running &lt;span class="m">1&lt;/span> 13m 192.168.1.71 k8s-master71u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-scheduler-k8s-master72u 1/1 Running &lt;span class="m">1&lt;/span> 12m 192.168.1.72 k8s-master72u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-scheduler-k8s-master73u 1/1 Running &lt;span class="m">2&lt;/span> &lt;span class="o">(&lt;/span>3m34s ago&lt;span class="o">)&lt;/span> 11m 192.168.1.73 k8s-master73u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system metrics-server-694db59894-4hfz5 1/1 Running &lt;span class="m">0&lt;/span> 6m19s 10.201.255.193 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system nodelocaldns-5kb8v 1/1 Running &lt;span class="m">0&lt;/span> 7m40s 192.168.1.72 k8s-master72u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system nodelocaldns-894wn 1/1 Running &lt;span class="m">0&lt;/span> 7m40s 192.168.1.71 k8s-master71u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system nodelocaldns-lkmlx 1/1 Running &lt;span class="m">0&lt;/span> 7m40s 192.168.1.75 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system nodelocaldns-q9q9s 1/1 Running &lt;span class="m">0&lt;/span> 7m40s 192.168.1.73 k8s-master73u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system nodelocaldns-qgrqs 1/1 Running &lt;span class="m">0&lt;/span> 7m40s 192.168.1.76 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="佈屬kubernetes的yaml">佈屬kubernetes的yaml&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# ll /etc/kubernetes/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total &lt;span class="m">412&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">5&lt;/span> kube root &lt;span class="m">4096&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 ./
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">105&lt;/span> root root &lt;span class="m">8192&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:44 ../
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">4&lt;/span> root root &lt;span class="m">49&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:52 addons/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">5669&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 admin.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1290&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:49 calico-config.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">550&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:49 calico-crb.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">4227&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:49 calico-cr.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">159&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:49 calico-ipamconfig.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1581&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:50 calico-kube-controllers.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">301&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:50 calico-kube-crb.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1733&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:50 calico-kube-cr.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">107&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:50 calico-kube-sa.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">197&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:49 calico-node-sa.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">11091&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:49 calico-node.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">5701&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:47 controller-manager.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">5684&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 &lt;span class="s1">&amp;#39;controller-manager.conf.15377.2023-12-03@14:47:03~&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">451&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 coredns-clusterrolebinding.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">473&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 coredns-clusterrole.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">601&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 coredns-config.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">3130&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 coredns-deployment.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">190&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 coredns-sa.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">591&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 coredns-svc.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">959&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 dns-autoscaler-clusterrolebinding.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1150&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 dns-autoscaler-clusterrole.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">763&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 dns-autoscaler-sa.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">2569&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 dns-autoscaler.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">219969&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:49 kdd-crds.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r----- &lt;span class="m">1&lt;/span> root root &lt;span class="m">3906&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 kubeadm-config.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">469&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:26 kubeadm-images.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">2017&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:46 kubelet.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">793&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 kubelet-config.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">513&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:44 kubelet.env
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">113&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:49 kubernetes-services-endpoint.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">199&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 kubescheduler-config.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> kube root &lt;span class="m">96&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 manifests/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r----- &lt;span class="m">1&lt;/span> root root &lt;span class="m">408&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:47 node-crb.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1035&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 nodelocaldns-config.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">2661&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 nodelocaldns-daemonset.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">149&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 nodelocaldns-sa.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">19&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:14 pki -&amp;gt; /etc/kubernetes/ssl/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">5649&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:47 scheduler.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">5632&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 &lt;span class="s1">&amp;#39;scheduler.conf.15389.2023-12-03@14:47:04~&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">4096&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 ssl/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="master組件yaml">master組件yaml&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# ll /etc/kubernetes/manifests/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total &lt;span class="m">20&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> kube root &lt;span class="m">96&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 ./
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">5&lt;/span> kube root &lt;span class="m">4096&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 ../
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">4727&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 kube-apiserver.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">3757&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 kube-controller-manager.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1698&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 kube-scheduler.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# calicoctl get ippool -o wide
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME CIDR NAT IPIPMODE VXLANMODE DISABLED DISABLEBGPEXPORT SELECTOR
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">default-pool 10.201.0.0/16 &lt;span class="nb">true&lt;/span> Never Always &lt;span class="nb">false&lt;/span> &lt;span class="nb">false&lt;/span> all&lt;span class="o">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="測試創建pod">測試創建POD&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl run test-nginx --image&lt;span class="o">=&lt;/span>nginx:alpine
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/test-nginx created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod -o wide
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">test-nginx 1/1 Running &lt;span class="m">0&lt;/span> 10s 10.201.14.130 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# curl 10.201.14.130
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;!DOCTYPE html&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;html&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;head&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;title&amp;gt;Welcome to nginx!&amp;lt;/title&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;style&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">html &lt;span class="o">{&lt;/span> color-scheme: light dark&lt;span class="p">;&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">body &lt;span class="o">{&lt;/span> width: 35em&lt;span class="p">;&lt;/span> margin: &lt;span class="m">0&lt;/span> auto&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">font-family: Tahoma, Verdana, Arial, sans-serif&lt;span class="p">;&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;/style&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;/head&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;body&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;h1&amp;gt;Welcome to nginx!&amp;lt;/h1&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;p&amp;gt;If you see this page, the nginx web server is successfully installed and
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">working. Further configuration is required.&amp;lt;/p&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;p&amp;gt;For online documentation and support please refer to
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;a &lt;span class="nv">href&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;http://nginx.org/&amp;#34;&lt;/span>&amp;gt;nginx.org&amp;lt;/a&amp;gt;.&amp;lt;br/&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Commercial support is available at
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;a &lt;span class="nv">href&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;http://nginx.com/&amp;#34;&lt;/span>&amp;gt;nginx.com&amp;lt;/a&amp;gt;.&amp;lt;/p&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;p&amp;gt;&amp;lt;em&amp;gt;Thank you &lt;span class="k">for&lt;/span> using nginx.&amp;lt;/em&amp;gt;&amp;lt;/p&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;/body&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;/html&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="測試deploymentserviceingress">測試Deployment、Service、Ingress&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat deployment2.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: apps/v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: Deployment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> labels:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app: web2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: web2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> replicas: &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> selector:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> matchLabels:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app: web2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> template:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> labels:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app: web2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> containers:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - image: nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl apply -f deployment2.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat service2.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: Service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> labels:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app: web2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: web2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ports:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - port: &lt;span class="m">80&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> protocol: TCP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> targetPort: &lt;span class="m">80&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> selector:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app: web2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> type: NodePort
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl apply -f service2.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat ingress.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: networking.k8s.io/v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: Ingress
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: web2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ingressClassName: nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rules:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - host: web2.jimmyhome.tw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> http:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> paths:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - backend:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: web2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> port:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> number: &lt;span class="m">80&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> path: /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pathType: Prefix
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl apply -f ingress.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod,svc,ingress -o wide
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/test-nginx 1/1 Running &lt;span class="m">0&lt;/span> 3m1s 10.201.14.130 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/web2-5d48fb75c5-dt5xd 1/1 Running &lt;span class="m">0&lt;/span> 113s 10.201.255.195 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/web2-5d48fb75c5-ggmrz 1/1 Running &lt;span class="m">0&lt;/span> 113s 10.201.14.131 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/web2-5d48fb75c5-jsvck 1/1 Running &lt;span class="m">0&lt;/span> 113s 10.201.255.194 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE SELECTOR
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service/kubernetes ClusterIP 10.202.0.1 &amp;lt;none&amp;gt; 443/TCP 22m &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service/web2 NodePort 10.202.72.45 &amp;lt;none&amp;gt; 80:31568/TCP 82s &lt;span class="nv">app&lt;/span>&lt;span class="o">=&lt;/span>web2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME CLASS HOSTS ADDRESS PORTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress.networking.k8s.io/web2 nginx web2.jimmyhome.tw &lt;span class="m">80&lt;/span> 56s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>以下都可以訪問nodeport
http://192.168.1.71:31568/
http://192.168.1.72:31568/
http://192.168.1.73:31568/
http://192.168.1.74:31568/
http://192.168.1.75:31568/
http://192.168.1.76:31568/&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231203230912.png"
loading="lazy"
>&lt;/p>
&lt;p>domain name也可以訪問，透過ingress-&amp;gt;service-&amp;gt;pod&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">chenqingze@chenqingze-MBP ~ % sudo vim /etc/hosts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.75 web2.jimmyhome.tw
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231203231115.png"
loading="lazy"
>&lt;/p>
&lt;h3 id="etcd服務">etcd服務&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl status etcd.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">● etcd.service - etcd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Loaded: loaded &lt;span class="o">(&lt;/span>/etc/systemd/system/etcd.service&lt;span class="p">;&lt;/span> enabled&lt;span class="p">;&lt;/span> vendor preset: enabled&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Active: active &lt;span class="o">(&lt;/span>running&lt;span class="o">)&lt;/span> since Sun 2023-12-03 14:43:39 UTC&lt;span class="p">;&lt;/span> 28min ago
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Main PID: &lt;span class="m">13409&lt;/span> &lt;span class="o">(&lt;/span>etcd&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Tasks: &lt;span class="m">14&lt;/span> &lt;span class="o">(&lt;/span>limit: 9387&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Memory: 117.0M
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CPU: 51.716s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CGroup: /system.slice/etcd.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └─13409 /usr/local/bin/etcd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 14:55:55 k8s-master71u etcd&lt;span class="o">[&lt;/span>13409&lt;span class="o">]&lt;/span>: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;level&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;info&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;ts&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;2023-12-03T14:55:55.63607Z&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;caller&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;mvcc/hash.go:137&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;msg&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;storing new hash&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;hash&amp;#34;&lt;/span>:1201138327,&lt;span class="s2">&amp;#34;re&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 15:06:09 k8s-master71u etcd[13409]: {&amp;#34;&lt;/span>level&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>info&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>ts&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>2023-12-03T15:06:09.854317Z&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>caller&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>mvcc/index.go:214&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>msg&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>compact tree index&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>revision&lt;span class="s2">&amp;#34;:3724}
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 15:06:09 k8s-master71u etcd[13409]: {&amp;#34;&lt;/span>level&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>info&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>ts&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>2023-12-03T15:06:09.942986Z&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>caller&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>mvcc/kvstore_compaction.go:66&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>msg&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>finished scheduled compac&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 15:06:09 k8s-master71u etcd&lt;span class="o">[&lt;/span>13409&lt;span class="o">]&lt;/span>: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;level&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;info&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;ts&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;2023-12-03T15:06:09.943036Z&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;caller&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;mvcc/hash.go:137&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;msg&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;storing new hash&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;hash&amp;#34;&lt;/span>:2096861132,&lt;span class="s2">&amp;#34;r&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 15:07:01 k8s-master71u etcd[13409]: {&amp;#34;&lt;/span>level&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>warn&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>ts&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>2023-12-03T15:07:01.091549Z&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>caller&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>etcdserver/util.go:170&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>msg&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>apply request took too long&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>to&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 15:07:01 k8s-master71u etcd&lt;span class="o">[&lt;/span>13409&lt;span class="o">]&lt;/span>: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;level&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;info&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;ts&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;2023-12-03T15:07:01.091613Z&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;caller&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;traceutil/trace.go:171&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;msg&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;trace[2099372944] range&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;detail&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 15:07:02 k8s-master71u etcd[13409]: {&amp;#34;&lt;/span>level&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>info&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>ts&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>2023-12-03T15:07:02.663992Z&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>caller&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>traceutil/trace.go:171&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>msg&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>trace&lt;span class="o">[&lt;/span>1476779153&lt;span class="o">]&lt;/span> transaction&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 15:11:09 k8s-master71u etcd&lt;span class="o">[&lt;/span>13409&lt;span class="o">]&lt;/span>: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;level&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;info&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;ts&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;2023-12-03T15:11:09.86509Z&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;caller&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;mvcc/index.go:214&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;msg&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;compact tree index&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;revision&amp;#34;&lt;/span>:4506&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 15:11:09 k8s-master71u etcd&lt;span class="o">[&lt;/span>13409&lt;span class="o">]&lt;/span>: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;level&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;info&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;ts&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;2023-12-03T15:11:09.890206Z&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;caller&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;mvcc/kvstore_compaction.go:66&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;msg&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;finished scheduled compac&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 15:11:09 k8s-master71u etcd[13409]: {&amp;#34;&lt;/span>level&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>info&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>ts&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>2023-12-03T15:11:09.890258Z&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>caller&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>mvcc/hash.go:137&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>msg&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>storing new hash&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>hash&lt;span class="s2">&amp;#34;:2253005372,&amp;#34;&lt;/span>r&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="cri-dockerd服務">cri-dockerd服務&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl status cri-dockerd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">● cri-dockerd.service - CRI Interface &lt;span class="k">for&lt;/span> Docker Application Container Engine
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Loaded: loaded &lt;span class="o">(&lt;/span>/etc/systemd/system/cri-dockerd.service&lt;span class="p">;&lt;/span> enabled&lt;span class="p">;&lt;/span> vendor preset: enabled&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Active: active &lt;span class="o">(&lt;/span>running&lt;span class="o">)&lt;/span> since Sun 2023-12-03 14:25:01 UTC&lt;span class="p">;&lt;/span> 46min ago
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TriggeredBy: ● cri-dockerd.socket
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Docs: https://docs.mirantis.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Main PID: &lt;span class="m">8096&lt;/span> &lt;span class="o">(&lt;/span>cri-dockerd&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Tasks: &lt;span class="m">14&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Memory: 19.4M
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CPU: 38.327s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CGroup: /system.slice/cri-dockerd.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └─8096 /usr/local/bin/cri-dockerd --container-runtime-endpoint unix:///var/run/cri-dockerd.sock --cni-conf-dir&lt;span class="o">=&lt;/span>/etc/cni/net.d --cni-bin-dir&lt;span class="o">=&lt;/span>/opt/cni/bin -&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 14:51:41 k8s-master71u cri-dockerd&lt;span class="o">[&lt;/span>8096&lt;span class="o">]&lt;/span>: 2023-12-03 14:51:41.774 &lt;span class="o">[&lt;/span>INFO&lt;span class="o">][&lt;/span>21767&lt;span class="o">]&lt;/span> dataplane_linux.go 473: Disabling IPv4 forwarding &lt;span class="nv">ContainerID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;b05ee1aac5d857271&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 14:51:41 k8s-master71u cri-dockerd[8096]: 2023-12-03 14:51:41.804 [INFO][21767] k8s.go 411: Added Mac, interface name, and active container ID to endpoint Conta&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 14:51:41 k8s-master71u cri-dockerd[8096]: 2023-12-03 14:51:41.825 [INFO][21767] k8s.go 489: Wrote updated endpoint to datastore ContainerID=&amp;#34;&lt;/span>b05ee1aac5d85727107&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 14:51:41 k8s-master71u cri-dockerd&lt;span class="o">[&lt;/span>8096&lt;span class="o">]&lt;/span>: &lt;span class="nv">time&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;2023-12-03T14:51:41Z&amp;#34;&lt;/span> &lt;span class="nv">level&lt;/span>&lt;span class="o">=&lt;/span>info &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Pulling image registry.k8s.io/ingress-nginx/controller:v1.9.4: 05535d57e64&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 14:51:51 k8s-master71u cri-dockerd[8096]: time=&amp;#34;&lt;/span>2023-12-03T14:51:51Z&lt;span class="s2">&amp;#34; level=info msg=&amp;#34;&lt;/span>Pulling image registry.k8s.io/ingress-nginx/controller:v1.9.4: 3da4cd537b4&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 14:51:52 k8s-master71u cri-dockerd&lt;span class="o">[&lt;/span>8096&lt;span class="o">]&lt;/span>: &lt;span class="nv">time&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;2023-12-03T14:51:52Z&amp;#34;&lt;/span> &lt;span class="nv">level&lt;/span>&lt;span class="o">=&lt;/span>info &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Will attempt to re-write config file /var/lib/docker/containers/e5ebeb0472&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 14:51:53 k8s-master71u cri-dockerd[8096]: time=&amp;#34;&lt;/span>2023-12-03T14:51:53Z&lt;span class="s2">&amp;#34; level=info msg=&amp;#34;&lt;/span>Stop pulling image registry.k8s.io/ingress-nginx/controller:v1.9.4: Status&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 14:55:33 k8s-master71u cri-dockerd&lt;span class="o">[&lt;/span>8096&lt;span class="o">]&lt;/span>: &lt;span class="nv">time&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;2023-12-03T14:55:33Z&amp;#34;&lt;/span> &lt;span class="nv">level&lt;/span>&lt;span class="o">=&lt;/span>info &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Docker cri received runtime config &amp;amp;RuntimeConfig{NetworkConfig:&amp;amp;NetworkCo&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 14:55:37 k8s-master71u cri-dockerd[8096]: time=&amp;#34;&lt;/span>2023-12-03T14:55:37Z&lt;span class="s2">&amp;#34; level=info msg=&amp;#34;&lt;/span>Will attempt to re-write config file /var/lib/docker/containers/f23d464928&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 14:56:08 k8s-master71u cri-dockerd&lt;span class="o">[&lt;/span>8096&lt;span class="o">]&lt;/span>: &lt;span class="nv">time&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;2023-12-03T14:56:08Z&amp;#34;&lt;/span> &lt;span class="nv">level&lt;/span>&lt;span class="o">=&lt;/span>info &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Will attempt to re-write config file /var/lib/docker/containers/651f69131d&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="kubelet服務">kubelet服務&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl status kubelet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">● kubelet.service - Kubernetes Kubelet Server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Loaded: loaded &lt;span class="o">(&lt;/span>/etc/systemd/system/kubelet.service&lt;span class="p">;&lt;/span> enabled&lt;span class="p">;&lt;/span> vendor preset: enabled&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Active: active &lt;span class="o">(&lt;/span>running&lt;span class="o">)&lt;/span> since Sun 2023-12-03 14:55:33 UTC&lt;span class="p">;&lt;/span> 16min ago
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Docs: https://github.com/GoogleCloudPlatform/kubernetes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Main PID: &lt;span class="m">27162&lt;/span> &lt;span class="o">(&lt;/span>kubelet&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Tasks: &lt;span class="m">16&lt;/span> &lt;span class="o">(&lt;/span>limit: 9387&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Memory: 42.9M
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CPU: 23.201s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CGroup: /system.slice/kubelet.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └─27162 /usr/local/bin/kubelet --v&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span> --node-ip&lt;span class="o">=&lt;/span>192.168.1.71 --hostname-override&lt;span class="o">=&lt;/span>k8s-master71u --bootstrap-kubeconfig&lt;span class="o">=&lt;/span>/etc/kubernetes/bootstrap-kubelet.con&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 15:11:31 k8s-master71u kubelet&lt;span class="o">[&lt;/span>27162&lt;span class="o">]&lt;/span>: E1203 15:11:31.892549 &lt;span class="m">27162&lt;/span> cri_stats_provider.go:643&lt;span class="o">]&lt;/span> &lt;span class="s2">&amp;#34;Unable to fetch container log stats&amp;#34;&lt;/span> &lt;span class="nv">err&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;failed to get fsstats&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 15:11:33 k8s-master71u kubelet[27162]: I1203 15:11:33.187859 27162 kubelet_getters.go:182] &amp;#34;&lt;/span>Pod status updated&lt;span class="s2">&amp;#34; pod=&amp;#34;&lt;/span>kube-system/kube-apiserver-k8s-master71u&lt;span class="s2">&amp;#34;&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 15:11:33 k8s-master71u kubelet[27162]: I1203 15:11:33.187909 27162 kubelet_getters.go:182] &amp;#34;&lt;/span>Pod status updated&lt;span class="s2">&amp;#34; pod=&amp;#34;&lt;/span>kube-system/kube-controller-manager-k8s-m&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 15:11:33 k8s-master71u kubelet&lt;span class="o">[&lt;/span>27162&lt;span class="o">]&lt;/span>: I1203 15:11:33.187921 &lt;span class="m">27162&lt;/span> kubelet_getters.go:182&lt;span class="o">]&lt;/span> &lt;span class="s2">&amp;#34;Pod status updated&amp;#34;&lt;/span> &lt;span class="nv">pod&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;kube-system/kube-scheduler-k8s-master71u&amp;#34;&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 15:11:42 k8s-master71u kubelet&lt;span class="o">[&lt;/span>27162&lt;span class="o">]&lt;/span>: E1203 15:11:42.968925 &lt;span class="m">27162&lt;/span> cri_stats_provider.go:643&lt;span class="o">]&lt;/span> &lt;span class="s2">&amp;#34;Unable to fetch container log stats&amp;#34;&lt;/span> &lt;span class="nv">err&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;failed to get fsstats&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 15:11:42 k8s-master71u kubelet[27162]: E1203 15:11:42.969222 27162 cri_stats_provider.go:643] &amp;#34;&lt;/span>Unable to fetch container log stats&lt;span class="s2">&amp;#34; err=&amp;#34;&lt;/span>failed to get fsstats&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 15:11:54 k8s-master71u kubelet&lt;span class="o">[&lt;/span>27162&lt;span class="o">]&lt;/span>: E1203 15:11:54.050355 &lt;span class="m">27162&lt;/span> cri_stats_provider.go:643&lt;span class="o">]&lt;/span> &lt;span class="s2">&amp;#34;Unable to fetch container log stats&amp;#34;&lt;/span> &lt;span class="nv">err&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;failed to get fsstats&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 15:11:54 k8s-master71u kubelet[27162]: E1203 15:11:54.050462 27162 cri_stats_provider.go:643] &amp;#34;&lt;/span>Unable to fetch container log stats&lt;span class="s2">&amp;#34; err=&amp;#34;&lt;/span>failed to get fsstats&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 15:12:05 k8s-master71u kubelet&lt;span class="o">[&lt;/span>27162&lt;span class="o">]&lt;/span>: E1203 15:12:05.124399 &lt;span class="m">27162&lt;/span> cri_stats_provider.go:643&lt;span class="o">]&lt;/span> &lt;span class="s2">&amp;#34;Unable to fetch container log stats&amp;#34;&lt;/span> &lt;span class="nv">err&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;failed to get fsstats&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 15:12:05 k8s-master71u kubelet[27162]: E1203 15:12:05.124943 27162 cri_stats_provider.go:643] &amp;#34;&lt;/span>Unable to fetch container log stats&lt;span class="s2">&amp;#34; err=&amp;#34;&lt;/span>failed to get fsstats&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="憑證與金鑰">憑證與金鑰&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# &lt;span class="nb">cd&lt;/span> /etc/kubernetes/pki
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:/etc/kubernetes/pki# ll
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total &lt;span class="m">56&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">4096&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 ./
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">5&lt;/span> kube root &lt;span class="m">4096&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 ../
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1428&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 apiserver.crt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1679&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 apiserver.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1164&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 apiserver-kubelet-client.crt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1679&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 apiserver-kubelet-client.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1099&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 ca.crt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1675&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 ca.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1115&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 front-proxy-ca.crt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1675&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 front-proxy-ca.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1119&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 front-proxy-client.crt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1675&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 front-proxy-client.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1679&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 sa.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">451&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 sa.pub
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:/etc/kubernetes/pki# &lt;span class="k">for&lt;/span> i in &lt;span class="k">$(&lt;/span>ls *.crt&lt;span class="k">)&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;===== &lt;/span>&lt;span class="nv">$i&lt;/span>&lt;span class="s2"> =====&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> openssl x509 -in &lt;span class="nv">$i&lt;/span> -text -noout &lt;span class="p">|&lt;/span> grep -A &lt;span class="m">3&lt;/span> &lt;span class="s1">&amp;#39;Validity&amp;#39;&lt;/span> &lt;span class="p">;&lt;/span> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> apiserver.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:45:49 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Dec &lt;span class="m">2&lt;/span> 14:45:50 &lt;span class="m">2024&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> kube-apiserver
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> apiserver-kubelet-client.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:45:49 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Dec &lt;span class="m">2&lt;/span> 14:45:50 &lt;span class="m">2024&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">O&lt;/span> &lt;span class="o">=&lt;/span> system:masters, &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> kube-apiserver-kubelet-client
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> ca.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:45:49 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">30&lt;/span> 14:45:49 &lt;span class="m">2033&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">kubernetes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> front-proxy-ca.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:45:50 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">30&lt;/span> 14:45:50 &lt;span class="m">2033&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> front-proxy-ca
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> front-proxy-client.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:45:50 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Dec &lt;span class="m">2&lt;/span> 14:45:51 &lt;span class="m">2024&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> front-proxy-client
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="etcd憑證與金鑰">etcd憑證與金鑰&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:/etc/kubernetes/pki# &lt;span class="nb">cd&lt;/span> /etc/ssl/etcd/ssl/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:/etc/ssl/etcd/ssl# ll
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total &lt;span class="m">84&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwx------ &lt;span class="m">2&lt;/span> etcd root &lt;span class="m">4096&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 ./
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwx------ &lt;span class="m">3&lt;/span> etcd root &lt;span class="m">37&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 ../
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1704&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 admin-k8s-master71u-key.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1476&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 admin-k8s-master71u.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1704&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 admin-k8s-master72u-key.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1476&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 admin-k8s-master72u.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1708&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 admin-k8s-master73u-key.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1476&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 admin-k8s-master73u.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1704&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 ca-key.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1111&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 ca.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1704&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 member-k8s-master71u-key.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1480&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 member-k8s-master71u.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1704&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 member-k8s-master72u-key.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1480&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 member-k8s-master72u.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1704&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 member-k8s-master73u-key.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1480&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 member-k8s-master73u.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1704&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 node-k8s-master71u-key.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1476&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 node-k8s-master71u.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1704&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 node-k8s-master72u-key.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1476&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 node-k8s-master72u.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1704&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 node-k8s-master73u-key.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1476&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 node-k8s-master73u.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:/etc/ssl/etcd/ssl# &lt;span class="k">for&lt;/span> i in &lt;span class="k">$(&lt;/span>ls *.pem &lt;span class="p">|&lt;/span> egrep -v &lt;span class="s2">&amp;#34;key&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;===== &lt;/span>&lt;span class="nv">$i&lt;/span>&lt;span class="s2"> =====&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> openssl x509 -in &lt;span class="nv">$i&lt;/span> -text -noout &lt;span class="p">|&lt;/span> grep -A &lt;span class="m">3&lt;/span> &lt;span class="s1">&amp;#39;Validity&amp;#39;&lt;/span> &lt;span class="p">;&lt;/span> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> admin-k8s-master71u.pem &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:42:05 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">9&lt;/span> 14:42:05 &lt;span class="m">2123&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> etcd-admin-k8s-master71u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> admin-k8s-master72u.pem &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:42:06 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">9&lt;/span> 14:42:06 &lt;span class="m">2123&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> etcd-admin-k8s-master72u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> admin-k8s-master73u.pem &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:42:07 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">9&lt;/span> 14:42:07 &lt;span class="m">2123&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> etcd-admin-k8s-master73u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> ca.pem &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:42:05 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">9&lt;/span> 14:42:05 &lt;span class="m">2123&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> etcd-ca
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> member-k8s-master71u.pem &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:42:05 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">9&lt;/span> 14:42:05 &lt;span class="m">2123&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> etcd-member-k8s-master71u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> member-k8s-master72u.pem &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:42:06 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">9&lt;/span> 14:42:06 &lt;span class="m">2123&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> etcd-member-k8s-master72u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> member-k8s-master73u.pem &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:42:06 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">9&lt;/span> 14:42:06 &lt;span class="m">2123&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> etcd-member-k8s-master73u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> node-k8s-master71u.pem &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:42:07 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">9&lt;/span> 14:42:07 &lt;span class="m">2123&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> etcd-node-k8s-master71u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> node-k8s-master72u.pem &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:42:07 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">9&lt;/span> 14:42:07 &lt;span class="m">2123&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> etcd-node-k8s-master72u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> node-k8s-master73u.pem &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:42:07 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">9&lt;/span> 14:42:07 &lt;span class="m">2123&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> etcd-node-k8s-master73u
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="安裝rancher管理平台高可用">安裝rancher管理平台(高可用)&lt;/h3>
&lt;p>詳細操作可以參考我這篇：
&lt;a class="link" href="https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/" target="_blank" rel="noopener"
>https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/&lt;/a>&lt;/p>
&lt;h4 id="一添加-helm-chart-倉庫">一、添加 Helm Chart 倉庫&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm repo add rancher-stable https://releases.rancher.com/server-charts/stable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;rancher-stable&amp;#34;&lt;/span> has been added to your repositories
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="二為-rancher-建立命名空間">二、為 Rancher 建立命名空間&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl create namespace cattle-system
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="三選擇-ssl-配置">三、選擇 SSL 配置&lt;/h4>
&lt;p>Rancher 產生的憑證（預設）
需要 cert-manager&lt;/p>
&lt;h4 id="四安裝-cert-manager">四、安裝 cert-manager&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 如果你手動安裝了CRD，而不是在 Helm 安裝命令中添加了 &amp;#39;--set installCRDs=true&amp;#39; 選項，你應該在升級 Helm Chart 之前升級 CRD 資源。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.11.0/cert-manager.crds.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 添加 Jetstack Helm 倉庫&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm repo add jetstack https://charts.jetstack.io
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 更新本地 Helm Chart 倉庫緩存&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm repo update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Hang tight &lt;span class="k">while&lt;/span> we grab the latest from your chart repositories...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...Successfully got an update from the &lt;span class="s2">&amp;#34;jetstack&amp;#34;&lt;/span> chart repository
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...Successfully got an update from the &lt;span class="s2">&amp;#34;rancher-stable&amp;#34;&lt;/span> chart repository
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Update Complete. ⎈Happy Helming!⎈
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安裝 cert-manager Helm Chart&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm install cert-manager jetstack/cert-manager &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --namespace cert-manager &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --create-namespace &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --version v1.11.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安裝完 cert-manager 后，你可以通過檢查 cert-manager 命名空間中正在運行的 Pod 來驗證它是否已正確部署&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pods --namespace cert-manager
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cert-manager-64f9f45d6f-vklzz 1/1 Running &lt;span class="m">0&lt;/span> 37s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cert-manager-cainjector-56bbdd5c47-wv2l7 1/1 Running &lt;span class="m">0&lt;/span> 37s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cert-manager-webhook-d4f4545d7-pw2cp 1/1 Running &lt;span class="m">0&lt;/span> 37s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="五根據你選擇的證書選項通過-helm-安裝-rancher">五、根據你選擇的證書選項，通過 Helm 安裝 Rancher&lt;/h4>
&lt;p>採Rancher 生成的證書方式&lt;/p>
&lt;p>Rancher Helm Chart 選項：
&lt;a class="link" href="https://ranchermanager.docs.rancher.com/zh/getting-started/installation-and-upgrade/installation-references/helm-chart-options" target="_blank" rel="noopener"
>https://ranchermanager.docs.rancher.com/zh/getting-started/installation-and-upgrade/installation-references/helm-chart-options&lt;/a>&lt;/p>
&lt;p>&lt;font color=red>需多指定ingressClassName為nginx&lt;/font>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm install rancher rancher-stable/rancher &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --namespace cattle-system &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --set &lt;span class="nv">hostname&lt;/span>&lt;span class="o">=&lt;/span>rancher.jimmyhome.tw &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --set &lt;span class="nv">bootstrapPassword&lt;/span>&lt;span class="o">=&lt;/span>admin &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --set ingress.ingressClassName&lt;span class="o">=&lt;/span>nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME: rancher
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">LAST DEPLOYED: Sun Dec &lt;span class="m">3&lt;/span> 15:40:43 &lt;span class="m">2023&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAMESPACE: cattle-system
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">STATUS: deployed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">REVISION: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TEST SUITE: None
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NOTES:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Rancher Server has been installed.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NOTE: Rancher may take several minutes to fully initialize. Please standby &lt;span class="k">while&lt;/span> Certificates are being issued, Containers are started and the Ingress rule comes up.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Check out our docs at https://rancher.com/docs/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">If you provided your own bootstrap password during installation, browse to https://rancher.jimmyhome.tw to get started.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">If this is the first &lt;span class="nb">time&lt;/span> you installed Rancher, get started by running this &lt;span class="nb">command&lt;/span> and clicking the URL it generates:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> https://rancher.jimmyhome.tw/dashboard/?setup&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>kubectl get secret --namespace cattle-system bootstrap-secret -o go-template&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;{{.data.bootstrapPassword|base64decode}}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">To get just the bootstrap password on its own, run:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubectl get secret --namespace cattle-system bootstrap-secret -o go-template&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;{{.data.bootstrapPassword|base64decode}}{{ &amp;#34;\n&amp;#34; }}&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Happy Containering!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 等待 Rancher 運行&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl -n cattle-system rollout status deploy/rancher
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Waiting &lt;span class="k">for&lt;/span> deployment &lt;span class="s2">&amp;#34;rancher&amp;#34;&lt;/span> rollout to finish: &lt;span class="m">0&lt;/span> of &lt;span class="m">3&lt;/span> updated replicas are available...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Waiting &lt;span class="k">for&lt;/span> deployment &lt;span class="s2">&amp;#34;rancher&amp;#34;&lt;/span> rollout to finish: &lt;span class="m">1&lt;/span> of &lt;span class="m">3&lt;/span> updated replicas are available...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Waiting &lt;span class="k">for&lt;/span> deployment &lt;span class="s2">&amp;#34;rancher&amp;#34;&lt;/span> rollout to finish: &lt;span class="m">2&lt;/span> of &lt;span class="m">3&lt;/span> updated replicas are available...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment &lt;span class="s2">&amp;#34;rancher&amp;#34;&lt;/span> successfully rolled out
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="六驗證-rancher-server-是否部署成功">六、驗證 Rancher Server 是否部署成功&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl -n cattle-system get deploy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY UP-TO-DATE AVAILABLE AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rancher 3/3 &lt;span class="m">3&lt;/span> &lt;span class="m">3&lt;/span> 5m2s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl -n cattle-system get pod -o wide
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">helm-operation-hpd69 2/2 Running &lt;span class="m">0&lt;/span> 40s 10.201.14.138 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rancher-64cf6ddd96-pcfv5 1/1 Running &lt;span class="m">0&lt;/span> 5m11s 10.201.255.201 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rancher-64cf6ddd96-q7dhp 1/1 Running &lt;span class="m">0&lt;/span> 5m11s 10.201.255.202 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rancher-64cf6ddd96-rr28z 1/1 Running &lt;span class="m">0&lt;/span> 5m11s 10.201.14.137 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl -n cattle-system get ingress
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME CLASS HOSTS ADDRESS PORTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rancher nginx rancher.jimmyhome.tw 80, &lt;span class="m">443&lt;/span> 5m35s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 我自己的筆電，先設定/etc/hosts測試網頁訪問&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 如是內部有dns server的，就到dns server設定a record解析&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chenqingze@chenqingze-MBP ~ % sudo vim /etc/hosts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.75 rancher.jimmyhome.tw
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>打 &lt;a class="link" href="https://rancher.jimmyhome.tw" target="_blank" rel="noopener"
>https://rancher.jimmyhome.tw&lt;/a> 可以看到網頁&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231203234722.png"
loading="lazy"
>&lt;/p>
&lt;p>由上方helm install rancher完成時，可以看到以下兩個指令，可以獲取到預設admin帳號的密碼&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># If this is the first time you installed Rancher, get started by running this command and clicking the URL it generates&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# &lt;span class="nb">echo&lt;/span> https://rancher.jimmyhome.tw/dashboard/?setup&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>kubectl get secret --namespace cattle-system bootstrap-secret -o go-template&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;{{.data.bootstrapPassword|base64decode}}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">https://rancher.jimmyhome.tw/dashboard/?setup&lt;span class="o">=&lt;/span>admin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># To get just the bootstrap password on its own, run&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get secret --namespace cattle-system bootstrap-secret -o go-template&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;{{.data.bootstrapPassword|base64decode}}{{ &amp;#34;\n&amp;#34; }}&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">admin
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>重設admin帳號的密碼&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231203235051.png"
loading="lazy"
>&lt;/p>
&lt;p>可以看到集群資訊，state為Active
&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231203235121.png"
loading="lazy"
>&lt;/p>
&lt;p>進入集群，可以看到集群詳細訊息
&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231203235142.png"
loading="lazy"
>&lt;/p>
&lt;p>也可以使用dashboard shell去管理集群
&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231203235210.png"
loading="lazy"
>&lt;/p>
&lt;h3 id="安裝rook-ceph分布式存儲系統">安裝rook-ceph分布式存儲系統&lt;/h3>
&lt;p>詳細操作可以參考我這篇：
&lt;a class="link" href="https://blog.goldfishbrain-fighting.com/2023/kubernetes-rook-ceph/" target="_blank" rel="noopener"
>https://blog.goldfishbrain-fighting.com/2023/kubernetes-rook-ceph/&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# lsblk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINTS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop0 7:0 &lt;span class="m">0&lt;/span> 63.4M &lt;span class="m">1&lt;/span> loop /snap/core20/1974
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop1 7:1 &lt;span class="m">0&lt;/span> 63.5M &lt;span class="m">1&lt;/span> loop /snap/core20/2015
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop2 7:2 &lt;span class="m">0&lt;/span> 111.9M &lt;span class="m">1&lt;/span> loop /snap/lxd/24322
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop3 7:3 &lt;span class="m">0&lt;/span> 40.8M &lt;span class="m">1&lt;/span> loop /snap/snapd/20092
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop4 7:4 &lt;span class="m">0&lt;/span> 40.9M &lt;span class="m">1&lt;/span> loop /snap/snapd/20290
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sda 8:0 &lt;span class="m">0&lt;/span> 50G &lt;span class="m">0&lt;/span> disk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├─sda1 8:1 &lt;span class="m">0&lt;/span> 1M &lt;span class="m">0&lt;/span> part
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├─sda2 8:2 &lt;span class="m">0&lt;/span> 2G &lt;span class="m">0&lt;/span> part /boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└─sda3 8:3 &lt;span class="m">0&lt;/span> 48G &lt;span class="m">0&lt;/span> part
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └─ubuntu--vg-root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 253:0 &lt;span class="m">0&lt;/span> 48G &lt;span class="m">0&lt;/span> lvm /var/lib/kubelet/pods/ce7174f8-ad8f-4f42-8e58-2abca8c91424/volume-subpaths/tigera-ca-bundle/calico-node/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sdb 8:16 &lt;span class="m">0&lt;/span> 16G &lt;span class="m">0&lt;/span> disk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sr0 11:0 &lt;span class="m">1&lt;/span> 1024M &lt;span class="m">0&lt;/span> rom
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# lsblk -f
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME FSTYPE FSVER LABEL UUID FSAVAIL FSUSE% MOUNTPOINTS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> squash 4.0 &lt;span class="m">0&lt;/span> 100% /snap/core20/1974
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> squash 4.0 &lt;span class="m">0&lt;/span> 100% /snap/core20/2015
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> squash 4.0 &lt;span class="m">0&lt;/span> 100% /snap/lxd/24322
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> squash 4.0 &lt;span class="m">0&lt;/span> 100% /snap/snapd/20092
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> squash 4.0 &lt;span class="m">0&lt;/span> 100% /snap/snapd/20290
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sda
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├─sda1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├─sda2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ xfs f681192a-1cf2-4362-a74c-745374011700 1.8G 9% /boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└─sda3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> LVM2_m LVM2 JEduSv-mV9g-tzdJ-sYEc-6piR-6nAo-48Srdh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └─ubuntu--vg-root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> xfs 19cd87ec-9741-4295-9762-e87fb4f472c8 37.9G 21% /var/lib/kubelet/pods/ce7174f8-ad8f-4f42-8e58-2abca8c91424/volume-subpaths/tigera-ca-bundle/calico-node/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sdb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# lsblk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINTS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop0 7:0 &lt;span class="m">0&lt;/span> 63.4M &lt;span class="m">1&lt;/span> loop /snap/core20/1974
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop1 7:1 &lt;span class="m">0&lt;/span> 63.5M &lt;span class="m">1&lt;/span> loop /snap/core20/2015
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop2 7:2 &lt;span class="m">0&lt;/span> 111.9M &lt;span class="m">1&lt;/span> loop /snap/lxd/24322
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop3 7:3 &lt;span class="m">0&lt;/span> 40.8M &lt;span class="m">1&lt;/span> loop /snap/snapd/20092
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop4 7:4 &lt;span class="m">0&lt;/span> 40.9M &lt;span class="m">1&lt;/span> loop /snap/snapd/20290
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sda 8:0 &lt;span class="m">0&lt;/span> 50G &lt;span class="m">0&lt;/span> disk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├─sda1 8:1 &lt;span class="m">0&lt;/span> 1M &lt;span class="m">0&lt;/span> part
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├─sda2 8:2 &lt;span class="m">0&lt;/span> 2G &lt;span class="m">0&lt;/span> part /boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└─sda3 8:3 &lt;span class="m">0&lt;/span> 48G &lt;span class="m">0&lt;/span> part
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └─ubuntu--vg-root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 253:0 &lt;span class="m">0&lt;/span> 48G &lt;span class="m">0&lt;/span> lvm /var/lib/kubelet/pods/ce7174f8-ad8f-4f42-8e58-2abca8c91424/volume-subpaths/tigera-ca-bundle/calico-node/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sdb 8:16 &lt;span class="m">0&lt;/span> 16G &lt;span class="m">0&lt;/span> disk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sr0 11:0 &lt;span class="m">1&lt;/span> 1024M &lt;span class="m">0&lt;/span> rom
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# git clone --single-branch --branch v1.12.8 https://github.com/rook/rook.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# &lt;span class="nb">cd&lt;/span> rook/deploy/examples
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f crds.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephblockpoolradosnamespaces.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephblockpools.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephbucketnotifications.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephbuckettopics.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephclients.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephclusters.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephcosidrivers.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephfilesystemmirrors.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephfilesystems.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephfilesystemsubvolumegroups.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephnfses.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephobjectrealms.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephobjectstores.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephobjectstoreusers.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephobjectzonegroups.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephobjectzones.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephrbdmirrors.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/objectbucketclaims.objectbucket.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/objectbuckets.objectbucket.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f common.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">namespace/rook-ceph created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/cephfs-csi-nodeplugin created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/cephfs-external-provisioner-runner created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/objectstorage-provisioner-role created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/rbd-csi-nodeplugin created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/rbd-external-provisioner-runner created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/rook-ceph-cluster-mgmt created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/rook-ceph-global created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/rook-ceph-mgr-cluster created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/rook-ceph-mgr-system created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/rook-ceph-object-bucket created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/rook-ceph-osd created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/rook-ceph-system created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrolebinding.rbac.authorization.k8s.io/cephfs-csi-nodeplugin-role created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrolebinding.rbac.authorization.k8s.io/cephfs-csi-provisioner-role created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrolebinding.rbac.authorization.k8s.io/objectstorage-provisioner-role-binding created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrolebinding.rbac.authorization.k8s.io/rbd-csi-nodeplugin created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrolebinding.rbac.authorization.k8s.io/rbd-csi-provisioner-role created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrolebinding.rbac.authorization.k8s.io/rook-ceph-global created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrolebinding.rbac.authorization.k8s.io/rook-ceph-mgr-cluster created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrolebinding.rbac.authorization.k8s.io/rook-ceph-object-bucket created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrolebinding.rbac.authorization.k8s.io/rook-ceph-osd created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrolebinding.rbac.authorization.k8s.io/rook-ceph-system created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">role.rbac.authorization.k8s.io/cephfs-external-provisioner-cfg created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">role.rbac.authorization.k8s.io/rbd-csi-nodeplugin created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">role.rbac.authorization.k8s.io/rbd-external-provisioner-cfg created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">role.rbac.authorization.k8s.io/rook-ceph-cmd-reporter created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">role.rbac.authorization.k8s.io/rook-ceph-mgr created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">role.rbac.authorization.k8s.io/rook-ceph-osd created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">role.rbac.authorization.k8s.io/rook-ceph-purge-osd created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">role.rbac.authorization.k8s.io/rook-ceph-rgw created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">role.rbac.authorization.k8s.io/rook-ceph-system created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/cephfs-csi-provisioner-role-cfg created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/rbd-csi-nodeplugin-role-cfg created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/rbd-csi-provisioner-role-cfg created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/rook-ceph-cluster-mgmt created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/rook-ceph-cmd-reporter created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/rook-ceph-mgr created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/rook-ceph-mgr-system created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/rook-ceph-osd created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/rook-ceph-purge-osd created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/rook-ceph-rgw created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/rook-ceph-system created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/objectstorage-provisioner created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/rook-ceph-cmd-reporter created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/rook-ceph-mgr created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/rook-ceph-osd created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/rook-ceph-purge-osd created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/rook-ceph-rgw created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/rook-ceph-system created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/rook-csi-cephfs-plugin-sa created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/rook-csi-cephfs-provisioner-sa created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/rook-csi-rbd-plugin-sa created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/rook-csi-rbd-provisioner-sa created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f operator.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">configmap/rook-ceph-operator-config created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment.apps/rook-ceph-operator created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get deployments.apps -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY UP-TO-DATE AVAILABLE AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-operator 1/1 &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> 22s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get pod -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-operator-58775c8bdf-vmdkn 1/1 Running &lt;span class="m">0&lt;/span> 39s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# vim cluster.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 角色調度&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> placement:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mon:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeAffinity:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requiredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeSelectorTerms:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: ceph-mon
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tolerations:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: Exists
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mgr:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeAffinity:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requiredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeSelectorTerms:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: ceph-mgr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tolerations:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: Exists
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> osd:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeAffinity:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requiredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeSelectorTerms:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: ceph-osd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tolerations:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: Exists
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> prepareosd:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeAffinity:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requiredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeSelectorTerms:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: ceph-osd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tolerations:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: Exists
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 角色資源&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> resources:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mon:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> limits:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: &lt;span class="s2">&amp;#34;1000m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: &lt;span class="s2">&amp;#34;2048Mi&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requests:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: &lt;span class="s2">&amp;#34;1000m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: &lt;span class="s2">&amp;#34;2048Mi&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mgr:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> limits:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: &lt;span class="s2">&amp;#34;1000m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: &lt;span class="s2">&amp;#34;1024Mi&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requests:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: &lt;span class="s2">&amp;#34;1000m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: &lt;span class="s2">&amp;#34;1024Mi&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> osd:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> limits:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: &lt;span class="s2">&amp;#34;1000m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: &lt;span class="s2">&amp;#34;2048Mi&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requests:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: &lt;span class="s2">&amp;#34;1000m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: &lt;span class="s2">&amp;#34;2048Mi&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 磁碟調度&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;k8s-master71u&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> devices:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;sdb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> config:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storeType: bluestore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> journalSizeMB: &lt;span class="s2">&amp;#34;4096&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;k8s-master72u&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> devices:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;sdb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> config:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storeType: bluestore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> journalSizeMB: &lt;span class="s2">&amp;#34;4096&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;k8s-master73u&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> devices:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;sdb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> config:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storeType: bluestore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> journalSizeMB: &lt;span class="s2">&amp;#34;4096&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;k8s-node75u&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> devices:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;sdb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> config:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storeType: bluestore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> journalSizeMB: &lt;span class="s2">&amp;#34;4096&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;k8s-node76u&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> devices:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;sdb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> config:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storeType: bluestore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> journalSizeMB: &lt;span class="s2">&amp;#34;4096&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 關閉磁碟自動全部調度&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storage: &lt;span class="c1"># cluster level storage configuration and selection&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#設置磁碟的參數，調整為false，方便後面訂製&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> useAllNodes: &lt;span class="nb">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> useAllDevices: &lt;span class="nb">false&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master71u ceph-mon&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-master71u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master72u ceph-mon&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-master72u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master73u ceph-mon&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-master73u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master71u ceph-mgr&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-master71u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master72u ceph-mgr&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-master72u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master73u ceph-mgr&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-master73u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master71u ceph-osd&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-master71u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master72u ceph-osd&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-master72u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master73u ceph-osd&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-master73u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-node75u ceph-osd&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-node75u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-node76u ceph-osd&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-node76u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f cluster.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cephcluster.ceph.rook.io/rook-ceph created
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get pod -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-cephfsplugin-nttgx 2/2 Running &lt;span class="m">0&lt;/span> 9m33s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-cephfsplugin-provisioner-668dfcf95b-dsxdk 5/5 Running &lt;span class="m">0&lt;/span> 9m33s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-cephfsplugin-provisioner-668dfcf95b-rgfv6 5/5 Running &lt;span class="m">0&lt;/span> 9m33s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-cephfsplugin-s6sc9 2/2 Running &lt;span class="m">0&lt;/span> 9m33s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-rbdplugin-bjv2p 2/2 Running &lt;span class="m">0&lt;/span> 9m33s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-rbdplugin-provisioner-5b78f67bbb-8ts8q 5/5 Running &lt;span class="m">0&lt;/span> 9m33s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-rbdplugin-provisioner-5b78f67bbb-rr5tn 5/5 Running &lt;span class="m">0&lt;/span> 9m33s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-rbdplugin-xb99w 2/2 Running &lt;span class="m">0&lt;/span> 9m33s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-crashcollector-k8s-master71u-55fcdbd66c-plz8m 1/1 Running &lt;span class="m">0&lt;/span> 2m57s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-crashcollector-k8s-master72u-675646bf64-8tl2q 1/1 Running &lt;span class="m">0&lt;/span> 3m18s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-crashcollector-k8s-master73u-84fdc469f7-9fkgh 1/1 Running &lt;span class="m">0&lt;/span> 2m56s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-crashcollector-k8s-node75u-bbc794dd9-rv4pw 1/1 Running &lt;span class="m">0&lt;/span> 11s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-crashcollector-k8s-node76u-5fd59cd68b-wljnj 1/1 Running &lt;span class="m">0&lt;/span> 73s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-a-59f556dbc9-695bv 3/3 Running &lt;span class="m">0&lt;/span> 3m33s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-b-f4c7855d-j69fj 3/3 Running &lt;span class="m">0&lt;/span> 3m33s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-a-b657589fb-c7c4f 2/2 Running &lt;span class="m">0&lt;/span> 8m2s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-b-6bdf47675f-tbhg8 2/2 Running &lt;span class="m">0&lt;/span> 3m59s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-c-5dcbc556d7-9zmmn 2/2 Running &lt;span class="m">0&lt;/span> 3m48s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-operator-58775c8bdf-m29b4 1/1 Running &lt;span class="m">0&lt;/span> 14m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-0-5b8dfc978f-fwlsv 2/2 Running &lt;span class="m">0&lt;/span> 2m58s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-1-c9544b764-gzcmd 2/2 Running &lt;span class="m">0&lt;/span> 2m57s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-2-897687cc9-mrntq 2/2 Running &lt;span class="m">0&lt;/span> 2m56s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-3-6c7c659454-9wk9z 2/2 Running &lt;span class="m">0&lt;/span> 73s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-4-68dcf49f6-vcpsj 1/2 Running &lt;span class="m">0&lt;/span> 12s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-prepare-k8s-master71u-6fjrl 0/1 Completed &lt;span class="m">0&lt;/span> 3m11s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-prepare-k8s-master72u-5mcbk 0/1 Completed &lt;span class="m">0&lt;/span> 3m10s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-prepare-k8s-master73u-cjklw 0/1 Completed &lt;span class="m">0&lt;/span> 3m9s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-prepare-k8s-node75u-tk24w 0/1 Completed &lt;span class="m">0&lt;/span> 3m8s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-prepare-k8s-node76u-7hqrg 0/1 Completed &lt;span class="m">0&lt;/span> 3m8s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f toolbox.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment.apps/rook-ceph-tools created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get pod -n rook-ceph &lt;span class="p">|&lt;/span> grep -i tool
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-tools-7cd4cd9c9c-54zk2 1/1 Running &lt;span class="m">0&lt;/span> 34s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl &lt;span class="nb">exec&lt;/span> -it rook-ceph-tools-7cd4cd9c9c-54zk2 -n rook-ceph -- /bin/bash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ ceph -s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cluster:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> id: 9da44d3d-58d1-402d-8f8b-66bd89a869a4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> health: HEALTH_OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> services:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mon: &lt;span class="m">3&lt;/span> daemons, quorum a,b,c &lt;span class="o">(&lt;/span>age 5m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mgr: a&lt;span class="o">(&lt;/span>active, starting, since 11s&lt;span class="o">)&lt;/span>, standbys: b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> osd: &lt;span class="m">5&lt;/span> osds: &lt;span class="m">5&lt;/span> up &lt;span class="o">(&lt;/span>since 93s&lt;span class="o">)&lt;/span>, &lt;span class="m">5&lt;/span> in &lt;span class="o">(&lt;/span>since 117s&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pools: &lt;span class="m">1&lt;/span> pools, &lt;span class="m">1&lt;/span> pgs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> objects: &lt;span class="m">2&lt;/span> objects, &lt;span class="m">449&lt;/span> KiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> usage: &lt;span class="m">41&lt;/span> MiB used, &lt;span class="m">80&lt;/span> GiB / &lt;span class="m">80&lt;/span> GiB avail
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pgs: &lt;span class="m">1&lt;/span> active+clean
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ ceph status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cluster:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> id: 9da44d3d-58d1-402d-8f8b-66bd89a869a4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> health: HEALTH_OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> services:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mon: &lt;span class="m">3&lt;/span> daemons, quorum a,b,c &lt;span class="o">(&lt;/span>age 5m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mgr: a&lt;span class="o">(&lt;/span>active, since 10s&lt;span class="o">)&lt;/span>, standbys: b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> osd: &lt;span class="m">5&lt;/span> osds: &lt;span class="m">5&lt;/span> up &lt;span class="o">(&lt;/span>since 104s&lt;span class="o">)&lt;/span>, &lt;span class="m">5&lt;/span> in &lt;span class="o">(&lt;/span>since 2m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pools: &lt;span class="m">1&lt;/span> pools, &lt;span class="m">1&lt;/span> pgs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> objects: &lt;span class="m">2&lt;/span> objects, &lt;span class="m">449&lt;/span> KiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> usage: &lt;span class="m">41&lt;/span> MiB used, &lt;span class="m">80&lt;/span> GiB / &lt;span class="m">80&lt;/span> GiB avail
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pgs: &lt;span class="m">1&lt;/span> active+clean
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ ceph osd status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ID HOST USED AVAIL WR OPS WR DATA RD OPS RD DATA STATE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">0&lt;/span> k8s-master71u 8788k 15.9G &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> exists,up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">1&lt;/span> k8s-master72u 8272k 15.9G &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> exists,up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">2&lt;/span> k8s-master73u 8788k 15.9G &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> exists,up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">3&lt;/span> k8s-node76u 8404k 15.9G &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> exists,up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4&lt;/span> k8s-node75u 7888k 15.9G &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> exists,up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ ceph df
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--- RAW STORAGE ---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CLASS SIZE AVAIL USED RAW USED %RAW USED
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ssd &lt;span class="m">80&lt;/span> GiB &lt;span class="m">80&lt;/span> GiB &lt;span class="m">41&lt;/span> MiB &lt;span class="m">41&lt;/span> MiB 0.05
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TOTAL &lt;span class="m">80&lt;/span> GiB &lt;span class="m">80&lt;/span> GiB &lt;span class="m">41&lt;/span> MiB &lt;span class="m">41&lt;/span> MiB 0.05
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--- POOLS ---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">POOL ID PGS STORED OBJECTS USED %USED MAX AVAIL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.mgr &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">449&lt;/span> KiB &lt;span class="m">2&lt;/span> &lt;span class="m">449&lt;/span> KiB &lt;span class="m">0&lt;/span> &lt;span class="m">25&lt;/span> GiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ rados df
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">POOL_NAME USED OBJECTS CLONES COPIES MISSING_ON_PRIMARY UNFOUND DEGRADED RD_OPS RD WR_OPS WR USED COMPR UNDER COMPR
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.mgr &lt;span class="m">449&lt;/span> KiB &lt;span class="m">2&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">6&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">288&lt;/span> &lt;span class="m">494&lt;/span> KiB &lt;span class="m">153&lt;/span> 1.3 MiB &lt;span class="m">0&lt;/span> B &lt;span class="m">0&lt;/span> B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total_objects &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total_used &lt;span class="m">41&lt;/span> MiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total_avail &lt;span class="m">80&lt;/span> GiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total_space &lt;span class="m">80&lt;/span> GiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ cat /etc/ceph/ceph.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>global&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">mon_host&lt;/span> &lt;span class="o">=&lt;/span> 10.202.156.149:6789,10.202.75.120:6789,10.202.62.213:6789
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>client.admin&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">keyring&lt;/span> &lt;span class="o">=&lt;/span> /etc/ceph/keyring
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ cat /etc/ceph/keyring
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>client.admin&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">AQCtp2xlw3soGRAAVvoyqWe8wzvkkt26JQEGtQ&lt;/span>&lt;span class="o">==&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ &lt;span class="nb">exit&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# apt update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# apt install ceph-common
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# vim /etc/ceph/ceph.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>global&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">mon_host&lt;/span> &lt;span class="o">=&lt;/span> 10.202.156.149:6789,10.202.75.120:6789,10.202.62.213:6789
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>client.admin&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">keyring&lt;/span> &lt;span class="o">=&lt;/span> /etc/ceph/keyring
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# vim /etc/ceph/keyring
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>client.admin&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">AQCtp2xlw3soGRAAVvoyqWe8wzvkkt26JQEGtQ&lt;/span>&lt;span class="o">==&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# ceph -s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cluster:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> id: 9da44d3d-58d1-402d-8f8b-66bd89a869a4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> health: HEALTH_OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> services:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mon: &lt;span class="m">3&lt;/span> daemons, quorum a,b,c &lt;span class="o">(&lt;/span>age 9m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mgr: a&lt;span class="o">(&lt;/span>active, since 4m&lt;span class="o">)&lt;/span>, standbys: b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> osd: &lt;span class="m">5&lt;/span> osds: &lt;span class="m">5&lt;/span> up &lt;span class="o">(&lt;/span>since 6m&lt;span class="o">)&lt;/span>, &lt;span class="m">5&lt;/span> in &lt;span class="o">(&lt;/span>since 6m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pools: &lt;span class="m">1&lt;/span> pools, &lt;span class="m">1&lt;/span> pgs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> objects: &lt;span class="m">2&lt;/span> objects, &lt;span class="m">449&lt;/span> KiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> usage: &lt;span class="m">41&lt;/span> MiB used, &lt;span class="m">80&lt;/span> GiB / &lt;span class="m">80&lt;/span> GiB avail
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pgs: &lt;span class="m">1&lt;/span> active+clean
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="cephfs">cephfs&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master71u ceph-mds&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master72u ceph-mds&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master73u ceph-mds&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-node75u ceph-mds&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-node76u ceph-mds&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# vim filesystem.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> activeCount: &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> placement:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeAffinity:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requiredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeSelectorTerms:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: ceph-mds
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tolerations:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: Exists
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> podAntiAffinity:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requiredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - labelSelector:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: app
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - rook-ceph-mds
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> topologyKey: kubernetes.io/hostname
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> preferredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - weight: &lt;span class="m">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> podAffinityTerm:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> labelSelector:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: app
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - rook-ceph-mds
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> topologyKey: topology.kubernetes.io/zone
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f filesystem.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get pod -n rook-ceph -o wide &lt;span class="p">|&lt;/span> grep -i rook-ceph-mds
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mds-myfs-a-fcf6b94fb-wskkq 2/2 Running &lt;span class="m">0&lt;/span> 18s 10.201.126.14 k8s-master72u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mds-myfs-b-55d97767d4-z872h 2/2 Running &lt;span class="m">0&lt;/span> 16s 10.201.255.227 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mds-myfs-c-5c9c94fbfb-chfnv 2/2 Running &lt;span class="m">0&lt;/span> 13s 10.201.14.164 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mds-myfs-d-69cc457f9b-hq7vv 2/2 Running &lt;span class="m">0&lt;/span> 10s 10.201.133.13 k8s-master71u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# ceph -s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cluster:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> id: 9da44d3d-58d1-402d-8f8b-66bd89a869a4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> health: HEALTH_OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> services:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mon: &lt;span class="m">3&lt;/span> daemons, quorum a,b,c &lt;span class="o">(&lt;/span>age 13m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mgr: a&lt;span class="o">(&lt;/span>active, since 8m&lt;span class="o">)&lt;/span>, standbys: b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mds: 2/2 daemons up, &lt;span class="m">2&lt;/span> hot standby
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> osd: &lt;span class="m">5&lt;/span> osds: &lt;span class="m">5&lt;/span> up &lt;span class="o">(&lt;/span>since 9m&lt;span class="o">)&lt;/span>, &lt;span class="m">5&lt;/span> in &lt;span class="o">(&lt;/span>since 10m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volumes: 1/1 healthy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pools: &lt;span class="m">3&lt;/span> pools, &lt;span class="m">3&lt;/span> pgs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> objects: &lt;span class="m">41&lt;/span> objects, &lt;span class="m">452&lt;/span> KiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> usage: &lt;span class="m">43&lt;/span> MiB used, &lt;span class="m">80&lt;/span> GiB / &lt;span class="m">80&lt;/span> GiB avail
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pgs: &lt;span class="m">3&lt;/span> active+clean
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> io:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> client: 2.2 KiB/s rd, 2.4 KiB/s wr, &lt;span class="m">2&lt;/span> op/s rd, &lt;span class="m">8&lt;/span> op/s wr
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# &lt;span class="nb">cd&lt;/span> csi/cephfs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/csi/cephfs# kubectl create -f storageclass.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">storageclass.storage.k8s.io/rook-cephfs created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/csi/cephfs# kubectl get storageclasses.storage.k8s.io
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME PROVISIONER RECLAIMPOLICY VOLUMEBINDINGMODE ALLOWVOLUMEEXPANSION AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-cephfs rook-ceph.cephfs.csi.ceph.com Delete Immediate &lt;span class="nb">true&lt;/span> 5s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/csi/cephfs# ceph fs ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">name: myfs, metadata pool: myfs-metadata, data pools: &lt;span class="o">[&lt;/span>myfs-replicated &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>驗證pvc,pc使用storageClassName: &amp;ldquo;rook-cephfs&amp;quot;自動生成&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat sc.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: apps/v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: Deployment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: web-sc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> selector:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> matchLabels:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app: nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> replicas: &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> template:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> labels:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app: nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> containers:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> image: nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volumeMounts:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: wwwroot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mountPath: /usr/share/nginx/html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volumes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: wwwroot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> persistentVolumeClaim:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> claimName: web-sc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: PersistentVolumeClaim
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: web-sc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storageClassName: &lt;span class="s2">&amp;#34;rook-cephfs&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> accessModes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - ReadWriteMany
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> resources:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requests:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storage: 5Gi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl create -f sc.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod,pvc,pv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/test-nginx 1/1 Running &lt;span class="m">2&lt;/span> &lt;span class="o">(&lt;/span>33m ago&lt;span class="o">)&lt;/span> 81m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/web-sc-7b6c54fbb9-55rtb 1/1 Running &lt;span class="m">0&lt;/span> 34s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/web-sc-7b6c54fbb9-fxx6r 1/1 Running &lt;span class="m">0&lt;/span> 34s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/web-sc-7b6c54fbb9-vlpwm 1/1 Running &lt;span class="m">0&lt;/span> 34s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/web2-5d48fb75c5-dt5xd 1/1 Running &lt;span class="m">2&lt;/span> &lt;span class="o">(&lt;/span>33m ago&lt;span class="o">)&lt;/span> 80m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/web2-5d48fb75c5-ggmrz 1/1 Running &lt;span class="m">2&lt;/span> &lt;span class="o">(&lt;/span>33m ago&lt;span class="o">)&lt;/span> 80m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/web2-5d48fb75c5-jsvck 1/1 Running &lt;span class="m">2&lt;/span> &lt;span class="o">(&lt;/span>33m ago&lt;span class="o">)&lt;/span> 80m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">persistentvolumeclaim/web-sc Bound pvc-ec58bbde-7e2c-4cc4-be13-223d10de5d99 5Gi RWX rook-cephfs 34s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">persistentvolume/pvc-ec58bbde-7e2c-4cc4-be13-223d10de5d99 5Gi RWX Delete Bound default/web-sc rook-cephfs 34s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl &lt;span class="nb">exec&lt;/span> -ti web-sc-7b6c54fbb9-55rtb -- /bin/bash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-55rtb:/#
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-55rtb:/# df -h
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Filesystem Size Used Avail Use% Mounted on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">overlay 48G 20G 29G 41% /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 64M &lt;span class="m">0&lt;/span> 64M 0% /dev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/dev/mapper/ubuntu--vg-root 48G 20G 29G 41% /etc/hosts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">shm 64M &lt;span class="m">0&lt;/span> 64M 0% /dev/shm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.202.75.120:6789,10.202.62.213:6789,10.202.156.149:6789:/volumes/csi/csi-vol-39f4781c-a08b-4b30-a2f9-5d244cd4f7af/58cdd551-8197-41f0-875b-a050fb0135aa 5.0G &lt;span class="m">0&lt;/span> 5.0G 0% /usr/share/nginx/html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 7.7G 12K 7.7G 1% /run/secrets/kubernetes.io/serviceaccount
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 3.9G &lt;span class="m">0&lt;/span> 3.9G 0% /proc/acpi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 3.9G &lt;span class="m">0&lt;/span> 3.9G 0% /proc/scsi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 3.9G &lt;span class="m">0&lt;/span> 3.9G 0% /sys/firmware
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-55rtb:/#
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-55rtb:/# &lt;span class="nb">cd&lt;/span> /usr/share/nginx/html/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-55rtb:/usr/share/nginx/html# touch &lt;span class="m">123&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-55rtb:/usr/share/nginx/html# ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">123&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-55rtb:/usr/share/nginx/html# &lt;span class="nb">exit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">exit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl &lt;span class="nb">exec&lt;/span> -ti web-sc-7b6c54fbb9-fxx6r -- /bin/bash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-fxx6r:/#
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-fxx6r:/# df -h
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Filesystem Size Used Avail Use% Mounted on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">overlay 48G 20G 29G 41% /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 64M &lt;span class="m">0&lt;/span> 64M 0% /dev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/dev/mapper/ubuntu--vg-root 48G 20G 29G 41% /etc/hosts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">shm 64M &lt;span class="m">0&lt;/span> 64M 0% /dev/shm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.202.75.120:6789,10.202.62.213:6789,10.202.156.149:6789:/volumes/csi/csi-vol-39f4781c-a08b-4b30-a2f9-5d244cd4f7af/58cdd551-8197-41f0-875b-a050fb0135aa 5.0G &lt;span class="m">0&lt;/span> 5.0G 0% /usr/share/nginx/html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 7.7G 12K 7.7G 1% /run/secrets/kubernetes.io/serviceaccount
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 3.9G &lt;span class="m">0&lt;/span> 3.9G 0% /proc/acpi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 3.9G &lt;span class="m">0&lt;/span> 3.9G 0% /proc/scsi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 3.9G &lt;span class="m">0&lt;/span> 3.9G 0% /sys/firmware
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-fxx6r:/#
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-fxx6r:/# &lt;span class="nb">cd&lt;/span> /usr/share/nginx/html/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-fxx6r:/usr/share/nginx/html# ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">123&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-fxx6r:/usr/share/nginx/html# &lt;span class="nb">exit&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get services -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr ClusterIP 10.202.138.211 &amp;lt;none&amp;gt; 9283/TCP 19m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-dashboard ClusterIP 10.202.204.184 &amp;lt;none&amp;gt; 8443/TCP 19m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-a ClusterIP 10.202.156.149 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 24m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-b ClusterIP 10.202.75.120 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 20m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-c ClusterIP 10.202.62.213 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 20m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f dashboard-external-https.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get services -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr ClusterIP 10.202.138.211 &amp;lt;none&amp;gt; 9283/TCP 21m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-dashboard ClusterIP 10.202.204.184 &amp;lt;none&amp;gt; 8443/TCP 21m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-dashboard-external-https NodePort 10.202.5.199 &amp;lt;none&amp;gt; 8443:30125/TCP 10s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-a ClusterIP 10.202.156.149 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 26m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-b ClusterIP 10.202.75.120 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 21m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-c ClusterIP 10.202.62.213 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 21m
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>以下網址，都可以訪問nodeport
https://192.168.1.71:30125/#/login?returnUrl=%2Fdashboard
https://192.168.1.72:30125/#/login?returnUrl=%2Fdashboard
https://192.168.1.73:30125/#/login?returnUrl=%2Fdashboard
https://192.168.1.74:30125/#/login?returnUrl=%2Fdashboard
https://192.168.1.75:30125/#/login?returnUrl=%2Fdashboard
https://192.168.1.76:30125/#/login?returnUrl=%2Fdashboard&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204003829.png"
loading="lazy"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get secrets -n rook-ceph rook-ceph-dashboard-password -o yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">data:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> password: &lt;span class="nv">KF1hVHhQTSc0NjpnYjBYL2NENig&lt;/span>&lt;span class="o">=&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: Secret
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> creationTimestamp: &lt;span class="s2">&amp;#34;2023-12-03T16:12:13Z&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: rook-ceph-dashboard-password
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> namespace: rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ownerReferences:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - apiVersion: ceph.rook.io/v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> blockOwnerDeletion: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> controller: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> kind: CephCluster
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> uid: 93039daa-6f89-447a-81c7-89d387c1350b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> resourceVersion: &lt;span class="s2">&amp;#34;25904&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> uid: b2396e15-0674-4a9d-982b-25d03916a553
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">type: kubernetes.io/rook
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;KF1hVHhQTSc0NjpnYjBYL2NENig=&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> base64 -d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(]&lt;/span>aTxPM&lt;span class="err">&amp;#39;&lt;/span>46:gb0X/cD6&lt;span class="o">(&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204003900.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204003915.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204003943.png"
loading="lazy"
>&lt;/p>
&lt;p>一直報這個錯誤，導致集群檢查不健康&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# ceph mgr module ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">MODULE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">balancer on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">crash on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">devicehealth on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">orchestrator on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pg_autoscaler on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">progress on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rbd_support on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">status on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">telemetry on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">volumes on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dashboard on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iostat on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nfs on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">prometheus on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">restful on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">alerts -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cephadm -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">diskprediction_local -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">influx -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">insights -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8sevents -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">localpool -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mds_autoscaler -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mirroring -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">osd_perf_query -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">osd_support -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">selftest -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">snap_schedule -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">stats -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">telegraf -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">test_orchestrator -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">zabbix -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# ceph mgr module &lt;span class="nb">enable&lt;/span> rook
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# ceph mgr module ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">MODULE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">balancer on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">crash on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">devicehealth on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">orchestrator on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pg_autoscaler on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">progress on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rbd_support on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">status on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">telemetry on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">volumes on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dashboard on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iostat on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nfs on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">prometheus on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">restful on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">alerts -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cephadm -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">diskprediction_local -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">influx -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">insights -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8sevents -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">localpool -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mds_autoscaler -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mirroring -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">osd_perf_query -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">osd_support -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">selftest -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">snap_schedule -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">stats -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">telegraf -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">test_orchestrator -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">zabbix -
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl create -f bundle.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl get pod
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">prometheus-rook-prometheus-0 2/2 Running &lt;span class="m">0&lt;/span> 48s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl create -f prometheus.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl create -f prometheus-service.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl create -f service-monitor.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl create -f grafana-all.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl get pod,svc -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/grafana-654886fbff-czjvf 1/1 Running &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>76s ago&lt;span class="o">)&lt;/span> 2m2s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/prometheus-rook-prometheus-0 2/2 Running &lt;span class="m">0&lt;/span> 3m42s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service/grafana NodePort 10.202.70.24 &amp;lt;none&amp;gt; 3000:31782/TCP 2m2s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service/prometheus-operated ClusterIP None &amp;lt;none&amp;gt; 9090/TCP 3m42s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>以下網址，都可以訪問nodeport&lt;/p>
&lt;p>http://192.168.1.71:31782/login
http://192.168.1.72:31782/login
http://192.168.1.73:31782/login
http://192.168.1.74:31782/login
http://192.168.1.75:31782/login&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204011532.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204011610.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204011643.png"
loading="lazy"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl get svc -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">grafana NodePort 10.202.70.24 &amp;lt;none&amp;gt; 3000:31782/TCP 5m59s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">prometheus-operated ClusterIP None &amp;lt;none&amp;gt; 9090/TCP 7m39s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr ClusterIP 10.202.138.211 &amp;lt;none&amp;gt; 9283/TCP 65m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-dashboard ClusterIP 10.202.204.184 &amp;lt;none&amp;gt; 8443/TCP 65m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-dashboard-external-https NodePort 10.202.5.199 &amp;lt;none&amp;gt; 8443:30125/TCP 44m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-a ClusterIP 10.202.156.149 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 70m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-b ClusterIP 10.202.75.120 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 66m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-c ClusterIP 10.202.62.213 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 65m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-prometheus NodePort 10.202.7.217 &amp;lt;none&amp;gt; 9090:30900/TCP 7m34s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204011803.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204011815.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;a class="link" href="https://grafana.com/grafana/dashboards/2842-ceph-cluster/" target="_blank" rel="noopener"
>https://grafana.com/grafana/dashboards/2842-ceph-cluster/&lt;/a>
&lt;a class="link" href="https://grafana.com/grafana/dashboards/5336-ceph-osd-single/" target="_blank" rel="noopener"
>https://grafana.com/grafana/dashboards/5336-ceph-osd-single/&lt;/a>
&lt;a class="link" href="https://grafana.com/grafana/dashboards/5342-ceph-pools/" target="_blank" rel="noopener"
>https://grafana.com/grafana/dashboards/5342-ceph-pools/&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204011903.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204011931.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204011947.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204012015.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204012038.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204012115.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204012129.png"
loading="lazy"
>&lt;/p>
&lt;h2 id="reset清除集群設定">reset清除集群設定&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 全部清除，包含所有創建目錄，systemd服務，/etc/hosts&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># ansible-playbook -i inventory/mycluster/hosts.yaml --become --become-user=root reset.yml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 流程進行，會再次確認您是否要reset，要輸入yes，ansible才會開始繼續進行&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PLAY &lt;span class="o">[&lt;/span>Reset cluster&lt;span class="o">]&lt;/span> *******************************************************************************************************************
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">週日 &lt;span class="m">03&lt;/span> 十二月 &lt;span class="m">2023&lt;/span> 14:43:01 +0800 &lt;span class="o">(&lt;/span>0:00:02.729&lt;span class="o">)&lt;/span> 0:00:44.278 ****************
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Reset Confirmation&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Are you sure you want to reset cluster state? Type &lt;span class="s1">&amp;#39;yes&amp;#39;&lt;/span> to reset your cluster.:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 清除完畢之後，主機要systemctl daemon-reload，不然會被判斷還有etcd服務，導致無法佈屬&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 以上執行完畢，重開機，即可重新再佈屬&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master72u:~# systemctl status etcd.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Warning: The unit file, &lt;span class="nb">source&lt;/span> configuration file or drop-ins of etcd.service changed on disk. Run &lt;span class="s1">&amp;#39;systemctl daemon-reload&amp;#39;&lt;/span> to reload units.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">○ etcd.service - etcd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Loaded: loaded &lt;span class="o">(&lt;/span>/etc/systemd/system/etcd.service&lt;span class="p">;&lt;/span> enabled&lt;span class="p">;&lt;/span> vendor preset: enabled&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Active: inactive &lt;span class="o">(&lt;/span>dead&lt;span class="o">)&lt;/span> since Mon 2023-12-04 17:46:25 UTC&lt;span class="p">;&lt;/span> 1min 34s ago
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Process: &lt;span class="m">906&lt;/span> &lt;span class="nv">ExecStart&lt;/span>&lt;span class="o">=&lt;/span>/usr/local/bin/etcd &lt;span class="o">(&lt;/span>&lt;span class="nv">code&lt;/span>&lt;span class="o">=&lt;/span>killed, &lt;span class="nv">signal&lt;/span>&lt;span class="o">=&lt;/span>TERM&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Main PID: &lt;span class="m">906&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="nv">code&lt;/span>&lt;span class="o">=&lt;/span>killed, &lt;span class="nv">signal&lt;/span>&lt;span class="o">=&lt;/span>TERM&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CPU: 6min 4.994s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">04&lt;/span> 17:46:24 k8s-master72u etcd&lt;span class="o">[&lt;/span>906&lt;span class="o">]&lt;/span>: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;level&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;info&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;ts&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;2023-12-04T17:46:24.978391Z&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;caller&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;rafthttp/pipeline.go:85&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;msg&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;stopped HTTP pipelining with remot&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 04 17:46:24 k8s-master72u etcd[906]: {&amp;#34;&lt;/span>level&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>info&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>ts&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>2023-12-04T17:46:24.978409Z&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>caller&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>rafthttp/stream.go:442&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>msg&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>stopped stream reader with remote p&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">04&lt;/span> 17:46:24 k8s-master72u etcd&lt;span class="o">[&lt;/span>906&lt;span class="o">]&lt;/span>: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;level&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;info&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;ts&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;2023-12-04T17:46:24.97843Z&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;caller&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;rafthttp/stream.go:442&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;msg&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;stopped stream reader with remote pe&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 04 17:46:24 k8s-master72u etcd[906]: {&amp;#34;&lt;/span>level&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>info&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>ts&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>2023-12-04T17:46:24.97845Z&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>caller&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>rafthttp/peer.go:335&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>msg&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>stopped remote peer&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>remote-peer-id&lt;span class="s2">&amp;#34;:&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 04 17:46:24 k8s-master72u etcd[906]: {&amp;#34;&lt;/span>level&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>info&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>ts&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>2023-12-04T17:46:24.98816Z&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>caller&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>embed/etcd.go:579&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>msg&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>stopping serving peer traffic&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>address&lt;span class="s2">&amp;#34;:&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 04 17:46:24 k8s-master72u etcd[906]: {&amp;#34;&lt;/span>level&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>info&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>ts&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>2023-12-04T17:46:24.988259Z&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>caller&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>embed/etcd.go:584&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>msg&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>stopped serving peer traffic&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>address&lt;span class="s2">&amp;#34;:&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 04 17:46:24 k8s-master72u etcd[906]: {&amp;#34;&lt;/span>level&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>info&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>ts&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>2023-12-04T17:46:24.988274Z&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>caller&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>embed/etcd.go:378&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>msg&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>closed etcd server&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>name&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>etcd2&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>data&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">04&lt;/span> 17:46:25 k8s-master72u systemd&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span>: etcd.service: Deactivated successfully.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">04&lt;/span> 17:46:25 k8s-master72u systemd&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span>: Stopped etcd.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">04&lt;/span> 17:46:25 k8s-master72u systemd&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span>: etcd.service: Consumed 6min 4.994s CPU time.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="如果沒外部vipworker-node透過nginx-proxy反代理訪問master-node的kube-apiserver">如果沒外部VIP，worker node透過nginx proxy反代理，訪問master node的kube-apiserver&lt;/h2>
&lt;p>worker node透過nginx proxy反代理，訪問master node的kube-apiserver，每一個worker node都會有一個nginx pod
&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231203004609.png"
loading="lazy"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod -A -o wide
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAMESPACE NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system nginx-proxy-node4 1/1 Running &lt;span class="m">0&lt;/span> 5m14s 192.168.1.75 node4 &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system nginx-proxy-node5 1/1 Running &lt;span class="m">0&lt;/span> 5m2s 192.168.1.76 node5 &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>