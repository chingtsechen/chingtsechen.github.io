<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>kubernetes on 翻轉吧金魚腦</title><link>https://blog.goldfishbrain-fighting.com/categories/kubernetes/</link><description>Recent content in kubernetes on 翻轉吧金魚腦</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Sat, 02 Dec 2023 17:34:57 +0800</lastBuildDate><atom:link href="https://blog.goldfishbrain-fighting.com/categories/kubernetes/index.xml" rel="self" type="application/rss+xml"/><item><title>使用kubespray專案，用ansible批量佈屬生產環境高可用kubernetes集群(kube-vip)</title><link>https://blog.goldfishbrain-fighting.com/2023/ansible-deploy-kubernetes-cluster-use-kubespray-kube-vip/</link><pubDate>Sat, 02 Dec 2023 17:34:57 +0800</pubDate><guid>https://blog.goldfishbrain-fighting.com/2023/ansible-deploy-kubernetes-cluster-use-kubespray-kube-vip/</guid><description>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/ansible-deploy-kubernetes-cluster-use-kubespray-kube-vip/media/Pasted-image-20231205222815.png" alt="Featured image of post 使用kubespray專案，用ansible批量佈屬生產環境高可用kubernetes集群(kube-vip)" />&lt;h1 id="架構圖">架構圖&lt;/h1>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/ansible-deploy-kubernetes-cluster-use-kubespray-kube-vip/media/Pasted-image-20231205214821.png"
width="1276"
height="728"
srcset="https://blog.goldfishbrain-fighting.com/2023/ansible-deploy-kubernetes-cluster-use-kubespray-kube-vip/media/Pasted-image-20231205214821_hua7912735140a57843d03f863f5ef97a0_414365_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/ansible-deploy-kubernetes-cluster-use-kubespray-kube-vip/media/Pasted-image-20231205214821_hua7912735140a57843d03f863f5ef97a0_414365_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="175"
data-flex-basis="420px"
>&lt;/p>
&lt;h1 id="集群自動化建置">集群自動化建置&lt;/h1>
&lt;h2 id="準備">準備&lt;/h2>
&lt;p>&lt;a class="link" href="https://kubespray.io/#/docs/ansible?id=installing-ansible" target="_blank" rel="noopener"
>https://kubespray.io/#/docs/ansible?id=installing-ansible&lt;/a>&lt;/p>
&lt;p>使用python3創建虛擬目錄，安裝依賴包&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ansible ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># python3 --version&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Python 3.9.18
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ansible ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># git clone https://github.com/kubernetes-sigs/kubespray.git&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ansible ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># VENVDIR=kubespray-venv&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ansible ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># KUBESPRAYDIR=kubespray&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ansible ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># python3 -m venv $VENVDIR&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ansible ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># source $VENVDIR/bin/activate&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># cd $KUBESPRAYDIR&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># pip install -U -r requirements.txt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting &lt;span class="nv">ansible&lt;/span>&lt;span class="o">==&lt;/span>8.5.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading ansible-8.5.0-py3-none-any.whl &lt;span class="o">(&lt;/span>47.5 MB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 47.5/47.5 MB 4.0 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting &lt;span class="nv">cryptography&lt;/span>&lt;span class="o">==&lt;/span>41.0.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading cryptography-41.0.4-cp37-abi3-manylinux_2_17_x86_64.manylinux2014_x86_64.whl &lt;span class="o">(&lt;/span>4.4 MB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 4.4/4.4 MB 9.2 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting &lt;span class="nv">jinja2&lt;/span>&lt;span class="o">==&lt;/span>3.1.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading Jinja2-3.1.2-py3-none-any.whl &lt;span class="o">(&lt;/span>&lt;span class="m">133&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 133.1/133.1 kB 9.1 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting &lt;span class="nv">jmespath&lt;/span>&lt;span class="o">==&lt;/span>1.0.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading jmespath-1.0.1-py3-none-any.whl &lt;span class="o">(&lt;/span>&lt;span class="m">20&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting &lt;span class="nv">MarkupSafe&lt;/span>&lt;span class="o">==&lt;/span>2.1.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading MarkupSafe-2.1.3-cp39-cp39-manylinux_2_17_x86_64.manylinux2014_x86_64.whl &lt;span class="o">(&lt;/span>&lt;span class="m">25&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting &lt;span class="nv">netaddr&lt;/span>&lt;span class="o">==&lt;/span>0.9.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading netaddr-0.9.0-py3-none-any.whl &lt;span class="o">(&lt;/span>2.2 MB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 2.2/2.2 MB 9.2 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting &lt;span class="nv">pbr&lt;/span>&lt;span class="o">==&lt;/span>5.11.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading pbr-5.11.1-py2.py3-none-any.whl &lt;span class="o">(&lt;/span>&lt;span class="m">112&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 112.7/112.7 kB 8.2 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting ruamel.yaml&lt;span class="o">==&lt;/span>0.17.35
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading ruamel.yaml-0.17.35-py3-none-any.whl &lt;span class="o">(&lt;/span>&lt;span class="m">112&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 112.9/112.9 kB 9.4 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting ruamel.yaml.clib&lt;span class="o">==&lt;/span>0.2.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading ruamel.yaml.clib-0.2.8-cp39-cp39-manylinux_2_5_x86_64.manylinux1_x86_64.whl &lt;span class="o">(&lt;/span>&lt;span class="m">562&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 562.1/562.1 kB 10.4 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting ansible-core~&lt;span class="o">=&lt;/span>2.15.5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading ansible_core-2.15.6-py3-none-any.whl &lt;span class="o">(&lt;/span>2.2 MB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 2.2/2.2 MB 9.3 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting cffi&amp;gt;&lt;span class="o">=&lt;/span>1.12
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading cffi-1.16.0-cp39-cp39-manylinux_2_17_x86_64.manylinux2014_x86_64.whl &lt;span class="o">(&lt;/span>&lt;span class="m">443&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 443.4/443.4 kB 9.7 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting importlib-resources&amp;lt;5.1,&amp;gt;&lt;span class="o">=&lt;/span>5.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading importlib_resources-5.0.7-py3-none-any.whl &lt;span class="o">(&lt;/span>&lt;span class="m">24&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting PyYAML&amp;gt;&lt;span class="o">=&lt;/span>5.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading PyYAML-6.0.1-cp39-cp39-manylinux_2_17_x86_64.manylinux2014_x86_64.whl &lt;span class="o">(&lt;/span>&lt;span class="m">738&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 738.9/738.9 kB 8.6 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting packaging
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading packaging-23.2-py3-none-any.whl &lt;span class="o">(&lt;/span>&lt;span class="m">53&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 53.0/53.0 kB 7.5 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting resolvelib&amp;lt;1.1.0,&amp;gt;&lt;span class="o">=&lt;/span>0.5.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading resolvelib-1.0.1-py2.py3-none-any.whl &lt;span class="o">(&lt;/span>&lt;span class="m">17&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Collecting pycparser
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Downloading pycparser-2.21-py2.py3-none-any.whl &lt;span class="o">(&lt;/span>&lt;span class="m">118&lt;/span> kB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 118.7/118.7 kB 8.6 MB/s eta 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Installing collected packages: resolvelib, netaddr, ruamel.yaml.clib, PyYAML, pycparser, pbr, packaging, MarkupSafe, jmespath, importlib-resources, ruamel.yaml, jinja2, cffi, cryptography, ansible-core, ansible
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Successfully installed MarkupSafe-2.1.3 PyYAML-6.0.1 ansible-8.5.0 ansible-core-2.15.6 cffi-1.16.0 cryptography-41.0.4 importlib-resources-5.0.7 jinja2-3.1.2 jmespath-1.0.1 netaddr-0.9.0 packaging-23.2 pbr-5.11.1 pycparser-2.21 resolvelib-1.0.1 ruamel.yaml-0.17.35 ruamel.yaml.clib-0.2.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>notice&lt;span class="o">]&lt;/span> A new release of pip is available: 23.0.1 -&amp;gt; 23.3.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>notice&lt;span class="o">]&lt;/span> To update, run: pip install --upgrade pip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="生成hostsyaml">生成hosts.yaml&lt;/h2>
&lt;p>&lt;a class="link" href="https://kubespray.io/#/?id=deploy-a-production-ready-kubernetes-cluster" target="_blank" rel="noopener"
>https://kubespray.io/#/?id=deploy-a-production-ready-kubernetes-cluster&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># cp -rfp inventory/sample inventory/mycluster&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># declare -a IPS=(192.168.1.71 192.168.1.72 192.168.1.73 192.168.1.75 192.168.1.76)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># CONFIG_FILE=inventory/mycluster/hosts.yaml python3 contrib/inventory_builder/inventory.py ${IPS[@]}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: Adding group all
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: Adding group kube_control_plane
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: Adding group kube_node
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: Adding group etcd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: Adding group k8s_cluster
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: Adding group calico_rr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node1 to group all
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node2 to group all
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node3 to group all
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node4 to group all
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node5 to group all
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node1 to group etcd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node2 to group etcd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node3 to group etcd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node1 to group kube_control_plane
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node2 to group kube_control_plane
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node1 to group kube_node
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node2 to group kube_node
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node3 to group kube_node
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node4 to group kube_node
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DEBUG: adding host node5 to group kube_node
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="修改allyml">修改all.yml&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">主要修改內容如下：
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">VIP與domain_name設定
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">需要Proxy的可以設定
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># vim inventory/mycluster/group_vars/all/all.yml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiserver_loadbalancer_domain_name: &lt;span class="s2">&amp;#34;k8s-apiserver-lb.jimmyhome.tw&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loadbalancer_apiserver:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> address: 192.168.1.74
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> port: &lt;span class="m">7443&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Set these proxy values in order to update package manager and docker daemon to use proxies and custom CA for https_proxy if needed&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># http_proxy: &amp;#34;http://x.x.x.x:3128&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># https_proxy: &amp;#34;http://x.x.x.x:3128&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># https_proxy_cert_file: &amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Refer to roles/kubespray-defaults/defaults/main.yml before modifying no_proxy&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># no_proxy: &amp;#34;127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,cattle-system.svc,.svc,.cluster.local,k8s-apiserver-lb.jimmyhome.tw&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="修改k8s-clusteryml">修改k8s-cluster.yml&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">主要修改內容如下：
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">要安裝的kubernetes版本
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service ip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod ip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">network_node_prefix
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">容器引擎，我這裡使用docker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">是否憑證自動更新(每個月月初，會自動更新)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># vim inventory/mycluster/group_vars/k8s_cluster/k8s-cluster.yml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Change this to use another Kubernetes version, e.g. a current beta release&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube_version: v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Kubernetes internal network for services, unused block of space.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube_service_addresses: 10.202.0.0/16
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># internal network. When used, it will assign IP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># addresses from this range to individual pods.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># This network must be unused in your network infrastructure!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube_pods_subnet: 10.201.0.0/16
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube_network_node_prefix: &lt;span class="m">16&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Container runtime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## docker for docker, crio for cri-o and containerd for containerd.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Default: containerd&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">container_manager: docker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## Automatically renew K8S control plane certificates on first Monday of each month&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">auto_renew_certificates: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="修改addonsyml">修改addons.yml&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">主要修改內容如下：
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">安裝Nginx ingress
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">安裝helm工具
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">安裝metrics_server
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># vim inventory/mycluster/group_vars/k8s_cluster/addons.yml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Nginx ingress controller deployment&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress_nginx_enabled: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress_nginx_host_network: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress_publish_status_address: &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ingress_nginx_nodeselector:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># kubernetes.io/os: &amp;#34;linux&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress_nginx_tolerations:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: &lt;span class="s2">&amp;#34;node-role.kubernetes.io/control-plane&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: &lt;span class="s2">&amp;#34;Equal&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> value: &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> effect: &lt;span class="s2">&amp;#34;NoSchedule&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Helm deployment&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">helm_enabled: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Metrics Server deployment&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metrics_server_enabled: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="修改mainyml">修改main.yml&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">主要修改內容如下：
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">網路組件calico版本
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># vim roles/kubespray-defaults/vars/main.yml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">calico_min_version_required: &lt;span class="s2">&amp;#34;v3.26.0&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># cri-docker版本修改位置，有需要再改，這裡就依這個版本&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># vim roles/download/defaults/main/main.yml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cri_dockerd_version: 0.3.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># docker版本修改位置，有需要再改，這裡就依這個版本&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># vim roles/container-engine/docker/defaults/main.yml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker_version: &lt;span class="s1">&amp;#39;20.10&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="修改hostsyaml">修改hosts.yaml&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">主要修改內容如下：
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">依據現況去填寫
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube_control_plane -&amp;gt; master節點(會有不能調度污點)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube_node -&amp;gt; worker節點
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">etcd -&amp;gt; 數據庫節點
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat inventory/mycluster/hosts.yaml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">all:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hosts:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-master71u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ansible_host: k8s-master71u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip: 192.168.1.71
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> access_ip: 192.168.1.71
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-master72u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ansible_host: k8s-master72u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip: 192.168.1.72
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> access_ip: 192.168.1.72
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-master73u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ansible_host: k8s-master73u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip: 192.168.1.73
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> access_ip: 192.168.1.73
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-node75u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ansible_host: k8s-node75u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip: 192.168.1.75
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> access_ip: 192.168.1.75
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-node76u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ansible_host: k8s-node76u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip: 192.168.1.76
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> access_ip: 192.168.1.76
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> children:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> kube_control_plane:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hosts:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-master71u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-master72u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-master73u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> kube_node:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hosts:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-node75u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-node76u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> etcd:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hosts:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-master71u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-master72u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s-master73u:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> k8s_cluster:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> children:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> kube_control_plane:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> kube_node:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> calico_rr:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hosts: &lt;span class="o">{}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="安裝配置haproxykeepalived">安裝配置haproxy、keepalived&lt;/h2>
&lt;p>操作節點： 所有的master&lt;/p>
&lt;p>注意：如果有兩個集群，都在同一網段內，/etc/keepalived/keepalived.conf裡面的virtual_router_id 60記得要不一樣，不然/var/log/message會一直報錯。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# apt-get install keepalived haproxy -y
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 所有master節點執行,注意替換最後的master節點IP地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat /etc/haproxy/haproxy.cfg
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">global
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> maxconn &lt;span class="m">2000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ulimit-n &lt;span class="m">16384&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> log 127.0.0.1 local0 err
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> stats timeout 30s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">defaults
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> log global
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mode http
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option httplog
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeout connect &lt;span class="m">5000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeout client &lt;span class="m">50000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeout server &lt;span class="m">50000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeout http-request 15s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeout http-keep-alive 15s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">frontend monitor-in
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">bind&lt;/span> *:33305
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mode http
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option httplog
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> monitor-uri /monitor
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">frontend k8s-master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">bind&lt;/span> 0.0.0.0:7443
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">bind&lt;/span> 127.0.0.1:7443
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mode tcp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option tcplog
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tcp-request inspect-delay 5s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default_backend k8s-master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">backend k8s-master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mode tcp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option tcplog
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option tcp-check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> balance roundrobin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default-server inter 10s downinter 5s rise &lt;span class="m">2&lt;/span> fall &lt;span class="m">2&lt;/span> slowstart 60s maxconn &lt;span class="m">250&lt;/span> maxqueue &lt;span class="m">256&lt;/span> weight &lt;span class="m">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server k8s-master71u 192.168.1.71:6443 check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server k8s-master72u 192.168.1.72:6443 check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server k8s-master73u 192.168.1.73:6443 check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 在k8s-master71u節點，注意mcast_src_ip換成實際的master1ip地址，virtual_ipaddress換成lb地址，interface要替換成主機IP使用的介面&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat /etc/keepalived/keepalived.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! Configuration File &lt;span class="k">for&lt;/span> keepalived
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">global_defs &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router_id LVS_DEVEL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">script_user root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> enable_script_security
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vrrp_script chk_apiserver &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> script &lt;span class="s2">&amp;#34;/etc/keepalived/check_apiserver.sh&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> interval &lt;span class="m">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> weight -5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> fall &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rise &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vrrp_instance VI_1 &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> state MASTER
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> interface ens160
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mcast_src_ip 192.168.1.71
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> virtual_router_id &lt;span class="m">64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> priority &lt;span class="m">101&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> advert_int &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> authentication &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> auth_type PASS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> auth_pass K8SHA_KA_AUTH
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> virtual_ipaddress &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 192.168.1.74
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> track_script &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> chk_apiserver
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 在k8s-master72u和k8s-master73u分別創建/etc/keepalived/keepalived.conf，注意修改mcast_src_ip和virtual_ipaddress&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#所有master節點配置KeepAlived健康檢查文件：&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@ck8s-p-4faj09-24:~# vim /etc/keepalived/check_apiserver.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#!/bin/bash&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">err&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> k in &lt;span class="k">$(&lt;/span>seq &lt;span class="m">1&lt;/span> 3&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">check_code&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>pgrep haproxy&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[[&lt;/span> &lt;span class="nv">$check_code&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span> &lt;span class="o">]]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">err&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>expr &lt;span class="nv">$err&lt;/span> + 1&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sleep &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">err&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[[&lt;/span> &lt;span class="nv">$err&lt;/span> !&lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;0&amp;#34;&lt;/span> &lt;span class="o">]]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;systemctl stop keepalived&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /usr/bin/systemctl stop keepalived
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 啟動haproxy和keepalived----&amp;gt;所有master節點&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# chmod +x /etc/keepalived/check_apiserver.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl daemon-reload
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl &lt;span class="nb">enable&lt;/span> --now haproxy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl &lt;span class="nb">enable&lt;/span> --now keepalived
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl restart haproxy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl restart keepalived
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl status haproxy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl status keepalived
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 測試lbip是否生效(從worker節點測試的)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# telnet 192.168.1.74 &lt;span class="m">7443&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Trying 192.168.1.74...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Connected to 192.168.1.74.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Escape character is &lt;span class="s1">&amp;#39;^]&amp;#39;&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Connection closed by foreign host.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="佈屬主機etchosts填寫">佈屬主機/etc/hosts填寫&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># vim /etc/hosts&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.71 k8s-master71u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.72 k8s-master72u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.73 k8s-master73u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.75 k8s-node75u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.76 k8s-node76u
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>將key推送至要佈屬的主機&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># ssh-copy-id k8s-master71u&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># ssh-copy-id k8s-master72u&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># ssh-copy-id k8s-master73u&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># ssh-copy-id k8s-node75u&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># ssh-copy-id k8s-node76u&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="開始佈屬">開始佈屬&lt;/h2>
&lt;p>中間如果有突然報錯中斷，查看報錯訊息，調整一下，再次執行佈屬即可&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># ansible-playbook -i inventory/mycluster/hosts.yaml --become --become-user=root cluster.yml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PLAY RECAP *****************************************************************************************************************************
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master71u : &lt;span class="nv">ok&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">746&lt;/span> &lt;span class="nv">changed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">145&lt;/span> &lt;span class="nv">unreachable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">failed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">skipped&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1288&lt;/span> &lt;span class="nv">rescued&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">ignored&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">8&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master72u : &lt;span class="nv">ok&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">643&lt;/span> &lt;span class="nv">changed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">130&lt;/span> &lt;span class="nv">unreachable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">failed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">skipped&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1138&lt;/span> &lt;span class="nv">rescued&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">ignored&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master73u : &lt;span class="nv">ok&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">645&lt;/span> &lt;span class="nv">changed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">131&lt;/span> &lt;span class="nv">unreachable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">failed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">skipped&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1136&lt;/span> &lt;span class="nv">rescued&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">ignored&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-node75u : &lt;span class="nv">ok&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">467&lt;/span> &lt;span class="nv">changed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">79&lt;/span> &lt;span class="nv">unreachable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">failed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">skipped&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">794&lt;/span> &lt;span class="nv">rescued&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">ignored&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-node76u : &lt;span class="nv">ok&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">467&lt;/span> &lt;span class="nv">changed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">79&lt;/span> &lt;span class="nv">unreachable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">failed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">skipped&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">793&lt;/span> &lt;span class="nv">rescued&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">ignored&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">localhost : &lt;span class="nv">ok&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">3&lt;/span> &lt;span class="nv">changed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">unreachable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">failed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">skipped&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">rescued&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">ignored&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">週日 &lt;span class="m">03&lt;/span> 十二月 &lt;span class="m">2023&lt;/span> 22:56:39 +0800 &lt;span class="o">(&lt;/span>0:00:01.997&lt;span class="o">)&lt;/span> 0:44:07.257 ****************
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">===============================================================================&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_file &lt;span class="p">|&lt;/span> Download item -------------------------------------------------------------------------------------- 114.13s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">container-engine/docker : Ensure docker packages are installed ----------------------------------------------------------------- 80.93s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_file &lt;span class="p">|&lt;/span> Download item --------------------------------------------------------------------------------------- 59.73s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_container &lt;span class="p">|&lt;/span> Download image &lt;span class="k">if&lt;/span> required --------------------------------------------------------------------- 50.88s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_container &lt;span class="p">|&lt;/span> Download image &lt;span class="k">if&lt;/span> required --------------------------------------------------------------------- 47.73s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubernetes/preinstall : Preinstall &lt;span class="p">|&lt;/span> &lt;span class="nb">wait&lt;/span> &lt;span class="k">for&lt;/span> the apiserver to be running ------------------------------------------------------ 46.30s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_file &lt;span class="p">|&lt;/span> Download item --------------------------------------------------------------------------------------- 44.36s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">container-engine/crictl : Download_file &lt;span class="p">|&lt;/span> Download item ------------------------------------------------------------------------ 42.56s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubernetes/preinstall : Install packages requirements -------------------------------------------------------------------------- 37.19s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubernetes/control-plane : Joining control plane node to the cluster. ---------------------------------------------------------- 34.16s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">container-engine/cri-dockerd : Download_file &lt;span class="p">|&lt;/span> Download item ------------------------------------------------------------------- 31.95s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_file &lt;span class="p">|&lt;/span> Download item --------------------------------------------------------------------------------------- 31.86s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_container &lt;span class="p">|&lt;/span> Download image &lt;span class="k">if&lt;/span> required --------------------------------------------------------------------- 30.03s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">container-engine/validate-container-engine : Populate service facts ------------------------------------------------------------ 27.13s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubernetes/control-plane : Kubeadm &lt;span class="p">|&lt;/span> Initialize first master ------------------------------------------------------------------- 26.53s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_container &lt;span class="p">|&lt;/span> Download image &lt;span class="k">if&lt;/span> required --------------------------------------------------------------------- 24.24s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_file &lt;span class="p">|&lt;/span> Download item --------------------------------------------------------------------------------------- 23.99s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_container &lt;span class="p">|&lt;/span> Download image &lt;span class="k">if&lt;/span> required --------------------------------------------------------------------- 23.34s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">download : Download_container &lt;span class="p">|&lt;/span> Download image &lt;span class="k">if&lt;/span> required --------------------------------------------------------------------- 21.88s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubernetes/kubeadm : Join to cluster ------------------------------------------------------------------------------------------- 21.07s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="功能驗證">功能驗證&lt;/h2>
&lt;h3 id="命令補全">命令補全&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 命令補全&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;source &amp;lt;(kubectl completion bash)&amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/profile
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# &lt;span class="nb">source&lt;/span> /etc/profile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="etchosts">/etc/hosts&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat /etc/hosts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">127.0.0.1 localhost localhost.localdomain
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">127.0.1.1 k8s-master71u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># The following lines are desirable for IPv6 capable hosts&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">::1 ip6-localhost ip6-loopback localhost6 localhost6.localdomain
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fe00::0 ip6-localnet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ff00::0 ip6-mcastprefix
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ff02::1 ip6-allnodes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ff02::2 ip6-allrouters
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Ansible inventory hosts BEGIN&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.71 k8s-master71u.cluster.local k8s-master71u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.72 k8s-master72u.cluster.local k8s-master72u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.73 k8s-master73u.cluster.local k8s-master73u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.75 k8s-node75u.cluster.local k8s-node75u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.76 k8s-node76u.cluster.local k8s-node76u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Ansible inventory hosts END&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.74 k8s-apiserver-lb.jimmyhome.tw
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="連線配置文件config">連線配置文件(config)&lt;/h3>
&lt;p>可以看到，都是用VIP的domain name，
k8s-apiserver-lb.jimmyhome.tw&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat .kube/config
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusters:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- cluster:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> certificate-authority-data: &lt;span class="nv">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1USXdNekUwTkRVME9Wb1hEVE16TVRFek1ERTBORFUwT1Zvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTHovCmVJQmpqY2xCd3ZtTWV2YlhsaDV4ZW1HcjVxRlBlRkxsMGhQcERGaW1lcHFGREJkZWl0V0ppTmdGSUFVa3JzaE0KdkdtdXVjNy9mMGt5UUFGVFprTDBzUFI3QUlnbHlyeS9Hc0M1dzRZUEdYTHVpZmRoUGczM09QREdTSWNCejRYMAoyNU1aR1hEcWU2TzhTS2JyOFZidnpNVkxBK1JjbldQVTNIOGR2Znd6N2FxY0N3MlRwdFFxU1VnbVhzS1Z0ZTIzCmgrUGJDMW90OUU0UTYzYXFGQmRWei91aGJ4VHVFYm8wb1c5T3p3c2V1RTJLMzQ0RE1qZWxvZy9rMVdNeFA2OGwKYWRuOC9MbkdPNUJtTlp2UUZ6Q05kaXFkcm1YdXRubUk5N3BYY0dyN0tIdzYzYzZ2dTZ5aGZHMXNjRjg3WG40bQpLZmo5eDRDQ0cvVUJWc2RIV1lzQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZFK0lJS2NBcTBLbVl3SUpFYjJDWER4VHFibXhNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBRWF3SmEwaEVCZmJ5VG1UazlORQoweGZYUm12SnYrOGpZSlVIZExENmkvYXppQnpKMUNPUlRKKzUxbVYrWmNIZFJWbDE3UkNOZDY4MU9RMkRFWkhWCi83aVphSGxvYldNM3cvUjAxSzdXZm4yQUJsQ09lVkU3d3RKOUc0VEMzK2FVNEhaZFhsdlNLSkt6Y0oxbjZ2V04KMjErbUp1UHdLQXlJTVZEYVB6OGx2QVhxbDR2elBGWTRUd1k1OWlORVZYaFBuUHBiOWhiUGVxTUtSMG80UFBTMgp2YmNlOGw5R016aVpEaEQxb0RDSXBacGE5VzVneXFYdDBTbXk3RVJBWkx2V1N3ZHVrVnJoMXcrWVh3TEFzajF6CkZhNGJKWDExOGdQT3JUVi8rYTNXZXVpYk5JOFNNZm5KSXhHTVduUkpEemVwYW1oUUdiZmtFT3BzdHpRQms2ZGoKd0QwPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg&lt;/span>&lt;span class="o">==&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server: https://k8s-apiserver-lb.jimmyhome.tw:7443
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: cluster.local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">contexts:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- context:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cluster: cluster.local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> user: kubernetes-admin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: kubernetes-admin@cluster.local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">current-context: kubernetes-admin@cluster.local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: Config
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">preferences: &lt;span class="o">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">users:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- name: kubernetes-admin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> user:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> client-certificate-data: &lt;span class="nv">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURJVENDQWdtZ0F3SUJBZ0lJSjc2UTFQWXh4Zm93RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TXpFeU1ETXhORFExTkRsYUZ3MHlOREV5TURJeE5EUTFOVEphTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXVOK0pkMHE1T0xnWVlhaE0Kdnp4YTB0M2E5U2psdTZTZzFUWW5TbE5LRTBYeEQrOTErUmhpV0dUc2o3RlhhNmpLSkd2WE1FT1ZWUVN4UktrQQpwNE8ybDM5L3gyUDlPQ3dZWEovZEJCRFRIQUZBdWNzYWRoa0VjV3gvbnNVZWZQUE44cWxNV3YrN1B3clRzQUpFCmJBalZYSEVERVhDM3VVN2ZWM3lHaEJWVnRHZ29mOFdMdEluN3k3b2ozbnUxbldPY1ZVQ0dhQ09ncXNPdURERGQKVms0QUpyWnFWTWllUDAvWkk0YjhuMkJkZHREbUIyRVl5NmpsZ1M5eVIyYk5nVnNjaW0zMS9MTjQxWEI1YnViYQptbzAyWWIzcE5QN3VzYmtRZndNalhPZ1VrM3U2dks2Ky9hSzQ4WWhndUZvWi9wUVR2ejJtUUpKeldWU2dvYW9mCk5VTTdzUUlEQVFBQm8xWXdWREFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0RBWURWUjBUQVFIL0JBSXdBREFmQmdOVkhTTUVHREFXZ0JSUGlDQ25BS3RDcG1NQ0NSRzlnbHc4VTZtNQpzVEFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBbHQwNXJSVkhhc25GTjh6ZlJDUXVOT2hSKzhxNW5tRnNXU0pUCnFIeW92Uys2NFBkRzBJU21jSTYvanVhTmU1ZzhHdENkTlZoMmVSendLakxZZHc0RGZCUXBTTWh5UEYxZlFLYzEKMmthS2twTzh1MjQ4alZscitaQTV3Q2FaeWh3Qy8yTFFIdGxpdjZnWFNXTjZoNU5IUjNQdzhuWFBJMXQ5Q3JsegpUTCtQcFI3Ti9UUXczOWJqOUgrU0RuZTh2eVNoSVBCeXIzbzhSYXA4K3RMZVF6eVMwWWZNU1BTVnJKZjJMVFFwCnBhaWEyYVF5MVRUcXlicEQxODFsY2RzYzZxOU16cVlseE9zdE5QdG1ES3BTNFdsdFE3bDlLZVVLKzhtdmh0TWwKZXRVZ3lleXdPWmdIcUsrd0lLaC9aMzJScG1LODlub05vOHJWTHdvTGxkMjRFSXpDbmc9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg&lt;/span>&lt;span class="o">==&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> client-key-data: &lt;span class="nv">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBdU4rSmQwcTVPTGdZWWFoTXZ6eGEwdDNhOVNqbHU2U2cxVFluU2xOS0UwWHhEKzkxCitSaGlXR1RzajdGWGE2aktKR3ZYTUVPVlZRU3hSS2tBcDRPMmwzOS94MlA5T0N3WVhKL2RCQkRUSEFGQXVjc2EKZGhrRWNXeC9uc1VlZlBQTjhxbE1Xdis3UHdyVHNBSkViQWpWWEhFREVYQzN1VTdmVjN5R2hCVlZ0R2dvZjhXTAp0SW43eTdvajNudTFuV09jVlVDR2FDT2dxc091REREZFZrNEFKclpxVk1pZVAwL1pJNGI4bjJCZGR0RG1CMkVZCnk2amxnUzl5UjJiTmdWc2NpbTMxL0xONDFYQjVidWJhbW8wMlliM3BOUDd1c2JrUWZ3TWpYT2dVazN1NnZLNisKL2FLNDhZaGd1Rm9aL3BRVHZ6Mm1RSkp6V1ZTZ29hb2ZOVU03c1FJREFRQUJBb0lCQVFDY2J0SmtOYjk3SmhQRApkdVRTSU9EOWN5c1dyYStQVXVPZzVuemlvSTJhdDJFZXlkSjZuODUvMjQ1c25IUkxyZnkyU3VaQWViOS92RU8vCnhIM0FRV3ljenc4eGlnTTNwK0JKYUNCZGsxci9aSFAvZ3NQMlVINzQ5d1VhTk5QeWlWNm9TZWRKVFFHRmU4VGEKTjJEc1JhRTg0b2ZsRndydmE3VUMwMlVEbVFYM2E0YXBiMnVNRklMSnpHenJ4bmM0RDY1VHBwQUxwM2dYclo0YwpLRU5sU051dG03TVdza2JPUDB3UzJNNTk2U0R3LzNEQkQ5cVB4Y2ZsR0NyMGFDOFp6cGRUQnpiTjg4TzNORTVNClk3RFFsZHZaRHE0Q1h3QnhqSk9jN2Q1RE9VNWd2aHg5K1Y0NFZtWUNLMHV0UkFDaEliNC9lYlMweWw0U1ZMSnIKV0NUMDVwV1JBb0dCQU0xZEMzNkM5WVFZZDVDRng3Q2Q4TXlUUVY3NnppNXVlMUFiWmtPM1FRcmJ3QVR6UG9RdApsNm1vOUF6dVpHUnpreXVBU1AwRW5XbWQ1QWd3N3MybWphbTRDYndnK21xaFFpUHBYaTYyay8rVjlJdCtycDVVCjNyeldteGZxNnVWZ0lUREdBSloyckVpOVB4Q091RU1JdEw3VHJRbnBVTWVBZjZXbTdyb3VlVVQxQW9HQkFPWjEKR3ZHK0ZVVGxVL3d5WlJmOTRSOUlRQVBrM05tSHhua1JQUENtb2xXYUNNZWRmK2JvaVZlQnJka2NCQ2RRYW1TYwpReERBTW4wekVjMVQyT0E4d1BoTDJaYWd0L2FEU1dsS1RsdFF2SUNhUy94TUx3UmFGQXlJQkE3a3JOUk42TWdYCkViM093Z3FETmZkNXFIODRxMW1NbzVRVzBRVGNaL1VDb2ZLcEpNWk5Bb0dBVkJ1TWJwY0NLTVRBaTA5UE5yV28KL3BBODBNS1ZtUXlrc20xV1Y5dUE1d3FUUFRQR1llb3VXRTBiRHdTLzF5aENtU2xrTzBRZG1Ea1RRSXVSOG1ZSgpWUDVMOW1IblRhNlg0UTllQkhIQWNZZ2Y3TlhJZkk0ejMxRmhtYzBid1MrNnlEZi8yNS9rOWJHVVY1cXNPc0FoCkRwcXhId01RazNTOFVzTG91Ulg1a3RVQ2dZRUFrSGhCRitMTmVvODVBeFNrZzFISVdzLzBNWHk3WmpMVG5Qbk4KZGg5QURPR3ZOMVBvNWx4SUhPOVNpSlFqbG5HM0FMTms1NDlWRjE5NGZYdGVyZFBvTkw5My9CRnN3Y0N6dUttNApUVTVqblVzYzcyRGk2SnQvamd1R1g3L0RDS1IrbFZEQThuZzI5RmdrOEtyM2tpbDRZWDdrM09VZ3l5ZFFsQ3UrClVsenVqTkVDZ1lCZW1xaWowMjBXQVFkTWZnbnRtVk9keWVybC9IZmxhZDQwRkw2cU8wRytDRWtlSXdpZkRnVU8Kc3FIOWFRR1p3NzY4STZDUmJPYlhJMzZueHhtVXRQdFY0TllqTGFoU0lySGhEeVI5VGhvL2o3bnh3NnMyVXRwOQpLbVZlb1dtT3JGcS9LVGJHK055MU15dHpaUWhRYzJBV1oyamxDcDVaVm8ycGo0aWF1Q2I0K0E9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo&lt;/span>&lt;span class="o">=&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="節點ready">節點Ready&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get nodes -o wide
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIME
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master71u Ready control-plane 12m v1.26.3 192.168.1.71 &amp;lt;none&amp;gt; Ubuntu 22.04.3 LTS 5.15.0-84-generic docker://20.10.20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master72u Ready control-plane 12m v1.26.3 192.168.1.72 &amp;lt;none&amp;gt; Ubuntu 22.04.3 LTS 5.15.0-84-generic docker://20.10.20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master73u Ready control-plane 12m v1.26.3 192.168.1.73 &amp;lt;none&amp;gt; Ubuntu 22.04.3 LTS 5.15.0-84-generic docker://20.10.20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-node75u Ready &amp;lt;none&amp;gt; 11m v1.26.3 192.168.1.75 &amp;lt;none&amp;gt; Ubuntu 22.04.3 LTS 5.15.0-84-generic docker://20.10.20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-node76u Ready &amp;lt;none&amp;gt; 10m v1.26.3 192.168.1.76 &amp;lt;none&amp;gt; Ubuntu 22.04.3 LTS 5.15.0-84-generic docker://20.10.20
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="master都有污點">master都有污點&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get nodes k8s-master71u -o yaml &lt;span class="p">|&lt;/span> grep -i -A &lt;span class="m">2&lt;/span> taint
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> taints:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> key: node-role.kubernetes.io/control-plane
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get nodes k8s-master72u -o yaml &lt;span class="p">|&lt;/span> grep -i -A &lt;span class="m">2&lt;/span> taint
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> taints:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> key: node-role.kubernetes.io/control-plane
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get nodes k8s-master73u -o yaml &lt;span class="p">|&lt;/span> grep -i -A &lt;span class="m">2&lt;/span> taint
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> taints:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> key: node-role.kubernetes.io/control-plane
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="helm有安裝">helm有安裝&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm version
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">version.BuildInfo&lt;span class="o">{&lt;/span>Version:&lt;span class="s2">&amp;#34;v3.13.1&amp;#34;&lt;/span>, GitCommit:&lt;span class="s2">&amp;#34;3547a4b5bf5edb5478ce352e18858d8a552a4110&amp;#34;&lt;/span>, GitTreeState:&lt;span class="s2">&amp;#34;clean&amp;#34;&lt;/span>, GoVersion:&lt;span class="s2">&amp;#34;go1.20.8&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="所有pod都running">所有POD都Running&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod -A -o wide
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAMESPACE NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress-nginx ingress-nginx-controller-46rbx 1/1 Running &lt;span class="m">0&lt;/span> 8m16s 192.168.1.75 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress-nginx ingress-nginx-controller-7ccdp 1/1 Running &lt;span class="m">0&lt;/span> 8m16s 192.168.1.72 k8s-master72u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress-nginx ingress-nginx-controller-fqvxb 1/1 Running &lt;span class="m">0&lt;/span> 8m16s 192.168.1.71 k8s-master71u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress-nginx ingress-nginx-controller-hjbv7 1/1 Running &lt;span class="m">0&lt;/span> 8m16s 192.168.1.73 k8s-master73u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress-nginx ingress-nginx-controller-hlkh8 1/1 Running &lt;span class="m">0&lt;/span> 8m16s 192.168.1.76 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system calico-kube-controllers-777ff6cddb-d4htx 1/1 Running &lt;span class="m">0&lt;/span> 8m31s 10.201.14.129 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system calico-node-4qhfj 1/1 Running &lt;span class="m">0&lt;/span> 9m56s 192.168.1.72 k8s-master72u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system calico-node-9wrql 1/1 Running &lt;span class="m">0&lt;/span> 9m56s 192.168.1.76 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system calico-node-9xzmn 1/1 Running &lt;span class="m">0&lt;/span> 9m56s 192.168.1.75 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system calico-node-m975z 1/1 Running &lt;span class="m">0&lt;/span> 9m56s 192.168.1.73 k8s-master73u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system calico-node-s9w4x 1/1 Running &lt;span class="m">0&lt;/span> 9m56s 192.168.1.71 k8s-master71u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system coredns-57c7559cc8-sq8c4 1/1 Running &lt;span class="m">0&lt;/span> 7m39s 10.201.96.1 k8s-master73u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system coredns-57c7559cc8-vrf7g 1/1 Running &lt;span class="m">0&lt;/span> 7m47s 10.201.133.1 k8s-master71u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system dns-autoscaler-9875c9b44-9x7cg 1/1 Running &lt;span class="m">0&lt;/span> 7m43s 10.201.126.1 k8s-master72u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-apiserver-k8s-master71u 1/1 Running &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>3m18s ago&lt;span class="o">)&lt;/span> 13m 192.168.1.71 k8s-master71u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-apiserver-k8s-master72u 1/1 Running &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>3m18s ago&lt;span class="o">)&lt;/span> 12m 192.168.1.72 k8s-master72u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-apiserver-k8s-master73u 1/1 Running &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>3m18s ago&lt;span class="o">)&lt;/span> 11m 192.168.1.73 k8s-master73u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-controller-manager-k8s-master71u 1/1 Running &lt;span class="m">2&lt;/span> &lt;span class="o">(&lt;/span>3m49s ago&lt;span class="o">)&lt;/span> 13m 192.168.1.71 k8s-master71u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-controller-manager-k8s-master72u 1/1 Running &lt;span class="m">2&lt;/span> &lt;span class="o">(&lt;/span>3m49s ago&lt;span class="o">)&lt;/span> 12m 192.168.1.72 k8s-master72u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-controller-manager-k8s-master73u 1/1 Running &lt;span class="m">2&lt;/span> &lt;span class="o">(&lt;/span>3m49s ago&lt;span class="o">)&lt;/span> 12m 192.168.1.73 k8s-master73u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-proxy-6rz9s 1/1 Running &lt;span class="m">0&lt;/span> 11m 192.168.1.76 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-proxy-jqvw9 1/1 Running &lt;span class="m">0&lt;/span> 11m 192.168.1.75 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-proxy-mtclv 1/1 Running &lt;span class="m">0&lt;/span> 11m 192.168.1.73 k8s-master73u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-proxy-rsv52 1/1 Running &lt;span class="m">0&lt;/span> 11m 192.168.1.71 k8s-master71u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-proxy-vmnwj 1/1 Running &lt;span class="m">0&lt;/span> 11m 192.168.1.72 k8s-master72u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-scheduler-k8s-master71u 1/1 Running &lt;span class="m">1&lt;/span> 13m 192.168.1.71 k8s-master71u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-scheduler-k8s-master72u 1/1 Running &lt;span class="m">1&lt;/span> 12m 192.168.1.72 k8s-master72u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system kube-scheduler-k8s-master73u 1/1 Running &lt;span class="m">2&lt;/span> &lt;span class="o">(&lt;/span>3m34s ago&lt;span class="o">)&lt;/span> 11m 192.168.1.73 k8s-master73u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system metrics-server-694db59894-4hfz5 1/1 Running &lt;span class="m">0&lt;/span> 6m19s 10.201.255.193 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system nodelocaldns-5kb8v 1/1 Running &lt;span class="m">0&lt;/span> 7m40s 192.168.1.72 k8s-master72u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system nodelocaldns-894wn 1/1 Running &lt;span class="m">0&lt;/span> 7m40s 192.168.1.71 k8s-master71u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system nodelocaldns-lkmlx 1/1 Running &lt;span class="m">0&lt;/span> 7m40s 192.168.1.75 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system nodelocaldns-q9q9s 1/1 Running &lt;span class="m">0&lt;/span> 7m40s 192.168.1.73 k8s-master73u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system nodelocaldns-qgrqs 1/1 Running &lt;span class="m">0&lt;/span> 7m40s 192.168.1.76 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="佈屬kubernetes的yaml">佈屬kubernetes的yaml&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# ll /etc/kubernetes/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total &lt;span class="m">412&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">5&lt;/span> kube root &lt;span class="m">4096&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 ./
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">105&lt;/span> root root &lt;span class="m">8192&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:44 ../
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">4&lt;/span> root root &lt;span class="m">49&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:52 addons/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">5669&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 admin.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1290&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:49 calico-config.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">550&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:49 calico-crb.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">4227&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:49 calico-cr.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">159&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:49 calico-ipamconfig.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1581&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:50 calico-kube-controllers.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">301&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:50 calico-kube-crb.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1733&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:50 calico-kube-cr.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">107&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:50 calico-kube-sa.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">197&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:49 calico-node-sa.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">11091&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:49 calico-node.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">5701&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:47 controller-manager.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">5684&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 &lt;span class="s1">&amp;#39;controller-manager.conf.15377.2023-12-03@14:47:03~&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">451&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 coredns-clusterrolebinding.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">473&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 coredns-clusterrole.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">601&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 coredns-config.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">3130&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 coredns-deployment.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">190&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 coredns-sa.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">591&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 coredns-svc.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">959&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 dns-autoscaler-clusterrolebinding.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1150&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 dns-autoscaler-clusterrole.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">763&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 dns-autoscaler-sa.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">2569&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 dns-autoscaler.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">219969&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:49 kdd-crds.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r----- &lt;span class="m">1&lt;/span> root root &lt;span class="m">3906&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 kubeadm-config.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">469&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:26 kubeadm-images.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">2017&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:46 kubelet.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">793&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 kubelet-config.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">513&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:44 kubelet.env
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">113&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:49 kubernetes-services-endpoint.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">199&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 kubescheduler-config.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> kube root &lt;span class="m">96&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 manifests/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r----- &lt;span class="m">1&lt;/span> root root &lt;span class="m">408&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:47 node-crb.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1035&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 nodelocaldns-config.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">2661&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 nodelocaldns-daemonset.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">149&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 nodelocaldns-sa.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">19&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:14 pki -&amp;gt; /etc/kubernetes/ssl/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">5649&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:47 scheduler.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">5632&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 &lt;span class="s1">&amp;#39;scheduler.conf.15389.2023-12-03@14:47:04~&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">4096&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 ssl/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="master組件yaml">master組件yaml&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# ll /etc/kubernetes/manifests/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total &lt;span class="m">20&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> kube root &lt;span class="m">96&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 ./
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">5&lt;/span> kube root &lt;span class="m">4096&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 ../
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">4727&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 kube-apiserver.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">3757&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 kube-controller-manager.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1698&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 kube-scheduler.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# calicoctl get ippool -o wide
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME CIDR NAT IPIPMODE VXLANMODE DISABLED DISABLEBGPEXPORT SELECTOR
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">default-pool 10.201.0.0/16 &lt;span class="nb">true&lt;/span> Never Always &lt;span class="nb">false&lt;/span> &lt;span class="nb">false&lt;/span> all&lt;span class="o">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="測試創建pod">測試創建POD&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl run test-nginx --image&lt;span class="o">=&lt;/span>nginx:alpine
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/test-nginx created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod -o wide
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">test-nginx 1/1 Running &lt;span class="m">0&lt;/span> 10s 10.201.14.130 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# curl 10.201.14.130
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;!DOCTYPE html&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;html&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;head&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;title&amp;gt;Welcome to nginx!&amp;lt;/title&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;style&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">html &lt;span class="o">{&lt;/span> color-scheme: light dark&lt;span class="p">;&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">body &lt;span class="o">{&lt;/span> width: 35em&lt;span class="p">;&lt;/span> margin: &lt;span class="m">0&lt;/span> auto&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">font-family: Tahoma, Verdana, Arial, sans-serif&lt;span class="p">;&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;/style&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;/head&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;body&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;h1&amp;gt;Welcome to nginx!&amp;lt;/h1&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;p&amp;gt;If you see this page, the nginx web server is successfully installed and
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">working. Further configuration is required.&amp;lt;/p&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;p&amp;gt;For online documentation and support please refer to
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;a &lt;span class="nv">href&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;http://nginx.org/&amp;#34;&lt;/span>&amp;gt;nginx.org&amp;lt;/a&amp;gt;.&amp;lt;br/&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Commercial support is available at
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;a &lt;span class="nv">href&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;http://nginx.com/&amp;#34;&lt;/span>&amp;gt;nginx.com&amp;lt;/a&amp;gt;.&amp;lt;/p&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;p&amp;gt;&amp;lt;em&amp;gt;Thank you &lt;span class="k">for&lt;/span> using nginx.&amp;lt;/em&amp;gt;&amp;lt;/p&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;/body&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;/html&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="測試deploymentserviceingress">測試Deployment、Service、Ingress&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat deployment2.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: apps/v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: Deployment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> labels:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app: web2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: web2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> replicas: &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> selector:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> matchLabels:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app: web2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> template:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> labels:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app: web2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> containers:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - image: nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl apply -f deployment2.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat service2.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: Service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> labels:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app: web2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: web2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ports:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - port: &lt;span class="m">80&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> protocol: TCP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> targetPort: &lt;span class="m">80&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> selector:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app: web2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> type: NodePort
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl apply -f service2.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat ingress.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: networking.k8s.io/v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: Ingress
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: web2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ingressClassName: nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rules:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - host: web2.jimmyhome.tw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> http:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> paths:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - backend:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: web2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> port:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> number: &lt;span class="m">80&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> path: /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pathType: Prefix
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl apply -f ingress.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod,svc,ingress -o wide
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/test-nginx 1/1 Running &lt;span class="m">0&lt;/span> 3m1s 10.201.14.130 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/web2-5d48fb75c5-dt5xd 1/1 Running &lt;span class="m">0&lt;/span> 113s 10.201.255.195 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/web2-5d48fb75c5-ggmrz 1/1 Running &lt;span class="m">0&lt;/span> 113s 10.201.14.131 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/web2-5d48fb75c5-jsvck 1/1 Running &lt;span class="m">0&lt;/span> 113s 10.201.255.194 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE SELECTOR
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service/kubernetes ClusterIP 10.202.0.1 &amp;lt;none&amp;gt; 443/TCP 22m &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service/web2 NodePort 10.202.72.45 &amp;lt;none&amp;gt; 80:31568/TCP 82s &lt;span class="nv">app&lt;/span>&lt;span class="o">=&lt;/span>web2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME CLASS HOSTS ADDRESS PORTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress.networking.k8s.io/web2 nginx web2.jimmyhome.tw &lt;span class="m">80&lt;/span> 56s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>以下都可以訪問nodeport
http://192.168.1.71:31568/
http://192.168.1.72:31568/
http://192.168.1.73:31568/
http://192.168.1.74:31568/
http://192.168.1.75:31568/
http://192.168.1.76:31568/&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231203230912.png"
loading="lazy"
>&lt;/p>
&lt;p>domain name也可以訪問，透過ingress-&amp;gt;service-&amp;gt;pod&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">chenqingze@chenqingze-MBP ~ % sudo vim /etc/hosts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.75 web2.jimmyhome.tw
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231203231115.png"
loading="lazy"
>&lt;/p>
&lt;h3 id="etcd服務">etcd服務&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl status etcd.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">● etcd.service - etcd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Loaded: loaded &lt;span class="o">(&lt;/span>/etc/systemd/system/etcd.service&lt;span class="p">;&lt;/span> enabled&lt;span class="p">;&lt;/span> vendor preset: enabled&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Active: active &lt;span class="o">(&lt;/span>running&lt;span class="o">)&lt;/span> since Sun 2023-12-03 14:43:39 UTC&lt;span class="p">;&lt;/span> 28min ago
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Main PID: &lt;span class="m">13409&lt;/span> &lt;span class="o">(&lt;/span>etcd&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Tasks: &lt;span class="m">14&lt;/span> &lt;span class="o">(&lt;/span>limit: 9387&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Memory: 117.0M
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CPU: 51.716s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CGroup: /system.slice/etcd.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └─13409 /usr/local/bin/etcd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 14:55:55 k8s-master71u etcd&lt;span class="o">[&lt;/span>13409&lt;span class="o">]&lt;/span>: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;level&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;info&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;ts&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;2023-12-03T14:55:55.63607Z&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;caller&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;mvcc/hash.go:137&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;msg&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;storing new hash&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;hash&amp;#34;&lt;/span>:1201138327,&lt;span class="s2">&amp;#34;re&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 15:06:09 k8s-master71u etcd[13409]: {&amp;#34;&lt;/span>level&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>info&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>ts&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>2023-12-03T15:06:09.854317Z&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>caller&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>mvcc/index.go:214&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>msg&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>compact tree index&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>revision&lt;span class="s2">&amp;#34;:3724}
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 15:06:09 k8s-master71u etcd[13409]: {&amp;#34;&lt;/span>level&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>info&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>ts&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>2023-12-03T15:06:09.942986Z&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>caller&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>mvcc/kvstore_compaction.go:66&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>msg&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>finished scheduled compac&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 15:06:09 k8s-master71u etcd&lt;span class="o">[&lt;/span>13409&lt;span class="o">]&lt;/span>: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;level&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;info&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;ts&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;2023-12-03T15:06:09.943036Z&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;caller&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;mvcc/hash.go:137&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;msg&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;storing new hash&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;hash&amp;#34;&lt;/span>:2096861132,&lt;span class="s2">&amp;#34;r&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 15:07:01 k8s-master71u etcd[13409]: {&amp;#34;&lt;/span>level&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>warn&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>ts&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>2023-12-03T15:07:01.091549Z&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>caller&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>etcdserver/util.go:170&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>msg&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>apply request took too long&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>to&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 15:07:01 k8s-master71u etcd&lt;span class="o">[&lt;/span>13409&lt;span class="o">]&lt;/span>: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;level&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;info&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;ts&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;2023-12-03T15:07:01.091613Z&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;caller&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;traceutil/trace.go:171&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;msg&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;trace[2099372944] range&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;detail&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 15:07:02 k8s-master71u etcd[13409]: {&amp;#34;&lt;/span>level&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>info&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>ts&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>2023-12-03T15:07:02.663992Z&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>caller&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>traceutil/trace.go:171&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>msg&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>trace&lt;span class="o">[&lt;/span>1476779153&lt;span class="o">]&lt;/span> transaction&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 15:11:09 k8s-master71u etcd&lt;span class="o">[&lt;/span>13409&lt;span class="o">]&lt;/span>: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;level&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;info&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;ts&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;2023-12-03T15:11:09.86509Z&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;caller&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;mvcc/index.go:214&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;msg&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;compact tree index&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;revision&amp;#34;&lt;/span>:4506&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 15:11:09 k8s-master71u etcd&lt;span class="o">[&lt;/span>13409&lt;span class="o">]&lt;/span>: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;level&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;info&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;ts&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;2023-12-03T15:11:09.890206Z&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;caller&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;mvcc/kvstore_compaction.go:66&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;msg&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;finished scheduled compac&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 15:11:09 k8s-master71u etcd[13409]: {&amp;#34;&lt;/span>level&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>info&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>ts&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>2023-12-03T15:11:09.890258Z&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>caller&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>mvcc/hash.go:137&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>msg&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>storing new hash&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>hash&lt;span class="s2">&amp;#34;:2253005372,&amp;#34;&lt;/span>r&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="cri-dockerd服務">cri-dockerd服務&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl status cri-dockerd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">● cri-dockerd.service - CRI Interface &lt;span class="k">for&lt;/span> Docker Application Container Engine
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Loaded: loaded &lt;span class="o">(&lt;/span>/etc/systemd/system/cri-dockerd.service&lt;span class="p">;&lt;/span> enabled&lt;span class="p">;&lt;/span> vendor preset: enabled&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Active: active &lt;span class="o">(&lt;/span>running&lt;span class="o">)&lt;/span> since Sun 2023-12-03 14:25:01 UTC&lt;span class="p">;&lt;/span> 46min ago
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TriggeredBy: ● cri-dockerd.socket
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Docs: https://docs.mirantis.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Main PID: &lt;span class="m">8096&lt;/span> &lt;span class="o">(&lt;/span>cri-dockerd&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Tasks: &lt;span class="m">14&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Memory: 19.4M
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CPU: 38.327s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CGroup: /system.slice/cri-dockerd.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └─8096 /usr/local/bin/cri-dockerd --container-runtime-endpoint unix:///var/run/cri-dockerd.sock --cni-conf-dir&lt;span class="o">=&lt;/span>/etc/cni/net.d --cni-bin-dir&lt;span class="o">=&lt;/span>/opt/cni/bin -&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 14:51:41 k8s-master71u cri-dockerd&lt;span class="o">[&lt;/span>8096&lt;span class="o">]&lt;/span>: 2023-12-03 14:51:41.774 &lt;span class="o">[&lt;/span>INFO&lt;span class="o">][&lt;/span>21767&lt;span class="o">]&lt;/span> dataplane_linux.go 473: Disabling IPv4 forwarding &lt;span class="nv">ContainerID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;b05ee1aac5d857271&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 14:51:41 k8s-master71u cri-dockerd[8096]: 2023-12-03 14:51:41.804 [INFO][21767] k8s.go 411: Added Mac, interface name, and active container ID to endpoint Conta&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 14:51:41 k8s-master71u cri-dockerd[8096]: 2023-12-03 14:51:41.825 [INFO][21767] k8s.go 489: Wrote updated endpoint to datastore ContainerID=&amp;#34;&lt;/span>b05ee1aac5d85727107&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 14:51:41 k8s-master71u cri-dockerd&lt;span class="o">[&lt;/span>8096&lt;span class="o">]&lt;/span>: &lt;span class="nv">time&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;2023-12-03T14:51:41Z&amp;#34;&lt;/span> &lt;span class="nv">level&lt;/span>&lt;span class="o">=&lt;/span>info &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Pulling image registry.k8s.io/ingress-nginx/controller:v1.9.4: 05535d57e64&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 14:51:51 k8s-master71u cri-dockerd[8096]: time=&amp;#34;&lt;/span>2023-12-03T14:51:51Z&lt;span class="s2">&amp;#34; level=info msg=&amp;#34;&lt;/span>Pulling image registry.k8s.io/ingress-nginx/controller:v1.9.4: 3da4cd537b4&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 14:51:52 k8s-master71u cri-dockerd&lt;span class="o">[&lt;/span>8096&lt;span class="o">]&lt;/span>: &lt;span class="nv">time&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;2023-12-03T14:51:52Z&amp;#34;&lt;/span> &lt;span class="nv">level&lt;/span>&lt;span class="o">=&lt;/span>info &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Will attempt to re-write config file /var/lib/docker/containers/e5ebeb0472&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 14:51:53 k8s-master71u cri-dockerd[8096]: time=&amp;#34;&lt;/span>2023-12-03T14:51:53Z&lt;span class="s2">&amp;#34; level=info msg=&amp;#34;&lt;/span>Stop pulling image registry.k8s.io/ingress-nginx/controller:v1.9.4: Status&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 14:55:33 k8s-master71u cri-dockerd&lt;span class="o">[&lt;/span>8096&lt;span class="o">]&lt;/span>: &lt;span class="nv">time&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;2023-12-03T14:55:33Z&amp;#34;&lt;/span> &lt;span class="nv">level&lt;/span>&lt;span class="o">=&lt;/span>info &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Docker cri received runtime config &amp;amp;RuntimeConfig{NetworkConfig:&amp;amp;NetworkCo&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 14:55:37 k8s-master71u cri-dockerd[8096]: time=&amp;#34;&lt;/span>2023-12-03T14:55:37Z&lt;span class="s2">&amp;#34; level=info msg=&amp;#34;&lt;/span>Will attempt to re-write config file /var/lib/docker/containers/f23d464928&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 14:56:08 k8s-master71u cri-dockerd&lt;span class="o">[&lt;/span>8096&lt;span class="o">]&lt;/span>: &lt;span class="nv">time&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;2023-12-03T14:56:08Z&amp;#34;&lt;/span> &lt;span class="nv">level&lt;/span>&lt;span class="o">=&lt;/span>info &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Will attempt to re-write config file /var/lib/docker/containers/651f69131d&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="kubelet服務">kubelet服務&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl status kubelet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">● kubelet.service - Kubernetes Kubelet Server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Loaded: loaded &lt;span class="o">(&lt;/span>/etc/systemd/system/kubelet.service&lt;span class="p">;&lt;/span> enabled&lt;span class="p">;&lt;/span> vendor preset: enabled&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Active: active &lt;span class="o">(&lt;/span>running&lt;span class="o">)&lt;/span> since Sun 2023-12-03 14:55:33 UTC&lt;span class="p">;&lt;/span> 16min ago
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Docs: https://github.com/GoogleCloudPlatform/kubernetes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Main PID: &lt;span class="m">27162&lt;/span> &lt;span class="o">(&lt;/span>kubelet&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Tasks: &lt;span class="m">16&lt;/span> &lt;span class="o">(&lt;/span>limit: 9387&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Memory: 42.9M
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CPU: 23.201s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CGroup: /system.slice/kubelet.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └─27162 /usr/local/bin/kubelet --v&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span> --node-ip&lt;span class="o">=&lt;/span>192.168.1.71 --hostname-override&lt;span class="o">=&lt;/span>k8s-master71u --bootstrap-kubeconfig&lt;span class="o">=&lt;/span>/etc/kubernetes/bootstrap-kubelet.con&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 15:11:31 k8s-master71u kubelet&lt;span class="o">[&lt;/span>27162&lt;span class="o">]&lt;/span>: E1203 15:11:31.892549 &lt;span class="m">27162&lt;/span> cri_stats_provider.go:643&lt;span class="o">]&lt;/span> &lt;span class="s2">&amp;#34;Unable to fetch container log stats&amp;#34;&lt;/span> &lt;span class="nv">err&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;failed to get fsstats&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 15:11:33 k8s-master71u kubelet[27162]: I1203 15:11:33.187859 27162 kubelet_getters.go:182] &amp;#34;&lt;/span>Pod status updated&lt;span class="s2">&amp;#34; pod=&amp;#34;&lt;/span>kube-system/kube-apiserver-k8s-master71u&lt;span class="s2">&amp;#34;&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 15:11:33 k8s-master71u kubelet[27162]: I1203 15:11:33.187909 27162 kubelet_getters.go:182] &amp;#34;&lt;/span>Pod status updated&lt;span class="s2">&amp;#34; pod=&amp;#34;&lt;/span>kube-system/kube-controller-manager-k8s-m&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 15:11:33 k8s-master71u kubelet&lt;span class="o">[&lt;/span>27162&lt;span class="o">]&lt;/span>: I1203 15:11:33.187921 &lt;span class="m">27162&lt;/span> kubelet_getters.go:182&lt;span class="o">]&lt;/span> &lt;span class="s2">&amp;#34;Pod status updated&amp;#34;&lt;/span> &lt;span class="nv">pod&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;kube-system/kube-scheduler-k8s-master71u&amp;#34;&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 15:11:42 k8s-master71u kubelet&lt;span class="o">[&lt;/span>27162&lt;span class="o">]&lt;/span>: E1203 15:11:42.968925 &lt;span class="m">27162&lt;/span> cri_stats_provider.go:643&lt;span class="o">]&lt;/span> &lt;span class="s2">&amp;#34;Unable to fetch container log stats&amp;#34;&lt;/span> &lt;span class="nv">err&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;failed to get fsstats&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 15:11:42 k8s-master71u kubelet[27162]: E1203 15:11:42.969222 27162 cri_stats_provider.go:643] &amp;#34;&lt;/span>Unable to fetch container log stats&lt;span class="s2">&amp;#34; err=&amp;#34;&lt;/span>failed to get fsstats&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 15:11:54 k8s-master71u kubelet&lt;span class="o">[&lt;/span>27162&lt;span class="o">]&lt;/span>: E1203 15:11:54.050355 &lt;span class="m">27162&lt;/span> cri_stats_provider.go:643&lt;span class="o">]&lt;/span> &lt;span class="s2">&amp;#34;Unable to fetch container log stats&amp;#34;&lt;/span> &lt;span class="nv">err&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;failed to get fsstats&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 15:11:54 k8s-master71u kubelet[27162]: E1203 15:11:54.050462 27162 cri_stats_provider.go:643] &amp;#34;&lt;/span>Unable to fetch container log stats&lt;span class="s2">&amp;#34; err=&amp;#34;&lt;/span>failed to get fsstats&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">03&lt;/span> 15:12:05 k8s-master71u kubelet&lt;span class="o">[&lt;/span>27162&lt;span class="o">]&lt;/span>: E1203 15:12:05.124399 &lt;span class="m">27162&lt;/span> cri_stats_provider.go:643&lt;span class="o">]&lt;/span> &lt;span class="s2">&amp;#34;Unable to fetch container log stats&amp;#34;&lt;/span> &lt;span class="nv">err&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;failed to get fsstats&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 03 15:12:05 k8s-master71u kubelet[27162]: E1203 15:12:05.124943 27162 cri_stats_provider.go:643] &amp;#34;&lt;/span>Unable to fetch container log stats&lt;span class="s2">&amp;#34; err=&amp;#34;&lt;/span>failed to get fsstats&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="憑證與金鑰">憑證與金鑰&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# &lt;span class="nb">cd&lt;/span> /etc/kubernetes/pki
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:/etc/kubernetes/pki# ll
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total &lt;span class="m">56&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">4096&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 ./
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">5&lt;/span> kube root &lt;span class="m">4096&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:51 ../
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1428&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 apiserver.crt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1679&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 apiserver.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1164&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 apiserver-kubelet-client.crt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1679&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 apiserver-kubelet-client.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1099&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 ca.crt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1675&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 ca.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1115&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 front-proxy-ca.crt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1675&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 front-proxy-ca.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1119&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 front-proxy-client.crt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1675&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 front-proxy-client.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1679&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 sa.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">451&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:45 sa.pub
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:/etc/kubernetes/pki# &lt;span class="k">for&lt;/span> i in &lt;span class="k">$(&lt;/span>ls *.crt&lt;span class="k">)&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;===== &lt;/span>&lt;span class="nv">$i&lt;/span>&lt;span class="s2"> =====&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> openssl x509 -in &lt;span class="nv">$i&lt;/span> -text -noout &lt;span class="p">|&lt;/span> grep -A &lt;span class="m">3&lt;/span> &lt;span class="s1">&amp;#39;Validity&amp;#39;&lt;/span> &lt;span class="p">;&lt;/span> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> apiserver.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:45:49 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Dec &lt;span class="m">2&lt;/span> 14:45:50 &lt;span class="m">2024&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> kube-apiserver
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> apiserver-kubelet-client.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:45:49 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Dec &lt;span class="m">2&lt;/span> 14:45:50 &lt;span class="m">2024&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">O&lt;/span> &lt;span class="o">=&lt;/span> system:masters, &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> kube-apiserver-kubelet-client
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> ca.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:45:49 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">30&lt;/span> 14:45:49 &lt;span class="m">2033&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">kubernetes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> front-proxy-ca.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:45:50 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">30&lt;/span> 14:45:50 &lt;span class="m">2033&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> front-proxy-ca
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> front-proxy-client.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:45:50 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Dec &lt;span class="m">2&lt;/span> 14:45:51 &lt;span class="m">2024&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> front-proxy-client
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="etcd憑證與金鑰">etcd憑證與金鑰&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:/etc/kubernetes/pki# &lt;span class="nb">cd&lt;/span> /etc/ssl/etcd/ssl/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:/etc/ssl/etcd/ssl# ll
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total &lt;span class="m">84&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwx------ &lt;span class="m">2&lt;/span> etcd root &lt;span class="m">4096&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 ./
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwx------ &lt;span class="m">3&lt;/span> etcd root &lt;span class="m">37&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 ../
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1704&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 admin-k8s-master71u-key.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1476&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 admin-k8s-master71u.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1704&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 admin-k8s-master72u-key.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1476&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 admin-k8s-master72u.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1708&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 admin-k8s-master73u-key.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1476&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 admin-k8s-master73u.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1704&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 ca-key.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1111&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 ca.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1704&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 member-k8s-master71u-key.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1480&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 member-k8s-master71u.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1704&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 member-k8s-master72u-key.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1480&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 member-k8s-master72u.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1704&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 member-k8s-master73u-key.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1480&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 member-k8s-master73u.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1704&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 node-k8s-master71u-key.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1476&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 node-k8s-master71u.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1704&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 node-k8s-master72u-key.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1476&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 node-k8s-master72u.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1704&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 node-k8s-master73u-key.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwx------ &lt;span class="m">1&lt;/span> etcd root &lt;span class="m">1476&lt;/span> Dec &lt;span class="m">3&lt;/span> 14:42 node-k8s-master73u.pem*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:/etc/ssl/etcd/ssl# &lt;span class="k">for&lt;/span> i in &lt;span class="k">$(&lt;/span>ls *.pem &lt;span class="p">|&lt;/span> egrep -v &lt;span class="s2">&amp;#34;key&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;===== &lt;/span>&lt;span class="nv">$i&lt;/span>&lt;span class="s2"> =====&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> openssl x509 -in &lt;span class="nv">$i&lt;/span> -text -noout &lt;span class="p">|&lt;/span> grep -A &lt;span class="m">3&lt;/span> &lt;span class="s1">&amp;#39;Validity&amp;#39;&lt;/span> &lt;span class="p">;&lt;/span> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> admin-k8s-master71u.pem &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:42:05 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">9&lt;/span> 14:42:05 &lt;span class="m">2123&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> etcd-admin-k8s-master71u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> admin-k8s-master72u.pem &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:42:06 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">9&lt;/span> 14:42:06 &lt;span class="m">2123&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> etcd-admin-k8s-master72u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> admin-k8s-master73u.pem &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:42:07 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">9&lt;/span> 14:42:07 &lt;span class="m">2123&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> etcd-admin-k8s-master73u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> ca.pem &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:42:05 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">9&lt;/span> 14:42:05 &lt;span class="m">2123&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> etcd-ca
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> member-k8s-master71u.pem &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:42:05 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">9&lt;/span> 14:42:05 &lt;span class="m">2123&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> etcd-member-k8s-master71u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> member-k8s-master72u.pem &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:42:06 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">9&lt;/span> 14:42:06 &lt;span class="m">2123&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> etcd-member-k8s-master72u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> member-k8s-master73u.pem &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:42:06 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">9&lt;/span> 14:42:06 &lt;span class="m">2123&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> etcd-member-k8s-master73u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> node-k8s-master71u.pem &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:42:07 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">9&lt;/span> 14:42:07 &lt;span class="m">2123&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> etcd-node-k8s-master71u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> node-k8s-master72u.pem &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:42:07 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">9&lt;/span> 14:42:07 &lt;span class="m">2123&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> etcd-node-k8s-master72u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> node-k8s-master73u.pem &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Dec &lt;span class="m">3&lt;/span> 14:42:07 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Nov &lt;span class="m">9&lt;/span> 14:42:07 &lt;span class="m">2123&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> etcd-node-k8s-master73u
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="安裝rancher管理平台高可用">安裝rancher管理平台(高可用)&lt;/h3>
&lt;p>詳細操作可以參考我這篇：
&lt;a class="link" href="https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/" target="_blank" rel="noopener"
>https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/&lt;/a>&lt;/p>
&lt;h4 id="一添加-helm-chart-倉庫">一、添加 Helm Chart 倉庫&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm repo add rancher-stable https://releases.rancher.com/server-charts/stable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;rancher-stable&amp;#34;&lt;/span> has been added to your repositories
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="二為-rancher-建立命名空間">二、為 Rancher 建立命名空間&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl create namespace cattle-system
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="三選擇-ssl-配置">三、選擇 SSL 配置&lt;/h4>
&lt;p>Rancher 產生的憑證（預設）
需要 cert-manager&lt;/p>
&lt;h4 id="四安裝-cert-manager">四、安裝 cert-manager&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 如果你手動安裝了CRD，而不是在 Helm 安裝命令中添加了 &amp;#39;--set installCRDs=true&amp;#39; 選項，你應該在升級 Helm Chart 之前升級 CRD 資源。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.11.0/cert-manager.crds.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 添加 Jetstack Helm 倉庫&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm repo add jetstack https://charts.jetstack.io
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 更新本地 Helm Chart 倉庫緩存&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm repo update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Hang tight &lt;span class="k">while&lt;/span> we grab the latest from your chart repositories...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...Successfully got an update from the &lt;span class="s2">&amp;#34;jetstack&amp;#34;&lt;/span> chart repository
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...Successfully got an update from the &lt;span class="s2">&amp;#34;rancher-stable&amp;#34;&lt;/span> chart repository
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Update Complete. ⎈Happy Helming!⎈
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安裝 cert-manager Helm Chart&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm install cert-manager jetstack/cert-manager &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --namespace cert-manager &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --create-namespace &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --version v1.11.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安裝完 cert-manager 后，你可以通過檢查 cert-manager 命名空間中正在運行的 Pod 來驗證它是否已正確部署&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pods --namespace cert-manager
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cert-manager-64f9f45d6f-vklzz 1/1 Running &lt;span class="m">0&lt;/span> 37s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cert-manager-cainjector-56bbdd5c47-wv2l7 1/1 Running &lt;span class="m">0&lt;/span> 37s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cert-manager-webhook-d4f4545d7-pw2cp 1/1 Running &lt;span class="m">0&lt;/span> 37s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="五根據你選擇的證書選項通過-helm-安裝-rancher">五、根據你選擇的證書選項，通過 Helm 安裝 Rancher&lt;/h4>
&lt;p>採Rancher 生成的證書方式&lt;/p>
&lt;p>Rancher Helm Chart 選項：
&lt;a class="link" href="https://ranchermanager.docs.rancher.com/zh/getting-started/installation-and-upgrade/installation-references/helm-chart-options" target="_blank" rel="noopener"
>https://ranchermanager.docs.rancher.com/zh/getting-started/installation-and-upgrade/installation-references/helm-chart-options&lt;/a>&lt;/p>
&lt;p>&lt;font color=red>需多指定ingressClassName為nginx&lt;/font>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm install rancher rancher-stable/rancher &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --namespace cattle-system &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --set &lt;span class="nv">hostname&lt;/span>&lt;span class="o">=&lt;/span>rancher.jimmyhome.tw &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --set &lt;span class="nv">bootstrapPassword&lt;/span>&lt;span class="o">=&lt;/span>admin &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --set ingress.ingressClassName&lt;span class="o">=&lt;/span>nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME: rancher
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">LAST DEPLOYED: Sun Dec &lt;span class="m">3&lt;/span> 15:40:43 &lt;span class="m">2023&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAMESPACE: cattle-system
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">STATUS: deployed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">REVISION: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TEST SUITE: None
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NOTES:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Rancher Server has been installed.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NOTE: Rancher may take several minutes to fully initialize. Please standby &lt;span class="k">while&lt;/span> Certificates are being issued, Containers are started and the Ingress rule comes up.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Check out our docs at https://rancher.com/docs/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">If you provided your own bootstrap password during installation, browse to https://rancher.jimmyhome.tw to get started.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">If this is the first &lt;span class="nb">time&lt;/span> you installed Rancher, get started by running this &lt;span class="nb">command&lt;/span> and clicking the URL it generates:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> https://rancher.jimmyhome.tw/dashboard/?setup&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>kubectl get secret --namespace cattle-system bootstrap-secret -o go-template&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;{{.data.bootstrapPassword|base64decode}}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">To get just the bootstrap password on its own, run:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubectl get secret --namespace cattle-system bootstrap-secret -o go-template&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;{{.data.bootstrapPassword|base64decode}}{{ &amp;#34;\n&amp;#34; }}&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Happy Containering!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 等待 Rancher 運行&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl -n cattle-system rollout status deploy/rancher
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Waiting &lt;span class="k">for&lt;/span> deployment &lt;span class="s2">&amp;#34;rancher&amp;#34;&lt;/span> rollout to finish: &lt;span class="m">0&lt;/span> of &lt;span class="m">3&lt;/span> updated replicas are available...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Waiting &lt;span class="k">for&lt;/span> deployment &lt;span class="s2">&amp;#34;rancher&amp;#34;&lt;/span> rollout to finish: &lt;span class="m">1&lt;/span> of &lt;span class="m">3&lt;/span> updated replicas are available...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Waiting &lt;span class="k">for&lt;/span> deployment &lt;span class="s2">&amp;#34;rancher&amp;#34;&lt;/span> rollout to finish: &lt;span class="m">2&lt;/span> of &lt;span class="m">3&lt;/span> updated replicas are available...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment &lt;span class="s2">&amp;#34;rancher&amp;#34;&lt;/span> successfully rolled out
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="六驗證-rancher-server-是否部署成功">六、驗證 Rancher Server 是否部署成功&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl -n cattle-system get deploy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY UP-TO-DATE AVAILABLE AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rancher 3/3 &lt;span class="m">3&lt;/span> &lt;span class="m">3&lt;/span> 5m2s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl -n cattle-system get pod -o wide
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">helm-operation-hpd69 2/2 Running &lt;span class="m">0&lt;/span> 40s 10.201.14.138 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rancher-64cf6ddd96-pcfv5 1/1 Running &lt;span class="m">0&lt;/span> 5m11s 10.201.255.201 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rancher-64cf6ddd96-q7dhp 1/1 Running &lt;span class="m">0&lt;/span> 5m11s 10.201.255.202 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rancher-64cf6ddd96-rr28z 1/1 Running &lt;span class="m">0&lt;/span> 5m11s 10.201.14.137 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl -n cattle-system get ingress
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME CLASS HOSTS ADDRESS PORTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rancher nginx rancher.jimmyhome.tw 80, &lt;span class="m">443&lt;/span> 5m35s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 我自己的筆電，先設定/etc/hosts測試網頁訪問&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 如是內部有dns server的，就到dns server設定a record解析&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chenqingze@chenqingze-MBP ~ % sudo vim /etc/hosts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.75 rancher.jimmyhome.tw
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>打 &lt;a class="link" href="https://rancher.jimmyhome.tw" target="_blank" rel="noopener"
>https://rancher.jimmyhome.tw&lt;/a> 可以看到網頁&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231203234722.png"
loading="lazy"
>&lt;/p>
&lt;p>由上方helm install rancher完成時，可以看到以下兩個指令，可以獲取到預設admin帳號的密碼&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># If this is the first time you installed Rancher, get started by running this command and clicking the URL it generates&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# &lt;span class="nb">echo&lt;/span> https://rancher.jimmyhome.tw/dashboard/?setup&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>kubectl get secret --namespace cattle-system bootstrap-secret -o go-template&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;{{.data.bootstrapPassword|base64decode}}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">https://rancher.jimmyhome.tw/dashboard/?setup&lt;span class="o">=&lt;/span>admin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># To get just the bootstrap password on its own, run&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get secret --namespace cattle-system bootstrap-secret -o go-template&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;{{.data.bootstrapPassword|base64decode}}{{ &amp;#34;\n&amp;#34; }}&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">admin
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>重設admin帳號的密碼&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231203235051.png"
loading="lazy"
>&lt;/p>
&lt;p>可以看到集群資訊，state為Active
&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231203235121.png"
loading="lazy"
>&lt;/p>
&lt;p>進入集群，可以看到集群詳細訊息
&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231203235142.png"
loading="lazy"
>&lt;/p>
&lt;p>也可以使用dashboard shell去管理集群
&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231203235210.png"
loading="lazy"
>&lt;/p>
&lt;h3 id="安裝rook-ceph分布式存儲系統">安裝rook-ceph分布式存儲系統&lt;/h3>
&lt;p>詳細操作可以參考我這篇：
&lt;a class="link" href="https://blog.goldfishbrain-fighting.com/2023/kubernetes-rook-ceph/" target="_blank" rel="noopener"
>https://blog.goldfishbrain-fighting.com/2023/kubernetes-rook-ceph/&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# lsblk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINTS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop0 7:0 &lt;span class="m">0&lt;/span> 63.4M &lt;span class="m">1&lt;/span> loop /snap/core20/1974
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop1 7:1 &lt;span class="m">0&lt;/span> 63.5M &lt;span class="m">1&lt;/span> loop /snap/core20/2015
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop2 7:2 &lt;span class="m">0&lt;/span> 111.9M &lt;span class="m">1&lt;/span> loop /snap/lxd/24322
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop3 7:3 &lt;span class="m">0&lt;/span> 40.8M &lt;span class="m">1&lt;/span> loop /snap/snapd/20092
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop4 7:4 &lt;span class="m">0&lt;/span> 40.9M &lt;span class="m">1&lt;/span> loop /snap/snapd/20290
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sda 8:0 &lt;span class="m">0&lt;/span> 50G &lt;span class="m">0&lt;/span> disk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├─sda1 8:1 &lt;span class="m">0&lt;/span> 1M &lt;span class="m">0&lt;/span> part
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├─sda2 8:2 &lt;span class="m">0&lt;/span> 2G &lt;span class="m">0&lt;/span> part /boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└─sda3 8:3 &lt;span class="m">0&lt;/span> 48G &lt;span class="m">0&lt;/span> part
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └─ubuntu--vg-root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 253:0 &lt;span class="m">0&lt;/span> 48G &lt;span class="m">0&lt;/span> lvm /var/lib/kubelet/pods/ce7174f8-ad8f-4f42-8e58-2abca8c91424/volume-subpaths/tigera-ca-bundle/calico-node/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sdb 8:16 &lt;span class="m">0&lt;/span> 16G &lt;span class="m">0&lt;/span> disk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sr0 11:0 &lt;span class="m">1&lt;/span> 1024M &lt;span class="m">0&lt;/span> rom
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# lsblk -f
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME FSTYPE FSVER LABEL UUID FSAVAIL FSUSE% MOUNTPOINTS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> squash 4.0 &lt;span class="m">0&lt;/span> 100% /snap/core20/1974
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> squash 4.0 &lt;span class="m">0&lt;/span> 100% /snap/core20/2015
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> squash 4.0 &lt;span class="m">0&lt;/span> 100% /snap/lxd/24322
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> squash 4.0 &lt;span class="m">0&lt;/span> 100% /snap/snapd/20092
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> squash 4.0 &lt;span class="m">0&lt;/span> 100% /snap/snapd/20290
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sda
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├─sda1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├─sda2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ xfs f681192a-1cf2-4362-a74c-745374011700 1.8G 9% /boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└─sda3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> LVM2_m LVM2 JEduSv-mV9g-tzdJ-sYEc-6piR-6nAo-48Srdh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └─ubuntu--vg-root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> xfs 19cd87ec-9741-4295-9762-e87fb4f472c8 37.9G 21% /var/lib/kubelet/pods/ce7174f8-ad8f-4f42-8e58-2abca8c91424/volume-subpaths/tigera-ca-bundle/calico-node/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sdb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# lsblk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINTS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop0 7:0 &lt;span class="m">0&lt;/span> 63.4M &lt;span class="m">1&lt;/span> loop /snap/core20/1974
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop1 7:1 &lt;span class="m">0&lt;/span> 63.5M &lt;span class="m">1&lt;/span> loop /snap/core20/2015
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop2 7:2 &lt;span class="m">0&lt;/span> 111.9M &lt;span class="m">1&lt;/span> loop /snap/lxd/24322
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop3 7:3 &lt;span class="m">0&lt;/span> 40.8M &lt;span class="m">1&lt;/span> loop /snap/snapd/20092
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop4 7:4 &lt;span class="m">0&lt;/span> 40.9M &lt;span class="m">1&lt;/span> loop /snap/snapd/20290
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sda 8:0 &lt;span class="m">0&lt;/span> 50G &lt;span class="m">0&lt;/span> disk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├─sda1 8:1 &lt;span class="m">0&lt;/span> 1M &lt;span class="m">0&lt;/span> part
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├─sda2 8:2 &lt;span class="m">0&lt;/span> 2G &lt;span class="m">0&lt;/span> part /boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└─sda3 8:3 &lt;span class="m">0&lt;/span> 48G &lt;span class="m">0&lt;/span> part
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └─ubuntu--vg-root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 253:0 &lt;span class="m">0&lt;/span> 48G &lt;span class="m">0&lt;/span> lvm /var/lib/kubelet/pods/ce7174f8-ad8f-4f42-8e58-2abca8c91424/volume-subpaths/tigera-ca-bundle/calico-node/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sdb 8:16 &lt;span class="m">0&lt;/span> 16G &lt;span class="m">0&lt;/span> disk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sr0 11:0 &lt;span class="m">1&lt;/span> 1024M &lt;span class="m">0&lt;/span> rom
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# git clone --single-branch --branch v1.12.8 https://github.com/rook/rook.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# &lt;span class="nb">cd&lt;/span> rook/deploy/examples
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f crds.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephblockpoolradosnamespaces.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephblockpools.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephbucketnotifications.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephbuckettopics.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephclients.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephclusters.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephcosidrivers.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephfilesystemmirrors.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephfilesystems.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephfilesystemsubvolumegroups.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephnfses.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephobjectrealms.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephobjectstores.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephobjectstoreusers.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephobjectzonegroups.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephobjectzones.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/cephrbdmirrors.ceph.rook.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/objectbucketclaims.objectbucket.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">customresourcedefinition.apiextensions.k8s.io/objectbuckets.objectbucket.io created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f common.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">namespace/rook-ceph created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/cephfs-csi-nodeplugin created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/cephfs-external-provisioner-runner created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/objectstorage-provisioner-role created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/rbd-csi-nodeplugin created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/rbd-external-provisioner-runner created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/rook-ceph-cluster-mgmt created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/rook-ceph-global created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/rook-ceph-mgr-cluster created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/rook-ceph-mgr-system created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/rook-ceph-object-bucket created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/rook-ceph-osd created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrole.rbac.authorization.k8s.io/rook-ceph-system created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrolebinding.rbac.authorization.k8s.io/cephfs-csi-nodeplugin-role created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrolebinding.rbac.authorization.k8s.io/cephfs-csi-provisioner-role created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrolebinding.rbac.authorization.k8s.io/objectstorage-provisioner-role-binding created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrolebinding.rbac.authorization.k8s.io/rbd-csi-nodeplugin created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrolebinding.rbac.authorization.k8s.io/rbd-csi-provisioner-role created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrolebinding.rbac.authorization.k8s.io/rook-ceph-global created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrolebinding.rbac.authorization.k8s.io/rook-ceph-mgr-cluster created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrolebinding.rbac.authorization.k8s.io/rook-ceph-object-bucket created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrolebinding.rbac.authorization.k8s.io/rook-ceph-osd created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterrolebinding.rbac.authorization.k8s.io/rook-ceph-system created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">role.rbac.authorization.k8s.io/cephfs-external-provisioner-cfg created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">role.rbac.authorization.k8s.io/rbd-csi-nodeplugin created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">role.rbac.authorization.k8s.io/rbd-external-provisioner-cfg created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">role.rbac.authorization.k8s.io/rook-ceph-cmd-reporter created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">role.rbac.authorization.k8s.io/rook-ceph-mgr created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">role.rbac.authorization.k8s.io/rook-ceph-osd created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">role.rbac.authorization.k8s.io/rook-ceph-purge-osd created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">role.rbac.authorization.k8s.io/rook-ceph-rgw created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">role.rbac.authorization.k8s.io/rook-ceph-system created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/cephfs-csi-provisioner-role-cfg created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/rbd-csi-nodeplugin-role-cfg created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/rbd-csi-provisioner-role-cfg created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/rook-ceph-cluster-mgmt created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/rook-ceph-cmd-reporter created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/rook-ceph-mgr created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/rook-ceph-mgr-system created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/rook-ceph-osd created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/rook-ceph-purge-osd created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/rook-ceph-rgw created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rolebinding.rbac.authorization.k8s.io/rook-ceph-system created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/objectstorage-provisioner created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/rook-ceph-cmd-reporter created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/rook-ceph-mgr created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/rook-ceph-osd created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/rook-ceph-purge-osd created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/rook-ceph-rgw created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/rook-ceph-system created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/rook-csi-cephfs-plugin-sa created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/rook-csi-cephfs-provisioner-sa created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/rook-csi-rbd-plugin-sa created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">serviceaccount/rook-csi-rbd-provisioner-sa created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f operator.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">configmap/rook-ceph-operator-config created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment.apps/rook-ceph-operator created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get deployments.apps -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY UP-TO-DATE AVAILABLE AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-operator 1/1 &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> 22s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get pod -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-operator-58775c8bdf-vmdkn 1/1 Running &lt;span class="m">0&lt;/span> 39s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# vim cluster.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 角色調度&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> placement:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mon:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeAffinity:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requiredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeSelectorTerms:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: ceph-mon
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tolerations:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: Exists
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mgr:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeAffinity:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requiredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeSelectorTerms:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: ceph-mgr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tolerations:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: Exists
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> osd:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeAffinity:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requiredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeSelectorTerms:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: ceph-osd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tolerations:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: Exists
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> prepareosd:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeAffinity:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requiredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeSelectorTerms:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: ceph-osd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tolerations:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: Exists
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 角色資源&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> resources:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mon:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> limits:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: &lt;span class="s2">&amp;#34;1000m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: &lt;span class="s2">&amp;#34;2048Mi&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requests:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: &lt;span class="s2">&amp;#34;1000m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: &lt;span class="s2">&amp;#34;2048Mi&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mgr:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> limits:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: &lt;span class="s2">&amp;#34;1000m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: &lt;span class="s2">&amp;#34;1024Mi&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requests:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: &lt;span class="s2">&amp;#34;1000m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: &lt;span class="s2">&amp;#34;1024Mi&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> osd:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> limits:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: &lt;span class="s2">&amp;#34;1000m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: &lt;span class="s2">&amp;#34;2048Mi&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requests:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: &lt;span class="s2">&amp;#34;1000m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: &lt;span class="s2">&amp;#34;2048Mi&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 磁碟調度&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;k8s-master71u&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> devices:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;sdb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> config:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storeType: bluestore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> journalSizeMB: &lt;span class="s2">&amp;#34;4096&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;k8s-master72u&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> devices:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;sdb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> config:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storeType: bluestore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> journalSizeMB: &lt;span class="s2">&amp;#34;4096&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;k8s-master73u&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> devices:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;sdb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> config:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storeType: bluestore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> journalSizeMB: &lt;span class="s2">&amp;#34;4096&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;k8s-node75u&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> devices:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;sdb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> config:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storeType: bluestore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> journalSizeMB: &lt;span class="s2">&amp;#34;4096&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;k8s-node76u&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> devices:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;sdb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> config:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storeType: bluestore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> journalSizeMB: &lt;span class="s2">&amp;#34;4096&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 關閉磁碟自動全部調度&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storage: &lt;span class="c1"># cluster level storage configuration and selection&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#設置磁碟的參數，調整為false，方便後面訂製&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> useAllNodes: &lt;span class="nb">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> useAllDevices: &lt;span class="nb">false&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master71u ceph-mon&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-master71u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master72u ceph-mon&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-master72u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master73u ceph-mon&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-master73u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master71u ceph-mgr&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-master71u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master72u ceph-mgr&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-master72u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master73u ceph-mgr&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-master73u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master71u ceph-osd&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-master71u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master72u ceph-osd&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-master72u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master73u ceph-osd&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-master73u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-node75u ceph-osd&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-node75u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-node76u ceph-osd&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">node/k8s-node76u labeled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f cluster.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cephcluster.ceph.rook.io/rook-ceph created
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get pod -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-cephfsplugin-nttgx 2/2 Running &lt;span class="m">0&lt;/span> 9m33s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-cephfsplugin-provisioner-668dfcf95b-dsxdk 5/5 Running &lt;span class="m">0&lt;/span> 9m33s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-cephfsplugin-provisioner-668dfcf95b-rgfv6 5/5 Running &lt;span class="m">0&lt;/span> 9m33s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-cephfsplugin-s6sc9 2/2 Running &lt;span class="m">0&lt;/span> 9m33s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-rbdplugin-bjv2p 2/2 Running &lt;span class="m">0&lt;/span> 9m33s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-rbdplugin-provisioner-5b78f67bbb-8ts8q 5/5 Running &lt;span class="m">0&lt;/span> 9m33s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-rbdplugin-provisioner-5b78f67bbb-rr5tn 5/5 Running &lt;span class="m">0&lt;/span> 9m33s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-rbdplugin-xb99w 2/2 Running &lt;span class="m">0&lt;/span> 9m33s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-crashcollector-k8s-master71u-55fcdbd66c-plz8m 1/1 Running &lt;span class="m">0&lt;/span> 2m57s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-crashcollector-k8s-master72u-675646bf64-8tl2q 1/1 Running &lt;span class="m">0&lt;/span> 3m18s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-crashcollector-k8s-master73u-84fdc469f7-9fkgh 1/1 Running &lt;span class="m">0&lt;/span> 2m56s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-crashcollector-k8s-node75u-bbc794dd9-rv4pw 1/1 Running &lt;span class="m">0&lt;/span> 11s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-crashcollector-k8s-node76u-5fd59cd68b-wljnj 1/1 Running &lt;span class="m">0&lt;/span> 73s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-a-59f556dbc9-695bv 3/3 Running &lt;span class="m">0&lt;/span> 3m33s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-b-f4c7855d-j69fj 3/3 Running &lt;span class="m">0&lt;/span> 3m33s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-a-b657589fb-c7c4f 2/2 Running &lt;span class="m">0&lt;/span> 8m2s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-b-6bdf47675f-tbhg8 2/2 Running &lt;span class="m">0&lt;/span> 3m59s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-c-5dcbc556d7-9zmmn 2/2 Running &lt;span class="m">0&lt;/span> 3m48s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-operator-58775c8bdf-m29b4 1/1 Running &lt;span class="m">0&lt;/span> 14m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-0-5b8dfc978f-fwlsv 2/2 Running &lt;span class="m">0&lt;/span> 2m58s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-1-c9544b764-gzcmd 2/2 Running &lt;span class="m">0&lt;/span> 2m57s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-2-897687cc9-mrntq 2/2 Running &lt;span class="m">0&lt;/span> 2m56s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-3-6c7c659454-9wk9z 2/2 Running &lt;span class="m">0&lt;/span> 73s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-4-68dcf49f6-vcpsj 1/2 Running &lt;span class="m">0&lt;/span> 12s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-prepare-k8s-master71u-6fjrl 0/1 Completed &lt;span class="m">0&lt;/span> 3m11s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-prepare-k8s-master72u-5mcbk 0/1 Completed &lt;span class="m">0&lt;/span> 3m10s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-prepare-k8s-master73u-cjklw 0/1 Completed &lt;span class="m">0&lt;/span> 3m9s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-prepare-k8s-node75u-tk24w 0/1 Completed &lt;span class="m">0&lt;/span> 3m8s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-prepare-k8s-node76u-7hqrg 0/1 Completed &lt;span class="m">0&lt;/span> 3m8s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f toolbox.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment.apps/rook-ceph-tools created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get pod -n rook-ceph &lt;span class="p">|&lt;/span> grep -i tool
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-tools-7cd4cd9c9c-54zk2 1/1 Running &lt;span class="m">0&lt;/span> 34s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl &lt;span class="nb">exec&lt;/span> -it rook-ceph-tools-7cd4cd9c9c-54zk2 -n rook-ceph -- /bin/bash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ ceph -s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cluster:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> id: 9da44d3d-58d1-402d-8f8b-66bd89a869a4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> health: HEALTH_OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> services:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mon: &lt;span class="m">3&lt;/span> daemons, quorum a,b,c &lt;span class="o">(&lt;/span>age 5m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mgr: a&lt;span class="o">(&lt;/span>active, starting, since 11s&lt;span class="o">)&lt;/span>, standbys: b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> osd: &lt;span class="m">5&lt;/span> osds: &lt;span class="m">5&lt;/span> up &lt;span class="o">(&lt;/span>since 93s&lt;span class="o">)&lt;/span>, &lt;span class="m">5&lt;/span> in &lt;span class="o">(&lt;/span>since 117s&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pools: &lt;span class="m">1&lt;/span> pools, &lt;span class="m">1&lt;/span> pgs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> objects: &lt;span class="m">2&lt;/span> objects, &lt;span class="m">449&lt;/span> KiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> usage: &lt;span class="m">41&lt;/span> MiB used, &lt;span class="m">80&lt;/span> GiB / &lt;span class="m">80&lt;/span> GiB avail
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pgs: &lt;span class="m">1&lt;/span> active+clean
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ ceph status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cluster:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> id: 9da44d3d-58d1-402d-8f8b-66bd89a869a4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> health: HEALTH_OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> services:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mon: &lt;span class="m">3&lt;/span> daemons, quorum a,b,c &lt;span class="o">(&lt;/span>age 5m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mgr: a&lt;span class="o">(&lt;/span>active, since 10s&lt;span class="o">)&lt;/span>, standbys: b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> osd: &lt;span class="m">5&lt;/span> osds: &lt;span class="m">5&lt;/span> up &lt;span class="o">(&lt;/span>since 104s&lt;span class="o">)&lt;/span>, &lt;span class="m">5&lt;/span> in &lt;span class="o">(&lt;/span>since 2m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pools: &lt;span class="m">1&lt;/span> pools, &lt;span class="m">1&lt;/span> pgs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> objects: &lt;span class="m">2&lt;/span> objects, &lt;span class="m">449&lt;/span> KiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> usage: &lt;span class="m">41&lt;/span> MiB used, &lt;span class="m">80&lt;/span> GiB / &lt;span class="m">80&lt;/span> GiB avail
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pgs: &lt;span class="m">1&lt;/span> active+clean
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ ceph osd status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ID HOST USED AVAIL WR OPS WR DATA RD OPS RD DATA STATE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">0&lt;/span> k8s-master71u 8788k 15.9G &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> exists,up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">1&lt;/span> k8s-master72u 8272k 15.9G &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> exists,up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">2&lt;/span> k8s-master73u 8788k 15.9G &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> exists,up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">3&lt;/span> k8s-node76u 8404k 15.9G &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> exists,up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4&lt;/span> k8s-node75u 7888k 15.9G &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> exists,up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ ceph df
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--- RAW STORAGE ---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CLASS SIZE AVAIL USED RAW USED %RAW USED
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ssd &lt;span class="m">80&lt;/span> GiB &lt;span class="m">80&lt;/span> GiB &lt;span class="m">41&lt;/span> MiB &lt;span class="m">41&lt;/span> MiB 0.05
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TOTAL &lt;span class="m">80&lt;/span> GiB &lt;span class="m">80&lt;/span> GiB &lt;span class="m">41&lt;/span> MiB &lt;span class="m">41&lt;/span> MiB 0.05
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--- POOLS ---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">POOL ID PGS STORED OBJECTS USED %USED MAX AVAIL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.mgr &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">449&lt;/span> KiB &lt;span class="m">2&lt;/span> &lt;span class="m">449&lt;/span> KiB &lt;span class="m">0&lt;/span> &lt;span class="m">25&lt;/span> GiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ rados df
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">POOL_NAME USED OBJECTS CLONES COPIES MISSING_ON_PRIMARY UNFOUND DEGRADED RD_OPS RD WR_OPS WR USED COMPR UNDER COMPR
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.mgr &lt;span class="m">449&lt;/span> KiB &lt;span class="m">2&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">6&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">288&lt;/span> &lt;span class="m">494&lt;/span> KiB &lt;span class="m">153&lt;/span> 1.3 MiB &lt;span class="m">0&lt;/span> B &lt;span class="m">0&lt;/span> B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total_objects &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total_used &lt;span class="m">41&lt;/span> MiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total_avail &lt;span class="m">80&lt;/span> GiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total_space &lt;span class="m">80&lt;/span> GiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ cat /etc/ceph/ceph.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>global&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">mon_host&lt;/span> &lt;span class="o">=&lt;/span> 10.202.156.149:6789,10.202.75.120:6789,10.202.62.213:6789
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>client.admin&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">keyring&lt;/span> &lt;span class="o">=&lt;/span> /etc/ceph/keyring
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ cat /etc/ceph/keyring
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>client.admin&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">AQCtp2xlw3soGRAAVvoyqWe8wzvkkt26JQEGtQ&lt;/span>&lt;span class="o">==&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ &lt;span class="nb">exit&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# apt update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# apt install ceph-common
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# vim /etc/ceph/ceph.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>global&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">mon_host&lt;/span> &lt;span class="o">=&lt;/span> 10.202.156.149:6789,10.202.75.120:6789,10.202.62.213:6789
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>client.admin&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">keyring&lt;/span> &lt;span class="o">=&lt;/span> /etc/ceph/keyring
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# vim /etc/ceph/keyring
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>client.admin&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">AQCtp2xlw3soGRAAVvoyqWe8wzvkkt26JQEGtQ&lt;/span>&lt;span class="o">==&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# ceph -s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cluster:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> id: 9da44d3d-58d1-402d-8f8b-66bd89a869a4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> health: HEALTH_OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> services:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mon: &lt;span class="m">3&lt;/span> daemons, quorum a,b,c &lt;span class="o">(&lt;/span>age 9m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mgr: a&lt;span class="o">(&lt;/span>active, since 4m&lt;span class="o">)&lt;/span>, standbys: b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> osd: &lt;span class="m">5&lt;/span> osds: &lt;span class="m">5&lt;/span> up &lt;span class="o">(&lt;/span>since 6m&lt;span class="o">)&lt;/span>, &lt;span class="m">5&lt;/span> in &lt;span class="o">(&lt;/span>since 6m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pools: &lt;span class="m">1&lt;/span> pools, &lt;span class="m">1&lt;/span> pgs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> objects: &lt;span class="m">2&lt;/span> objects, &lt;span class="m">449&lt;/span> KiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> usage: &lt;span class="m">41&lt;/span> MiB used, &lt;span class="m">80&lt;/span> GiB / &lt;span class="m">80&lt;/span> GiB avail
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pgs: &lt;span class="m">1&lt;/span> active+clean
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="cephfs">cephfs&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master71u ceph-mds&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master72u ceph-mds&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master73u ceph-mds&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-node75u ceph-mds&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-node76u ceph-mds&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# vim filesystem.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> activeCount: &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> placement:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeAffinity:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requiredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeSelectorTerms:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: ceph-mds
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tolerations:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: Exists
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> podAntiAffinity:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requiredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - labelSelector:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: app
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - rook-ceph-mds
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> topologyKey: kubernetes.io/hostname
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> preferredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - weight: &lt;span class="m">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> podAffinityTerm:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> labelSelector:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: app
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - rook-ceph-mds
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> topologyKey: topology.kubernetes.io/zone
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f filesystem.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get pod -n rook-ceph -o wide &lt;span class="p">|&lt;/span> grep -i rook-ceph-mds
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mds-myfs-a-fcf6b94fb-wskkq 2/2 Running &lt;span class="m">0&lt;/span> 18s 10.201.126.14 k8s-master72u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mds-myfs-b-55d97767d4-z872h 2/2 Running &lt;span class="m">0&lt;/span> 16s 10.201.255.227 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mds-myfs-c-5c9c94fbfb-chfnv 2/2 Running &lt;span class="m">0&lt;/span> 13s 10.201.14.164 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mds-myfs-d-69cc457f9b-hq7vv 2/2 Running &lt;span class="m">0&lt;/span> 10s 10.201.133.13 k8s-master71u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# ceph -s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cluster:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> id: 9da44d3d-58d1-402d-8f8b-66bd89a869a4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> health: HEALTH_OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> services:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mon: &lt;span class="m">3&lt;/span> daemons, quorum a,b,c &lt;span class="o">(&lt;/span>age 13m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mgr: a&lt;span class="o">(&lt;/span>active, since 8m&lt;span class="o">)&lt;/span>, standbys: b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mds: 2/2 daemons up, &lt;span class="m">2&lt;/span> hot standby
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> osd: &lt;span class="m">5&lt;/span> osds: &lt;span class="m">5&lt;/span> up &lt;span class="o">(&lt;/span>since 9m&lt;span class="o">)&lt;/span>, &lt;span class="m">5&lt;/span> in &lt;span class="o">(&lt;/span>since 10m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volumes: 1/1 healthy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pools: &lt;span class="m">3&lt;/span> pools, &lt;span class="m">3&lt;/span> pgs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> objects: &lt;span class="m">41&lt;/span> objects, &lt;span class="m">452&lt;/span> KiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> usage: &lt;span class="m">43&lt;/span> MiB used, &lt;span class="m">80&lt;/span> GiB / &lt;span class="m">80&lt;/span> GiB avail
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pgs: &lt;span class="m">3&lt;/span> active+clean
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> io:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> client: 2.2 KiB/s rd, 2.4 KiB/s wr, &lt;span class="m">2&lt;/span> op/s rd, &lt;span class="m">8&lt;/span> op/s wr
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# &lt;span class="nb">cd&lt;/span> csi/cephfs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/csi/cephfs# kubectl create -f storageclass.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">storageclass.storage.k8s.io/rook-cephfs created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/csi/cephfs# kubectl get storageclasses.storage.k8s.io
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME PROVISIONER RECLAIMPOLICY VOLUMEBINDINGMODE ALLOWVOLUMEEXPANSION AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-cephfs rook-ceph.cephfs.csi.ceph.com Delete Immediate &lt;span class="nb">true&lt;/span> 5s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/csi/cephfs# ceph fs ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">name: myfs, metadata pool: myfs-metadata, data pools: &lt;span class="o">[&lt;/span>myfs-replicated &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>驗證pvc,pc使用storageClassName: &amp;ldquo;rook-cephfs&amp;quot;自動生成&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat sc.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: apps/v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: Deployment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: web-sc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> selector:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> matchLabels:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app: nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> replicas: &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> template:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> labels:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app: nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> containers:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> image: nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volumeMounts:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: wwwroot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mountPath: /usr/share/nginx/html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volumes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: wwwroot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> persistentVolumeClaim:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> claimName: web-sc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: PersistentVolumeClaim
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: web-sc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storageClassName: &lt;span class="s2">&amp;#34;rook-cephfs&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> accessModes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - ReadWriteMany
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> resources:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requests:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storage: 5Gi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl create -f sc.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod,pvc,pv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/test-nginx 1/1 Running &lt;span class="m">2&lt;/span> &lt;span class="o">(&lt;/span>33m ago&lt;span class="o">)&lt;/span> 81m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/web-sc-7b6c54fbb9-55rtb 1/1 Running &lt;span class="m">0&lt;/span> 34s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/web-sc-7b6c54fbb9-fxx6r 1/1 Running &lt;span class="m">0&lt;/span> 34s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/web-sc-7b6c54fbb9-vlpwm 1/1 Running &lt;span class="m">0&lt;/span> 34s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/web2-5d48fb75c5-dt5xd 1/1 Running &lt;span class="m">2&lt;/span> &lt;span class="o">(&lt;/span>33m ago&lt;span class="o">)&lt;/span> 80m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/web2-5d48fb75c5-ggmrz 1/1 Running &lt;span class="m">2&lt;/span> &lt;span class="o">(&lt;/span>33m ago&lt;span class="o">)&lt;/span> 80m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/web2-5d48fb75c5-jsvck 1/1 Running &lt;span class="m">2&lt;/span> &lt;span class="o">(&lt;/span>33m ago&lt;span class="o">)&lt;/span> 80m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">persistentvolumeclaim/web-sc Bound pvc-ec58bbde-7e2c-4cc4-be13-223d10de5d99 5Gi RWX rook-cephfs 34s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">persistentvolume/pvc-ec58bbde-7e2c-4cc4-be13-223d10de5d99 5Gi RWX Delete Bound default/web-sc rook-cephfs 34s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl &lt;span class="nb">exec&lt;/span> -ti web-sc-7b6c54fbb9-55rtb -- /bin/bash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-55rtb:/#
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-55rtb:/# df -h
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Filesystem Size Used Avail Use% Mounted on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">overlay 48G 20G 29G 41% /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 64M &lt;span class="m">0&lt;/span> 64M 0% /dev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/dev/mapper/ubuntu--vg-root 48G 20G 29G 41% /etc/hosts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">shm 64M &lt;span class="m">0&lt;/span> 64M 0% /dev/shm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.202.75.120:6789,10.202.62.213:6789,10.202.156.149:6789:/volumes/csi/csi-vol-39f4781c-a08b-4b30-a2f9-5d244cd4f7af/58cdd551-8197-41f0-875b-a050fb0135aa 5.0G &lt;span class="m">0&lt;/span> 5.0G 0% /usr/share/nginx/html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 7.7G 12K 7.7G 1% /run/secrets/kubernetes.io/serviceaccount
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 3.9G &lt;span class="m">0&lt;/span> 3.9G 0% /proc/acpi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 3.9G &lt;span class="m">0&lt;/span> 3.9G 0% /proc/scsi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 3.9G &lt;span class="m">0&lt;/span> 3.9G 0% /sys/firmware
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-55rtb:/#
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-55rtb:/# &lt;span class="nb">cd&lt;/span> /usr/share/nginx/html/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-55rtb:/usr/share/nginx/html# touch &lt;span class="m">123&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-55rtb:/usr/share/nginx/html# ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">123&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-55rtb:/usr/share/nginx/html# &lt;span class="nb">exit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">exit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl &lt;span class="nb">exec&lt;/span> -ti web-sc-7b6c54fbb9-fxx6r -- /bin/bash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-fxx6r:/#
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-fxx6r:/# df -h
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Filesystem Size Used Avail Use% Mounted on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">overlay 48G 20G 29G 41% /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 64M &lt;span class="m">0&lt;/span> 64M 0% /dev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/dev/mapper/ubuntu--vg-root 48G 20G 29G 41% /etc/hosts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">shm 64M &lt;span class="m">0&lt;/span> 64M 0% /dev/shm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.202.75.120:6789,10.202.62.213:6789,10.202.156.149:6789:/volumes/csi/csi-vol-39f4781c-a08b-4b30-a2f9-5d244cd4f7af/58cdd551-8197-41f0-875b-a050fb0135aa 5.0G &lt;span class="m">0&lt;/span> 5.0G 0% /usr/share/nginx/html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 7.7G 12K 7.7G 1% /run/secrets/kubernetes.io/serviceaccount
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 3.9G &lt;span class="m">0&lt;/span> 3.9G 0% /proc/acpi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 3.9G &lt;span class="m">0&lt;/span> 3.9G 0% /proc/scsi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 3.9G &lt;span class="m">0&lt;/span> 3.9G 0% /sys/firmware
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-fxx6r:/#
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-fxx6r:/# &lt;span class="nb">cd&lt;/span> /usr/share/nginx/html/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-fxx6r:/usr/share/nginx/html# ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">123&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-fxx6r:/usr/share/nginx/html# &lt;span class="nb">exit&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get services -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr ClusterIP 10.202.138.211 &amp;lt;none&amp;gt; 9283/TCP 19m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-dashboard ClusterIP 10.202.204.184 &amp;lt;none&amp;gt; 8443/TCP 19m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-a ClusterIP 10.202.156.149 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 24m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-b ClusterIP 10.202.75.120 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 20m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-c ClusterIP 10.202.62.213 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 20m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f dashboard-external-https.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get services -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr ClusterIP 10.202.138.211 &amp;lt;none&amp;gt; 9283/TCP 21m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-dashboard ClusterIP 10.202.204.184 &amp;lt;none&amp;gt; 8443/TCP 21m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-dashboard-external-https NodePort 10.202.5.199 &amp;lt;none&amp;gt; 8443:30125/TCP 10s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-a ClusterIP 10.202.156.149 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 26m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-b ClusterIP 10.202.75.120 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 21m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-c ClusterIP 10.202.62.213 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 21m
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>以下網址，都可以訪問nodeport
https://192.168.1.71:30125/#/login?returnUrl=%2Fdashboard
https://192.168.1.72:30125/#/login?returnUrl=%2Fdashboard
https://192.168.1.73:30125/#/login?returnUrl=%2Fdashboard
https://192.168.1.74:30125/#/login?returnUrl=%2Fdashboard
https://192.168.1.75:30125/#/login?returnUrl=%2Fdashboard
https://192.168.1.76:30125/#/login?returnUrl=%2Fdashboard&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204003829.png"
loading="lazy"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get secrets -n rook-ceph rook-ceph-dashboard-password -o yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">data:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> password: &lt;span class="nv">KF1hVHhQTSc0NjpnYjBYL2NENig&lt;/span>&lt;span class="o">=&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: Secret
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> creationTimestamp: &lt;span class="s2">&amp;#34;2023-12-03T16:12:13Z&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: rook-ceph-dashboard-password
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> namespace: rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ownerReferences:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - apiVersion: ceph.rook.io/v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> blockOwnerDeletion: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> controller: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> kind: CephCluster
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> uid: 93039daa-6f89-447a-81c7-89d387c1350b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> resourceVersion: &lt;span class="s2">&amp;#34;25904&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> uid: b2396e15-0674-4a9d-982b-25d03916a553
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">type: kubernetes.io/rook
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;KF1hVHhQTSc0NjpnYjBYL2NENig=&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> base64 -d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(]&lt;/span>aTxPM&lt;span class="err">&amp;#39;&lt;/span>46:gb0X/cD6&lt;span class="o">(&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204003900.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204003915.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204003943.png"
loading="lazy"
>&lt;/p>
&lt;p>一直報這個錯誤，導致集群檢查不健康&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# ceph mgr module ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">MODULE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">balancer on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">crash on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">devicehealth on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">orchestrator on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pg_autoscaler on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">progress on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rbd_support on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">status on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">telemetry on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">volumes on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dashboard on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iostat on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nfs on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">prometheus on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">restful on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">alerts -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cephadm -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">diskprediction_local -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">influx -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">insights -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8sevents -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">localpool -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mds_autoscaler -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mirroring -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">osd_perf_query -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">osd_support -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">selftest -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">snap_schedule -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">stats -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">telegraf -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">test_orchestrator -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">zabbix -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# ceph mgr module &lt;span class="nb">enable&lt;/span> rook
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# ceph mgr module ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">MODULE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">balancer on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">crash on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">devicehealth on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">orchestrator on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pg_autoscaler on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">progress on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rbd_support on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">status on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">telemetry on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">volumes on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dashboard on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iostat on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nfs on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">prometheus on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">restful on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">alerts -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cephadm -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">diskprediction_local -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">influx -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">insights -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8sevents -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">localpool -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mds_autoscaler -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mirroring -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">osd_perf_query -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">osd_support -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">selftest -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">snap_schedule -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">stats -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">telegraf -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">test_orchestrator -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">zabbix -
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl create -f bundle.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl get pod
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">prometheus-rook-prometheus-0 2/2 Running &lt;span class="m">0&lt;/span> 48s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl create -f prometheus.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl create -f prometheus-service.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl create -f service-monitor.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl create -f grafana-all.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl get pod,svc -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/grafana-654886fbff-czjvf 1/1 Running &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>76s ago&lt;span class="o">)&lt;/span> 2m2s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/prometheus-rook-prometheus-0 2/2 Running &lt;span class="m">0&lt;/span> 3m42s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service/grafana NodePort 10.202.70.24 &amp;lt;none&amp;gt; 3000:31782/TCP 2m2s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service/prometheus-operated ClusterIP None &amp;lt;none&amp;gt; 9090/TCP 3m42s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>以下網址，都可以訪問nodeport&lt;/p>
&lt;p>http://192.168.1.71:31782/login
http://192.168.1.72:31782/login
http://192.168.1.73:31782/login
http://192.168.1.74:31782/login
http://192.168.1.75:31782/login&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204011532.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204011610.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204011643.png"
loading="lazy"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl get svc -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">grafana NodePort 10.202.70.24 &amp;lt;none&amp;gt; 3000:31782/TCP 5m59s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">prometheus-operated ClusterIP None &amp;lt;none&amp;gt; 9090/TCP 7m39s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr ClusterIP 10.202.138.211 &amp;lt;none&amp;gt; 9283/TCP 65m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-dashboard ClusterIP 10.202.204.184 &amp;lt;none&amp;gt; 8443/TCP 65m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-dashboard-external-https NodePort 10.202.5.199 &amp;lt;none&amp;gt; 8443:30125/TCP 44m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-a ClusterIP 10.202.156.149 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 70m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-b ClusterIP 10.202.75.120 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 66m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-c ClusterIP 10.202.62.213 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 65m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-prometheus NodePort 10.202.7.217 &amp;lt;none&amp;gt; 9090:30900/TCP 7m34s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204011803.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204011815.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;a class="link" href="https://grafana.com/grafana/dashboards/2842-ceph-cluster/" target="_blank" rel="noopener"
>https://grafana.com/grafana/dashboards/2842-ceph-cluster/&lt;/a>
&lt;a class="link" href="https://grafana.com/grafana/dashboards/5336-ceph-osd-single/" target="_blank" rel="noopener"
>https://grafana.com/grafana/dashboards/5336-ceph-osd-single/&lt;/a>
&lt;a class="link" href="https://grafana.com/grafana/dashboards/5342-ceph-pools/" target="_blank" rel="noopener"
>https://grafana.com/grafana/dashboards/5342-ceph-pools/&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204011903.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204011931.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204011947.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204012015.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204012038.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204012115.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231204012129.png"
loading="lazy"
>&lt;/p>
&lt;h2 id="reset清除集群設定">reset清除集群設定&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 全部清除，包含所有創建目錄，systemd服務，/etc/hosts&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>kubespray-venv&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>root@ansible kubespray&lt;span class="o">]&lt;/span>&lt;span class="c1"># ansible-playbook -i inventory/mycluster/hosts.yaml --become --become-user=root reset.yml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 流程進行，會再次確認您是否要reset，要輸入yes，ansible才會開始繼續進行&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PLAY &lt;span class="o">[&lt;/span>Reset cluster&lt;span class="o">]&lt;/span> *******************************************************************************************************************
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">週日 &lt;span class="m">03&lt;/span> 十二月 &lt;span class="m">2023&lt;/span> 14:43:01 +0800 &lt;span class="o">(&lt;/span>0:00:02.729&lt;span class="o">)&lt;/span> 0:00:44.278 ****************
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Reset Confirmation&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Are you sure you want to reset cluster state? Type &lt;span class="s1">&amp;#39;yes&amp;#39;&lt;/span> to reset your cluster.:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 清除完畢之後，主機要systemctl daemon-reload，不然會被判斷還有etcd服務，導致無法佈屬&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 以上執行完畢，重開機，即可重新再佈屬&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master72u:~# systemctl status etcd.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Warning: The unit file, &lt;span class="nb">source&lt;/span> configuration file or drop-ins of etcd.service changed on disk. Run &lt;span class="s1">&amp;#39;systemctl daemon-reload&amp;#39;&lt;/span> to reload units.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">○ etcd.service - etcd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Loaded: loaded &lt;span class="o">(&lt;/span>/etc/systemd/system/etcd.service&lt;span class="p">;&lt;/span> enabled&lt;span class="p">;&lt;/span> vendor preset: enabled&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Active: inactive &lt;span class="o">(&lt;/span>dead&lt;span class="o">)&lt;/span> since Mon 2023-12-04 17:46:25 UTC&lt;span class="p">;&lt;/span> 1min 34s ago
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Process: &lt;span class="m">906&lt;/span> &lt;span class="nv">ExecStart&lt;/span>&lt;span class="o">=&lt;/span>/usr/local/bin/etcd &lt;span class="o">(&lt;/span>&lt;span class="nv">code&lt;/span>&lt;span class="o">=&lt;/span>killed, &lt;span class="nv">signal&lt;/span>&lt;span class="o">=&lt;/span>TERM&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Main PID: &lt;span class="m">906&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="nv">code&lt;/span>&lt;span class="o">=&lt;/span>killed, &lt;span class="nv">signal&lt;/span>&lt;span class="o">=&lt;/span>TERM&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CPU: 6min 4.994s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">04&lt;/span> 17:46:24 k8s-master72u etcd&lt;span class="o">[&lt;/span>906&lt;span class="o">]&lt;/span>: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;level&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;info&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;ts&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;2023-12-04T17:46:24.978391Z&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;caller&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;rafthttp/pipeline.go:85&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;msg&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;stopped HTTP pipelining with remot&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 04 17:46:24 k8s-master72u etcd[906]: {&amp;#34;&lt;/span>level&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>info&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>ts&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>2023-12-04T17:46:24.978409Z&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>caller&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>rafthttp/stream.go:442&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>msg&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>stopped stream reader with remote p&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">04&lt;/span> 17:46:24 k8s-master72u etcd&lt;span class="o">[&lt;/span>906&lt;span class="o">]&lt;/span>: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;level&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;info&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;ts&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;2023-12-04T17:46:24.97843Z&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;caller&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;rafthttp/stream.go:442&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;msg&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;stopped stream reader with remote pe&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 04 17:46:24 k8s-master72u etcd[906]: {&amp;#34;&lt;/span>level&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>info&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>ts&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>2023-12-04T17:46:24.97845Z&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>caller&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>rafthttp/peer.go:335&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>msg&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>stopped remote peer&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>remote-peer-id&lt;span class="s2">&amp;#34;:&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 04 17:46:24 k8s-master72u etcd[906]: {&amp;#34;&lt;/span>level&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>info&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>ts&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>2023-12-04T17:46:24.98816Z&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>caller&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>embed/etcd.go:579&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>msg&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>stopping serving peer traffic&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>address&lt;span class="s2">&amp;#34;:&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 04 17:46:24 k8s-master72u etcd[906]: {&amp;#34;&lt;/span>level&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>info&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>ts&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>2023-12-04T17:46:24.988259Z&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>caller&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>embed/etcd.go:584&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>msg&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>stopped serving peer traffic&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>address&lt;span class="s2">&amp;#34;:&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Dec 04 17:46:24 k8s-master72u etcd[906]: {&amp;#34;&lt;/span>level&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>info&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>ts&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>2023-12-04T17:46:24.988274Z&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>caller&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>embed/etcd.go:378&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>msg&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>closed etcd server&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>name&lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span>etcd2&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>data&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">04&lt;/span> 17:46:25 k8s-master72u systemd&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span>: etcd.service: Deactivated successfully.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">04&lt;/span> 17:46:25 k8s-master72u systemd&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span>: Stopped etcd.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dec &lt;span class="m">04&lt;/span> 17:46:25 k8s-master72u systemd&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span>: etcd.service: Consumed 6min 4.994s CPU time.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="如果沒外部vipworker-node透過nginx-proxy反代理訪問master-node的kube-apiserver">如果沒外部VIP，worker node透過nginx proxy反代理，訪問master node的kube-apiserver&lt;/h2>
&lt;p>worker node透過nginx proxy反代理，訪問master node的kube-apiserver，每一個worker node都會有一個nginx pod
&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231203004609.png"
loading="lazy"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod -A -o wide
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAMESPACE NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system nginx-proxy-node4 1/1 Running &lt;span class="m">0&lt;/span> 5m14s 192.168.1.75 node4 &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-system nginx-proxy-node5 1/1 Running &lt;span class="m">0&lt;/span> 5m2s 192.168.1.76 node5 &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>使用Rook在Kubernetes安裝與管理Ceph分布式存儲系統</title><link>https://blog.goldfishbrain-fighting.com/2023/kubernetes-rook-ceph/</link><pubDate>Mon, 27 Nov 2023 21:13:16 +0800</pubDate><guid>https://blog.goldfishbrain-fighting.com/2023/kubernetes-rook-ceph/</guid><description>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-rook-ceph/media/Pasted-image-20231205214201.png" alt="Featured image of post 使用Rook在Kubernetes安裝與管理Ceph分布式存儲系統" />&lt;p>&lt;a class="link" href="https://rook.io/docs/rook/latest-release/Getting-Started/intro/" target="_blank" rel="noopener"
>https://rook.io/docs/rook/latest-release/Getting-Started/intro/&lt;/a>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>節點名稱&lt;/th>
&lt;th>IP&lt;/th>
&lt;th>K8S角色&lt;/th>
&lt;th>組件&lt;/th>
&lt;th>磁碟 16G&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>k8s-master71u&lt;/td>
&lt;td>192.168.1.71&lt;/td>
&lt;td>master&lt;/td>
&lt;td>mon mgr osd mds mds&lt;/td>
&lt;td>/dev/sdb&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>k8s-master72u&lt;/td>
&lt;td>192.168.1.72&lt;/td>
&lt;td>master&lt;/td>
&lt;td>mon mgr osd mds&lt;/td>
&lt;td>/dev/sdb&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>k8s-master73u&lt;/td>
&lt;td>192.168.1.73&lt;/td>
&lt;td>master&lt;/td>
&lt;td>mon osd mds&lt;/td>
&lt;td>/dev/sdb&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>k8s-node75u&lt;/td>
&lt;td>192.168.1.75&lt;/td>
&lt;td>worker&lt;/td>
&lt;td>osd mds&lt;/td>
&lt;td>/dev/sdb&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>k8s-node76u&lt;/td>
&lt;td>192.168.1.76&lt;/td>
&lt;td>worker&lt;/td>
&lt;td>osd&lt;/td>
&lt;td>/dev/sdb&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="確認磁碟無格式化過">確認磁碟無格式化過&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# lsblk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINTS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop0 7:0 &lt;span class="m">0&lt;/span> 63.4M &lt;span class="m">1&lt;/span> loop /snap/core20/1974
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop1 7:1 &lt;span class="m">0&lt;/span> 63.5M &lt;span class="m">1&lt;/span> loop /snap/core20/2015
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop2 7:2 &lt;span class="m">0&lt;/span> 111.9M &lt;span class="m">1&lt;/span> loop /snap/lxd/24322
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop3 7:3 &lt;span class="m">0&lt;/span> 40.8M &lt;span class="m">1&lt;/span> loop /snap/snapd/20092
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop4 7:4 &lt;span class="m">0&lt;/span> 40.9M &lt;span class="m">1&lt;/span> loop /snap/snapd/20290
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sda 8:0 &lt;span class="m">0&lt;/span> 50G &lt;span class="m">0&lt;/span> disk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├─sda1 8:1 &lt;span class="m">0&lt;/span> 1M &lt;span class="m">0&lt;/span> part
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├─sda2 8:2 &lt;span class="m">0&lt;/span> 2G &lt;span class="m">0&lt;/span> part /boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└─sda3 8:3 &lt;span class="m">0&lt;/span> 48G &lt;span class="m">0&lt;/span> part
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └─ubuntu--vg-root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 253:0 &lt;span class="m">0&lt;/span> 48G &lt;span class="m">0&lt;/span> lvm /var/lib/kubelet/pods/ce7174f8-ad8f-4f42-8e58-2abca8c91424/volume-subpaths/tigera-ca-bundle/calico-node/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sdb 8:16 &lt;span class="m">0&lt;/span> 16G &lt;span class="m">0&lt;/span> disk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sr0 11:0 &lt;span class="m">1&lt;/span> 1024M &lt;span class="m">0&lt;/span> rom
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# lsblk -f
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME FSTYPE FSVER LABEL UUID FSAVAIL FSUSE% MOUNTPOINTS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> squash 4.0 &lt;span class="m">0&lt;/span> 100% /snap/core20/1974
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> squash 4.0 &lt;span class="m">0&lt;/span> 100% /snap/core20/2015
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> squash 4.0 &lt;span class="m">0&lt;/span> 100% /snap/lxd/24322
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> squash 4.0 &lt;span class="m">0&lt;/span> 100% /snap/snapd/20092
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> squash 4.0 &lt;span class="m">0&lt;/span> 100% /snap/snapd/20290
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sda
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├─sda1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├─sda2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ xfs f681192a-1cf2-4362-a74c-745374011700 1.8G 9% /boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└─sda3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> LVM2_m LVM2 JEduSv-mV9g-tzdJ-sYEc-6piR-6nAo-48Srdh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └─ubuntu--vg-root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> xfs 19cd87ec-9741-4295-9762-e87fb4f472c8 37.9G 21% /var/lib/kubelet/pods/ce7174f8-ad8f-4f42-8e58-2abca8c91424/volume-subpaths/tigera-ca-bundle/calico-node/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sdb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# lsblk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINTS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop0 7:0 &lt;span class="m">0&lt;/span> 63.4M &lt;span class="m">1&lt;/span> loop /snap/core20/1974
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop1 7:1 &lt;span class="m">0&lt;/span> 63.5M &lt;span class="m">1&lt;/span> loop /snap/core20/2015
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop2 7:2 &lt;span class="m">0&lt;/span> 111.9M &lt;span class="m">1&lt;/span> loop /snap/lxd/24322
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop3 7:3 &lt;span class="m">0&lt;/span> 40.8M &lt;span class="m">1&lt;/span> loop /snap/snapd/20092
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">loop4 7:4 &lt;span class="m">0&lt;/span> 40.9M &lt;span class="m">1&lt;/span> loop /snap/snapd/20290
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sda 8:0 &lt;span class="m">0&lt;/span> 50G &lt;span class="m">0&lt;/span> disk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├─sda1 8:1 &lt;span class="m">0&lt;/span> 1M &lt;span class="m">0&lt;/span> part
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├─sda2 8:2 &lt;span class="m">0&lt;/span> 2G &lt;span class="m">0&lt;/span> part /boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└─sda3 8:3 &lt;span class="m">0&lt;/span> 48G &lt;span class="m">0&lt;/span> part
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └─ubuntu--vg-root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 253:0 &lt;span class="m">0&lt;/span> 48G &lt;span class="m">0&lt;/span> lvm /var/lib/kubelet/pods/ce7174f8-ad8f-4f42-8e58-2abca8c91424/volume-subpaths/tigera-ca-bundle/calico-node/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sdb 8:16 &lt;span class="m">0&lt;/span> 16G &lt;span class="m">0&lt;/span> disk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sr0 11:0 &lt;span class="m">1&lt;/span> 1024M &lt;span class="m">0&lt;/span> rom
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="ceph-cluster佈屬">ceph cluster佈屬&lt;/h2>
&lt;h3 id="依序執行三個yaml">依序執行三個yaml&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">rook/deploy/examples/crds.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook/deploy/examples/common.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook/deploy/examples/operator.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# git clone --single-branch --branch v1.12.8 https://github.com/rook/rook.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# &lt;span class="nb">cd&lt;/span> rook/deploy/examples
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f crds.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f common.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f operator.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 確認 rook-ceph-operator pod啟動完成&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get deployments.apps -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY UP-TO-DATE AVAILABLE AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-operator 1/1 &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> 22s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get pod -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-operator-58775c8bdf-vmdkn 1/1 Running &lt;span class="m">0&lt;/span> 39s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="執行clusteryaml">執行cluster.yaml&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">cluster.yaml 分別調整
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 調度(使用節點親和性調度)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 角色資源
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 磁碟調度
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 關閉磁碟自動全部調度
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# vim cluster.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 角色調度(使用節點親和性調度)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> placement:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mon:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeAffinity:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requiredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeSelectorTerms:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: ceph-mon
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tolerations:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: Exists
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mgr:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeAffinity:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requiredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeSelectorTerms:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: ceph-mgr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tolerations:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: Exists
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> osd:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeAffinity:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requiredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeSelectorTerms:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: ceph-osd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tolerations:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: Exists
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> prepareosd:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeAffinity:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requiredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeSelectorTerms:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: ceph-osd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tolerations:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: Exists
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 角色資源&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> resources:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mon:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> limits:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: &lt;span class="s2">&amp;#34;1000m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: &lt;span class="s2">&amp;#34;2048Mi&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requests:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: &lt;span class="s2">&amp;#34;1000m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: &lt;span class="s2">&amp;#34;2048Mi&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mgr:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> limits:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: &lt;span class="s2">&amp;#34;1000m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: &lt;span class="s2">&amp;#34;1024Mi&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requests:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: &lt;span class="s2">&amp;#34;1000m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: &lt;span class="s2">&amp;#34;1024Mi&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> osd:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> limits:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: &lt;span class="s2">&amp;#34;1000m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: &lt;span class="s2">&amp;#34;2048Mi&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requests:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: &lt;span class="s2">&amp;#34;1000m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: &lt;span class="s2">&amp;#34;2048Mi&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 磁碟調度&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;k8s-master71u&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> devices:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;sdb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> config:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storeType: bluestore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> journalSizeMB: &lt;span class="s2">&amp;#34;4096&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;k8s-master72u&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> devices:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;sdb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> config:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storeType: bluestore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> journalSizeMB: &lt;span class="s2">&amp;#34;4096&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;k8s-master73u&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> devices:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;sdb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> config:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storeType: bluestore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> journalSizeMB: &lt;span class="s2">&amp;#34;4096&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;k8s-node75u&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> devices:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;sdb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> config:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storeType: bluestore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> journalSizeMB: &lt;span class="s2">&amp;#34;4096&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;k8s-node76u&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> devices:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &lt;span class="s2">&amp;#34;sdb&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> config:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storeType: bluestore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> journalSizeMB: &lt;span class="s2">&amp;#34;4096&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 關閉磁碟自動全部調度&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storage: &lt;span class="c1"># cluster level storage configuration and selection&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#設置磁碟的參數，調整為false，方便後面訂製&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> useAllNodes: &lt;span class="nb">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> useAllDevices: &lt;span class="nb">false&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="主機打標籤">主機打標籤&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master71u ceph-mon&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master72u ceph-mon&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master73u ceph-mon&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master71u ceph-mgr&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master72u ceph-mgr&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master73u ceph-mgr&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master71u ceph-osd&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master72u ceph-osd&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master73u ceph-osd&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-node75u ceph-osd&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-node76u ceph-osd&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f cluster.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cephcluster.ceph.rook.io/rook-ceph created
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="確認佈屬結果pending狀況發生">確認佈屬結果(Pending狀況發生)&lt;/h3>
&lt;p>&lt;font color=red>全部節點重開機就可以&lt;/font>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get pod -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-cephfsplugin-dfz59 2/2 Running &lt;span class="m">0&lt;/span> 17s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-cephfsplugin-provisioner-668dfcf95b-dgs5l 5/5 Running &lt;span class="m">0&lt;/span> 17s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-cephfsplugin-provisioner-668dfcf95b-wlz6r 5/5 Running &lt;span class="m">0&lt;/span> 17s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-cephfsplugin-xqdvc 2/2 Running &lt;span class="m">0&lt;/span> 17s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-rbdplugin-l294v 2/2 Running &lt;span class="m">0&lt;/span> 17s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-rbdplugin-lts27 2/2 Running &lt;span class="m">0&lt;/span> 17s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-rbdplugin-provisioner-5b78f67bbb-7gz4x 5/5 Running &lt;span class="m">0&lt;/span> 17s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-rbdplugin-provisioner-5b78f67bbb-8w47k 5/5 Running &lt;span class="m">0&lt;/span> 17s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-csi-detect-version-tg598 0/1 Completed &lt;span class="m">0&lt;/span> 20s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-detect-version-z52cj 0/1 Completed &lt;span class="m">0&lt;/span> 20s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-a-6b8f546466-h5rp2 0/2 Pending &lt;span class="m">0&lt;/span> 9s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-a-canary-5554b85b75-wf78h 2/2 Running &lt;span class="m">0&lt;/span> 12s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-b-canary-7569748cf6-cr59z 2/2 Running &lt;span class="m">0&lt;/span> 12s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-c-canary-85d88b48d5-649pv 2/2 Running &lt;span class="m">0&lt;/span> 12s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-operator-6bfb456b57-297f8 1/1 Running &lt;span class="m">0&lt;/span> 31s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>無法調度&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl describe pod rook-ceph-mon-a-6b8f546466-h5rp2 -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Node-Selectors: kubernetes.io/hostname&lt;span class="o">=&lt;/span>k8s-master71u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Tolerations: :NoSchedule &lt;span class="nv">op&lt;/span>&lt;span class="o">=&lt;/span>Exists
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> node.kubernetes.io/not-ready:NoExecute &lt;span class="nv">op&lt;/span>&lt;span class="o">=&lt;/span>Exists &lt;span class="k">for&lt;/span> 300s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> node.kubernetes.io/unreachable:NoExecute &lt;span class="nv">op&lt;/span>&lt;span class="o">=&lt;/span>Exists &lt;span class="k">for&lt;/span> 300s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Events:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Type Reason Age From Message
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ---- ------ ---- ---- -------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Warning FailedScheduling 81s default-scheduler 0/5 nodes are available: &lt;span class="m">1&lt;/span> node&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span> didn&lt;span class="s1">&amp;#39;t satisfy existing pods anti-affinity rules, 4 node(s) didn&amp;#39;&lt;/span>t match Pod&lt;span class="err">&amp;#39;&lt;/span>s node affinity/selector. preemption: 0/5 nodes are available: &lt;span class="m">1&lt;/span> No preemption victims found &lt;span class="k">for&lt;/span> incoming pod, &lt;span class="m">4&lt;/span> Preemption is not helpful &lt;span class="k">for&lt;/span> scheduling..
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-cephfsplugin-bk8gt 2/2 Running &lt;span class="m">4&lt;/span> &lt;span class="o">(&lt;/span>5m36s ago&lt;span class="o">)&lt;/span> 18m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-cephfsplugin-provisioner-668dfcf95b-858rd 5/5 Running &lt;span class="m">10&lt;/span> &lt;span class="o">(&lt;/span>5m37s ago&lt;span class="o">)&lt;/span> 18m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-cephfsplugin-provisioner-668dfcf95b-n4wdx 5/5 Running &lt;span class="m">10&lt;/span> &lt;span class="o">(&lt;/span>5m36s ago&lt;span class="o">)&lt;/span> 18m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-cephfsplugin-rp5nh 2/2 Running &lt;span class="m">4&lt;/span> &lt;span class="o">(&lt;/span>5m37s ago&lt;span class="o">)&lt;/span> 18m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-rbdplugin-provisioner-5b78f67bbb-4vrtb 5/5 Running &lt;span class="m">10&lt;/span> &lt;span class="o">(&lt;/span>5m36s ago&lt;span class="o">)&lt;/span> 18m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-rbdplugin-provisioner-5b78f67bbb-m5789 5/5 Running &lt;span class="m">10&lt;/span> &lt;span class="o">(&lt;/span>5m36s ago&lt;span class="o">)&lt;/span> 18m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-rbdplugin-qfrtk 2/2 Running &lt;span class="m">4&lt;/span> &lt;span class="o">(&lt;/span>5m36s ago&lt;span class="o">)&lt;/span> 18m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-rbdplugin-z68hx 2/2 Running &lt;span class="m">4&lt;/span> &lt;span class="o">(&lt;/span>5m36s ago&lt;span class="o">)&lt;/span> 18m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-crashcollector-k8s-master71u-55fcdbd66c-k6pkj 1/1 Running &lt;span class="m">0&lt;/span> 2m13s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-crashcollector-k8s-master72u-675646bf64-hnpw9 1/1 Running &lt;span class="m">0&lt;/span> 2m12s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-crashcollector-k8s-master73u-84fdc469f7-6khkr 1/1 Running &lt;span class="m">0&lt;/span> 2m42s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-crashcollector-k8s-node75u-bbc794dd9-5zbhs 1/1 Running &lt;span class="m">0&lt;/span> 15s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-crashcollector-k8s-node76u-5fd59cd68b-b9pxq 1/1 Running &lt;span class="m">0&lt;/span> 24s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-csi-detect-version-pqgj7 0/1 Completed &lt;span class="m">0&lt;/span> 3m52s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-detect-version-rtgsq 0/1 Completed &lt;span class="m">0&lt;/span> 13s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-a-767b9fc956-xm4ns 3/3 Running &lt;span class="m">0&lt;/span> 2m49s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-b-8956fb9c-rvjff 3/3 Running &lt;span class="m">0&lt;/span> 2m48s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-a-769fd77b5b-trw4f 2/2 Running &lt;span class="m">0&lt;/span> 9m7s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-b-65cf769696-7dncd 2/2 Running &lt;span class="m">0&lt;/span> 3m14s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-c-58664986b-vqrzw 2/2 Running &lt;span class="m">0&lt;/span> 3m2s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-operator-58775c8bdf-mfp6n 1/1 Running &lt;span class="m">2&lt;/span> &lt;span class="o">(&lt;/span>5m36s ago&lt;span class="o">)&lt;/span> 23m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-0-55f6d9b-xrjb6 2/2 Running &lt;span class="m">0&lt;/span> 2m13s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-1-7db86764b-2fn48 2/2 Running &lt;span class="m">0&lt;/span> 2m12s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-2-84cd64ffcb-nxrkx 2/2 Running &lt;span class="m">0&lt;/span> 2m10s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-3-748c78f4dd-whsxk 2/2 Running &lt;span class="m">0&lt;/span> 24s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-4-65c79df6dd-2w7z9 1/2 Running &lt;span class="m">0&lt;/span> 15s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-prepare-k8s-master71u-shwfs 0/1 Completed &lt;span class="m">0&lt;/span> 2m26s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-prepare-k8s-master72u-z4vbt 0/1 Completed &lt;span class="m">0&lt;/span> 2m26s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-prepare-k8s-master73u-rgxtn 0/1 Completed &lt;span class="m">0&lt;/span> 2m25s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-prepare-k8s-node75u-sdm5n 0/1 Completed &lt;span class="m">0&lt;/span> 2m24s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-osd-prepare-k8s-node76u-l8dlp 0/1 Completed &lt;span class="m">0&lt;/span> 2m23s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="執行toolboxyaml">執行toolbox.yaml&lt;/h3>
&lt;p>創建工具POD&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f toolbox.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment.apps/rook-ceph-tools created
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>可以看到ceph集群狀況&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl &lt;span class="nb">exec&lt;/span> -it rook-ceph-tools-7cd4cd9c9c-kd8pf -n rook-ceph -- /bin/bash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ ceph -s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cluster:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> id: b5e028e3-725d-4a26-8a14-17fe4dead850
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> health: HEALTH_OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> services:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mon: &lt;span class="m">3&lt;/span> daemons, quorum a,b,c &lt;span class="o">(&lt;/span>age 5m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mgr: a&lt;span class="o">(&lt;/span>active, since 86s&lt;span class="o">)&lt;/span>, standbys: b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> osd: &lt;span class="m">5&lt;/span> osds: &lt;span class="m">5&lt;/span> up &lt;span class="o">(&lt;/span>since 2m&lt;span class="o">)&lt;/span>, &lt;span class="m">5&lt;/span> in &lt;span class="o">(&lt;/span>since 3m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pools: &lt;span class="m">1&lt;/span> pools, &lt;span class="m">1&lt;/span> pgs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> objects: &lt;span class="m">2&lt;/span> objects, &lt;span class="m">449&lt;/span> KiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> usage: &lt;span class="m">41&lt;/span> MiB used, &lt;span class="m">80&lt;/span> GiB / &lt;span class="m">80&lt;/span> GiB avail
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pgs: &lt;span class="m">1&lt;/span> active+clean
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ ceph status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cluster:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> id: b5e028e3-725d-4a26-8a14-17fe4dead850
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> health: HEALTH_OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> services:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mon: &lt;span class="m">3&lt;/span> daemons, quorum a,b,c &lt;span class="o">(&lt;/span>age 6m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mgr: a&lt;span class="o">(&lt;/span>active, since 116s&lt;span class="o">)&lt;/span>, standbys: b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> osd: &lt;span class="m">5&lt;/span> osds: &lt;span class="m">5&lt;/span> up &lt;span class="o">(&lt;/span>since 3m&lt;span class="o">)&lt;/span>, &lt;span class="m">5&lt;/span> in &lt;span class="o">(&lt;/span>since 3m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pools: &lt;span class="m">1&lt;/span> pools, &lt;span class="m">1&lt;/span> pgs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> objects: &lt;span class="m">2&lt;/span> objects, &lt;span class="m">449&lt;/span> KiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> usage: &lt;span class="m">41&lt;/span> MiB used, &lt;span class="m">80&lt;/span> GiB / &lt;span class="m">80&lt;/span> GiB avail
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pgs: &lt;span class="m">1&lt;/span> active+clean
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ ceph osd status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ID HOST USED AVAIL WR OPS WR DATA RD OPS RD DATA STATE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">0&lt;/span> k8s-master71u 8368k 15.9G &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> exists,up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">1&lt;/span> k8s-master72u 8820k 15.9G &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> exists,up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">2&lt;/span> k8s-master73u 8820k 15.9G &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> exists,up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">3&lt;/span> k8s-node76u 8432k 15.9G &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> exists,up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4&lt;/span> k8s-node75u 7920k 15.9G &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> exists,up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ ceph df
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--- RAW STORAGE ---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CLASS SIZE AVAIL USED RAW USED %RAW USED
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ssd &lt;span class="m">80&lt;/span> GiB &lt;span class="m">80&lt;/span> GiB &lt;span class="m">41&lt;/span> MiB &lt;span class="m">41&lt;/span> MiB 0.05
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TOTAL &lt;span class="m">80&lt;/span> GiB &lt;span class="m">80&lt;/span> GiB &lt;span class="m">41&lt;/span> MiB &lt;span class="m">41&lt;/span> MiB 0.05
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--- POOLS ---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">POOL ID PGS STORED OBJECTS USED %USED MAX AVAIL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.mgr &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">449&lt;/span> KiB &lt;span class="m">2&lt;/span> &lt;span class="m">449&lt;/span> KiB &lt;span class="m">0&lt;/span> &lt;span class="m">25&lt;/span> GiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ rados df
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">POOL_NAME USED OBJECTS CLONES COPIES MISSING_ON_PRIMARY UNFOUND DEGRADED RD_OPS RD WR_OPS WR USED COMPR UNDER COMPR
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.mgr &lt;span class="m">449&lt;/span> KiB &lt;span class="m">2&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">6&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">288&lt;/span> &lt;span class="m">494&lt;/span> KiB &lt;span class="m">153&lt;/span> 1.3 MiB &lt;span class="m">0&lt;/span> B &lt;span class="m">0&lt;/span> B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total_objects &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total_used &lt;span class="m">41&lt;/span> MiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total_avail &lt;span class="m">80&lt;/span> GiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total_space &lt;span class="m">80&lt;/span> GiB
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="主機直接查看cephceph-common安裝">主機直接查看ceph(ceph-common安裝)&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安裝ceph client工具&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# apt update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# apt install ceph-common
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 將連線設定，複製出來&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl &lt;span class="nb">exec&lt;/span> -it rook-ceph-tools-7cd4cd9c9c-kd8pf -n rook-ceph -- /bin/bash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ cat /etc/ceph/ceph.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>global&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">mon_host&lt;/span> &lt;span class="o">=&lt;/span> 10.245.146.85:6789,10.245.203.29:6789,10.245.216.126:6789
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>client.admin&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">keyring&lt;/span> &lt;span class="o">=&lt;/span> /etc/ceph/keyring
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash-4.4$ cat /etc/ceph/keyring
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>client.admin&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">AQA8LmZlDA21GhAAvgMoEOkXur9olDYtGkF8kQ&lt;/span>&lt;span class="o">==&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 主機創建連線設定&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# vim /etc/ceph/ceph.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>global&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">mon_host&lt;/span> &lt;span class="o">=&lt;/span> 10.245.146.85:6789,10.245.203.29:6789,10.245.216.126:6789
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>client.admin&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">keyring&lt;/span> &lt;span class="o">=&lt;/span> /etc/ceph/keyring
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# vim /etc/ceph/keyring
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>client.admin&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">AQA8LmZlDA21GhAAvgMoEOkXur9olDYtGkF8kQ&lt;/span>&lt;span class="o">==&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 主機直接連接ceph管理&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# ceph -s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cluster:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> id: b5e028e3-725d-4a26-8a14-17fe4dead850
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> health: HEALTH_OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> services:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mon: &lt;span class="m">3&lt;/span> daemons, quorum a,b,c &lt;span class="o">(&lt;/span>age 2m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mgr: a&lt;span class="o">(&lt;/span>active, since 2m&lt;span class="o">)&lt;/span>, standbys: b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> osd: &lt;span class="m">5&lt;/span> osds: &lt;span class="m">5&lt;/span> up &lt;span class="o">(&lt;/span>since 2m&lt;span class="o">)&lt;/span>, &lt;span class="m">5&lt;/span> in &lt;span class="o">(&lt;/span>since 10m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pools: &lt;span class="m">1&lt;/span> pools, &lt;span class="m">1&lt;/span> pgs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> objects: &lt;span class="m">2&lt;/span> objects, &lt;span class="m">449&lt;/span> KiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> usage: &lt;span class="m">39&lt;/span> MiB used, &lt;span class="m">80&lt;/span> GiB / &lt;span class="m">80&lt;/span> GiB avail
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pgs: &lt;span class="m">1&lt;/span> active+clean
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="cephfs佈屬">cephfs佈屬&lt;/h2>
&lt;h3 id="主機打標籤-1">主機打標籤&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master71u ceph-mds&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master72u ceph-mds&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-master73u ceph-mds&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-node75u ceph-mds&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl label node k8s-node76u ceph-mds&lt;span class="o">=&lt;/span>enabled
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="執行filesystemyaml">執行filesystem.yaml&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">filesystem.yaml 分別調整
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># activeCount: 2 (2 active、2 stanby)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 調度(使用節點親和性調度) -&amp;gt; nodeAffinity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># POD反親和性 -&amp;gt; podAntiAffinity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 防止同一台主機上，有兩個mds
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# vim filesystem.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> activeCount: &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> placement:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeAffinity:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requiredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeSelectorTerms:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: ceph-mds
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tolerations:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: Exists
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> podAntiAffinity:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requiredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - labelSelector:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: app
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - rook-ceph-mds
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> topologyKey: kubernetes.io/hostname
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> preferredDuringSchedulingIgnoredDuringExecution:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - weight: &lt;span class="m">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> podAffinityTerm:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> labelSelector:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> matchExpressions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - key: app
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> operator: In
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> values:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - rook-ceph-mds
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> topologyKey: topology.kubernetes.io/zone
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f filesystem.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="確認佈屬結果">確認佈屬結果&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get pod -n rook-ceph -o wide &lt;span class="p">|&lt;/span> grep -i rook-ceph-mds
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mds-myfs-a-656c99cf6b-mp7bq 2/2 Running &lt;span class="m">0&lt;/span> 2m37s 10.244.96.33 k8s-master73u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mds-myfs-b-65bf4fdbcd-j9gzt 2/2 Running &lt;span class="m">0&lt;/span> 2m36s 10.244.14.186 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mds-myfs-c-b7bd7658-tt845 2/2 Running &lt;span class="m">0&lt;/span> 2m34s 10.244.255.213 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mds-myfs-d-dff64fb98-zb4rv 2/2 Running &lt;span class="m">0&lt;/span> 2m31s 10.244.133.17 k8s-master71u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# ceph -s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cluster:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> id: b5e028e3-725d-4a26-8a14-17fe4dead850
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> health: HEALTH_OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> services:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mon: &lt;span class="m">3&lt;/span> daemons, quorum a,b,c &lt;span class="o">(&lt;/span>age 11m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mgr: a&lt;span class="o">(&lt;/span>active, since 12m&lt;span class="o">)&lt;/span>, standbys: b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mds: 2/2 daemons up, &lt;span class="m">2&lt;/span> hot standby
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> osd: &lt;span class="m">5&lt;/span> osds: &lt;span class="m">5&lt;/span> up &lt;span class="o">(&lt;/span>since 12m&lt;span class="o">)&lt;/span>, &lt;span class="m">5&lt;/span> in &lt;span class="o">(&lt;/span>since 19m&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volumes: 1/1 healthy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pools: &lt;span class="m">3&lt;/span> pools, &lt;span class="m">49&lt;/span> pgs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> objects: &lt;span class="m">45&lt;/span> objects, &lt;span class="m">452&lt;/span> KiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> usage: &lt;span class="m">46&lt;/span> MiB used, &lt;span class="m">80&lt;/span> GiB / &lt;span class="m">80&lt;/span> GiB avail
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pgs: 2.041% pgs not active
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">48&lt;/span> active+clean
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">1&lt;/span> peering
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> io:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> client: 1.5 KiB/s rd, &lt;span class="m">3&lt;/span> op/s rd, &lt;span class="m">0&lt;/span> op/s wr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> recovery: &lt;span class="m">95&lt;/span> B/s, &lt;span class="m">0&lt;/span> objects/s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="創建storageclassstorageclassyaml">創建storageclass(storageclass.yaml)&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/csi/cephfs# kubectl create -f storageclass.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/csi/cephfs# kubectl get storageclasses.storage.k8s.io
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME PROVISIONER RECLAIMPOLICY VOLUMEBINDINGMODE ALLOWVOLUMEEXPANSION AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-cephfs rook-ceph.cephfs.csi.ceph.com Delete Immediate &lt;span class="nb">true&lt;/span> 8s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/csi/cephfs# ceph fs ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">name: myfs, metadata pool: myfs-metadata, data pools: &lt;span class="o">[&lt;/span>myfs-replicated &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="測試storageclassnamerook-cephfs">測試storageClassName(rook-cephfs)&lt;/h3>
&lt;p>申請PVC，指定storageClassName: &amp;ldquo;rook-cephfs&amp;rdquo;&lt;/p>
&lt;p>實現自動提供掛載空間&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat sc.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: apps/v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: Deployment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: web-sc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> selector:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> matchLabels:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app: nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> replicas: &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> template:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> labels:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app: nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> containers:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> image: nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volumeMounts:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: wwwroot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mountPath: /usr/share/nginx/html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volumes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: wwwroot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> persistentVolumeClaim:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> claimName: web-sc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: PersistentVolumeClaim
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: web-sc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storageClassName: &lt;span class="s2">&amp;#34;rook-cephfs&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> accessModes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - ReadWriteMany
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> resources:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requests:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storage: 5Gi
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl create -f sc.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">test-nginx 1/1 Running &lt;span class="m">5&lt;/span> &lt;span class="o">(&lt;/span>33m ago&lt;span class="o">)&lt;/span> 69d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">web-sc-7b6c54fbb9-8q254 1/1 Running &lt;span class="m">0&lt;/span> 46s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">web-sc-7b6c54fbb9-hkw2z 1/1 Running &lt;span class="m">0&lt;/span> 46s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">web-sc-7b6c54fbb9-m4qlf 1/1 Running &lt;span class="m">0&lt;/span> 46s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pvc-ea9ac011-5fd5-4436-ad61-468e9ce95239 5Gi RWX Delete Bound default/web-sc rook-cephfs 51s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pvc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">web-sc Bound pvc-ea9ac011-5fd5-4436-ad61-468e9ce95239 5Gi RWX rook-cephfs 54s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>測試兩個POD確實掛載了相同位置&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl &lt;span class="nb">exec&lt;/span> -ti web-sc-7b6c54fbb9-8q254 -- /bin/bash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-8q254:/#
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-8q254:/# df -h
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Filesystem Size Used Avail Use% Mounted on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.245.146.85:6789,10.245.203.29:6789,10.245.216.126:6789:/volumes/csi/csi-vol-d7642fd0-5da4-4599-b69e-bc0c1b948ded/dccf324f-8ad6-40f3-9e99-6186a32d3faf 5.0G &lt;span class="m">0&lt;/span> 5.0G 0% /usr/share/nginx/html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-8q254:/# &lt;span class="nb">cd&lt;/span> /usr/share/nginx/html/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-8q254:/usr/share/nginx/html# touch &lt;span class="m">123&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-8q254:/usr/share/nginx/html# ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">123&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-8q254:/usr/share/nginx/html# &lt;span class="nb">exit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl &lt;span class="nb">exec&lt;/span> -ti web-sc-7b6c54fbb9-hkw2z -- /bin/bash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-hkw2z:/# df -h
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Filesystem Size Used Avail Use% Mounted on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.245.146.85:6789,10.245.203.29:6789,10.245.216.126:6789:/volumes/csi/csi-vol-d7642fd0-5da4-4599-b69e-bc0c1b948ded/dccf324f-8ad6-40f3-9e99-6186a32d3faf 5.0G &lt;span class="m">0&lt;/span> 5.0G 0% /usr/share/nginx/html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-hkw2z:/# &lt;span class="nb">cd&lt;/span> /usr/share/nginx/html/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@web-sc-7b6c54fbb9-hkw2z:/usr/share/nginx/html# ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">123&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="ceph管理平台">Ceph管理平台&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get services -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr ClusterIP 10.245.33.129 &amp;lt;none&amp;gt; 9283/TCP 34m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-dashboard ClusterIP 10.245.17.131 &amp;lt;none&amp;gt; 7000/TCP 34m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-a ClusterIP 10.245.146.85 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 41m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-b ClusterIP 10.245.203.29 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 35m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-c ClusterIP 10.245.216.126 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 35m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl create -f dashboard-external-https.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get services -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr ClusterIP 10.245.33.129 &amp;lt;none&amp;gt; 9283/TCP 36m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-dashboard ClusterIP 10.245.17.131 &amp;lt;none&amp;gt; 7000/TCP 36m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-dashboard-external-https NodePort 10.245.106.246 &amp;lt;none&amp;gt; 8443:30901/TCP 10s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-a ClusterIP 10.245.146.85 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 43m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-b ClusterIP 10.245.203.29 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 37m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-c ClusterIP 10.245.216.126 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 37m
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>https://192.168.1.75:30901/#/login?returnUrl=%2Fdashboard&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231129030025.png"
loading="lazy"
>&lt;/p>
&lt;p>獲取密碼&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# kubectl get secrets -n rook-ceph rook-ceph-dashboard-password -o yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">data:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> password: &lt;span class="nv">Y0w5bG1Vb0QlTCpQViM2RFB3U3k&lt;/span>&lt;span class="o">=&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Y0w5bG1Vb0QlTCpQViM2RFB3U3k=&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> base64 -d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cL9lmUoD%L*PV#6DPwSy
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231129030211.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231129035101.png"
loading="lazy"
>&lt;/p>
&lt;p>更改密碼
&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231130001900.png"
loading="lazy"
>&lt;/p>
&lt;p>一直報這個錯誤，導致集群檢查不健康
&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231130010912.png"
loading="lazy"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">overall HEALTH_WARN &lt;span class="m">1&lt;/span> mgr modules have recently crashed
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>查看報錯&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# ceph crash ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ID ENTITY NEW
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2023-11-28T19:02:15.741903Z_cff323ca-e2d5-415c-b5e6-e518a4a2e892 mgr.a *
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# ceph crash info 2023-11-28T19:02:15.741903Z_cff323ca-e2d5-415c-b5e6-e518a4a2e892
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;backtrace&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34; File \&amp;#34;/usr/share/ceph/mgr/nfs/module.py\&amp;#34;, line 169, in cluster_ls\n return available_clusters(self)&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34; File \&amp;#34;/usr/share/ceph/mgr/nfs/utils.py\&amp;#34;, line 38, in available_clusters\n completion = mgr.describe_service(service_type=&amp;#39;nfs&amp;#39;)&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34; File \&amp;#34;/usr/share/ceph/mgr/orchestrator/_interface.py\&amp;#34;, line 1488, in inner\n completion = self._oremote(method_name, args, kwargs)&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34; File \&amp;#34;/usr/share/ceph/mgr/orchestrator/_interface.py\&amp;#34;, line 1555, in _oremote\n raise NoOrchestrator()&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;orchestrator._interface.NoOrchestrator: No orchestrator configured (try `ceph orch set backend`)&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;ceph_version&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;17.2.6&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;crash_id&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;2023-11-28T19:02:15.741903Z_cff323ca-e2d5-415c-b5e6-e518a4a2e892&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;entity_name&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;mgr.a&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;mgr_module&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;nfs&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;mgr_module_caller&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;ActivePyModule::dispatch_remote cluster_ls&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;mgr_python_exception&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;NoOrchestrator&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;os_id&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;centos&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;os_name&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;CentOS Stream&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;os_version&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;8&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;os_version_id&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;8&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;process_name&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;ceph-mgr&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;stack_sig&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;b01db59d356dd52f69bfb0b128a216e7606f54a60674c3c82711c23cf64832ce&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;timestamp&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;2023-11-28T19:02:15.741903Z&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;utsname_hostname&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;rook-ceph-mgr-a-767b9fc956-xm4ns&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;utsname_machine&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;x86_64&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;utsname_release&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;5.15.0-84-generic&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;utsname_sysname&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;Linux&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;utsname_version&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;#93-Ubuntu SMP Tue Sep 5 17:16:10 UTC 2023&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>需啟用mgr rook的modules&lt;/p>
&lt;p>參考網址： &lt;a class="link" href="https://github.com/rook/rook/issues/11316" target="_blank" rel="noopener"
>https://github.com/rook/rook/issues/11316&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 預設rook沒有啟用&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# ceph mgr module ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# ceph mgr module &lt;span class="nb">enable&lt;/span> rook
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# ceph mgr module ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">MODULE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">balancer on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">crash on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">devicehealth on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">orchestrator on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pg_autoscaler on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">progress on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rbd_support on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">status on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">telemetry on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">volumes on &lt;span class="o">(&lt;/span>always on&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dashboard on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iostat on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nfs on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">prometheus on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">restful on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples# ceph crash archive 2023-11-28T19:02:15.741903Z_cff323ca-e2d5-415c-b5e6-e518a4a2e892
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>這樣集群檢查就會顯示健康&lt;/p>
&lt;h3 id="查看mgr暴露的metric監控指標">查看mgr暴露的metric監控指標&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 服務改成 NodePort&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl edit services rook-ceph-mgr -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> type: NodePort
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl get svc -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr NodePort 10.245.33.129 &amp;lt;none&amp;gt; 9283:30602/TCP 48m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 可以看到監控指標&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# curl http://10.245.33.129:9283/metrics
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># HELP ceph_purge_queue_pq_item_in_journal Purge item left in journal&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># TYPE ceph_purge_queue_pq_item_in_journal gauge&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ceph_purge_queue_pq_item_in_journal&lt;span class="o">{&lt;/span>&lt;span class="nv">ceph_daemon&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;mds.myfs-d&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span> 0.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ceph_purge_queue_pq_item_in_journal&lt;span class="o">{&lt;/span>&lt;span class="nv">ceph_daemon&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;mds.myfs-a&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span> 0.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ceph_purge_queue_pq_item_in_journal&lt;span class="o">{&lt;/span>&lt;span class="nv">ceph_daemon&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;mds.myfs-b&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span> 0.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ceph_purge_queue_pq_item_in_journal&lt;span class="o">{&lt;/span>&lt;span class="nv">ceph_daemon&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;mds.myfs-c&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span> 0.0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>http://192.168.1.75:30602/metrics&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231129031249.png"
loading="lazy"
>&lt;/p>
&lt;h2 id="安裝prometheus收集指標">安裝Prometheus收集指標&lt;/h2>
&lt;h4 id="安裝prometheus-operator">安裝prometheus-operator&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# wget https://raw.githubusercontent.com/coreos/prometheus-operator/v0.70.0/bundle.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl create -f bundle.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl get pod
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">prometheus-operator-754cf6c978-wgn4w 1/1 Running &lt;span class="m">0&lt;/span> 23s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">prometheus-operator-847b56864c-6gp95 1/1 Running &lt;span class="m">0&lt;/span> 5m55s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="安裝prometheus-server">安裝prometheus server&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl create -f prometheus.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl create -f prometheus-service.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl create -f service-monitor.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl get pod -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">prometheus-rook-prometheus-0 2/2 Running &lt;span class="m">0&lt;/span> 63s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl get services -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">prometheus-operated ClusterIP None &amp;lt;none&amp;gt; 9090/TCP 88s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr NodePort 10.245.33.129 &amp;lt;none&amp;gt; 9283:30602/TCP 53m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-dashboard ClusterIP 10.245.17.131 &amp;lt;none&amp;gt; 7000/TCP 53m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mgr-dashboard-external-https NodePort 10.245.106.246 &amp;lt;none&amp;gt; 8443:30901/TCP 17m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-a ClusterIP 10.245.146.85 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 60m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-b ClusterIP 10.245.203.29 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 54m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-ceph-mon-c ClusterIP 10.245.216.126 &amp;lt;none&amp;gt; 6789/TCP,3300/TCP 54m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rook-prometheus NodePort 10.245.174.189 &amp;lt;none&amp;gt; 9090:30900/TCP 77s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>http://192.168.1.75:30900/graph&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231129031704.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231129031715.png"
loading="lazy"
>&lt;/p>
&lt;h2 id="安裝grafana展示圖表">安裝Grafana展示圖表&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# vim grafana-all.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: PersistentVolumeClaim
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: grafana
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> namespace: rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> accessModes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - ReadWriteOnce
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storageClassName: rook-cephfs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> resources:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requests:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> storage: 100Gi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: apps/v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: Deployment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: grafana
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> namespace: rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> selector:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> matchLabels:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app: grafana
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> template:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> labels:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app: grafana
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volumes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: storage
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> persistentVolumeClaim:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> claimName: grafana
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> securityContext:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> runAsUser: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> containers:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: grafana
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> image: grafana/grafana:9.5.14
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> imagePullPolicy: IfNotPresent
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ports:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - containerPort: &lt;span class="m">3000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: grafana
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> env:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: GF_SECURITY_ADMIN_USER
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> value: admin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: GF_SECURITY_ADMIN_PASSWORD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> value: admin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> readinessProbe:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> failureThreshold: &lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> httpGet:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> path: /api/health
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> port: &lt;span class="m">3000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> scheme: HTTP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> initialDelaySeconds: &lt;span class="m">60&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> periodSeconds: &lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> successThreshold: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeoutSeconds: &lt;span class="m">30&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> livenessProbe:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> failureThreshold: &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> httpGet:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> path: /api/health
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> port: &lt;span class="m">3000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> scheme: HTTP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> periodSeconds: &lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> successThreshold: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeoutSeconds: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> resources:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> limits:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: 150m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: 512Mi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> requests:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cpu: 150m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memory: 512Mi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volumeMounts:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - mountPath: /var/lib/grafana
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: storage
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: Service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: grafana
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> namespace: rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> type: NodePort
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ports:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - port: &lt;span class="m">3000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> selector:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app: grafana
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: networking.k8s.io/v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: Ingress
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: grafana
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> namespace: rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ingressClassName: nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rules:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - host: grafana.jimmyhome.tw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> http:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> paths:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - path: /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pathType: Prefix
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> backend:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> service:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: grafana
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> port:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> number: &lt;span class="m">3000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl create -f grafana-all.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl get pod -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">grafana-654886fbff-wzx9n 0/1 Running &lt;span class="m">0&lt;/span> 42s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/rook/deploy/examples/monitoring# kubectl get svc,pvc -n rook-ceph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT&lt;span class="o">(&lt;/span>S&lt;span class="o">)&lt;/span> AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">service/grafana NodePort 10.245.92.95 &amp;lt;none&amp;gt; 3000:31348/TCP 68s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">persistentvolumeclaim/grafana Bound pvc-75e0cc6e-5130-4ab6-b447-0d19d95880f3 200Gi RWO rook-cephfs 69s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>http://192.168.1.75:31348/login&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231129032738.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231129032828.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231129032923.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231129032945.png"
loading="lazy"
>&lt;/p>
&lt;p>填寫Prometheus service ip
&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231129033201.png"
loading="lazy"
>&lt;/p>
&lt;p>連線成功
&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231129033216.png"
loading="lazy"
>&lt;/p>
&lt;p>Dashboard導入&lt;/p>
&lt;p>&lt;a class="link" href="https://grafana.com/grafana/dashboards/2842-ceph-cluster/" target="_blank" rel="noopener"
>https://grafana.com/grafana/dashboards/2842-ceph-cluster/&lt;/a>
&lt;a class="link" href="https://grafana.com/grafana/dashboards/5336-ceph-osd-single/" target="_blank" rel="noopener"
>https://grafana.com/grafana/dashboards/5336-ceph-osd-single/&lt;/a>
&lt;a class="link" href="https://grafana.com/grafana/dashboards/5342-ceph-pools/" target="_blank" rel="noopener"
>https://grafana.com/grafana/dashboards/5342-ceph-pools/&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231129033454.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231129033528.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231129033556.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231129033610.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231129033640.png"
loading="lazy"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/media/Pasted%20image%2020231129033654.png"
loading="lazy"
>&lt;/p></description></item><item><title>Kubernetes Summit 2023</title><link>https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/</link><pubDate>Sun, 29 Oct 2023 18:37:28 +0800</pubDate><guid>https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/</guid><description>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029184656.png" alt="Featured image of post Kubernetes Summit 2023" />&lt;h2 id="大會議程">大會議程&lt;/h2>
&lt;h3 id="1025">10/25&lt;/h3>
&lt;p>&lt;font color=blue>官方網站連結：&lt;/font>
&lt;a class="link" href="https://k8s.ithome.com.tw/2023/agenda#day01" target="_blank" rel="noopener"
>https://k8s.ithome.com.tw/2023/agenda#day01&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029184954.png"
width="1103"
height="788"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029184954_hu789cf0cffa7a927720910455bf1f3fda_131417_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029184954_hu789cf0cffa7a927720910455bf1f3fda_131417_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="139"
data-flex-basis="335px"
>
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029185027.png"
width="1064"
height="727"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029185027_hue0ee08926733fc10385e501d9ee9b688_161689_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029185027_hue0ee08926733fc10385e501d9ee9b688_161689_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="146"
data-flex-basis="351px"
>
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029185042.png"
width="1060"
height="431"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029185042_hu30403b9c23bceb5e4335092009919719_112702_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029185042_hu30403b9c23bceb5e4335092009919719_112702_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="245"
data-flex-basis="590px"
>&lt;/p>
&lt;h3 id="1026">10/26&lt;/h3>
&lt;p>&lt;font color=blue>官方網站連結：&lt;/font>
&lt;a class="link" href="https://k8s.ithome.com.tw/2023/agenda#day02" target="_blank" rel="noopener"
>https://k8s.ithome.com.tw/2023/agenda#day02&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029185219.png"
width="1097"
height="778"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029185219_hu6f14276858f99f129e5aaba5372a986d_119601_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029185219_hu6f14276858f99f129e5aaba5372a986d_119601_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="141"
data-flex-basis="338px"
>
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029185306.png"
width="1099"
height="789"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029185306_hu8f0023fb001c9dd10d86a2a1e9a29c02_176380_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029185306_hu8f0023fb001c9dd10d86a2a1e9a29c02_176380_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="139"
data-flex-basis="334px"
>
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029185333.png"
width="1094"
height="588"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029185333_hu57a7110ce0b1da3fef40856d8bdaa3ed_128581_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029185333_hu57a7110ce0b1da3fef40856d8bdaa3ed_128581_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="186"
data-flex-basis="446px"
>&lt;/p>
&lt;h2 id="我拍的照片">我拍的照片&lt;/h2>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/900C265C-28CE-465E-80E3-867F1418DB8E_1_105_c.jpeg"
width="768"
height="1024"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/900C265C-28CE-465E-80E3-867F1418DB8E_1_105_c_hu0aa814a31a3b71e1d3641a7667c75fc0_318746_480x0_resize_q75_box.jpeg 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/900C265C-28CE-465E-80E3-867F1418DB8E_1_105_c_hu0aa814a31a3b71e1d3641a7667c75fc0_318746_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="75"
data-flex-basis="180px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/F92CB0CD-C30A-48AC-96D8-C08AE871F044_1_105_c.jpeg"
width="768"
height="1024"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/F92CB0CD-C30A-48AC-96D8-C08AE871F044_1_105_c_hu733febc7948f815e215421e7dc85ce6b_217937_480x0_resize_q75_box.jpeg 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/F92CB0CD-C30A-48AC-96D8-C08AE871F044_1_105_c_hu733febc7948f815e215421e7dc85ce6b_217937_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="75"
data-flex-basis="180px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/6984AAF0-C037-4091-A477-97E1EB6C29FF_1_105_c.jpeg"
width="768"
height="1024"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/6984AAF0-C037-4091-A477-97E1EB6C29FF_1_105_c_hu7b38d76b01a74ab8667ac604c60714f5_222196_480x0_resize_q75_box.jpeg 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/6984AAF0-C037-4091-A477-97E1EB6C29FF_1_105_c_hu7b38d76b01a74ab8667ac604c60714f5_222196_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="75"
data-flex-basis="180px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/254CAF44-653C-4824-AD01-D370B6566634_1_105_c.jpeg"
width="768"
height="1024"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/254CAF44-653C-4824-AD01-D370B6566634_1_105_c_hu592b45e3f325788d113073226f5ad04d_226110_480x0_resize_q75_box.jpeg 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/254CAF44-653C-4824-AD01-D370B6566634_1_105_c_hu592b45e3f325788d113073226f5ad04d_226110_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="75"
data-flex-basis="180px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/5865921B-7DD5-4B01-8964-75382259E708_1_105_c.jpeg"
width="768"
height="1024"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/5865921B-7DD5-4B01-8964-75382259E708_1_105_c_hu03dc406bb761b1e684cf563e3f3750b0_206164_480x0_resize_q75_box.jpeg 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/5865921B-7DD5-4B01-8964-75382259E708_1_105_c_hu03dc406bb761b1e684cf563e3f3750b0_206164_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="75"
data-flex-basis="180px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/1B6BD820-CA4E-4FEE-A420-B9D3BA22724E_1_105_c.jpeg"
width="768"
height="1024"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/1B6BD820-CA4E-4FEE-A420-B9D3BA22724E_1_105_c_hu0f7e806bb27f63510b878d1f683c4e15_254205_480x0_resize_q75_box.jpeg 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/1B6BD820-CA4E-4FEE-A420-B9D3BA22724E_1_105_c_hu0f7e806bb27f63510b878d1f683c4e15_254205_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="75"
data-flex-basis="180px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/8D906871-C37C-4DA9-9C70-14816C5601DA_1_105_c.jpeg"
width="768"
height="1024"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/8D906871-C37C-4DA9-9C70-14816C5601DA_1_105_c_hu776d8ee949699bda250a13b5c571ae5f_238598_480x0_resize_q75_box.jpeg 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/8D906871-C37C-4DA9-9C70-14816C5601DA_1_105_c_hu776d8ee949699bda250a13b5c571ae5f_238598_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="75"
data-flex-basis="180px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/B1F85081-0C02-4203-A322-902492E182FF_1_105_c.jpeg"
width="768"
height="1024"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/B1F85081-0C02-4203-A322-902492E182FF_1_105_c_hu9c82092b8c82a7aae84744544609739a_212735_480x0_resize_q75_box.jpeg 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/B1F85081-0C02-4203-A322-902492E182FF_1_105_c_hu9c82092b8c82a7aae84744544609739a_212735_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="75"
data-flex-basis="180px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/340FD391-C95E-4BA6-9385-B7F7F8BF8D74_1_105_c.jpeg"
width="768"
height="1024"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/340FD391-C95E-4BA6-9385-B7F7F8BF8D74_1_105_c_hu4334a25ed9c4f1e94764a162a3b41b7e_217642_480x0_resize_q75_box.jpeg 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/340FD391-C95E-4BA6-9385-B7F7F8BF8D74_1_105_c_hu4334a25ed9c4f1e94764a162a3b41b7e_217642_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="75"
data-flex-basis="180px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/94571335-4478-4096-BC55-66E458CCA863_1_105_c.jpeg"
width="768"
height="1024"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/94571335-4478-4096-BC55-66E458CCA863_1_105_c_hu5e2a7a4d167c1a270be2f54b27441f59_206945_480x0_resize_q75_box.jpeg 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/94571335-4478-4096-BC55-66E458CCA863_1_105_c_hu5e2a7a4d167c1a270be2f54b27441f59_206945_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="75"
data-flex-basis="180px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/EEC5A14E-7C74-4E9D-A709-BD499210A9E7_1_105_c.jpeg"
width="768"
height="1024"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/EEC5A14E-7C74-4E9D-A709-BD499210A9E7_1_105_c_hu766c583e394d7e17a3c15c7aee088414_190724_480x0_resize_q75_box.jpeg 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/EEC5A14E-7C74-4E9D-A709-BD499210A9E7_1_105_c_hu766c583e394d7e17a3c15c7aee088414_190724_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="75"
data-flex-basis="180px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/6D744DEE-A698-42B1-83B5-ED82073F3AA4_1_105_c.jpeg"
width="768"
height="1024"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/6D744DEE-A698-42B1-83B5-ED82073F3AA4_1_105_c_hua90f76b4c52ea22f7a5558f6df033c80_318527_480x0_resize_q75_box.jpeg 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/6D744DEE-A698-42B1-83B5-ED82073F3AA4_1_105_c_hua90f76b4c52ea22f7a5558f6df033c80_318527_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="75"
data-flex-basis="180px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/0857E6F4-3C85-41B0-9784-CE0F8068B2C1_1_105_c.jpeg"
width="768"
height="1024"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/0857E6F4-3C85-41B0-9784-CE0F8068B2C1_1_105_c_hucdb21c994a6fefe9bb7f315bc34c3f77_339154_480x0_resize_q75_box.jpeg 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/0857E6F4-3C85-41B0-9784-CE0F8068B2C1_1_105_c_hucdb21c994a6fefe9bb7f315bc34c3f77_339154_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="75"
data-flex-basis="180px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/B4169EF3-F3D0-4A02-A0E4-BA20C628D42C_1_105_c.jpeg"
width="768"
height="1024"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/B4169EF3-F3D0-4A02-A0E4-BA20C628D42C_1_105_c_hu850f2375f3fd56a481dbec66fc59c869_269975_480x0_resize_q75_box.jpeg 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/B4169EF3-F3D0-4A02-A0E4-BA20C628D42C_1_105_c_hu850f2375f3fd56a481dbec66fc59c869_269975_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="75"
data-flex-basis="180px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/29DA918C-6413-410E-AAFE-29CCB2D55649_1_105_c.jpeg"
width="768"
height="1024"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/29DA918C-6413-410E-AAFE-29CCB2D55649_1_105_c_huc9109aaca3490527c508592e03b6c70a_208841_480x0_resize_q75_box.jpeg 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/29DA918C-6413-410E-AAFE-29CCB2D55649_1_105_c_huc9109aaca3490527c508592e03b6c70a_208841_1024x0_resize_q75_box.jpeg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="75"
data-flex-basis="180px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029201517.png"
width="595"
height="807"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029201517_hua893e301d11dc2358b761030eaec4916_809012_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029201517_hua893e301d11dc2358b761030eaec4916_809012_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="73"
data-flex-basis="176px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029210053.png"
width="1218"
height="715"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029210053_huac3f77c77e155f6b9eed6e5c1d97535c_1687183_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-summit-2023/media/Pasted-image-20231029210053_huac3f77c77e155f6b9eed6e5c1d97535c_1687183_1024x0_resize_box_3.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="170"
data-flex-basis="408px"
>&lt;/p>
&lt;h2 id="我參加的議程">我參加的議程&lt;/h2>
&lt;h3 id="1025-1">10/25&lt;/h3>
&lt;h4 id="ㄧ大規模-kubernetes-運維甘苦談關於自建雲端和-cicd-的那些大小事">(ㄧ)大規模 Kubernetes 運維甘苦談：關於自建、雲端和 CI/CD 的那些大小事&lt;/h4>
&lt;p>本議程將分享趨勢科技實際進行大規模 Kubernetes 運維的經驗與踩過的雷。&lt;/p>
&lt;p>透過最初自建的背景介紹，經歷雲端半託管時期，一路到現在全雲端託管的 Kubernetes 叢集部署的策略演進（以 AWS EKS 為例），分享CI/CD的最佳實踐經驗，並帶各位了解大規模維運會碰到的挑戰，包含如何進行有效的資源管理與擴展、故障排除及監控等。&lt;/p>
&lt;p>希望這些辛酸血淚史能對有志管理大型 Kubernetes cluster的同路人有所幫助。&lt;/p>
&lt;p>&lt;font color=blue>官方網站連結：&lt;/font>
&lt;a class="link" href="https://k8s.ithome.com.tw/2023/session-page/2250" target="_blank" rel="noopener"
>https://k8s.ithome.com.tw/2023/session-page/2250&lt;/a>&lt;/p>
&lt;h4 id="二融合-ai-技術加速應用開發交付與優化">(二)融合 AI 技術，加速應用開發、交付與優化&lt;/h4>
&lt;p>應用現代化和多雲是數位化轉型的核心。研究顯示，超過 70% 的企業正在開發全新的雲原生應用，而專為多雲設計的現代化應用在企業中的使用率現已超過傳統應用 ; 因此，應用開發的敏捷性和上市速度對於企業能否在競爭中取得成功至關重要。本議程探討如何運用 VMware Tanzu 平台加速應用開發、交付和提供智能管理，藉以提升業務敏捷性與整合多雲應用。&lt;/p>
&lt;p>&lt;font color=blue>官方網站連結：&lt;/font>
&lt;a class="link" href="https://k8s.ithome.com.tw/2023/session-page/2317" target="_blank" rel="noopener"
>https://k8s.ithome.com.tw/2023/session-page/2317&lt;/a>&lt;/p>
&lt;h4 id="三google-重塑新一代-kubernetes-ops-與-ai-技術的致勝關鍵">(三)Google 重塑新一代 Kubernetes Ops 與 AI 技術的致勝關鍵&lt;/h4>
&lt;p>歡迎參加本議程活動，了解 Google 新一代 Kubernetes Ops 的最新消息與致勝關鍵，包括從容器至 AI 等主要議題。不論是透過雲端服務打造自己的平台，抑或是開發與管理應用程式，您將可透過本議程了解如何在每日 IT 維運任務中提升效率、可靠性及資安條件。您亦可了解業界頂尖公司如何運用具高度擴展性且自動化的 Kubernetes，迅速打造專屬自己的雲端致勝模式，並借助 AI 的力量邁向成功之路。&lt;/p>
&lt;p>Join this session to learn the latest and best from Google for Next Genereation Kubernetes Ops – from containers to AI. Whether you’re building your own platform or developing and managing applications using cloud services, learn how to improve efficiency, reliability, and security in your IT operations. You’ll also discover how leading companies use the most scalable and automated Kubernetes to build fast and harness AI in their IT operations.&lt;/p>
&lt;p>&lt;font color=blue>官方網站連結：&lt;/font>
&lt;a class="link" href="https://k8s.ithome.com.tw/2023/session-page/2318" target="_blank" rel="noopener"
>https://k8s.ithome.com.tw/2023/session-page/2318&lt;/a>&lt;/p>
&lt;h4 id="四how-to-link-k8s-to-business-讓主管們都聽得懂">(四)How to link K8s to Business 讓主管們都聽得懂&lt;/h4>
&lt;p>探討及分享雲架構平台跟業務的關係，從 CIO 角度看技術轉型。&lt;/p>
&lt;p>&lt;font color=blue>官方網站連結：&lt;/font>
&lt;a class="link" href="https://k8s.ithome.com.tw/2023/session-page/2319" target="_blank" rel="noopener"
>https://k8s.ithome.com.tw/2023/session-page/2319&lt;/a>&lt;/p>
&lt;h4 id="五從數據看台灣企業雲原生採用大趨勢">(五)從數據看台灣企業雲原生採用大趨勢&lt;/h4>
&lt;p>即將揭曉，敬請期待&lt;/p>
&lt;p>&lt;font color=blue>官方網站連結：&lt;/font>
&lt;a class="link" href="https://k8s.ithome.com.tw/2023/session-page/2356" target="_blank" rel="noopener"
>https://k8s.ithome.com.tw/2023/session-page/2356&lt;/a>&lt;/p>
&lt;h4 id="六resource-as-code-for-kubernetes-stop-kubectl-apply">(六)Resource as Code for Kubernetes: Stop kubectl apply&lt;/h4>
&lt;p>Infrastrure as Code (IaC) 與 PaC，在萬物都該 as Code 得時代，你還在不斷的 kubectl apply 嗎？&lt;/p>
&lt;p>手動 apply 的痛點：&lt;/p>
&lt;ul>
&lt;li>人就是會忘：是誰 apply 這個在 K8s 上的？是誰上次漏 apply 所以壞了？&lt;/li>
&lt;li>人就是會寫錯：能否 apply&lt;/li>
&lt;li>管理大量的 label, taint, annotation&lt;/li>
&lt;li>安全：apply 變更內容是否有經過資訊安全的 review&lt;/li>
&lt;li>多環境管理：多座 K8s 要如何管理 K8s resource&lt;/li>
&lt;/ul>
&lt;p>當服務的 app code base 都已經用 chart 打包，使用 vcs 管理後，為何依賴的 k8s resource (namespace, secret, label, crd, &amp;hellip;) 不需要推上 vcs 管理的？&lt;/p>
&lt;p>本次演講集合幾個管理 K8s 的範例，將 K8s resource 以 code 管理，推上 vcs，並使用 argoCD, secret operator, &amp;hellip; 等工具進行管理，來讓避免低級的人工操作錯誤，降低團隊整體失誤率，並降低 K8s admin 管理的成本，提高管理效率&lt;/p>
&lt;p>&lt;font color=blue>官方網站連結：&lt;/font>
&lt;a class="link" href="https://k8s.ithome.com.tw/2023/session-page/2331" target="_blank" rel="noopener"
>https://k8s.ithome.com.tw/2023/session-page/2331&lt;/a>&lt;/p>
&lt;h4 id="七kubernetes-資安攻防---採用機密運算與零信任策略守護您的應用">(七)Kubernetes 資安攻防 - 採用機密運算與零信任策略，守護您的應用&lt;/h4>
&lt;p>我們將探討如何使用機密運算和零信任方法在 Kubernetes 環境中保護應用程式和數據。Kubernetes 已經成為現代各大企業軟體開發和運營的必然趨勢，然而，與之相關的安全挑戰也成為現在大家關注的重點。在這個議程中，我們將深入探討您日常 Kubernetes 運營中可能面臨的潛在風險和安全挑戰。我們將透過實際案例和最佳實踐，與您分享如何有效應對這些挑戰，並強調採取相關進階措施的必要性。&lt;/p>
&lt;p>透過參加此議程，您將有機會深入了解如何運用機密運算和基於零信任的安全方法來保護您的 Kubernetes 環境。無論您是一名 Kubernetes 初學者還是資深專家，這個議程都將為您提供相關見解，以確保您的應用程式和數據得到最高水平的保護。&lt;/p>
&lt;p>&lt;font color=blue>官方網站連結：&lt;/font>
&lt;a class="link" href="https://k8s.ithome.com.tw/2023/session-page/2352" target="_blank" rel="noopener"
>https://k8s.ithome.com.tw/2023/session-page/2352&lt;/a>&lt;/p>
&lt;h4 id="八新世代的-service-mesh---istio-ambient-mesh">(八)新世代的 Service Mesh - Istio Ambient Mesh&lt;/h4>
&lt;p>在 Kubernetes 平台上開發應用程式時, 通常很容易會討論到是否要使用 Service Mesh。而 Service Mesh 中的代表性解決方案 Istio, 更是目前廣為採用的 Service Mesh 之一。Istio 能夠對服務的溝通，管理，乃至於監控, 提供一個強大的平台。但相對的，使用 Istio 的所需要付出的代價也相當不小，往往令許多人有心採用的人往而卻步。&lt;/p>
&lt;p>有鑑於此，Istio 在 2022 年的九月，發表了 Ambient Mesh, 一個全新的 Istio Data Plane Mode，旨在簡化操作，拓展應用成式兼容性，降低基礎架構所需成本。 Ambient Mesh 讓使用者不再需要使用之前的 Sidecar 模式，將 Data Plane 無縫地整合進 Kubernetes 基礎架構，同時還能保有 Istio 既有的零信任安全、觀測性和流量治理等核心特性。&lt;/p>
&lt;p>在 2023 三月, Ambient Mesh 進入了 Istio 開源專案的 main branch, 預計在 2023 年底會 production ready。這正是一個絕佳的時刻，讓大家能了解 Ambient Mesh 所帶來的新架構的優勢, 讓有心想要導入 Istio 的人能夠重新評估 Ambient Mesh 的可能性，對於 Sidecar &amp;amp; Sidecarless 的 Istio 應該如何選擇使用，進行一個深入淺出的探討。&lt;/p>
&lt;p>&lt;font color=blue>官方網站連結：&lt;/font>
&lt;a class="link" href="https://k8s.ithome.com.tw/2023/session-page/2326" target="_blank" rel="noopener"
>https://k8s.ithome.com.tw/2023/session-page/2326&lt;/a>&lt;/p>
&lt;h4 id="九通往-cloud-native-的神奇之旅自製-kubernetes-工具大揭秘">(九)通往 Cloud Native 的神奇之旅：自製 Kubernetes 工具大揭秘&lt;/h4>
&lt;p>透過這次的分享，我們將深入探討 LINE Pay Taiwan 是如何成功從傳統的 VM 基礎架構轉向高效的 Cluster-based Infrastructure 的過程。在這趟旅程中，我們將揭示自行開發的工具如何在這轉型過程中發揮關鍵作用，並怎樣迅速引入 Kubernetes 技術，實現卓越的效益與競爭優勢。&lt;/p>
&lt;p>&lt;strong>議程重點：&lt;/strong>&lt;/p>
&lt;p>&lt;strong>Why&lt;/strong>: 為何選擇 Cloud Native？&lt;/p>
&lt;ul>
&lt;li>探索導入 Kubernetes 背後的動機，以及如何解決LINE Pay Taiwan所面臨的實際挑戰&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>How&lt;/strong>: 落實 Cloud Native 轉型的實踐之道&lt;/p>
&lt;ul>
&lt;li>在有限資源下，我們如何革新現有的 CI/CD 流程，同時保持合規性。&lt;/li>
&lt;li>設計和改進 CI/CD 流程，以實現 Kubernetes 的順利導入。&lt;/li>
&lt;li>介紹我們如何使用 GoLang 開發自有 CLI 工具，協助工程師快速融入 Cloud Native 生態系統&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>What&lt;/strong>: 享受 Cloud Native 帶來的好處&lt;/p>
&lt;ul>
&lt;li>發現我們自行開發的工具如何帶來的優勢。&lt;/li>
&lt;li>洞察導入 Kubernetes 架構後，LINE Pay Taiwan的服務將獲得什麼樣的轉變&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>Which&lt;/strong>: 系統性調整和未來優化之路&lt;/p>
&lt;ul>
&lt;li>窺探在架構轉型後，我們經歷了哪些系統性調整&lt;/li>
&lt;li>探討更多可持續優化的可能性&lt;/li>
&lt;/ul>
&lt;p>&lt;font color=blue>官方網站連結：&lt;/font>
&lt;a class="link" href="https://k8s.ithome.com.tw/2023/session-page/2353" target="_blank" rel="noopener"
>https://k8s.ithome.com.tw/2023/session-page/2353&lt;/a>&lt;/p>
&lt;h3 id="1026-1">10/26&lt;/h3>
&lt;h4 id="一kubernetes-apis-for-the-future-building-platforms-and-managing-everything">(一)Kubernetes APIs for the Future: Building Platforms and Managing Everything&lt;/h4>
&lt;p>Kubernetes is a powerful platform for building platforms. With CustomResourceDefinition (CRD), you can build the APIs you need to manage your applications and infrastructure. Kubernetes is becoming universal for everything, and you can use Kubernetes APIs to manage cloud resources, as well as applications and services.&lt;/p>
&lt;p>GitOps is a Git-based approach to managing infrastructure and applications. It removes toil and reduces the barrier for using Kubernetes, making it easier to be effective. With GitOps, you can build your platform using Kubernetes APIs easier, safer, and faster.&lt;/p>
&lt;p>This keynote speech is for anyone who wants to learn more about how to use Kubernetes to build and manage platforms, applications, and infrastructure. Whether you are a beginner or an expert, you will learn something new.&lt;/p>
&lt;p>&lt;font color=blue>官方網站連結：&lt;/font>
&lt;a class="link" href="https://k8s.ithome.com.tw/2023/session-page/2336" target="_blank" rel="noopener"
>https://k8s.ithome.com.tw/2023/session-page/2336&lt;/a>&lt;/p>
&lt;h4 id="二打造雲原生世界的資安堡壘">(二)打造雲原生世界的資安堡壘&lt;/h4>
&lt;p>成功的企業容器安全計劃必須要能從容器生命週期的建構、部署到運作的所有階段，以及底層的容器基礎架構中執行主要控制措施。&lt;/p>
&lt;p>不知從何著手嗎？本議程介紹 Red Hat 容器平台如何在雲原生世界提供完整的安全防護，為企業打造最堅實的現代化資安堡壘。&lt;/p>
&lt;p>&lt;font color=blue>官方網站連結：&lt;/font>
&lt;a class="link" href="https://k8s.ithome.com.tw/2023/session-page/2337" target="_blank" rel="noopener"
>https://k8s.ithome.com.tw/2023/session-page/2337&lt;/a>&lt;/p>
&lt;h4 id="三幫服務建立觀測性利用-itsm-與自動化完成數位企業最後一哩路">(三)幫服務建立觀測性，利用 ITSM 與自動化完成數位企業最後一哩路&lt;/h4>
&lt;p>企業熱衷於新技術導入，越來越多服務導入不同種新技術建立在不同的運作平台上，單純的服務監控已經不能滿足需求，需要建立觀測性(Observability)來協助我們更了解服務的運作狀態，尤其當容器化的世代來臨，更複雜的 IT 環境需要更好的工具協助我們觀測且協作，透過自動化工具，協助企業動態且快速建立服務所需要的資源；BMC 將分享關於如何建立服務觀測性，透過 AI/ML 工具有效將服務與 IT 整合起來，起到協同運作、共做共榮的使用情境，加速數位企業轉型，達成目標。&lt;/p>
&lt;p>&lt;font color=blue>官方網站連結：&lt;/font>
&lt;a class="link" href="https://k8s.ithome.com.tw/2023/session-page/2338" target="_blank" rel="noopener"
>https://k8s.ithome.com.tw/2023/session-page/2338&lt;/a>&lt;/p>
&lt;h4 id="四feature-toggle-makes-development-more-efficient">(四)Feature Toggle Makes Development more Efficient&lt;/h4>
&lt;p>在 Kubernetes 的部署中，經常會面臨一些挑戰。例如，新功能的部署可能會導致系統穩定性下降，甚至可能需要回朔上次部署，從而提高部署風險。此外，每次部署都需要全面的測試，這不僅增加了部署和測試的複雜性，也消耗了更多的時間。這可能會對用戶的使用體驗產生影響。透過這次的演講，我們將探討如何透過 Feature Toggle 來解決這些問題，並提升我們的部署與開發的效率和靈活性。&lt;/p>
&lt;p>因此，我們的議程將會包含以下的內容：&lt;/p>
&lt;ul>
&lt;li>Feature Toggle 的簡介：&lt;/li>
&lt;/ul>
&lt;p>我們將介紹什麼是 Feature Toggle，以及它的基本概念和工作原理。&lt;/p>
&lt;ul>
&lt;li>Feature Toggle 的應用場景：&lt;/li>
&lt;/ul>
&lt;p>我們將分享 Feature Toggle 的實際應用場景，包括 AB testing, Canary Release 等。&lt;/p>
&lt;ul>
&lt;li>LINE台灣在推動的工法：&lt;/li>
&lt;/ul>
&lt;p>我們將分享 LINE 台灣在推動 Feature Toggle 的經驗和工法。&lt;/p>
&lt;ul>
&lt;li>從 Feature Toggle 到 Kubernetes 的影響：&lt;/li>
&lt;/ul>
&lt;p>我們將探討 Feature Toggle 如何影響到開發流程和 CI/CD 在 Kubernetes 上的部署，並分享如何解決上述的痛點。&lt;/p>
&lt;ul>
&lt;li>如何持續地縮短 Release 週期與增進開發效率：&lt;/li>
&lt;/ul>
&lt;p>我們將分享如何透過 Feature Toggle 持續地縮短 Release 週期和提高開發效率。&lt;/p>
&lt;p>&lt;font color=blue>官方網站連結：&lt;/font>
&lt;a class="link" href="https://k8s.ithome.com.tw/2023/session-page/2339" target="_blank" rel="noopener"
>https://k8s.ithome.com.tw/2023/session-page/2339&lt;/a>&lt;/p>
&lt;h4 id="五on-premise-workload-遷移-kubernetes-心路歷程">(五)On-premise Workload 遷移 Kubernetes 心路歷程&lt;/h4>
&lt;p>往雲端 Kubernetes 遷移 workload 的過程，服務會同時並行於 on-premise 和雲端一段混合的過程，KKBOX 擁有超過千萬會員，首先面對的挑戰會是，要如何最小化遷移對使用者的影響，遷移邁入後期後，則需要持續優化營運成本。此次分享會對上述議題，分享 KKBOX 如何解決這些技術上的難題。&lt;/p>
&lt;p>&lt;font color=blue>官方網站連結：&lt;/font>
&lt;a class="link" href="https://k8s.ithome.com.tw/2023/session-page/2355" target="_blank" rel="noopener"
>https://k8s.ithome.com.tw/2023/session-page/2355&lt;/a>&lt;/p>
&lt;h4 id="六如何在銀行內部用-k8s-打造無伺服器批次運算平台">(六)如何在銀行內部用 K8s 打造無伺服器批次運算平台&lt;/h4>
&lt;p>過去企業需要考量著基礎設施的管理議題，但隨著近幾年無伺服器概念的推出，徹底的改變既有的思路，讓企業開發者能夠更專注在開發應用，而並非架構上，同時又能有效節省冗餘硬體資源並提升整體效益等優點。&lt;/p>
&lt;p>隨著 Google 將 Knative 專案貢獻給雲端原生運算基金會 (CNCF)，迅速帶起各大企業使用Serverless的浪潮，而玉山也乘著這波概念的浪潮，打造獨有的無伺服器批次運算平台，來強化玉山批次運行架構，以達對硬體資源使用、開發、維運整體效益整體的提升。&lt;/p>
&lt;p>本次演講會分享所謂 Serverless 概念及 Knative 的運作原理，並說明玉山銀行如何結合 Serverless，改造批次運行架構，提高硬體使用集縮比，以降低硬體資源成本。&lt;/p>
&lt;p>&lt;font color=blue>官方網站連結：&lt;/font>
&lt;a class="link" href="https://k8s.ithome.com.tw/2023/session-page/2347" target="_blank" rel="noopener"
>https://k8s.ithome.com.tw/2023/session-page/2347&lt;/a>&lt;/p>
&lt;h4 id="七聯邦學習在-k8s-上的實現與應用">(七)聯邦學習在 K8s 上的實現與應用&lt;/h4>
&lt;p>Machine learning 的模型建立時需要足夠的資料量與足夠的解釋力特徵，如欲建立機器學習模型時最重要的的任務即是蒐集足夠的資料量與特徵，但往往在企業上同一客戶的資料可能會分散在不同的子公司上，或是想統整運用不同子公司各自擁有的客戶群資料以提升模型準確性，基於隱私條款的限制，子公司間是無法直接進行資料交換來做使用。在資料量與特徵不足的情況下機器學習模型的整體效果就較難做進一步的提升。&lt;/p>
&lt;p>國泰資料科學團隊以 KubeFate 聯邦學習框架的基礎下開發名為 CaFe 的聯邦學習框架，使用 Helm 建立高效的聯邦學習架構，開發 Operator 用於同步不同 Namespaces 中的 ConfigMap 資料，藉由 webhook 實現自動掛載 ConfigMap 到相應的應用程式，使整個建置過程更加自動化和高效。子公司的使用者能在不交換實體資料的情況下於各自 K8S 環境共同訓練出效果比單一方自行訓練的模型效果更佳，進而提升整體模型效度。我們將與大家分享以下內容：&lt;/p>
&lt;ol>
&lt;li>聯邦學習簡介&lt;/li>
&lt;li>聯邦學習框架 KubeFate 使用評估&lt;/li>
&lt;li>CaFe 部署於 OKD 上與內部資料科學平台的結合&lt;/li>
&lt;li>POC 測試案&lt;/li>
&lt;/ol>
&lt;p>&lt;font color=blue>官方網站連結：&lt;/font>
&lt;a class="link" href="https://k8s.ithome.com.tw/2023/session-page/2350" target="_blank" rel="noopener"
>https://k8s.ithome.com.tw/2023/session-page/2350&lt;/a>&lt;/p>
&lt;h4 id="八cloud-native-messaging-service-by-nats">(八)Cloud-native messaging service by NATS&lt;/h4>
&lt;p>NATS 是一個 open source pub/sub messaging system，於 2018 年成為 CNCF 的 incubating project 後，歷經快速的發展，2019 年 NATS 2.0 增加了 supercluster、 leafnode 和 decentralized security 功能，2021 年 NATS2.2 將新的分散式儲存系統 JetStream 正式 GA 整合進 NATS，直到最近的 NATS2.9 持續提升穩定性，此議程想讓觀眾了解 NATS 的功能、最新的 NATS 發展與佈署 NATS 在 K8s 上維運的建議。&lt;/p>
&lt;ol>
&lt;li>NATS 的基本介紹，什麼是 NATS Core 和 JetStream，以 demo 形式讓觀眾快速了解&lt;/li>
&lt;li>NATS open source project 的發展現況&lt;/li>
&lt;li>NATS cluster 於 K8s 的佈署、維運、如何持續擴充&lt;/li>
&lt;li>導入 NATS 的建議流程&lt;/li>
&lt;li>目前有哪些 open source project 支援 NATS JetStream&lt;/li>
&lt;/ol>
&lt;p>&lt;font color=blue>官方網站連結：&lt;/font>
&lt;a class="link" href="https://k8s.ithome.com.tw/2023/session-page/2325" target="_blank" rel="noopener"
>https://k8s.ithome.com.tw/2023/session-page/2325&lt;/a>&lt;/p>
&lt;h4 id="九adopt-kubernetes-for-infrastructure-as-code-打造以-k8s-為底層的-iac-系統">(九)Adopt Kubernetes for Infrastructure as Code (打造以 K8S 為底層的 IaC 系統）&lt;/h4>
&lt;p>K8S 從開源以來，就以宣告式的方式，提供標準資源的自癒與擴充能力，在 1.13 後提供的客制資源 (CRD) 管理的擴充能力，延伸了 K8S 的宣告式平台。&lt;/p>
&lt;p>Google 在 GCP 上首先提出了 KCC (Kubernetes Config Connector) 的實作，通過 GKE 管理 GCP 各項 IT 資源的生命週期，Google 也進一步與開源社群 (Crossplane) 合作，將 KCC 的概念延伸到其他的基礎架構提供者中，打造新的 IaC 生命週期管理機制：Cloud Resource Accelerator。&lt;/p>
&lt;p>這個機制，通過 YAML 物件的解耦，有效的限制開發者與管理者對 IaC 的控制能力，同時通過 K8S 的宣告機制，讓部署出來的資源能受到 K8S 的完整保護，這些強化都有效的彌補現有 IaC CLI 的不足。&lt;/p>
&lt;p>&lt;font color=blue>官方網站連結：&lt;/font>
&lt;a class="link" href="https://k8s.ithome.com.tw/2023/session-page/2322" target="_blank" rel="noopener"
>https://k8s.ithome.com.tw/2023/session-page/2322&lt;/a>&lt;/p>
&lt;h2 id="心得與收穫">心得與收穫&lt;/h2>
&lt;p>由於去年參加過，今年參加Summit，我在議題上的選擇，著重於就比較往能協助公司導入Kubernetes的議題去參加，因為目前公司也是處於此階段，例如分享導入經驗與甘苦談的議題、導入有效管理工具使用的議題、最新Kubernetes技術分享的議題，像是一些公司新產品發表那些議題，我就沒去參加。&lt;/p>
&lt;p>至於印象比較深刻的議題如下：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>是Google分享了他們目前看到的趨勢，預計到2027，企業將正式生產環境導入容器或Kubernetes會高達90%，也就是說，那時候，會將近有90%的企業，會使用容器或Kubernetes當作直接對外服務的主要環境。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>也是Google分享了istio在網路流量治理的變革，以前，要使用istio進行Kubernetes流量治理與管理，是採用sidecar的方式，也就是說，在Kubernetes平台中，每起一個Pod(服務)，都得伴隨著一個邊車容器Sidecar，每個Pod(服務)流量進出，都得經過Sidecar，對於整個Kubernetes平台，侵入性非常高，等於現在如果有100個Pod(服務)，就得起100個Sidecar容器，對於Kubernetes平台的資源消耗也非常高，變革後，採用Istio Ambient Mesh，不用每個Pod都得起一個Sidecar容器，現在是改在每個Node節點部屬流量治理，容器改連至那裡，進行流量治理與管理，大大了減少整體Kubernetes平台性能與資源消耗，並能針對L4層和L7層，分別進行流量管理與治理。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>兩天下來，幾乎8成的公司，都是採用GitOps的方式，進行Kubernetes的業務部屬和管理，看到最多的方式，就是採用Argocd開源專案。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>再來是中華開發金分享的，如何讓主管們都聽的懂Kubernetes，當然關係到此專案最終能否執行下去，一定還是成本考量，如果達不到省錢，要老闆掏錢出來，難上加難。基於這個點往前探討，如何讓業務和PM單位聽的懂，需將系統與業務上的關連和影響點出來，讓他們知道，有什麼益處，能幫助到他們什麼。再來如何讓資訊單位聽的懂，需將現況系統遇到的瓶頸與導入後的關連和影響點出來，並將系統高可用、高彈性、穩定&amp;hellip;等益處突顯出來。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>再來是Line Pay，太讓我驚訝了，還沒有用到GitOps方式，他們在Kubernetes DevOps這方面，還是用傳統的方式，寫一個模版，透過linux指令sed，去替換模版裡面的變數，去部屬服務，當然講者的說法是，他們還是求穩定，所以才採取這個方式，當然未來也不排除會導入Argocd這個專案，讓他們管理起來更有效率。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>再來是Suse分享的資安攻防，Suse Rancher NeuVector這項開源產品，我已經聽過第二次了，非常好的產品，能跟Rancher平台直接做結合，部屬起來，非常方便，功能也非常強大，鏡像掃描、異常流量阻斷&amp;hellip;等。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>再來是玉山銀行分享的如何在內部用 K8s 打造無伺服器批次運算平台，由於玉山銀行內部，有專門跑排程的主機，好幾百台，佔用了非常多伺服器資源，他們將跑排程的主機改用Kubernetes裡面的一個Pod功能叫Job，需要跑排程時，Kubernetes會起一個一次性任務的Pod，執行完任務，Pod就會自動刪除，讓他們大大節省了伺服器資源的使用。&lt;/p>
&lt;/li>
&lt;/ol></description></item><item><title>kubeadm安裝 高可用版(ubuntu2204+k8s版本1.26.3+docker+cri-docker)</title><link>https://blog.goldfishbrain-fighting.com/2023/kubernetes-install/</link><pubDate>Sat, 07 Oct 2023 02:30:00 +0800</pubDate><guid>https://blog.goldfishbrain-fighting.com/2023/kubernetes-install/</guid><description>&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-install/media/Pasted-image-20230919205815.png"
width="1057"
height="723"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-install/media/Pasted-image-20230919205815_hu68c64d2de39064ad11cfc1877399bd32_320279_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-install/media/Pasted-image-20230919205815_hu68c64d2de39064ad11cfc1877399bd32_320279_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230919205815.png"
class="gallery-image"
data-flex-grow="146"
data-flex-basis="350px"
>&lt;/p>
&lt;h2 id="一節點規劃">一、節點規劃&lt;/h2>
&lt;p>部署k8s集群的節點按照用途可以劃分為如下2類角色：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>master&lt;/strong>：集群的master節點，集群的初始化節點，基礎配置不低於2C4G&lt;/li>
&lt;li>&lt;strong>node&lt;/strong>：集群的node節點，可以多台，基礎配置不低於2C4G&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>K8S實體機網段: 192.168.1.0/24&lt;/strong>&lt;/p>
&lt;p>&lt;strong>POD網段: 10.244.0.0/16&lt;/strong>&lt;/p>
&lt;p>&lt;strong>SERVICE網段: 10.245.0.0/16&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>主機名&lt;/th>
&lt;th>節點ip&lt;/th>
&lt;th>角色&lt;/th>
&lt;th>部署組件&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>k8s-master71u&lt;/td>
&lt;td>192.168.1.71&lt;/td>
&lt;td>master&lt;/td>
&lt;td>etcd, kube-apiserver, kube-controller-manager, kubectl, kubeadm, kubelet, kube-proxy, calico&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>k8s-master72u&lt;/td>
&lt;td>192.168.1.72&lt;/td>
&lt;td>master&lt;/td>
&lt;td>etcd, kube-apiserver, kube-controller-manager, kubectl, kubeadm, kubelet, kube-proxy, calico&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>k8s-master73u&lt;/td>
&lt;td>192.168.1.73&lt;/td>
&lt;td>master&lt;/td>
&lt;td>etcd, kube-apiserver, kube-controller-manager, kubectl, kubeadm, kubelet, kube-proxy, calico&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>&lt;strong>192.168.1.74&lt;/strong>&lt;/td>
&lt;td>VIP&lt;/td>
&lt;td>作為3台master節點的LB使用&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>k8s-node75u&lt;/td>
&lt;td>k8s-node75u&lt;/td>
&lt;td>node&lt;/td>
&lt;td>kubectl, kubelet, kube-proxy, calico&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>k8s-node76u&lt;/td>
&lt;td>k8s-node76u&lt;/td>
&lt;td>node&lt;/td>
&lt;td>kubectl, kubelet, kube-proxy, calico&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="二組件版本">二、組件版本&lt;/h2>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>組件&lt;/th>
&lt;th>版本&lt;/th>
&lt;th>說明&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Ubuntu&lt;/td>
&lt;td>22.04.3 LTS&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Kernel&lt;/td>
&lt;td>5.15.0-83-generic&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>etcd&lt;/td>
&lt;td>3.5.6-0&lt;/td>
&lt;td>使用Pod方式部署，默認數據掛載到本地路徑&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>coredns&lt;/td>
&lt;td>v1.9.3&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>kubeadm&lt;/td>
&lt;td>v1.26.3&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>kubectl&lt;/td>
&lt;td>v1.26.3&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>kubelet&lt;/td>
&lt;td>v1.26.3&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>kube-proxy&lt;/td>
&lt;td>v1.26.3&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>calico&lt;/td>
&lt;td>v3.26.0&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cri-dockerd&lt;/td>
&lt;td>0.3.3.3-0&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h1 id="安裝前準備">安裝前準備&lt;/h1>
&lt;h2 id="一設置hosts解析">一、設置hosts解析&lt;/h2>
&lt;p>操作節點：所有節點（&lt;code>k8s-master，k8s-node&lt;/code>）均需執行&lt;/p>
&lt;ul>
&lt;li>&lt;strong>添加hosts解析&lt;/strong>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat &amp;gt;&amp;gt;/etc/hosts&lt;span class="s">&amp;lt;&amp;lt;EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">192.168.1.71 k8s-master71u
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">192.168.1.72 k8s-master72u
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">192.168.1.73 k8s-master73u
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">192.168.1.75 k8s-node75u
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">192.168.1.76 k8s-node76u
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat /etc/hosts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">127.0.0.1 localhost
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">127.0.1.1 k8s-master71u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># The following lines are desirable for IPv6 capable hosts&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">::1 ip6-localhost ip6-loopback
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fe00::0 ip6-localnet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ff00::0 ip6-mcastprefix
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ff02::1 ip6-allnodes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ff02::2 ip6-allrouters
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.71 k8s-master71u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.72 k8s-master72u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.73 k8s-master73u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.75 k8s-node75u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.76 k8s-node76u
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="二調整系統配置">二、調整系統配置&lt;/h2>
&lt;p>操作節點： 所有的master和node節點（&lt;code>k8s-master,k8s-node&lt;/code>）需要執行&lt;/p>
&lt;blockquote>
&lt;p>本章下述操作均以k8s-master為例，其他節點均是相同的操作（ip和hostname的值換成對應機器的真實值）&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>&lt;strong>設置安全組開放端口&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>如果節點間無安全組限制（內網機器間可以任意訪問），可以忽略，否則，至少保證如下端口可通： k8s-master節點：TCP：6443，2379，2380，60080，60081UDP協議端口全部打開 k8s-node節點：UDP協議端口全部打開&lt;/p>
&lt;ul>
&lt;li>&lt;strong>關閉防火牆&lt;/strong>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# ufw status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Status: inactive
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>&lt;strong>關閉swap&lt;/strong>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# swapoff -a &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> sysctl -w vm.swappiness&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vm.swappiness &lt;span class="o">=&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# sed -i &lt;span class="s1">&amp;#39;s/.*swap.*/#&amp;amp;/g&amp;#39;&lt;/span> /etc/fstab
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#/dev/disk/by-id/dm-uuid-LVM-kAtY9KpfwxzNTDEpBzFkOODzcZgK93hc3OfpHLBwOVbgBZUOZC21pLNScKzDP2aI none swap sw 0 0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>&lt;strong>修改內核參數&lt;/strong>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat &lt;span class="s">&amp;lt;&amp;lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">overlay
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">br_netfilter
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl restart systemd-modules-load.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl status systemd-modules-load.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">● systemd-modules-load.service - Load Kernel Modules
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Loaded: loaded &lt;span class="o">(&lt;/span>/lib/systemd/system/systemd-modules-load.service&lt;span class="p">;&lt;/span> static&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Active: active &lt;span class="o">(&lt;/span>exited&lt;span class="o">)&lt;/span> since Wed 2023-09-20 00:23:11 UTC&lt;span class="p">;&lt;/span> 6s ago
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Docs: man:systemd-modules-load.service&lt;span class="o">(&lt;/span>8&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> man:modules-load.d&lt;span class="o">(&lt;/span>5&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Process: &lt;span class="m">2322&lt;/span> &lt;span class="nv">ExecStart&lt;/span>&lt;span class="o">=&lt;/span>/lib/systemd/systemd-modules-load &lt;span class="o">(&lt;/span>&lt;span class="nv">code&lt;/span>&lt;span class="o">=&lt;/span>exited, &lt;span class="nv">status&lt;/span>&lt;span class="o">=&lt;/span>0/SUCCESS&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Main PID: &lt;span class="m">2322&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="nv">code&lt;/span>&lt;span class="o">=&lt;/span>exited, &lt;span class="nv">status&lt;/span>&lt;span class="o">=&lt;/span>0/SUCCESS&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CPU: 39ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sep &lt;span class="m">20&lt;/span> 00:23:11 k8s-master71u systemd&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span>: Starting Load Kernel Modules...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sep &lt;span class="m">20&lt;/span> 00:23:11 k8s-master71u systemd-modules-load&lt;span class="o">[&lt;/span>2322&lt;span class="o">]&lt;/span>: Inserted module &lt;span class="s1">&amp;#39;overlay&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sep &lt;span class="m">20&lt;/span> 00:23:11 k8s-master71u systemd-modules-load&lt;span class="o">[&lt;/span>2322&lt;span class="o">]&lt;/span>: Inserted module &lt;span class="s1">&amp;#39;br_netfilter&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sep &lt;span class="m">20&lt;/span> 00:23:11 k8s-master71u systemd&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span>: Finished Load Kernel Modules.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# lsmod &lt;span class="p">|&lt;/span>grep -e overlay
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">overlay &lt;span class="m">151552&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# lsmod &lt;span class="p">|&lt;/span>grep -e br_netfilter
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">br_netfilter &lt;span class="m">32768&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bridge &lt;span class="m">307200&lt;/span> &lt;span class="m">1&lt;/span> br_netfilter
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat &lt;span class="s">&amp;lt;&amp;lt;EOF &amp;gt; /etc/sysctl.d/k8s.conf
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">vm.max_map_count=262144
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">net.ipv4.ip_forward = 1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">net.bridge.bridge-nf-call-iptables = 1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">net.bridge.bridge-nf-call-ip6tables = 1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">vm.overcommit_memory=1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">vm.panic_on_oom=0
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">fs.inotify.max_user_watches=89100
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">fs.file-max=52706963
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">fs.nr_open=52706963
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">net.netfilter.nf_conntrack_max=2310720
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">net.ipv4.tcp_keepalive_time = 600
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">net.ipv4.tcp_keepalive_probes = 3
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">net.ipv4.tcp_keepalive_intvl =15
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">net.ipv4.tcp_max_tw_buckets = 36000
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">net.ipv4.tcp_tw_reuse = 1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">net.ipv4.tcp_max_orphans = 327680
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">net.ipv4.tcp_orphan_retries = 3
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">net.ipv4.tcp_syncookies = 1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">net.ipv4.tcp_max_syn_backlog = 16384
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">net.ipv4.tcp_max_syn_backlog = 16384
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">net.ipv4.tcp_timestamps = 0
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">net.core.somaxconn = 16384
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# sysctl -p /etc/sysctl.d/k8s.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vm.max_map_count &lt;span class="o">=&lt;/span> &lt;span class="m">262144&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.ip_forward &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.bridge.bridge-nf-call-iptables &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.bridge.bridge-nf-call-ip6tables &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vm.overcommit_memory &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vm.panic_on_oom &lt;span class="o">=&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fs.inotify.max_user_watches &lt;span class="o">=&lt;/span> &lt;span class="m">89100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fs.file-max &lt;span class="o">=&lt;/span> &lt;span class="m">52706963&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fs.nr_open &lt;span class="o">=&lt;/span> &lt;span class="m">52706963&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sysctl: cannot stat /proc/sys/net/netfilter/nf_conntrack_max: No such file or directory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_keepalive_time &lt;span class="o">=&lt;/span> &lt;span class="m">600&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_keepalive_probes &lt;span class="o">=&lt;/span> &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_keepalive_intvl &lt;span class="o">=&lt;/span> &lt;span class="m">15&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_max_tw_buckets &lt;span class="o">=&lt;/span> &lt;span class="m">36000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_tw_reuse &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_max_orphans &lt;span class="o">=&lt;/span> &lt;span class="m">327680&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_orphan_retries &lt;span class="o">=&lt;/span> &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_syncookies &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_max_syn_backlog &lt;span class="o">=&lt;/span> &lt;span class="m">16384&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_max_syn_backlog &lt;span class="o">=&lt;/span> &lt;span class="m">16384&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_timestamps &lt;span class="o">=&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.core.somaxconn &lt;span class="o">=&lt;/span> &lt;span class="m">16384&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 報錯&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sysctl: cannot stat /proc/sys/net/netfilter/nf_conntrack_max: 沒有此一檔案或目錄
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 解決方式&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# modprobe ip_conntrack
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# sysctl -p /etc/sysctl.d/k8s.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vm.max_map_count &lt;span class="o">=&lt;/span> &lt;span class="m">262144&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.ip_forward &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.bridge.bridge-nf-call-iptables &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.bridge.bridge-nf-call-ip6tables &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vm.overcommit_memory &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vm.panic_on_oom &lt;span class="o">=&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fs.inotify.max_user_watches &lt;span class="o">=&lt;/span> &lt;span class="m">89100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fs.file-max &lt;span class="o">=&lt;/span> &lt;span class="m">52706963&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fs.nr_open &lt;span class="o">=&lt;/span> &lt;span class="m">52706963&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.netfilter.nf_conntrack_max &lt;span class="o">=&lt;/span> &lt;span class="m">2310720&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_keepalive_time &lt;span class="o">=&lt;/span> &lt;span class="m">600&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_keepalive_probes &lt;span class="o">=&lt;/span> &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_keepalive_intvl &lt;span class="o">=&lt;/span> &lt;span class="m">15&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_max_tw_buckets &lt;span class="o">=&lt;/span> &lt;span class="m">36000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_tw_reuse &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_max_orphans &lt;span class="o">=&lt;/span> &lt;span class="m">327680&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_orphan_retries &lt;span class="o">=&lt;/span> &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_syncookies &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_max_syn_backlog &lt;span class="o">=&lt;/span> &lt;span class="m">16384&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_max_syn_backlog &lt;span class="o">=&lt;/span> &lt;span class="m">16384&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_timestamps &lt;span class="o">=&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.core.somaxconn &lt;span class="o">=&lt;/span> &lt;span class="m">16384&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>&lt;strong>添加ipvs，安裝套件&lt;/strong>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# apt -y install ipvsadm ipset sysstat conntrack libseccomp2 libseccomp-dev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat &amp;gt; /etc/modules-load.d/ipvs.conf &lt;span class="s">&amp;lt;&amp;lt; EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">ip_vs
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">ip_vs_lc
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">ip_vs_wlc
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">ip_vs_rr
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">ip_vs_wrr
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">ip_vs_lblc
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">ip_vs_lblcr
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">ip_vs_dh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">ip_vs_sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">ip_vs_fo
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">ip_vs_nq
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">ip_vs_sed
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">ip_vs_ftp
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">nf_conntrack
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">ip_tables
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">ip_set
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">xt_set
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">ipt_set
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">ipt_rpfilter
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">ipt_REJECT
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">ipip
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl restart systemd-modules-load.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl status systemd-modules-load.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">● systemd-modules-load.service - Load Kernel Modules
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Loaded: loaded &lt;span class="o">(&lt;/span>/lib/systemd/system/systemd-modules-load.service&lt;span class="p">;&lt;/span> static&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Active: active &lt;span class="o">(&lt;/span>exited&lt;span class="o">)&lt;/span> since Wed 2023-09-20 00:28:06 UTC&lt;span class="p">;&lt;/span> 7s ago
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Docs: man:systemd-modules-load.service&lt;span class="o">(&lt;/span>8&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> man:modules-load.d&lt;span class="o">(&lt;/span>5&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Process: &lt;span class="m">3116&lt;/span> &lt;span class="nv">ExecStart&lt;/span>&lt;span class="o">=&lt;/span>/lib/systemd/systemd-modules-load &lt;span class="o">(&lt;/span>&lt;span class="nv">code&lt;/span>&lt;span class="o">=&lt;/span>exited, &lt;span class="nv">status&lt;/span>&lt;span class="o">=&lt;/span>0/SUCCESS&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Main PID: &lt;span class="m">3116&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="nv">code&lt;/span>&lt;span class="o">=&lt;/span>exited, &lt;span class="nv">status&lt;/span>&lt;span class="o">=&lt;/span>0/SUCCESS&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CPU: 76ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sep &lt;span class="m">20&lt;/span> 00:28:06 k8s-master71u systemd-modules-load&lt;span class="o">[&lt;/span>3116&lt;span class="o">]&lt;/span>: Inserted module &lt;span class="s1">&amp;#39;ip_vs_fo&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sep &lt;span class="m">20&lt;/span> 00:28:06 k8s-master71u systemd-modules-load&lt;span class="o">[&lt;/span>3116&lt;span class="o">]&lt;/span>: Inserted module &lt;span class="s1">&amp;#39;ip_vs_nq&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sep &lt;span class="m">20&lt;/span> 00:28:06 k8s-master71u systemd-modules-load&lt;span class="o">[&lt;/span>3116&lt;span class="o">]&lt;/span>: Inserted module &lt;span class="s1">&amp;#39;ip_vs_sed&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sep &lt;span class="m">20&lt;/span> 00:28:06 k8s-master71u systemd-modules-load&lt;span class="o">[&lt;/span>3116&lt;span class="o">]&lt;/span>: Inserted module &lt;span class="s1">&amp;#39;ip_vs_ftp&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sep &lt;span class="m">20&lt;/span> 00:28:06 k8s-master71u systemd-modules-load&lt;span class="o">[&lt;/span>3116&lt;span class="o">]&lt;/span>: Inserted module &lt;span class="s1">&amp;#39;ip_set&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sep &lt;span class="m">20&lt;/span> 00:28:06 k8s-master71u systemd-modules-load&lt;span class="o">[&lt;/span>3116&lt;span class="o">]&lt;/span>: Inserted module &lt;span class="s1">&amp;#39;xt_set&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sep &lt;span class="m">20&lt;/span> 00:28:06 k8s-master71u systemd-modules-load&lt;span class="o">[&lt;/span>3116&lt;span class="o">]&lt;/span>: Inserted module &lt;span class="s1">&amp;#39;ipt_rpfilter&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sep &lt;span class="m">20&lt;/span> 00:28:06 k8s-master71u systemd-modules-load&lt;span class="o">[&lt;/span>3116&lt;span class="o">]&lt;/span>: Inserted module &lt;span class="s1">&amp;#39;ipt_REJECT&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sep &lt;span class="m">20&lt;/span> 00:28:06 k8s-master71u systemd-modules-load&lt;span class="o">[&lt;/span>3116&lt;span class="o">]&lt;/span>: Inserted module &lt;span class="s1">&amp;#39;ipip&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sep &lt;span class="m">20&lt;/span> 00:28:06 k8s-master71u systemd&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span>: Finished Load Kernel Modules.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# lsmod &lt;span class="p">|&lt;/span>grep -e ip_vs -e nf_conntrack_ipv4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip_vs_ftp &lt;span class="m">16384&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nf_nat &lt;span class="m">49152&lt;/span> &lt;span class="m">1&lt;/span> ip_vs_ftp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip_vs_sed &lt;span class="m">16384&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip_vs_nq &lt;span class="m">16384&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip_vs_fo &lt;span class="m">16384&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip_vs_sh &lt;span class="m">16384&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip_vs_dh &lt;span class="m">16384&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip_vs_lblcr &lt;span class="m">16384&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip_vs_lblc &lt;span class="m">16384&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip_vs_wrr &lt;span class="m">16384&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip_vs_rr &lt;span class="m">16384&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip_vs_wlc &lt;span class="m">16384&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip_vs_lc &lt;span class="m">16384&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip_vs &lt;span class="m">176128&lt;/span> &lt;span class="m">24&lt;/span> ip_vs_wlc,ip_vs_rr,ip_vs_dh,ip_vs_lblcr,ip_vs_sh,ip_vs_fo,ip_vs_nq,ip_vs_lblc,ip_vs_wrr,ip_vs_lc,ip_vs_sed,ip_vs_ftp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nf_conntrack &lt;span class="m">172032&lt;/span> &lt;span class="m">2&lt;/span> nf_nat,ip_vs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nf_defrag_ipv6 &lt;span class="m">24576&lt;/span> &lt;span class="m">2&lt;/span> nf_conntrack,ip_vs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">libcrc32c &lt;span class="m">16384&lt;/span> &lt;span class="m">7&lt;/span> nf_conntrack,nf_nat,btrfs,nf_tables,xfs,raid456,ip_vs
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="三安裝docker">三、安裝docker&lt;/h2>
&lt;p>所有的master和node節點（&lt;code>k8s-master,k8s-node&lt;/code>）需要執行&lt;/p>
&lt;p>&lt;a class="link" href="https://docs.docker.com/engine/install/ubuntu/" target="_blank" rel="noopener"
>https://docs.docker.com/engine/install/ubuntu/&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 1. Update the apt package index and install packages to allow apt to use a repository over HTTPS:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo apt-get update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo apt-get install ca-certificates curl gnupg
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 2. Add Docker’s official GPG key:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo install -m &lt;span class="m">0755&lt;/span> -d /etc/apt/keyrings
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -fsSL https://download.docker.com/linux/ubuntu/gpg &lt;span class="p">|&lt;/span> sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo chmod a+r /etc/apt/keyrings/docker.gpg
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 3. Use the following command to set up the repository:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> &lt;span class="s2">&amp;#34;deb [arch=&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>dpkg --print-architecture&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34; signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>. /etc/os-release &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$VERSION_CODENAME&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34; stable&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> sudo tee /etc/apt/sources.list.d/docker.list &amp;gt; /dev/null
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 4. 檢查是否已經添加源&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat /etc/apt/sources.list.d/docker.list
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deb &lt;span class="o">[&lt;/span>&lt;span class="nv">arch&lt;/span>&lt;span class="o">=&lt;/span>amd64 signed-by&lt;span class="o">=&lt;/span>/etc/apt/keyrings/docker.gpg&lt;span class="o">]&lt;/span> https://download.docker.com/linux/ubuntu jammy stable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 5. Update the apt package index&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo apt-get update
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看所有的可用版本&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# apt-cache madison docker-ce &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{ print $3 }&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:24.0.6-1~ubuntu.22.04~jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:24.0.5-1~ubuntu.22.04~jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:24.0.4-1~ubuntu.22.04~jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:24.0.3-1~ubuntu.22.04~jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:24.0.2-1~ubuntu.22.04~jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:24.0.1-1~ubuntu.22.04~jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:24.0.0-1~ubuntu.22.04~jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:23.0.6-1~ubuntu.22.04~jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:23.0.5-1~ubuntu.22.04~jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:23.0.4-1~ubuntu.22.04~jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:23.0.3-1~ubuntu.22.04~jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:23.0.2-1~ubuntu.22.04~jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:23.0.1-1~ubuntu.22.04~jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:23.0.0-1~ubuntu.22.04~jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:20.10.24~3-0~ubuntu-jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:20.10.23~3-0~ubuntu-jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:20.10.22~3-0~ubuntu-jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:20.10.21~3-0~ubuntu-jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:20.10.20~3-0~ubuntu-jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:20.10.19~3-0~ubuntu-jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:20.10.18~3-0~ubuntu-jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:20.10.17~3-0~ubuntu-jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:20.10.16~3-0~ubuntu-jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:20.10.15~3-0~ubuntu-jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:20.10.14~3-0~ubuntu-jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:20.10.13~3-0~ubuntu-jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 指定版本，安裝docker-ce&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# &lt;span class="nv">VERSION_STRING&lt;/span>&lt;span class="o">=&lt;/span>5:20.10.13~3-0~ubuntu-jammy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# sudo apt-get install docker-ce&lt;span class="o">=&lt;/span>&lt;span class="nv">$VERSION_STRING&lt;/span> docker-ce-cli&lt;span class="o">=&lt;/span>&lt;span class="nv">$VERSION_STRING&lt;/span> containerd.io
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## 配置docker使用cgroupdriver=systemd&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# mkdir -p /etc/docker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# vim /etc/docker/daemon.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;exec-opts&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;native.cgroupdriver=systemd&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl daemon-reload
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl restart docker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## 啟動docker&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl &lt;span class="nb">enable&lt;/span> docker &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> systemctl start docker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl status docker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## 測試起一個容器&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# sudo docker run hello-world
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Unable to find image &lt;span class="s1">&amp;#39;hello-world:latest&amp;#39;&lt;/span> locally
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">latest: Pulling from library/hello-world
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">719385e32844: Pull &lt;span class="nb">complete&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Digest: sha256:4f53e2564790c8e7856ec08e384732aa38dc43c52f02952483e3f003afbf23db
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Status: Downloaded newer image &lt;span class="k">for&lt;/span> hello-world:latest
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Hello from Docker!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="四安裝cri-docker">四、安裝cri-docker&lt;/h2>
&lt;p>所有的master和node節點（&lt;code>k8s-master,k8s-node&lt;/code>）需要執行&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/Mirantis/cri-dockerd" target="_blank" rel="noopener"
>https://github.com/Mirantis/cri-dockerd&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# wget https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.3/cri-dockerd_0.3.3.3-0.ubuntu-jammy_amd64.deb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# sudo dpkg -i cri-dockerd_0.3.3.3-0.ubuntu-jammy_amd64.deb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl daemon-reload
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl &lt;span class="nb">enable&lt;/span> cri-docker &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> systemctl start cri-docker &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> systemctl status cri-docker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">● cri-docker.service - CRI Interface &lt;span class="k">for&lt;/span> Docker Application Container Engine
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Loaded: loaded &lt;span class="o">(&lt;/span>/lib/systemd/system/cri-docker.service&lt;span class="p">;&lt;/span> enabled&lt;span class="p">;&lt;/span> vendor preset: enabled&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Active: active &lt;span class="o">(&lt;/span>running&lt;span class="o">)&lt;/span> since Wed 2023-09-20 00:44:58 UTC&lt;span class="p">;&lt;/span> 25s ago
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TriggeredBy: ● cri-docker.socket
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Docs: https://docs.mirantis.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Main PID: &lt;span class="m">5055&lt;/span> &lt;span class="o">(&lt;/span>cri-dockerd&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Tasks: &lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Memory: 9.8M
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CPU: 83ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CGroup: /system.slice/cri-docker.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └─5055 /usr/bin/cri-dockerd --container-runtime-endpoint fd://
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sep &lt;span class="m">20&lt;/span> 00:44:58 k8s-master71u cri-dockerd&lt;span class="o">[&lt;/span>5055&lt;span class="o">]&lt;/span>: &lt;span class="nv">time&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;2023-09-20T00:44:58Z&amp;#34;&lt;/span> &lt;span class="nv">level&lt;/span>&lt;span class="o">=&lt;/span>info &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Start docker client with reque&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Sep 20 00:44:58 k8s-master71u cri-dockerd[5055]: time=&amp;#34;&lt;/span>2023-09-20T00:44:58Z&lt;span class="s2">&amp;#34; level=info msg=&amp;#34;&lt;/span>Hairpin mode is &lt;span class="nb">set&lt;/span> to none&lt;span class="s2">&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Sep 20 00:44:58 k8s-master71u cri-dockerd[5055]: time=&amp;#34;&lt;/span>2023-09-20T00:44:58Z&lt;span class="s2">&amp;#34; level=info msg=&amp;#34;&lt;/span>Loaded network plugin cni&lt;span class="s2">&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Sep 20 00:44:58 k8s-master71u cri-dockerd[5055]: time=&amp;#34;&lt;/span>2023-09-20T00:44:58Z&lt;span class="s2">&amp;#34; level=info msg=&amp;#34;&lt;/span>Docker cri networking managed &amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sep &lt;span class="m">20&lt;/span> 00:44:58 k8s-master71u cri-dockerd&lt;span class="o">[&lt;/span>5055&lt;span class="o">]&lt;/span>: &lt;span class="nv">time&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;2023-09-20T00:44:58Z&amp;#34;&lt;/span> &lt;span class="nv">level&lt;/span>&lt;span class="o">=&lt;/span>info &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Docker Info: &amp;amp;{ID:ZVOJ:5V6C:QO&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Sep 20 00:44:58 k8s-master71u cri-dockerd[5055]: time=&amp;#34;&lt;/span>2023-09-20T00:44:58Z&lt;span class="s2">&amp;#34; level=info msg=&amp;#34;&lt;/span>Setting cgroupDriver systemd&lt;span class="s2">&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Sep 20 00:44:58 k8s-master71u cri-dockerd[5055]: time=&amp;#34;&lt;/span>2023-09-20T00:44:58Z&lt;span class="s2">&amp;#34; level=info msg=&amp;#34;&lt;/span>Docker cri received runtime co&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sep &lt;span class="m">20&lt;/span> 00:44:58 k8s-master71u cri-dockerd&lt;span class="o">[&lt;/span>5055&lt;span class="o">]&lt;/span>: &lt;span class="nv">time&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;2023-09-20T00:44:58Z&amp;#34;&lt;/span> &lt;span class="nv">level&lt;/span>&lt;span class="o">=&lt;/span>info &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Starting the GRPC backend for &amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Sep 20 00:44:58 k8s-master71u cri-dockerd[5055]: time=&amp;#34;&lt;/span>2023-09-20T00:44:58Z&lt;span class="s2">&amp;#34; level=info msg=&amp;#34;&lt;/span>Start cri-dockerd grpc backend&lt;span class="s2">&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">Sep 20 00:44:58 k8s-master71u systemd[1]: Started CRI Interface for Docker Application Container Engine.
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="初始化集群">初始化集群&lt;/h1>
&lt;h2 id="一安裝kubeadmkubeletkubectl">一、安裝kubeadm、kubelet、kubectl&lt;/h2>
&lt;p>操作節點： 所有的master和node節點(&lt;code>k8s-master,k8s-node&lt;/code>) 需要執行&lt;/p>
&lt;p>&lt;a class="link" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/" target="_blank" rel="noopener"
>https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 1. Update the apt package index and install packages needed to use the Kubernetes apt repository:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo apt-get update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo apt-get install -y apt-transport-https ca-certificates curl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 2. Download the Google Cloud public signing key:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg &lt;span class="p">|&lt;/span> sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-archive-keyring.gpg
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 3. Add the Kubernetes apt repository:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> sudo tee /etc/apt/sources.list.d/kubernetes.list
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 4. 檢查是否已經添加源 &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat /etc/apt/sources.list.d/kubernetes.list
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deb &lt;span class="o">[&lt;/span>signed-by&lt;span class="o">=&lt;/span>/etc/apt/keyrings/kubernetes-archive-keyring.gpg&lt;span class="o">]&lt;/span> https://apt.kubernetes.io/ kubernetes-xenial main
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 5. Update apt package index, install kubelet, kubeadm and kubectl, and pin their version:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo apt-get update
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# sudo apt-get install -y &lt;span class="nv">kubelet&lt;/span>&lt;span class="o">=&lt;/span>1.26.3-00 &lt;span class="nv">kubeadm&lt;/span>&lt;span class="o">=&lt;/span>1.26.3-00 &lt;span class="nv">kubectl&lt;/span>&lt;span class="o">=&lt;/span>1.26.3-00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## 查看kubeadm 版本&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubeadm version
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubeadm version: &lt;span class="p">&amp;amp;&lt;/span>version.Info&lt;span class="o">{&lt;/span>Major:&lt;span class="s2">&amp;#34;1&amp;#34;&lt;/span>, Minor:&lt;span class="s2">&amp;#34;26&amp;#34;&lt;/span>, GitVersion:&lt;span class="s2">&amp;#34;v1.26.3&amp;#34;&lt;/span>, GitCommit:&lt;span class="s2">&amp;#34;9e644106593f3f4aa98f8a84b23db5fa378900bd&amp;#34;&lt;/span>, GitTreeState:&lt;span class="s2">&amp;#34;clean&amp;#34;&lt;/span>, BuildDate:&lt;span class="s2">&amp;#34;2023-03-15T13:38:47Z&amp;#34;&lt;/span>, GoVersion:&lt;span class="s2">&amp;#34;go1.19.7&amp;#34;&lt;/span>, Compiler:&lt;span class="s2">&amp;#34;gc&amp;#34;&lt;/span>, Platform:&lt;span class="s2">&amp;#34;linux/amd64&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## 設置kubelet開機啟動，並使用ipvs與systemd&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# vim /etc/default/kubelet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">KUBE_PROXY_MODE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;ipvs&amp;#34;&lt;/span> &lt;span class="nv">KUBELET_EXTRA_ARGS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;--cgroup-driver=systemd --pod-infra-container-image=registry.k8s.io/pause:3.6&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl &lt;span class="nb">enable&lt;/span> --now kubelet
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="二安裝配置haproxykeepalived">二、安裝配置haproxy、keepalived&lt;/h2>
&lt;p>&lt;font color=red>操作節點： 所有的master&lt;/font>&lt;/p>
&lt;p>注意：如果有兩個集群，都在同一網段內，/etc/keepalived/keepalived.conf裡面的virtual_router_id 60記得要不一樣，不然/var/log/message會一直報錯。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# apt-get install keepalived haproxy -y
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 所有master節點執行,注意替換最後的master節點IP地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# vim /etc/haproxy/haproxy.cfg
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">global
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> maxconn &lt;span class="m">2000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ulimit-n &lt;span class="m">16384&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> log 127.0.0.1 local0 err
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> stats timeout 30s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">defaults
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> log global
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mode http
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option httplog
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeout connect &lt;span class="m">5000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeout client &lt;span class="m">50000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeout server &lt;span class="m">50000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeout http-request 15s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeout http-keep-alive 15s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">frontend monitor-in
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">bind&lt;/span> *:33305
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mode http
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option httplog
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> monitor-uri /monitor
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">frontend k8s-master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">bind&lt;/span> 0.0.0.0:7443
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">bind&lt;/span> 127.0.0.1:7443
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mode tcp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option tcplog
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tcp-request inspect-delay 5s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default_backend k8s-master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">backend k8s-master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mode tcp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option tcplog
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option tcp-check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> balance roundrobin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default-server inter 10s downinter 5s rise &lt;span class="m">2&lt;/span> fall &lt;span class="m">2&lt;/span> slowstart 60s maxconn &lt;span class="m">250&lt;/span> maxqueue &lt;span class="m">256&lt;/span> weight &lt;span class="m">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server k8s-master71u 192.168.1.71:6443 check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server k8s-master72u 192.168.1.72:6443 check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server k8s-master73u 192.168.1.73:6443 check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 在k8s-master71u節點，注意mcast_src_ip換成實際的master1ip地址，virtual_ipaddress換成lb地址，interface要替換成主機IP使用的介面&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# vim /etc/keepalived/keepalived.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! Configuration File &lt;span class="k">for&lt;/span> keepalived
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">global_defs &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router_id LVS_DEVEL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">script_user root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> enable_script_security
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vrrp_script chk_apiserver &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> script &lt;span class="s2">&amp;#34;/etc/keepalived/check_apiserver.sh&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> interval &lt;span class="m">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> weight -5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> fall &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rise &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vrrp_instance VI_1 &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> state MASTER
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> interface ens160
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mcast_src_ip 192.168.1.71
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> virtual_router_id &lt;span class="m">60&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> priority &lt;span class="m">101&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> advert_int &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> authentication &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> auth_type PASS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> auth_pass K8SHA_KA_AUTH
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> virtual_ipaddress &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 192.168.1.74
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> track_script &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> chk_apiserver
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 在k8s-master52u和k8s-master53u分別創建/etc/keepalived/keepalived.conf，注意修改mcast_src_ip和virtual_ipaddress&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#所有master節點配置KeepAlived健康檢查文件：&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# vim /etc/keepalived/check_apiserver.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#!/bin/bash&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">err&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> k in &lt;span class="k">$(&lt;/span>seq &lt;span class="m">1&lt;/span> 3&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">check_code&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>pgrep haproxy&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[[&lt;/span> &lt;span class="nv">$check_code&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span> &lt;span class="o">]]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">err&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>expr &lt;span class="nv">$err&lt;/span> + 1&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sleep &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">err&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[[&lt;/span> &lt;span class="nv">$err&lt;/span> !&lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;0&amp;#34;&lt;/span> &lt;span class="o">]]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;systemctl stop keepalived&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /usr/bin/systemctl stop keepalived
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 啟動haproxy和keepalived----&amp;gt;所有master節點&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# chmod +x /etc/keepalived/check_apiserver.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl daemon-reload
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl &lt;span class="nb">enable&lt;/span> --now haproxy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl &lt;span class="nb">enable&lt;/span> --now keepalived
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl restart haproxy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl restart keepalived
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl status haproxy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# systemctl status keepalived
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 測試lbip是否生效(從node節點測試的)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-node76u:~# telnet 192.168.1.74 &lt;span class="m">7443&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Trying 192.168.1.74...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Connected to 192.168.1.74.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Escape character is &lt;span class="s1">&amp;#39;^]&amp;#39;&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Connection closed by foreign host.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="三初始化配置文件">三、初始化配置文件&lt;/h2>
&lt;p>操作節點： 只在master節點（&lt;code>k8s-master&lt;/code>）執行&lt;/p>
&lt;p>&lt;a class="link" href="https://kubernetes.io/docs/reference/config-api/kubeadm-config.v1beta3/" target="_blank" rel="noopener"
>https://kubernetes.io/docs/reference/config-api/kubeadm-config.v1beta3/&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 1.24.0版本之後，需修改為criSocket: unix:///var/run/cri-dockerd.sock&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 1.27.x版本之後，需修改為apiVersion: kubeadm.k8s.io/v1beta3，v1beta2不能用了&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># imageRepository: k8s.gcr.io已不更新，改imageRepository: registry.k8s.io&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># clusterName: kubernetes -&amp;gt;依自己需求修改&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># dns: type: CoreDNS 已棄用，不用寫&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# vim kubeadm.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: kubeadm.k8s.io/v1beta3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bootstrapTokens:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- groups:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - system:bootstrappers:kubeadm:default-node-token
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> token: 7t2weq.bjbawausm0jaxury
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ttl: 24h0m0s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> usages:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - signing
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - authentication
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: InitConfiguration
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">localAPIEndpoint:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> advertiseAddress: 192.168.1.71
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bindPort: &lt;span class="m">6443&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nodeRegistration:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> criSocket: unix:///var/run/cri-dockerd.sock
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: k8s-master71u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> taints:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - effect: NoSchedule
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> key: node-role.kubernetes.io/master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiServer:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> certSANs:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - 192.168.1.74
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeoutForControlPlane: 4m0s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: kubeadm.k8s.io/v1beta3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">certificatesDir: /etc/kubernetes/pki
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">clusterName: kubernetes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">controlPlaneEndpoint: 192.168.1.74:7443
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">controllerManager: &lt;span class="o">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">etcd:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> local:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dataDir: /var/lib/etcd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">imageRepository: registry.k8s.io
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: ClusterConfiguration
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubernetesVersion: v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">networking:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dnsDomain: cluster.local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> podSubnet: 10.244.0.0/16
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> serviceSubnet: 10.245.0.0/16
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">scheduler: &lt;span class="o">{}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="四提前下載鏡像">四、提前下載鏡像&lt;/h2>
&lt;p>操作節點：所有master節點執行&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubeadm config images list --config kubeadm.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">registry.k8s.io/kube-apiserver:v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">registry.k8s.io/kube-controller-manager:v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">registry.k8s.io/kube-scheduler:v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">registry.k8s.io/kube-proxy:v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">registry.k8s.io/pause:3.9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">registry.k8s.io/etcd:3.5.6-0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">registry.k8s.io/coredns/coredns:v1.9.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubeadm config images pull --config kubeadm.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>config/images&lt;span class="o">]&lt;/span> Pulled registry.k8s.io/kube-apiserver:v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>config/images&lt;span class="o">]&lt;/span> Pulled registry.k8s.io/kube-controller-manager:v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>config/images&lt;span class="o">]&lt;/span> Pulled registry.k8s.io/kube-scheduler:v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>config/images&lt;span class="o">]&lt;/span> Pulled registry.k8s.io/kube-proxy:v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>config/images&lt;span class="o">]&lt;/span> Pulled registry.k8s.io/pause:3.9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>config/images&lt;span class="o">]&lt;/span> Pulled registry.k8s.io/etcd:3.5.6-0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>config/images&lt;span class="o">]&lt;/span> Pulled registry.k8s.io/coredns/coredns:v1.9.3
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="五初始化master節點">五、初始化master節點&lt;/h2>
&lt;p>操作節點：只在master節點（&lt;code>k8s-master&lt;/code>）執行，找一台master執行即可&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubeadm init --config kubeadm.yaml --upload-certs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## 若初始化成功後，最後會提示如下信息：&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Your Kubernetes control-plane has initialized successfully!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">To start using your cluster, you need to run the following as a regular user:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mkdir -p &lt;span class="nv">$HOME&lt;/span>/.kube
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sudo cp -i /etc/kubernetes/admin.conf &lt;span class="nv">$HOME&lt;/span>/.kube/config
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sudo chown &lt;span class="k">$(&lt;/span>id -u&lt;span class="k">)&lt;/span>:&lt;span class="k">$(&lt;/span>id -g&lt;span class="k">)&lt;/span> &lt;span class="nv">$HOME&lt;/span>/.kube/config
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Alternatively, &lt;span class="k">if&lt;/span> you are the root user, you can run:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">export&lt;/span> &lt;span class="nv">KUBECONFIG&lt;/span>&lt;span class="o">=&lt;/span>/etc/kubernetes/admin.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">You should now deploy a pod network to the cluster.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Run &lt;span class="s2">&amp;#34;kubectl apply -f [podnetwork].yaml&amp;#34;&lt;/span> with one of the options listed at:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> https://kubernetes.io/docs/concepts/cluster-administration/addons/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">You can now join any number of the control-plane node running the following &lt;span class="nb">command&lt;/span> on each as root:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> kubeadm join 192.168.1.74:7443 --token 7t2weq.bjbawausm0jaxury &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --discovery-token-ca-cert-hash sha256:86af29371fd57d46a8592782fb4ae158035711372c0541449dcadfdc8f7fc243 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --control-plane --certificate-key a543d4775e0ca9787d4d2936758a3447d189cdae117170512b4de60a23b59e8a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">As a safeguard, uploaded-certs will be deleted in two hours&lt;span class="p">;&lt;/span> If necessary, you can use
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;kubeadm init phase upload-certs --upload-certs&amp;#34;&lt;/span> to reload certs afterward.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Then you can join any number of worker nodes by running the following on each as root:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubeadm join 192.168.1.74:7443 --token 7t2weq.bjbawausm0jaxury &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --discovery-token-ca-cert-hash sha256:86af29371fd57d46a8592782fb4ae158035711372c0541449dcadfdc8f7fc243
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## 接下來按照上述提示信息操作，配置kubectl客戶端的認證&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# mkdir -p &lt;span class="nv">$HOME&lt;/span>/.kube
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# sudo cp -i /etc/kubernetes/admin.conf &lt;span class="nv">$HOME&lt;/span>/.kube/config
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# sudo chown &lt;span class="k">$(&lt;/span>id -u&lt;span class="k">)&lt;/span>:&lt;span class="k">$(&lt;/span>id -g&lt;span class="k">)&lt;/span> &lt;span class="nv">$HOME&lt;/span>/.kube/config
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>若執行初始化過程中出錯，根據錯誤信息調整後，執行 kubeadm reset -f ; ipvsadm &amp;ndash;clear ; rm -rf ~/.kube ; rm -rf /etc/kubernetes/manifests/* ; rm -rf /var/lib/etcd/&lt;/p>
&lt;/blockquote>
&lt;h2 id="六添加其他master節點到集群中">六、添加其他master節點到集群中&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># k8s-master72u主機&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master72u:~# kubeadm join 192.168.1.74:7443 --token 7t2weq.bjbawausm0jaxury &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --discovery-token-ca-cert-hash sha256:86af29371fd57d46a8592782fb4ae158035711372c0541449dcadfdc8f7fc243 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --control-plane --certificate-key a543d4775e0ca9787d4d2936758a3447d189cdae117170512b4de60a23b59e8a &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --cri-socket&lt;span class="o">=&lt;/span>unix:///var/run/cri-dockerd.sock
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master72u:~# mkdir -p &lt;span class="nv">$HOME&lt;/span>/.kube
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master72u:~# sudo cp -i /etc/kubernetes/admin.conf &lt;span class="nv">$HOME&lt;/span>/.kube/config
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master72u:~# sudo chown &lt;span class="k">$(&lt;/span>id -u&lt;span class="k">)&lt;/span>:&lt;span class="k">$(&lt;/span>id -g&lt;span class="k">)&lt;/span> &lt;span class="nv">$HOME&lt;/span>/.kube/config
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># k8s-master73u主機&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master73u:~# kubeadm join 192.168.1.74:7443 --token 7t2weq.bjbawausm0jaxury &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --discovery-token-ca-cert-hash sha256:86af29371fd57d46a8592782fb4ae158035711372c0541449dcadfdc8f7fc243 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --control-plane --certificate-key a543d4775e0ca9787d4d2936758a3447d189cdae117170512b4de60a23b59e8a &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --cri-socket&lt;span class="o">=&lt;/span>unix:///var/run/cri-dockerd.sock
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master73u:~# mkdir -p &lt;span class="nv">$HOME&lt;/span>/.kube
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master73u:~# sudo cp -i /etc/kubernetes/admin.conf &lt;span class="nv">$HOME&lt;/span>/.kube/config
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master73u:~# sudo chown &lt;span class="k">$(&lt;/span>id -u&lt;span class="k">)&lt;/span>:&lt;span class="k">$(&lt;/span>id -g&lt;span class="k">)&lt;/span> &lt;span class="nv">$HOME&lt;/span>/.kube/config
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="七添加node節點到集群中">七、添加node節點到集群中&lt;/h2>
&lt;p>操作節點：所有的node節點（&lt;code>k8s-node&lt;/code>）需要執行 在每台node節點，執行如下命令，該命令是在kubeadm init成功後提示信息中打印出來的，需要替換成實際init後打印出的命令。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># k8s-node75u主機&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-node75u:~# kubeadm join 192.168.1.74:7443 --token 7t2weq.bjbawausm0jaxury &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --discovery-token-ca-cert-hash sha256:86af29371fd57d46a8592782fb4ae158035711372c0541449dcadfdc8f7fc243 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --cri-socket&lt;span class="o">=&lt;/span>unix:///var/run/cri-dockerd.sock
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># k8s-node76u主機&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-node76u:~# kubeadm join 192.168.1.74:7443 --token 7t2weq.bjbawausm0jaxury &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --discovery-token-ca-cert-hash sha256:86af29371fd57d46a8592782fb4ae158035711372c0541449dcadfdc8f7fc243 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --cri-socket&lt;span class="o">=&lt;/span>unix:///var/run/cri-dockerd.sock
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>如果忘記添加命令，可以通過如下命令生成：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ kubeadm token create --print-join-command
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>查看目前node狀況:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get node
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME STATUS ROLES AGE VERSION
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master71u NotReady control-plane 10m v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master72u NotReady control-plane 3m58s v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master73u NotReady control-plane 2m57s v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-node75u NotReady &amp;lt;none&amp;gt; 55s v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-node76u NotReady &amp;lt;none&amp;gt; 51s v1.26.3
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="部署容器網絡calico">部署容器網絡（calico）&lt;/h2>
&lt;p>操作節點：只在master節點（&lt;code>k8s-master&lt;/code>）執行，找一台master執行即可，CNI&lt;/p>
&lt;p>Calico是一個純三層的數據中心網絡方案，是目前Kubernetes主流的網絡方案。&lt;/p>
&lt;p>&lt;a class="link" href="https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart" target="_blank" rel="noopener"
>https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# mkdir calico
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# &lt;span class="nb">cd&lt;/span> calico/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/calico# wget https://raw.githubusercontent.com/projectcalico/calico/v3.26.0/manifests/tigera-operator.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/calico# wget https://raw.githubusercontent.com/projectcalico/calico/v3.26.0/manifests/custom-resources.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/calico# kubectl create -f tigera-operator.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># cidr ip部分，與前面kubeadm init的 --pod-network-cidr指定的一樣。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/calico# vim custom-resources.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># This section includes base Calico installation configuration.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># For more information, see: https://projectcalico.docs.tigera.io/master/reference/installation/api#operator.tigera.io/v1.Installation&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: operator.tigera.io/v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: Installation
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Configures Calico networking.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> calicoNetwork:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Note: The ipPools section cannot be modified post-install.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipPools:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - blockSize: &lt;span class="m">26&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cidr: 10.244.0.0/16
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> encapsulation: VXLANCrossSubnet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> natOutgoing: Enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodeSelector: all&lt;span class="o">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># This section configures the Calico API server.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># For more information, see: https://projectcalico.docs.tigera.io/master/reference/installation/api#operator.tigera.io/v1.APIServer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: operator.tigera.io/v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: APIServer
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spec: &lt;span class="o">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/calico# kubectl create -f custom-resources.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 等Calico Pod都Running，節點也會准備就緒。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/calico# kubectl get pods -n calico-system
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">calico-kube-controllers-676484d755-9llvm 1/1 Running &lt;span class="m">0&lt;/span> 16m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">calico-node-2s4gl 1/1 Running &lt;span class="m">0&lt;/span> 16m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">calico-node-f9dz9 1/1 Running &lt;span class="m">0&lt;/span> 16m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">calico-node-kvc55 1/1 Running &lt;span class="m">0&lt;/span> 16m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">calico-node-l9gb2 1/1 Running &lt;span class="m">0&lt;/span> 16m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">calico-node-xdp42 1/1 Running &lt;span class="m">0&lt;/span> 16m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">calico-typha-98f544f9f-nqc4n 1/1 Running &lt;span class="m">0&lt;/span> 16m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">calico-typha-98f544f9f-plpnn 1/1 Running &lt;span class="m">0&lt;/span> 16m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">calico-typha-98f544f9f-vgrmn 1/1 Running &lt;span class="m">0&lt;/span> 16m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-node-driver-42c8p 2/2 Running &lt;span class="m">0&lt;/span> 16m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-node-driver-kdd42 2/2 Running &lt;span class="m">0&lt;/span> 16m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-node-driver-nxf5d 2/2 Running &lt;span class="m">0&lt;/span> 16m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-node-driver-rphdj 2/2 Running &lt;span class="m">0&lt;/span> 16m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-node-driver-shs2s 2/2 Running &lt;span class="m">0&lt;/span> 16m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/calico# kubectl get node
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME STATUS ROLES AGE VERSION
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master71u Ready control-plane 31m v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master72u Ready control-plane 24m v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master73u Ready control-plane 23m v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-node75u Ready &amp;lt;none&amp;gt; 21m v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-node76u Ready &amp;lt;none&amp;gt; 21m v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/calico# kubectl get pods -n kube-system
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">coredns-787d4945fb-6x8v2 1/1 Running &lt;span class="m">0&lt;/span> 31m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">coredns-787d4945fb-ddpgp 1/1 Running &lt;span class="m">0&lt;/span> 31m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">etcd-k8s-master71u 1/1 Running &lt;span class="m">0&lt;/span> 31m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">etcd-k8s-master72u 1/1 Running &lt;span class="m">0&lt;/span> 24m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">etcd-k8s-master73u 1/1 Running &lt;span class="m">0&lt;/span> 23m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-apiserver-k8s-master71u 1/1 Running &lt;span class="m">0&lt;/span> 31m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-apiserver-k8s-master72u 1/1 Running &lt;span class="m">0&lt;/span> 24m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-apiserver-k8s-master73u 1/1 Running &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>23m ago&lt;span class="o">)&lt;/span> 23m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-controller-manager-k8s-master71u 1/1 Running &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>24m ago&lt;span class="o">)&lt;/span> 31m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-controller-manager-k8s-master72u 1/1 Running &lt;span class="m">0&lt;/span> 24m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-controller-manager-k8s-master73u 1/1 Running &lt;span class="m">0&lt;/span> 22m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-proxy-4rtwz 1/1 Running &lt;span class="m">0&lt;/span> 23m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-proxy-84v9t 1/1 Running &lt;span class="m">0&lt;/span> 24m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-proxy-9bh8t 1/1 Running &lt;span class="m">0&lt;/span> 21m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-proxy-m5gj8 1/1 Running &lt;span class="m">0&lt;/span> 21m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-proxy-x4t5v 1/1 Running &lt;span class="m">0&lt;/span> 31m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-scheduler-k8s-master71u 1/1 Running &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>24m ago&lt;span class="o">)&lt;/span> 31m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-scheduler-k8s-master72u 1/1 Running &lt;span class="m">0&lt;/span> 24m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-scheduler-k8s-master73u 1/1 Running &lt;span class="m">0&lt;/span> 22m
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>註：以後所有yaml文件都只在Master節點執行。&lt;/p>
&lt;p>安裝目錄：/etc/kubernetes/&lt;/p>
&lt;p>組件配置文件目錄：/etc/kubernetes/manifests/&lt;/p>
&lt;h1 id="集群設置">集群設置&lt;/h1>
&lt;h2 id="設置master節點是否可調度可選">設置master節點是否可調度（可選）&lt;/h2>
&lt;p>操作節點：&lt;code>k8s-master&lt;/code>&lt;/p>
&lt;p>默認部署成功後，master節點無法調度業務pod，如需設置master節點也可以參與pod的調度，需執行：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ kubectl taint node k8s-master node-role.kubernetes.io/master:NoSchedule-
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="設置kubectl自動補全">設置kubectl自動補全&lt;/h2>
&lt;p>操作節點：&lt;code>k8s-master&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# apt install -y bash-completion
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# apt install plocate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# locate bash_completion
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# &lt;span class="nb">source&lt;/span> /usr/share/bash-completion/bash_completion
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# &lt;span class="nb">source&lt;/span> &amp;lt;&lt;span class="o">(&lt;/span>kubectl completion bash&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;source &amp;lt;(kubectl completion bash)&amp;#34;&lt;/span> &amp;gt;&amp;gt; ~/.bashrc
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="調整證書過期">調整證書過期&lt;/h1>
&lt;p>使用kubeadm安裝的集群，證書默認有效期為1年，可以通過如下方式修改為10年。&lt;strong>全部master節點都要執行&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/calico# &lt;span class="nb">cd&lt;/span> /etc/kubernetes/pki
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:/etc/kubernetes/pki# &lt;span class="k">for&lt;/span> i in &lt;span class="k">$(&lt;/span>ls *.crt&lt;span class="k">)&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;===== &lt;/span>&lt;span class="nv">$i&lt;/span>&lt;span class="s2"> =====&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> openssl x509 -in &lt;span class="nv">$i&lt;/span> -text -noout &lt;span class="p">|&lt;/span> grep -A &lt;span class="m">3&lt;/span> &lt;span class="s1">&amp;#39;Validity&amp;#39;&lt;/span> &lt;span class="p">;&lt;/span> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> apiserver.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Sep &lt;span class="m">20&lt;/span> 04:42:27 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Sep &lt;span class="m">19&lt;/span> 04:42:27 &lt;span class="m">2024&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> kube-apiserver
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> apiserver-etcd-client.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Sep &lt;span class="m">20&lt;/span> 04:42:28 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Sep &lt;span class="m">19&lt;/span> 04:42:29 &lt;span class="m">2024&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">O&lt;/span> &lt;span class="o">=&lt;/span> system:masters, &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> kube-apiserver-etcd-client
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> apiserver-kubelet-client.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Sep &lt;span class="m">20&lt;/span> 04:42:27 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Sep &lt;span class="m">19&lt;/span> 04:42:27 &lt;span class="m">2024&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">O&lt;/span> &lt;span class="o">=&lt;/span> system:masters, &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> kube-apiserver-kubelet-client
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> ca.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Sep &lt;span class="m">20&lt;/span> 04:42:27 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Sep &lt;span class="m">17&lt;/span> 04:42:27 &lt;span class="m">2033&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">kubernetes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> front-proxy-ca.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Sep &lt;span class="m">20&lt;/span> 04:42:27 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Sep &lt;span class="m">17&lt;/span> 04:42:27 &lt;span class="m">2033&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> front-proxy-ca
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> front-proxy-client.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Sep &lt;span class="m">20&lt;/span> 04:42:27 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Sep &lt;span class="m">19&lt;/span> 04:42:28 &lt;span class="m">2024&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> front-proxy-client
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:/etc/kubernetes/pki# mkdir backup_key&lt;span class="p">;&lt;/span> cp -rp ./* backup_key/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:/etc/kubernetes/pki# git clone https://github.com/yuyicai/update-kube-cert.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:/etc/kubernetes/pki# &lt;span class="nb">cd&lt;/span> update-kube-cert/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:/etc/kubernetes/pki/update-kube-cert# bash update-kubeadm-cert.sh all
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:/etc/kubernetes/pki/update-kube-cert# kubectl -n kube-system delete po kube-apiserver-k8s-master71u kube-apiserver-k8s-master72u kube-apiserver-k8s-master73u kube-controller-manager-k8s-master71u kube-controller-manager-k8s-master72u kube-controller-manager-k8s-master73u kube-scheduler-k8s-master71u kube-scheduler-k8s-master72u kube-scheduler-k8s-master73u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:/etc/kubernetes/pki/update-kube-cert# kubectl get pod -n kube-system
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">coredns-787d4945fb-6x8v2 1/1 Running &lt;span class="m">0&lt;/span> 36m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">coredns-787d4945fb-ddpgp 1/1 Running &lt;span class="m">0&lt;/span> 36m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">etcd-k8s-master71u 1/1 Running &lt;span class="m">0&lt;/span> 36m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">etcd-k8s-master72u 1/1 Running &lt;span class="m">0&lt;/span> 29m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">etcd-k8s-master73u 1/1 Running &lt;span class="m">0&lt;/span> 28m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-apiserver-k8s-master71u 1/1 Running &lt;span class="m">0&lt;/span> 30s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-apiserver-k8s-master72u 1/1 Running &lt;span class="m">0&lt;/span> 30s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-apiserver-k8s-master73u 1/1 Running &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>28m ago&lt;span class="o">)&lt;/span> 30s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-controller-manager-k8s-master71u 1/1 Running &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>29m ago&lt;span class="o">)&lt;/span> 30s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-controller-manager-k8s-master72u 1/1 Running &lt;span class="m">0&lt;/span> 30s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-controller-manager-k8s-master73u 1/1 Running &lt;span class="m">0&lt;/span> 30s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-proxy-4rtwz 1/1 Running &lt;span class="m">0&lt;/span> 28m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-proxy-84v9t 1/1 Running &lt;span class="m">0&lt;/span> 29m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-proxy-9bh8t 1/1 Running &lt;span class="m">0&lt;/span> 26m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-proxy-m5gj8 1/1 Running &lt;span class="m">0&lt;/span> 26m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-proxy-x4t5v 1/1 Running &lt;span class="m">0&lt;/span> 36m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-scheduler-k8s-master71u 1/1 Running &lt;span class="m">2&lt;/span> &lt;span class="o">(&lt;/span>69s ago&lt;span class="o">)&lt;/span> 30s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-scheduler-k8s-master72u 1/1 Running &lt;span class="m">0&lt;/span> 30s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kube-scheduler-k8s-master73u 1/1 Running &lt;span class="m">0&lt;/span> 30s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:/etc/kubernetes/pki/update-kube-cert# &lt;span class="nb">cd&lt;/span> /etc/kubernetes/pki
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:/etc/kubernetes/pki# &lt;span class="k">for&lt;/span> i in &lt;span class="k">$(&lt;/span>ls *.crt&lt;span class="k">)&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;===== &lt;/span>&lt;span class="nv">$i&lt;/span>&lt;span class="s2"> =====&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> openssl x509 -in &lt;span class="nv">$i&lt;/span> -text -noout &lt;span class="p">|&lt;/span> grep -A &lt;span class="m">3&lt;/span> &lt;span class="s1">&amp;#39;Validity&amp;#39;&lt;/span> &lt;span class="p">;&lt;/span> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> apiserver.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Sep &lt;span class="m">20&lt;/span> 05:17:58 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Sep &lt;span class="m">17&lt;/span> 05:17:58 &lt;span class="m">2033&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> kube-apiserver
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> apiserver-etcd-client.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Sep &lt;span class="m">20&lt;/span> 05:17:55 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Sep &lt;span class="m">17&lt;/span> 05:17:55 &lt;span class="m">2033&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">O&lt;/span> &lt;span class="o">=&lt;/span> system:masters, &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> kube-apiserver-etcd-client
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> apiserver-kubelet-client.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Sep &lt;span class="m">20&lt;/span> 05:17:58 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Sep &lt;span class="m">17&lt;/span> 05:17:58 &lt;span class="m">2033&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">O&lt;/span> &lt;span class="o">=&lt;/span> system:masters, &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> kube-apiserver-kubelet-client
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> ca.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Sep &lt;span class="m">20&lt;/span> 04:42:27 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Sep &lt;span class="m">17&lt;/span> 04:42:27 &lt;span class="m">2033&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">kubernetes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> front-proxy-ca.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Sep &lt;span class="m">20&lt;/span> 04:42:27 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Sep &lt;span class="m">17&lt;/span> 04:42:27 &lt;span class="m">2033&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> front-proxy-ca
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=====&lt;/span> front-proxy-client.crt &lt;span class="o">=====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Validity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not Before: Sep &lt;span class="m">20&lt;/span> 05:17:59 &lt;span class="m">2023&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not After : Sep &lt;span class="m">17&lt;/span> 05:17:59 &lt;span class="m">2033&lt;/span> GMT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Subject: &lt;span class="nv">CN&lt;/span> &lt;span class="o">=&lt;/span> front-proxy-client
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="驗證集群">驗證集群&lt;/h1>
&lt;p>操作節點： 在master節點（&lt;code>k8s-master&lt;/code>）執行&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get nodes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME STATUS ROLES AGE VERSION
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master71u Ready control-plane 39m v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master72u Ready control-plane 32m v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-master73u Ready control-plane 31m v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-node75u Ready &amp;lt;none&amp;gt; 29m v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">k8s-node76u Ready &amp;lt;none&amp;gt; 29m v1.26.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl run test-nginx --image&lt;span class="o">=&lt;/span>nginx:alpine
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/test-nginx created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod -o wide
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">test-nginx 1/1 Running &lt;span class="m">0&lt;/span> 21s 10.244.255.195 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# curl 10.244.255.195
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;!DOCTYPE html&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;html&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;head&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;title&amp;gt;Welcome to nginx!&amp;lt;/title&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;style&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">html &lt;span class="o">{&lt;/span> color-scheme: light dark&lt;span class="p">;&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">body &lt;span class="o">{&lt;/span> width: 35em&lt;span class="p">;&lt;/span> margin: &lt;span class="m">0&lt;/span> auto&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">font-family: Tahoma, Verdana, Arial, sans-serif&lt;span class="p">;&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;/style&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;/head&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;body&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;h1&amp;gt;Welcome to nginx!&amp;lt;/h1&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;p&amp;gt;If you see this page, the nginx web server is successfully installed and
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">working. Further configuration is required.&amp;lt;/p&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;p&amp;gt;For online documentation and support please refer to
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;a &lt;span class="nv">href&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;http://nginx.org/&amp;#34;&lt;/span>&amp;gt;nginx.org&amp;lt;/a&amp;gt;.&amp;lt;br/&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Commercial support is available at
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;a &lt;span class="nv">href&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;http://nginx.com/&amp;#34;&lt;/span>&amp;gt;nginx.com&amp;lt;/a&amp;gt;.&amp;lt;/p&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;p&amp;gt;&amp;lt;em&amp;gt;Thank you &lt;span class="k">for&lt;/span> using nginx.&amp;lt;/em&amp;gt;&amp;lt;/p&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;/body&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;/html&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>使用Docker安裝Rancher管理平台，納管現有k8s集群(單節點-非高可用)</title><link>https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/</link><pubDate>Sat, 07 Oct 2023 02:00:00 +0800</pubDate><guid>https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/</guid><description>&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920224620.png"
width="1185"
height="787"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920224620_hu5a39cd61ec6101b6320b865185a3e4e0_367454_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920224620_hu5a39cd61ec6101b6320b865185a3e4e0_367454_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920224620.png"
class="gallery-image"
data-flex-grow="150"
data-flex-basis="361px"
>&lt;/p>
&lt;p>Rancher官網安裝網址：
&lt;a class="link" href="https://ranchermanager.docs.rancher.com/zh/pages-for-subheaders/rancher-on-a-single-node-with-docker" target="_blank" rel="noopener"
>https://ranchermanager.docs.rancher.com/zh/pages-for-subheaders/rancher-on-a-single-node-with-docker&lt;/a>&lt;/p>
&lt;p>最新版Rancher(v2.7.6)能夠納管的kubernetes版本為1.26.4：
&lt;a class="link" href="https://www.suse.com/suse-rancher/support-matrix/all-supported-versions/rancher-v2-7-6/" target="_blank" rel="noopener"
>https://www.suse.com/suse-rancher/support-matrix/all-supported-versions/rancher-v2-7-6/&lt;/a>
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920175154.png"
width="767"
height="576"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920175154_hu01fa84ee148454aed4aa51b480f9836a_40466_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920175154_hu01fa84ee148454aed4aa51b480f9836a_40466_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920175154.png"
class="gallery-image"
data-flex-grow="133"
data-flex-basis="319px"
>&lt;/p>
&lt;h2 id="一rancher-server安裝">一、Rancher Server安裝&lt;/h2>
&lt;h3 id="一使用docker起容器">一、使用docker起容器&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-node75u:~# sudo docker run --privileged -d --restart&lt;span class="o">=&lt;/span>unless-stopped -p 80:80 -p 443:443 rancher/rancher
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-node75u:~# docker ps
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0e92a3ece9cd rancher/rancher &lt;span class="s2">&amp;#34;entrypoint.sh&amp;#34;&lt;/span> &lt;span class="m">4&lt;/span> minutes ago Up About a minute 0.0.0.0:80-&amp;gt;80/tcp, :::80-&amp;gt;80/tcp, 0.0.0.0:443-&amp;gt;443/tcp, :::443-&amp;gt;443/tcp dreamy_rubin
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="二查看初始密碼">二、查看初始密碼&lt;/h3>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920175456.png"
width="766"
height="755"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920175456_hua3986ebe76c28593123877564810c0e5_76029_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920175456_hua3986ebe76c28593123877564810c0e5_76029_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920175456.png"
class="gallery-image"
data-flex-grow="101"
data-flex-basis="243px"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-node75u:~# docker logs 0e92a3ece9cd 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span> &lt;span class="p">|&lt;/span> grep &lt;span class="s2">&amp;#34;Bootstrap Password:&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2023/09/20 09:50:01 &lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> Bootstrap Password: 79j4khgd9952rmn55kdntxt7kwxfn7f7dvpmrsgx6nr7wqblrtpp6l
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="三登入">三、登入&lt;/h3>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920175658.png"
width="783"
height="768"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920175658_hu3d2c40f5d0939a2b52203051317c438e_76967_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920175658_hu3d2c40f5d0939a2b52203051317c438e_76967_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920175658.png"
class="gallery-image"
data-flex-grow="101"
data-flex-basis="244px"
>&lt;/p>
&lt;h3 id="四重新設定admin密碼">四、重新設定admin密碼&lt;/h3>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920175838.png"
width="801"
height="890"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920175838_hu52cba99bffb2683bebf9888bc6b13c40_85503_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920175838_hu52cba99bffb2683bebf9888bc6b13c40_85503_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920175838.png"
class="gallery-image"
data-flex-grow="90"
data-flex-basis="216px"
>
登入成功頁面
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920180029.png"
width="1571"
height="723"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920180029_hufcf2fa2ea45ee7c98df35c55f7b48945_101094_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920180029_hufcf2fa2ea45ee7c98df35c55f7b48945_101094_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920180029.png"
class="gallery-image"
data-flex-grow="217"
data-flex-basis="521px"
>&lt;/p>
&lt;h2 id="二匯入現有集群">二、匯入現有集群&lt;/h2>
&lt;h3 id="一點選import-existing">一、點選Import Existing&lt;/h3>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920180135.png"
width="1568"
height="715"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920180135_hu81920a18e2926839b7b0711657581ae5_100846_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920180135_hu81920a18e2926839b7b0711657581ae5_100846_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920180135.png"
class="gallery-image"
data-flex-grow="219"
data-flex-basis="526px"
>&lt;/p>
&lt;h3 id="二點選import-any-kubernetes-clustergeneric">二、點選Import any Kubernetes cluster(Generic)&lt;/h3>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920180232.png"
width="1241"
height="625"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920180232_hu4d47c145f3344da3a90cc7cca9c878c3_69000_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920180232_hu4d47c145f3344da3a90cc7cca9c878c3_69000_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920180232.png"
class="gallery-image"
data-flex-grow="198"
data-flex-basis="476px"
>&lt;/p>
&lt;h3 id="三填寫cluster-name自己決定以利後續辨識點選create">三、填寫Cluster Name(自己決定，以利後續辨識)，點選Create&lt;/h3>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920180509.png"
width="1563"
height="943"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920180509_hud6431c9eb3b2c5342e0bb099a0106bc5_103694_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920180509_hud6431c9eb3b2c5342e0bb099a0106bc5_103694_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920180509.png"
class="gallery-image"
data-flex-grow="165"
data-flex-basis="397px"
>&lt;/p>
&lt;h3 id="四創建之後會有提供加入的方式選擇第二項">四、創建之後，會有提供加入的方式，選擇第二項&lt;/h3>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920180638.png"
width="1559"
height="805"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920180638_hu962b03cd08d4a0c5eedf892051dab8f4_177154_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920180638_hu962b03cd08d4a0c5eedf892051dab8f4_177154_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920180638.png"
class="gallery-image"
data-flex-grow="193"
data-flex-basis="464px"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># master節點執行&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# curl --insecure -sfL https://192.168.1.75/v3/import/ff4mlx8k768hsz8vmwl89lqhbmcsfbttkxqdtmk4m8pgqsrnd87pqc_c-m-gq2vbtfn.yaml &lt;span class="p">|&lt;/span> kubectl apply -f -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看pod是否都創建成功&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod -n cattle-system -o wide
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cattle-cluster-agent-6c97c478bb-mjgwg 1/1 Running &lt;span class="m">0&lt;/span> 5m 10.244.14.137 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cattle-cluster-agent-6c97c478bb-vdn59 1/1 Running &lt;span class="m">0&lt;/span> 16m 10.244.255.199 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rancher-webhook-74c9bd4d6-znrdp 1/1 Running &lt;span class="m">0&lt;/span> 61s 10.244.255.201 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="五確認現有集群已加入納管">五、確認現有集群已加入納管&lt;/h3>
&lt;p>加入rancher需要一點時間，請耐心等候，如果鏡像拉取失敗，可以手動去下載鏡像&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920183031.png"
width="1573"
height="720"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920183031_hu9e59a4907e63c34faa594edfc314c151_111515_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920183031_hu9e59a4907e63c34faa594edfc314c151_111515_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920183031.png"
class="gallery-image"
data-flex-grow="218"
data-flex-basis="524px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920182502.png"
width="1563"
height="936"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920182502_hu0d54cd16036aa81d0943b0f05cc93b8a_152101_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920182502_hu0d54cd16036aa81d0943b0f05cc93b8a_152101_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920182502.png"
class="gallery-image"
data-flex-grow="166"
data-flex-basis="400px"
>&lt;/p>
&lt;h3 id="六開啟kubectl-shell介面rancher會臨時起一個容器來跑shell指令關閉shell介面容器就會刪除">六、開啟Kubectl Shell介面，Rancher會臨時起一個容器來跑Shell指令，關閉Shell介面，容器就會刪除&lt;/h3>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920182636.png"
width="1568"
height="949"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920182636_hu7038623ebb20f600634e4c858d61cdf9_227476_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920182636_hu7038623ebb20f600634e4c858d61cdf9_227476_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920182636.png"
class="gallery-image"
data-flex-grow="165"
data-flex-basis="396px"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pod -n cattle-system -o wide
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cattle-cluster-agent-6c97c478bb-mjgwg 1/1 Running &lt;span class="m">0&lt;/span> 6m11s 10.244.14.137 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cattle-cluster-agent-6c97c478bb-vdn59 1/1 Running &lt;span class="m">0&lt;/span> 17m 10.244.255.199 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dashboard-shell-75g77 2/2 Running &lt;span class="m">0&lt;/span> 9s 10.244.255.202 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rancher-webhook-74c9bd4d6-znrdp 1/1 Running &lt;span class="m">0&lt;/span> 2m12s 10.244.255.201 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="三加入windows-server-active-directory-ldap">三、加入Windows Server Active Directory (LDAP)&lt;/h2>
&lt;p>Rancher官網設定網址： &lt;a class="link" href="https://ranchermanager.docs.rancher.com/zh/how-to-guides/new-user-guides/authentication-permissions-and-global-configuration/authentication-config/configure-active-directory" target="_blank" rel="noopener"
>https://ranchermanager.docs.rancher.com/zh/how-to-guides/new-user-guides/authentication-permissions-and-global-configuration/authentication-config/configure-active-directory&lt;/a>&lt;/p>
&lt;h3 id="一查看可以整合登入驗證的方式">一、查看可以整合登入驗證的方式&lt;/h3>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920183804.png"
width="277"
height="578"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920183804_hubff23e8276d6d1ee799bc3e36745626f_37911_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920183804_hubff23e8276d6d1ee799bc3e36745626f_37911_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920183804.png"
class="gallery-image"
data-flex-grow="47"
data-flex-basis="115px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920183831.png"
width="1553"
height="713"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920183831_hu316de54a60d50e6d08a5ea8995e319c3_103739_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920183831_hu316de54a60d50e6d08a5ea8995e319c3_103739_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920183831.png"
class="gallery-image"
data-flex-grow="217"
data-flex-basis="522px"
>&lt;/p>
&lt;h3 id="二創建ad使用者供rancher獲取ldap使用者資料">二、創建AD使用者，供Rancher獲取ldap使用者資料&lt;/h3>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920195052.png"
width="1022"
height="672"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920195052_hu4bf1f5dae4f9517e3a6de85d581b01ad_468873_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920195052_hu4bf1f5dae4f9517e3a6de85d581b01ad_468873_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920195052.png"
class="gallery-image"
data-flex-grow="152"
data-flex-basis="365px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920195204.png"
width="508"
height="427"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920195204_hu67582e5b58b9fa956d48e3e1b3025d88_55257_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920195204_hu67582e5b58b9fa956d48e3e1b3025d88_55257_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920195204.png"
class="gallery-image"
data-flex-grow="118"
data-flex-basis="285px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920195303.png"
width="512"
height="430"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920195303_hua519bb2883bb325622ef0a431cf08e34_56340_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920195303_hua519bb2883bb325622ef0a431cf08e34_56340_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920195303.png"
class="gallery-image"
data-flex-grow="119"
data-flex-basis="285px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920195336.png"
width="748"
height="526"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920195336_hu0984df2fb84430bf441ceeaf57952603_246853_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920195336_hu0984df2fb84430bf441ceeaf57952603_246853_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920195336.png"
class="gallery-image"
data-flex-grow="142"
data-flex-basis="341px"
>&lt;/p>
&lt;h3 id="三使用ldapsearch測試一下是否可以查找到剛剛建立的使用者資訊">三、使用ldapsearch測試一下，是否可以查找到剛剛建立的使用者資訊&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">chenqingze@chenqingze-MBP ~ % ldapsearch -x -H &lt;span class="s2">&amp;#34;ldap://192.168.1.49:389&amp;#34;&lt;/span> -D &lt;span class="s2">&amp;#34;jimmyhome\rancheruser&amp;#34;&lt;/span> -w &lt;span class="s2">&amp;#34;密碼&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -b &lt;span class="s2">&amp;#34;dc=jimmyhome,dc=tw&amp;#34;&lt;/span> -s sub &lt;span class="s2">&amp;#34;sAMAccountName=rancheruser&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># extended LDIF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># LDAPv3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># base &amp;lt;dc=jimmyhome,dc=tw&amp;gt; with scope subtree&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># filter: sAMAccountName=rancheruser&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># requesting: ALL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># rancheruser, Users, jimmyhome.tw&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dn: &lt;span class="nv">CN&lt;/span>&lt;span class="o">=&lt;/span>rancheruser,CN&lt;span class="o">=&lt;/span>Users,DC&lt;span class="o">=&lt;/span>jimmyhome,DC&lt;span class="o">=&lt;/span>tw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">objectClass: top
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">objectClass: person
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">objectClass: organizationalPerson
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">objectClass: user
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cn: rancheruser
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">givenName: rancheruser
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">distinguishedName: &lt;span class="nv">CN&lt;/span>&lt;span class="o">=&lt;/span>rancheruser,CN&lt;span class="o">=&lt;/span>Users,DC&lt;span class="o">=&lt;/span>jimmyhome,DC&lt;span class="o">=&lt;/span>tw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">instanceType: &lt;span class="m">4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">whenCreated: 20230920115311.0Z
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">whenChanged: 20230920120448.0Z
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">displayName: rancheruser
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">uSNCreated: &lt;span class="m">16399&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">uSNChanged: &lt;span class="m">16452&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">name: rancheruser
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">objectGUID:: &lt;span class="nv">B9nTPDTyY0ehHZz4mWIJ1Q&lt;/span>&lt;span class="o">==&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">userAccountControl: &lt;span class="m">66048&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">badPwdCount: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">codePage: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">countryCode: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">badPasswordTime: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lastLogoff: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lastLogon: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pwdLastSet: &lt;span class="m">133396843913520620&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">primaryGroupID: &lt;span class="m">513&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">objectSid:: &lt;span class="nv">AQUAAAAAAAUVAAAA2KPkIYA62ax0WlhyTwQAAA&lt;/span>&lt;span class="o">==&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">accountExpires: &lt;span class="m">9223372036854775807&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">logonCount: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sAMAccountName: rancheruser
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sAMAccountType: &lt;span class="m">805306368&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">userPrincipalName: rancheruser@jimmyhome.tw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">objectCategory: &lt;span class="nv">CN&lt;/span>&lt;span class="o">=&lt;/span>Person,CN&lt;span class="o">=&lt;/span>Schema,CN&lt;span class="o">=&lt;/span>Configuration,DC&lt;span class="o">=&lt;/span>jimmyhome,DC&lt;span class="o">=&lt;/span>tw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dSCorePropagationData: 16010101000000.0Z
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lastLogonTimestamp: &lt;span class="m">133396850882972826&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># search reference&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ref: ldap://ForestDnsZones.jimmyhome.tw/DC&lt;span class="o">=&lt;/span>ForestDnsZones,DC&lt;span class="o">=&lt;/span>jimmyhome,DC&lt;span class="o">=&lt;/span>tw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># search reference&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ref: ldap://DomainDnsZones.jimmyhome.tw/DC&lt;span class="o">=&lt;/span>DomainDnsZones,DC&lt;span class="o">=&lt;/span>jimmyhome,DC&lt;span class="o">=&lt;/span>tw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># search reference&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ref: ldap://jimmyhome.tw/CN&lt;span class="o">=&lt;/span>Configuration,DC&lt;span class="o">=&lt;/span>jimmyhome,DC&lt;span class="o">=&lt;/span>tw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># search result&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">search: &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">result: &lt;span class="m">0&lt;/span> Success
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># numResponses: 5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># numEntries: 1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># numReferences: 3&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="四整合ad驗證">四、整合AD驗證&lt;/h3>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920195828.png"
width="1565"
height="752"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920195828_hu32023433e28c58be869cfd4b00a53e0a_109608_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920195828_hu32023433e28c58be869cfd4b00a53e0a_109608_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920195828.png"
class="gallery-image"
data-flex-grow="208"
data-flex-basis="499px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920202516.png"
width="1562"
height="770"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920202516_huf5819385887aa47ed3ad2353805236a5_89123_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920202516_huf5819385887aa47ed3ad2353805236a5_89123_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920202516.png"
class="gallery-image"
data-flex-grow="202"
data-flex-basis="486px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920200440.png"
width="1564"
height="876"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920200440_hu594f130566eb0d55a608ebc53d559d8b_105762_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920200440_hu594f130566eb0d55a608ebc53d559d8b_105762_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920200440.png"
class="gallery-image"
data-flex-grow="178"
data-flex-basis="428px"
>
確認驗證成功，連接到ldap
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920202553.png"
width="1573"
height="400"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920202553_hu55c8f478c070de92d1bbb3a45da7ed62_61301_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920202553_hu55c8f478c070de92d1bbb3a45da7ed62_61301_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920202553.png"
class="gallery-image"
data-flex-grow="393"
data-flex-basis="943px"
>&lt;/p>
&lt;p>可以看到，此時已經自動改成用剛剛驗證的ad帳戶登入了
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920203808.png"
width="1575"
height="444"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920203808_hue9cb7d09133fb0a90ab4f9720061370b_73641_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920203808_hue9cb7d09133fb0a90ab4f9720061370b_73641_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920203808.png"
class="gallery-image"
data-flex-grow="354"
data-flex-basis="851px"
>&lt;/p>
&lt;h3 id="五再到ad創建一個使用者驗證一下是否rancher可以獲取到此使用者帳號">五、再到AD創建一個使用者，驗證一下，是否Rancher可以獲取到此使用者帳號&lt;/h3>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920202931.png"
width="754"
height="530"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920202931_hucce501a8d63116565fd51bf626607f7a_265285_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920202931_hucce501a8d63116565fd51bf626607f7a_265285_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920202931.png"
class="gallery-image"
data-flex-grow="142"
data-flex-basis="341px"
>&lt;/p>
&lt;p>編輯default project(裡面只有一個default namespace)
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920203941.png"
width="1573"
height="652"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920203941_hu85815b49f4cde207d4d8d84c72ff1e58_89204_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920203941_hu85815b49f4cde207d4d8d84c72ff1e58_89204_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920203941.png"
class="gallery-image"
data-flex-grow="241"
data-flex-basis="579px"
>&lt;/p>
&lt;p>添加ldap帳號
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204039.png"
width="1247"
height="487"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204039_hu4d5d91582cc4c220bc6ff9f834b34b84_54173_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204039_hu4d5d91582cc4c220bc6ff9f834b34b84_54173_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920204039.png"
class="gallery-image"
data-flex-grow="256"
data-flex-basis="614px"
>&lt;/p>
&lt;p>可以看到有jimmy帳號
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204053.png"
width="600"
height="515"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204053_hu2abd776d23e2d0a365cc775f8f5692c4_43125_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204053_hu2abd776d23e2d0a365cc775f8f5692c4_43125_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920204053.png"
class="gallery-image"
data-flex-grow="116"
data-flex-basis="279px"
>&lt;/p>
&lt;p>添加此帳號
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204121.png"
width="1573"
height="871"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204121_hu80effc2f7246d9943ad2ff6d835d4b03_79555_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204121_hu80effc2f7246d9943ad2ff6d835d4b03_79555_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920204121.png"
class="gallery-image"
data-flex-grow="180"
data-flex-basis="433px"
>&lt;/p>
&lt;p>登出Rancher，改用jimmy帳號登入，密碼是ad中設定的密碼
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920203512.png"
width="785"
height="724"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920203512_hu88df8f70c9e88da09d43788021a358c2_40923_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920203512_hu88df8f70c9e88da09d43788021a358c2_40923_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920203512.png"
class="gallery-image"
data-flex-grow="108"
data-flex-basis="260px"
>
確認可以登入
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204201.png"
width="1572"
height="664"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204201_hu7ae9ac3b08242c87cd4281f509e35bba_85934_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204201_hu7ae9ac3b08242c87cd4281f509e35bba_85934_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920204201.png"
class="gallery-image"
data-flex-grow="236"
data-flex-basis="568px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204230.png"
width="1561"
height="692"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204230_hud978b472884248a7277e5c20dd0fafaf_82394_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204230_hud978b472884248a7277e5c20dd0fafaf_82394_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920204230.png"
class="gallery-image"
data-flex-grow="225"
data-flex-basis="541px"
>&lt;/p>
&lt;p>可以看到，能查看到default project與default namespace
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204242.png"
width="1568"
height="428"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204242_hu72ca91c4954247a7001523fef5da9ab9_54105_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204242_hu72ca91c4954247a7001523fef5da9ab9_54105_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920204242.png"
class="gallery-image"
data-flex-grow="366"
data-flex-basis="879px"
>&lt;/p>
&lt;p>dashboard shell也是可以使用的，但只能看到default namespace的資源
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204317.png"
width="1562"
height="588"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204317_hu6392b9858d6d8f644485c04ae83482b0_79177_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204317_hu6392b9858d6d8f644485c04ae83482b0_79177_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920204317.png"
class="gallery-image"
data-flex-grow="265"
data-flex-basis="637px"
>&lt;/p>
&lt;p>是無法查看kube-system namespace的資源，確實跟前面設定的權限是符合的
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204411.png"
width="1581"
height="615"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204411_hu365ef24150b6d29b60f3749b249db757_101516_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204411_hu365ef24150b6d29b60f3749b249db757_101516_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920204411.png"
class="gallery-image"
data-flex-grow="257"
data-flex-basis="616px"
>&lt;/p>
&lt;h3 id="六也可以下載連線設定檔到自己常用linux主機連線管理">六、也可以下載連線設定檔到自己常用linux主機，連線管理&lt;/h3>
&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204450.png"
width="1568"
height="509"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204450_hu09d71deb5eec4885ea45686ca35e74b2_90652_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-docker/media/Pasted-image-20230920204450_hu09d71deb5eec4885ea45686ca35e74b2_90652_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230920204450.png"
class="gallery-image"
data-flex-grow="308"
data-flex-basis="739px"
>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 1. 將下載的設定檔，scp到常用linux主機&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chenqingze@chenqingze-MBP ~ % scp /Users/chenqingze/Downloads/kubernetes-config.yml root@192.168.1.76:/root/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 2. 可以看到設定檔&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-node76u:~# ls -l
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total &lt;span class="m">9376&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1396&lt;/span> Sep &lt;span class="m">20&lt;/span> 12:47 kubernetes-config.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 3. 在使用者家目錄下，創建.kube目錄&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-node76u:~# mkdir .kube
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 4. 將設定檔複製到.kube目錄，且命名為config(因kubectl預設就是用.kube/config設定檔連線)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-node76u:~# cp kubernetes-config.yml ~/.kube/config
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 5. 確認可以連線，查看default namespace下的資源&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-node76u:~# kubectl get pod
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">test-nginx 1/1 Running &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>3h20m ago&lt;span class="o">)&lt;/span> 7h26m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 6. 其他namespace下的資源，是無法查看的&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-node76u:~# kubectl get pod -n kube-system
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Error from server &lt;span class="o">(&lt;/span>Forbidden&lt;span class="o">)&lt;/span>: pods is forbidden: User &lt;span class="s2">&amp;#34;u-hx7xy6ap22&amp;#34;&lt;/span> cannot list resource &lt;span class="s2">&amp;#34;pods&amp;#34;&lt;/span> in API group &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span> in the namespace &lt;span class="s2">&amp;#34;kube-system&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>使用Helm安裝Rancher管理平台，納管現有k8s集群(高可用)</title><link>https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/</link><pubDate>Sat, 07 Oct 2023 01:00:00 +0800</pubDate><guid>https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/</guid><description>&lt;p>&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230922172936.png"
width="1323"
height="728"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230922172936_hu707fbbc58435615f6600069941230842_701550_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230922172936_hu707fbbc58435615f6600069941230842_701550_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230922172936.png"
class="gallery-image"
data-flex-grow="181"
data-flex-basis="436px"
>&lt;/p>
&lt;p>安裝先決條件：&lt;/p>
&lt;ul>
&lt;li>kubernetes 集群&lt;/li>
&lt;li>Ingress Controller&lt;/li>
&lt;li>Helm 、kubectl CLI 工具&lt;/li>
&lt;/ul>
&lt;h2 id="一ingress-controller安裝">一、Ingress Controller安裝&lt;/h2>
&lt;p>github網址:&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noopener"
>https://github.com/kubernetes/ingress-nginx&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">chenqingze@chenqingze-MBP ~ % scp /Users/chenqingze/Downloads/ingress-nginx-controller-v1.6.4.tar.gz root@192.168.1.71:/root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# tar -xzvf ingress-nginx-controller-v1.6.4.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# &lt;span class="nb">cd&lt;/span> ingress-nginx-controller-v1.6.4/deploy/static/provider/baremetal
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Deployment改成DaemonSet &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 添加hostNetwork: true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/ingress-nginx-controller-v1.6.4/deploy/static/provider/baremetal# vim deploy.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apiVersion: apps/v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kind: DaemonSet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> labels:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app.kubernetes.io/component: controller
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app.kubernetes.io/instance: ingress-nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app.kubernetes.io/name: ingress-nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app.kubernetes.io/part-of: ingress-nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app.kubernetes.io/version: 1.6.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name: ingress-nginx-controller
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> namespace: ingress-nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> minReadySeconds: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> revisionHistoryLimit: &lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> selector:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> matchLabels:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app.kubernetes.io/component: controller
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app.kubernetes.io/instance: ingress-nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app.kubernetes.io/name: ingress-nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> template:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> metadata:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> labels:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app.kubernetes.io/component: controller
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app.kubernetes.io/instance: ingress-nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> app.kubernetes.io/name: ingress-nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> spec:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hostNetwork: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> containers:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/ingress-nginx-controller-v1.6.4/deploy/static/provider/baremetal# kubectl apply -f deploy.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~/ingress-nginx-controller-v1.6.4/deploy/static/provider/baremetal# kubectl get pod -n ingress-nginx -owide
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress-nginx-admission-create-zmkrl 0/1 Completed &lt;span class="m">0&lt;/span> 73s 10.244.255.199 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress-nginx-admission-patch-rlglf 0/1 Completed &lt;span class="m">0&lt;/span> 73s 10.244.14.133 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress-nginx-controller-js2fl 1/1 Running &lt;span class="m">0&lt;/span> 73s 192.168.1.76 k8s-node76u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ingress-nginx-controller-mmc2h 1/1 Running &lt;span class="m">0&lt;/span> 73s 192.168.1.75 k8s-node75u &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="二kubectl與helm-cli-工具安裝">二、Kubectl與Helm CLI 工具安裝&lt;/h2>
&lt;p>官方安裝網站： &lt;a class="link" href="https://helm.sh/docs/intro/install/" target="_blank" rel="noopener"
>https://helm.sh/docs/intro/install/&lt;/a>&lt;/p>
&lt;p>Helm v3.12.3 Binary Releases：
&lt;a class="link" href="https://get.helm.sh/helm-v3.12.3-linux-amd64.tar.gz" target="_blank" rel="noopener"
>https://get.helm.sh/helm-v3.12.3-linux-amd64.tar.gz&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# wget https://get.helm.sh/helm-v3.12.3-linux-amd64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# tar -zxvf helm-v3.12.3-linux-amd64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# mv linux-amd64/helm /usr/local/bin/helm
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Kubectl：
&lt;a class="link" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/" target="_blank" rel="noopener"
>https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/&lt;/a>&lt;/p>
&lt;p>如果主機就是master,應該都有kubectl了,此流程可以略過&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 1. Update the apt package index and install packages needed to use the Kubernetes apt repository:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo apt-get update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo apt-get install -y apt-transport-https ca-certificates curl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 2. Download the Google Cloud public signing key:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg &lt;span class="p">|&lt;/span> sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-archive-keyring.gpg
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 3. Add the Kubernetes apt repository:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> sudo tee /etc/apt/sources.list.d/kubernetes.list
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 4. 檢查是否已經添加源 &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# cat /etc/apt/sources.list.d/kubernetes.list
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deb &lt;span class="o">[&lt;/span>signed-by&lt;span class="o">=&lt;/span>/etc/apt/keyrings/kubernetes-archive-keyring.gpg&lt;span class="o">]&lt;/span> https://apt.kubernetes.io/ kubernetes-xenial main
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 5. Update apt package index, install kubelet, kubeadm and kubectl, and pin their version:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo apt-get update
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# sudo apt-get install -y &lt;span class="nv">kubectl&lt;/span>&lt;span class="o">=&lt;/span>1.26.3-00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看版本&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl version
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="三rancher高可用管理平台安裝">三、Rancher高可用管理平台安裝&lt;/h2>
&lt;h3 id="一添加-helm-chart-倉庫">一、添加 Helm Chart 倉庫&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm repo add rancher-stable https://releases.rancher.com/server-charts/stable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;rancher-stable&amp;#34;&lt;/span> has been added to your repositories
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="二為-rancher-建立命名空間">二、為 Rancher 建立命名空間&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl create namespace cattle-system
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="三選擇-ssl-配置">三、選擇 SSL 配置&lt;/h3>
&lt;p>Rancher 產生的憑證（預設）
需要 cert-manager&lt;/p>
&lt;h3 id="四安裝-cert-manager">四、安裝 cert-manager&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 如果你手動安裝了CRD，而不是在 Helm 安裝命令中添加了 &amp;#39;--set installCRDs=true&amp;#39; 選項，你應該在升級 Helm Chart 之前升級 CRD 資源。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.11.0/cert-manager.crds.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 添加 Jetstack Helm 倉庫&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm repo add jetstack https://charts.jetstack.io
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 更新本地 Helm Chart 倉庫緩存&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm repo update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Hang tight &lt;span class="k">while&lt;/span> we grab the latest from your chart repositories...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...Successfully got an update from the &lt;span class="s2">&amp;#34;jetstack&amp;#34;&lt;/span> chart repository
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...Successfully got an update from the &lt;span class="s2">&amp;#34;rancher-stable&amp;#34;&lt;/span> chart repository
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Update Complete. ⎈Happy Helming!⎈
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安裝 cert-manager Helm Chart&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm install cert-manager jetstack/cert-manager &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --namespace cert-manager &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --create-namespace &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --version v1.11.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安裝完 cert-manager 后，你可以通過檢查 cert-manager 命名空間中正在運行的 Pod 來驗證它是否已正確部署&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get pods --namespace cert-manager
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cert-manager-64f9f45d6f-8j65z 1/1 Running &lt;span class="m">0&lt;/span> 2m1s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cert-manager-cainjector-56bbdd5c47-4hngr 1/1 Running &lt;span class="m">0&lt;/span> 2m1s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cert-manager-startupapicheck-vzq7z 0/1 Completed &lt;span class="m">0&lt;/span> 2m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cert-manager-webhook-d4f4545d7-rhbkv 1/1 Running &lt;span class="m">0&lt;/span> 2m1s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="五根據你選擇的證書選項通過-helm-安裝-rancher">五、根據你選擇的證書選項，通過 Helm 安裝 Rancher&lt;/h3>
&lt;p>採Rancher 生成的證書方式&lt;/p>
&lt;p>Rancher Helm Chart 選項：
&lt;a class="link" href="https://ranchermanager.docs.rancher.com/zh/getting-started/installation-and-upgrade/installation-references/helm-chart-options" target="_blank" rel="noopener"
>https://ranchermanager.docs.rancher.com/zh/getting-started/installation-and-upgrade/installation-references/helm-chart-options&lt;/a>&lt;/p>
&lt;p>&lt;font color=red>需多指定ingressClassName為nginx&lt;/font>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# helm install rancher rancher-stable/rancher &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --namespace cattle-system &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --set &lt;span class="nv">hostname&lt;/span>&lt;span class="o">=&lt;/span>rancher.jimmyhome.tw &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --set &lt;span class="nv">bootstrapPassword&lt;/span>&lt;span class="o">=&lt;/span>admin &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --set ingress.ingressClassName&lt;span class="o">=&lt;/span>nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME: rancher
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">LAST DEPLOYED: Wed Sep &lt;span class="m">20&lt;/span> 18:31:10 &lt;span class="m">2023&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAMESPACE: cattle-system
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">STATUS: deployed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">REVISION: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TEST SUITE: None
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NOTES:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Rancher Server has been installed.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NOTE: Rancher may take several minutes to fully initialize. Please standby &lt;span class="k">while&lt;/span> Certificates are being issued, Containers are started and the Ingress rule comes up.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Check out our docs at https://rancher.com/docs/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">If you provided your own bootstrap password during installation, browse to https://rancher.jimmyhome.tw to get started.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">If this is the first &lt;span class="nb">time&lt;/span> you installed Rancher, get started by running this &lt;span class="nb">command&lt;/span> and clicking the URL it generates:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> https://rancher.jimmyhome.tw/dashboard/?setup&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>kubectl get secret --namespace cattle-system bootstrap-secret -o go-template&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;{{.data.bootstrapPassword|base64decode}}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">To get just the bootstrap password on its own, run:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubectl get secret --namespace cattle-system bootstrap-secret -o go-template&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;{{.data.bootstrapPassword|base64decode}}{{ &amp;#34;\n&amp;#34; }}&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Happy Containering!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 等待 Rancher 運行&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl -n cattle-system rollout status deploy/rancher
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Waiting &lt;span class="k">for&lt;/span> deployment &lt;span class="s2">&amp;#34;rancher&amp;#34;&lt;/span> rollout to finish: &lt;span class="m">0&lt;/span> of &lt;span class="m">3&lt;/span> updated replicas are available...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Waiting &lt;span class="k">for&lt;/span> deployment &lt;span class="s2">&amp;#34;rancher&amp;#34;&lt;/span> rollout to finish: &lt;span class="m">1&lt;/span> of &lt;span class="m">3&lt;/span> updated replicas are available...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Waiting &lt;span class="k">for&lt;/span> deployment &lt;span class="s2">&amp;#34;rancher&amp;#34;&lt;/span> rollout to finish: &lt;span class="m">2&lt;/span> of &lt;span class="m">3&lt;/span> updated replicas are available...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment &lt;span class="s2">&amp;#34;rancher&amp;#34;&lt;/span> successfully rolled out
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="六驗證-rancher-server-是否部署成功">六、驗證 Rancher Server 是否部署成功&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl -n cattle-system get deploy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY UP-TO-DATE AVAILABLE AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rancher 3/3 &lt;span class="m">3&lt;/span> &lt;span class="m">3&lt;/span> 53s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl -n cattle-system get ingress
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME CLASS HOSTS ADDRESS PORTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rancher nginx rancher.jimmyhome.tw 192.168.1.75,192.168.1.76 80, &lt;span class="m">443&lt;/span> 67s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 我自己的筆電，先設定/etc/hosts測試網頁訪問&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 如是內部有dns server的，就到dns server設定a record解析&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chenqingze@chenqingze-MBP ~ % sudo vim /etc/hosts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.1.75 rancher.jimmyhome.tw
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>打 &lt;a class="link" href="https://rancher.jimmyhome.tw" target="_blank" rel="noopener"
>https://rancher.jimmyhome.tw&lt;/a> 可以看到網頁
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230921023255.png"
width="1010"
height="894"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230921023255_hu255ddf89689e804c5d835315e9863c95_89733_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230921023255_hu255ddf89689e804c5d835315e9863c95_89733_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230921023255.png"
class="gallery-image"
data-flex-grow="112"
data-flex-basis="271px"
>
由上方helm install rancher完成時，可以看到以下兩個指令，可以獲取到預設admin帳號的密碼&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># If this is the first time you installed Rancher, get started by running this command and clicking the URL it generates&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# &lt;span class="nb">echo&lt;/span> https://rancher.jimmyhome.tw/dashboard/?setup&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>kubectl get secret --namespace cattle-system bootstrap-secret -o go-template&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;{{.data.bootstrapPassword|base64decode}}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">https://rancher.jimmyhome.tw/dashboard/?setup&lt;span class="o">=&lt;/span>admin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># To get just the bootstrap password on its own, run&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@k8s-master71u:~# kubectl get secret --namespace cattle-system bootstrap-secret -o go-template&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;{{.data.bootstrapPassword|base64decode}}{{ &amp;#34;\n&amp;#34; }}&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">admin
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>重設admin帳號的密碼
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230921023557.png"
width="1008"
height="893"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230921023557_hu9e81d5777cb32757e44e3be582d3603e_90642_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230921023557_hu9e81d5777cb32757e44e3be582d3603e_90642_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230921023557.png"
class="gallery-image"
data-flex-grow="112"
data-flex-basis="270px"
>&lt;/p>
&lt;p>輸入剛剛重設的admin密碼，登入
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230921031136.png"
width="991"
height="782"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230921031136_hubdf0d5ed0ba43ff474725ac5a8ecccc3_79311_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230921031136_hubdf0d5ed0ba43ff474725ac5a8ecccc3_79311_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230921031136.png"
class="gallery-image"
data-flex-grow="126"
data-flex-basis="304px"
>&lt;/p>
&lt;p>可以看到集群資訊，state為Active
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230921031249.png"
width="1457"
height="722"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230921031249_hucbbfb060f3c77e6be7bccf554592ce7d_77193_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230921031249_hucbbfb060f3c77e6be7bccf554592ce7d_77193_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230921031249.png"
class="gallery-image"
data-flex-grow="201"
data-flex-basis="484px"
>&lt;/p>
&lt;p>進入集群，可以看到集群詳細訊息
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230921031718.png"
width="1975"
height="944"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230921031718_hu475c36b1f3937b05de60533cd5928b74_159357_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230921031718_hu475c36b1f3937b05de60533cd5928b74_159357_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230921031718.png"
class="gallery-image"
data-flex-grow="209"
data-flex-basis="502px"
>&lt;/p>
&lt;p>也可以使用dashboard shell去管理集群
&lt;img src="https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230921031746.png"
width="1983"
height="721"
srcset="https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230921031746_hu87f73535b369c4edcdb990f935a08331_143573_480x0_resize_box_3.png 480w, https://blog.goldfishbrain-fighting.com/2023/kubernetes-helm/media/Pasted-image-20230921031746_hu87f73535b369c4edcdb990f935a08331_143573_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="media/Pasted-image-20230921031746.png"
class="gallery-image"
data-flex-grow="275"
data-flex-basis="660px"
>&lt;/p></description></item></channel></rss>